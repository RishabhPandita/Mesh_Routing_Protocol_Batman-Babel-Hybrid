cscope 15 $HOME/repos/batman-adv/batman-adv               0000432496
	@bat_algo.h

20 #iâdeà
_NET_BATMAN_ADV_BAT_ALGO_H_


21 
	#_NET_BATMAN_ADV_BAT_ALGO_H_


	)

23 
b©adv_iv_š™
();

	@bat_iv_ogm.c

20 
	~"maš.h
"

21 
	~"Œª¦©iÚ-bË.h
"

22 
	~"ršg_bufãr.h
"

23 
	~"Üigš©Ü.h
"

24 
	~"routšg.h
"

25 
	~"g©eway_commÚ.h
"

26 
	~"g©eway_ş›Á.h
"

27 
	~"h¬d-š‹rçû.h
"

28 
	~"£nd.h
"

29 
	~"b©_®go.h
"

31 
b©adv_Ãigh_node
 *

32 
	$b©adv_iv_ogm_Ãigh_Ãw
(
b©adv_h¬d_içû
 *
h¬d_içû
,

33 cÚ¡ 
ušt8_t
 *
Ãigh_addr
,

34 
b©adv_Üig_node
 *
Üig_node
,

35 
b©adv_Üig_node
 *
Üig_Ãigh
, 
__be32
 
£qno
)

37 
b©adv_Ãigh_node
 *
Ãigh_node
;

39 
Ãigh_node
 = 
	`b©adv_Ãigh_node_Ãw
(
h¬d_içû
, 
Ãigh_addr
,

40 
	`Áohl
(
£qno
));

41 ià(!
Ãigh_node
)

42 
out
;

44 
	`INIT_LIST_HEAD
(&
Ãigh_node
->
bÚdšg_li¡
);

46 
Ãigh_node
->
Üig_node
 = 
Üig_Ãigh
;

47 
Ãigh_node
->
if_šcomšg
 = 
h¬d_içû
;

49 
	`¥š_lock_bh
(&
Üig_node
->
Ãigh_li¡_lock
);

50 
	`hli¡_add_h—d_rcu
(&
Ãigh_node
->
li¡
, &
Üig_node
->
Ãigh_li¡
);

51 
	`¥š_uÆock_bh
(&
Üig_node
->
Ãigh_li¡_lock
);

53 
out
:

54  
Ãigh_node
;

55 
	}
}

57 
	$b©adv_iv_ogm_içû_’abË
(
b©adv_h¬d_içû
 *
h¬d_içû
)

59 
b©adv_ogm_·ck‘
 *batadv_ogm_packet;

60 
ušt32_t
 
¿ndom_£qno
;

61 
»s
 = -
ENOMEM
;

64 
	`g‘_¿ndom_by‹s
(&
¿ndom_£qno
, (random_seqno));

65 
	`©omic_£t
(&
h¬d_içû
->
£qno
, 
¿ndom_£qno
);

67 
h¬d_içû
->
·ck‘_Ën
 = 
BATADV_OGM_HLEN
;

68 
h¬d_içû
->
·ck‘_buff
 = 
	`km®loc
(h¬d_içû->
·ck‘_Ën
, 
GFP_ATOMIC
);

70 ià(!
h¬d_içû
->
·ck‘_buff
)

71 
out
;

73 
b©adv_ogm_·ck‘
 = (b©adv_ogm_·ck‘ *)
h¬d_içû
->
·ck‘_buff
;

74 
b©adv_ogm_·ck‘
->
h—d”
.
·ck‘_ty³
 = 
BATADV_IV_OGM
;

75 
b©adv_ogm_·ck‘
->
h—d”
.
v”siÚ
 = 
BATADV_COMPAT_VERSION
;

76 
b©adv_ogm_·ck‘
->
h—d”
.
‰l
 = 2;

77 
b©adv_ogm_·ck‘
->
æags
 = 
BATADV_NO_FLAGS
;

78 
b©adv_ogm_·ck‘
->
tq
 = 
BATADV_TQ_MAX_VALUE
;

79 
b©adv_ogm_·ck‘
->
‰_num_chªges
 = 0;

80 
b©adv_ogm_·ck‘
->
‰vn
 = 0;

82 
»s
 = 0;

84 
out
:

85  
»s
;

86 
	}
}

88 
	$b©adv_iv_ogm_içû_di§bË
(
b©adv_h¬d_içû
 *
h¬d_içû
)

90 
	`kä“
(
h¬d_içû
->
·ck‘_buff
);

91 
h¬d_içû
->
·ck‘_buff
 = 
NULL
;

92 
	}
}

94 
	$b©adv_iv_ogm_içû_upd©e_mac
(
b©adv_h¬d_içû
 *
h¬d_içû
)

96 
b©adv_ogm_·ck‘
 *batadv_ogm_packet;

98 
b©adv_ogm_·ck‘
 = (b©adv_ogm_·ck‘ *)
h¬d_içû
->
·ck‘_buff
;

99 
	`memıy
(
b©adv_ogm_·ck‘
->
Üig
,

100 
h¬d_içû
->
Ãt_dev
->
dev_addr
, 
ETH_ALEN
);

101 
	`memıy
(
b©adv_ogm_·ck‘
->
´ev_£nd”
,

102 
h¬d_içû
->
Ãt_dev
->
dev_addr
, 
ETH_ALEN
);

103 
	}
}

106 
	$b©adv_iv_ogm_´im¬y_içû_£t
(
b©adv_h¬d_içû
 *
h¬d_içû
)

108 
b©adv_ogm_·ck‘
 *batadv_ogm_packet;

110 
b©adv_ogm_·ck‘
 = (b©adv_ogm_·ck‘ *)
h¬d_içû
->
·ck‘_buff
;

111 
b©adv_ogm_·ck‘
->
æags
 = 
BATADV_PRIMARIES_FIRST_HOP
;

112 
b©adv_ogm_·ck‘
->
h—d”
.
‰l
 = 
BATADV_TTL
;

113 
	}
}

117 
	$b©adv_iv_ogm_em™_£nd_time
(cÚ¡ 
b©adv_´iv
 *
b©_´iv
)

119 
m£cs
;

121 
m£cs
 = 
	`©omic_»ad
(&
b©_´iv
->
Üig_š‹rv®
è- 
BATADV_JITTER
;

122 
m£cs
 +ğ(
	`¿ndom32
(è% 2 * 
BATADV_JITTER
);

124  
jiff›s
 + 
	`m£cs_to_jiff›s
(
m£cs
);

125 
	}
}

128 
	$b©adv_iv_ogm_fwd_£nd_time
()

130  
jiff›s
 + 
	`m£cs_to_jiff›s
(
	`¿ndom32
(è% (
BATADV_JITTER
 / 2));

131 
	}
}

134 
ušt8_t
 
	$b©adv_hİ_³ÇÉy
(
ušt8_t
 
tq
,

135 cÚ¡ 
b©adv_´iv
 *
b©_´iv
)

137 
hİ_³ÇÉy
 = 
	`©omic_»ad
(&
b©_´iv
->hop_penalty);

138 
Ãw_tq
;

140 
Ãw_tq
 = 
tq
 * (
BATADV_TQ_MAX_VALUE
 - 
hİ_³ÇÉy
);

141 
Ãw_tq
 /ğ
BATADV_TQ_MAX_VALUE
;

143  
Ãw_tq
;

144 
	}
}

147 
	$b©adv_iv_ogm_aggr_·ck‘
(
buff_pos
, 
·ck‘_Ën
,

148 
‰_num_chªges
)

150 
Ãxt_buff_pos
 = 0;

152 
Ãxt_buff_pos
 +ğ
buff_pos
 + 
BATADV_OGM_HLEN
;

153 
Ãxt_buff_pos
 +ğ
	`b©adv_‰_Ën
(
‰_num_chªges
);

155  (
Ãxt_buff_pos
 <ğ
·ck‘_Ën
) &&

156 (
Ãxt_buff_pos
 <ğ
BATADV_MAX_AGGREGATION_BYTES
);

157 
	}
}

160 
	$b©adv_iv_ogm_£nd_to_if
(
b©adv_fÜw_·ck‘
 *
fÜw_·ck‘
,

161 
b©adv_h¬d_içû
 *
h¬d_içû
)

163 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
h¬d_içû
->
soá_içû
);

164 *
fwd_¡r
;

165 
ušt8_t
 
·ck‘_num
;

166 
št16_t
 
buff_pos
;

167 
b©adv_ogm_·ck‘
 *batadv_ogm_packet;

168 
sk_buff
 *
skb
;

169 
ušt8_t
 *
·ck‘_pos
;

171 ià(
h¬d_içû
->
if_¡©us
 !ğ
BATADV_IF_ACTIVE
)

174 
·ck‘_num
 = 0;

175 
buff_pos
 = 0;

176 
·ck‘_pos
 = 
fÜw_·ck‘
->
skb
->
d©a
;

177 
b©adv_ogm_·ck‘
 = (b©adv_ogm_·ck‘ *)
·ck‘_pos
;

180 
	`b©adv_iv_ogm_aggr_·ck‘
(
buff_pos
, 
fÜw_·ck‘
->
·ck‘_Ën
,

181 
b©adv_ogm_·ck‘
->
‰_num_chªges
)) {

186 ià(
fÜw_·ck‘
->
dœeù_lšk_æags
 & 
	`BIT
(
·ck‘_num
) &&

187 
fÜw_·ck‘
->
if_šcomšg
 =ğ
h¬d_içû
)

188 
b©adv_ogm_·ck‘
->
æags
 |ğ
BATADV_DIRECTLINK
;

190 
b©adv_ogm_·ck‘
->
æags
 &ğ~
BATADV_DIRECTLINK
;

192 ià(
·ck‘_num
 > 0 || !
fÜw_·ck‘
->
own
)

193 
fwd_¡r
 = "Forwarding";

195 
fwd_¡r
 = "Sending own";

197 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

199 
fwd_¡r
, (
·ck‘_num
 > 0 ? "aggregated " : ""),

200 
b©adv_ogm_·ck‘
->
Üig
,

201 
	`Áohl
(
b©adv_ogm_·ck‘
->
£qno
),

202 
b©adv_ogm_·ck‘
->
tq
, b©adv_ogm_·ck‘->
h—d”
.
‰l
,

203 (
b©adv_ogm_·ck‘
->
æags
 & 
BATADV_DIRECTLINK
 ?

205 
b©adv_ogm_·ck‘
->
‰vn
, 
h¬d_içû
->
Ãt_dev
->
Çme
,

206 
h¬d_içû
->
Ãt_dev
->
dev_addr
);

208 
buff_pos
 +ğ
BATADV_OGM_HLEN
;

209 
buff_pos
 +ğ
	`b©adv_‰_Ën
(
b©adv_ogm_·ck‘
->
‰_num_chªges
);

210 
·ck‘_num
++;

211 
·ck‘_pos
 = 
fÜw_·ck‘
->
skb
->
d©a
 + 
buff_pos
;

212 
b©adv_ogm_·ck‘
 = (b©adv_ogm_·ck‘ *)
·ck‘_pos
;

216 
skb
 = 
	`skb_şÚe
(
fÜw_·ck‘
->skb, 
GFP_ATOMIC
);

217 ià(
skb
) {

218 
	`b©adv_šc_couÁ”
(
b©_´iv
, 
BATADV_CNT_MGMT_TX
);

219 
	`b©adv_add_couÁ”
(
b©_´iv
, 
BATADV_CNT_MGMT_TX_BYTES
,

220 
skb
->
Ën
 + 
ETH_HLEN
);

221 
	`b©adv_£nd_skb_·ck‘
(
skb
, 
h¬d_içû
, 
b©adv_brßdÿ¡_addr
);

223 
	}
}

226 
	$b©adv_iv_ogm_em™
(
b©adv_fÜw_·ck‘
 *
fÜw_·ck‘
)

228 
b©adv_h¬d_içû
 *
h¬d_içû
;

229 
Ãt_deviû
 *
soá_içû
;

230 
b©adv_´iv
 *
b©_´iv
;

231 
b©adv_h¬d_içû
 *
´im¬y_if
 = 
NULL
;

232 
b©adv_ogm_·ck‘
 *batadv_ogm_packet;

233 
dœeùlšk
;

234 
ušt8_t
 *
·ck‘_pos
;

236 
·ck‘_pos
 = 
fÜw_·ck‘
->
skb
->
d©a
;

237 
b©adv_ogm_·ck‘
 = (b©adv_ogm_·ck‘ *)
·ck‘_pos
;

238 
dœeùlšk
 = (
b©adv_ogm_·ck‘
->
æags
 & 
BATADV_DIRECTLINK
 ? 1 : 0);

240 ià(!
fÜw_·ck‘
->
if_šcomšg
) {

241 
	`´_”r
("Error - can't forward…acket: incoming iface‚ot specified\n");

242 
out
;

245 
soá_içû
 = 
fÜw_·ck‘
->
if_šcomšg
->soft_iface;

246 
b©_´iv
 = 
	`Ãtdev_´iv
(
soá_içû
);

248 ià(
fÜw_·ck‘
->
if_šcomšg
->
if_¡©us
 !ğ
BATADV_IF_ACTIVE
)

249 
out
;

251 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

252 ià(!
´im¬y_if
)

253 
out
;

258 ià((
dœeùlšk
 && (
b©adv_ogm_·ck‘
->
h—d”
.
‰l
 == 1)) ||

259 (
fÜw_·ck‘
->
own
 && (fÜw_·ck‘->
if_šcomšg
 !ğ
´im¬y_if
))) {

262 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

264 (
fÜw_·ck‘
->
own
 ? "Sending own" : "Forwarding"),

265 
b©adv_ogm_·ck‘
->
Üig
,

266 
	`Áohl
(
b©adv_ogm_·ck‘
->
£qno
),

267 
b©adv_ogm_·ck‘
->
h—d”
.
‰l
,

268 
fÜw_·ck‘
->
if_šcomšg
->
Ãt_dev
->
Çme
,

269 
fÜw_·ck‘
->
if_šcomšg
->
Ãt_dev
->
dev_addr
);

272 
	`b©adv_£nd_skb_·ck‘
(
fÜw_·ck‘
->
skb
,

273 
fÜw_·ck‘
->
if_šcomšg
,

274 
b©adv_brßdÿ¡_addr
);

275 
fÜw_·ck‘
->
skb
 = 
NULL
;

277 
out
;

281 
	`rcu_»ad_lock
();

282 
	`li¡_fÜ_—ch_’Œy_rcu
(
h¬d_içû
, &
b©adv_h¬dif_li¡
, 
li¡
) {

283 ià(
h¬d_içû
->
soá_içû
 != soft_iface)

286 
	`b©adv_iv_ogm_£nd_to_if
(
fÜw_·ck‘
, 
h¬d_içû
);

288 
	`rcu_»ad_uÆock
();

290 
out
:

291 ià(
´im¬y_if
)

292 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

293 
	}
}

296 
boŞ


297 
	$b©adv_iv_ogm_ÿn_agg»g©e
(cÚ¡ 
b©adv_ogm_·ck‘
 *
Ãw_b©_ogm_·ck‘
,

298 
b©adv_´iv
 *
b©_´iv
,

299 
·ck‘_Ën
, 
£nd_time
,

300 
boŞ
 
dœeùlšk
,

301 cÚ¡ 
b©adv_h¬d_içû
 *
if_šcomšg
,

302 cÚ¡ 
b©adv_fÜw_·ck‘
 *
fÜw_·ck‘
)

304 
b©adv_ogm_·ck‘
 *batadv_ogm_packet;

305 
agg»g©ed_by‹s
 = 
fÜw_·ck‘
->
·ck‘_Ën
 +…acket_len;

306 
b©adv_h¬d_içû
 *
´im¬y_if
 = 
NULL
;

307 
boŞ
 
»s
 = 
çl£
;

308 
agg»g©iÚ_’d_time
;

310 
b©adv_ogm_·ck‘
 = (b©adv_ogm_·ck‘ *)
fÜw_·ck‘
->
skb
->
d©a
;

311 
agg»g©iÚ_’d_time
 = 
£nd_time
;

312 
agg»g©iÚ_’d_time
 +ğ
	`m£cs_to_jiff›s
(
BATADV_MAX_AGGREGATION_MS
);

321 ià(
	`time_befÜe
(
£nd_time
, 
fÜw_·ck‘
->send_time) &&

322 
	`time_aá”_eq
(
agg»g©iÚ_’d_time
, 
fÜw_·ck‘
->
£nd_time
) &&

323 (
agg»g©ed_by‹s
 <ğ
BATADV_MAX_AGGREGATION_BYTES
)) {

332 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

333 ià(!
´im¬y_if
)

334 
out
;

339 ià((!
dœeùlšk
) &&

340 (!(
b©adv_ogm_·ck‘
->
æags
 & 
BATADV_DIRECTLINK
)) &&

341 (
b©adv_ogm_·ck‘
->
h—d”
.
‰l
 != 1) &&

346 ((!
fÜw_·ck‘
->
own
) ||

347 (
fÜw_·ck‘
->
if_šcomšg
 =ğ
´im¬y_if
))) {

348 
»s
 = 
Œue
;

349 
out
;

355 ià((
dœeùlšk
) &&

356 (
Ãw_b©_ogm_·ck‘
->
h—d”
.
‰l
 == 1) &&

357 (
fÜw_·ck‘
->
if_šcomšg
 == if_incoming) &&

363 (
b©adv_ogm_·ck‘
->
æags
 & 
BATADV_DIRECTLINK
 ||

364 (
fÜw_·ck‘
->
own
 &&

365 
fÜw_·ck‘
->
if_šcomšg
 !ğ
´im¬y_if
))) {

366 
»s
 = 
Œue
;

367 
out
;

371 
out
:

372 ià(
´im¬y_if
)

373 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

374  
»s
;

375 
	}
}

378 
	$b©adv_iv_ogm_agg»g©e_Ãw
(cÚ¡ *
·ck‘_buff
,

379 
·ck‘_Ën
, 
£nd_time
,

380 
boŞ
 
dœeù_lšk
,

381 
b©adv_h¬d_içû
 *
if_šcomšg
,

382 
own_·ck‘
)

384 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
if_šcomšg
->
soá_içû
);

385 
b©adv_fÜw_·ck‘
 *
fÜw_·ck‘_aggr
;

386 *
skb_buff
;

387 
skb_size
;

389 ià(!
	`©omic_šc_nÙ_z”o
(&
if_šcomšg
->
»fcouÁ
))

393 ià(!
own_·ck‘
) {

394 ià(!
	`b©adv_©omic_dec_nÙ_z”o
(&
b©_´iv
->
b©mª_queue_Ëá
)) {

395 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

397 
out
;

401 
fÜw_·ck‘_aggr
 = 
	`km®loc
((*fÜw_·ck‘_aggr), 
GFP_ATOMIC
);

402 ià(!
fÜw_·ck‘_aggr
) {

403 ià(!
own_·ck‘
)

404 
	`©omic_šc
(&
b©_´iv
->
b©mª_queue_Ëá
);

405 
out
;

408 ià((
	`©omic_»ad
(&
b©_´iv
->
agg»g©ed_ogms
)) &&

409 (
·ck‘_Ën
 < 
BATADV_MAX_AGGREGATION_BYTES
))

410 
skb_size
 = 
BATADV_MAX_AGGREGATION_BYTES
 + 
ETH_HLEN
;

412 
skb_size
 = 
·ck‘_Ën
 + 
ETH_HLEN
;

414 
fÜw_·ck‘_aggr
->
skb
 = 
	`dev_®loc_skb
(
skb_size
);

415 ià(!
fÜw_·ck‘_aggr
->
skb
) {

416 ià(!
own_·ck‘
)

417 
	`©omic_šc
(&
b©_´iv
->
b©mª_queue_Ëá
);

418 
	`kä“
(
fÜw_·ck‘_aggr
);

419 
out
;

421 
	`skb_»£rve
(
fÜw_·ck‘_aggr
->
skb
, 
ETH_HLEN
);

423 
	`INIT_HLIST_NODE
(&
fÜw_·ck‘_aggr
->
li¡
);

425 
skb_buff
 = 
	`skb_put
(
fÜw_·ck‘_aggr
->
skb
, 
·ck‘_Ën
);

426 
fÜw_·ck‘_aggr
->
·ck‘_Ën
 =…acket_len;

427 
	`memıy
(
skb_buff
, 
·ck‘_buff
, 
·ck‘_Ën
);

429 
fÜw_·ck‘_aggr
->
own
 = 
own_·ck‘
;

430 
fÜw_·ck‘_aggr
->
if_šcomšg
 = if_incoming;

431 
fÜw_·ck‘_aggr
->
num_·ck‘s
 = 0;

432 
fÜw_·ck‘_aggr
->
dœeù_lšk_æags
 = 
BATADV_NO_FLAGS
;

433 
fÜw_·ck‘_aggr
->
£nd_time
 = send_time;

436 ià(
dœeù_lšk
)

437 
fÜw_·ck‘_aggr
->
dœeù_lšk_æags
 |= 1;

440 
	`¥š_lock_bh
(&
b©_´iv
->
fÜw_b©_li¡_lock
);

441 
	`hli¡_add_h—d
(&
fÜw_·ck‘_aggr
->
li¡
, &
b©_´iv
->
fÜw_b©_li¡
);

442 
	`¥š_uÆock_bh
(&
b©_´iv
->
fÜw_b©_li¡_lock
);

445 
	`INIT_DELAYED_WORK
(&
fÜw_·ck‘_aggr
->
d–ayed_wÜk
,

446 
b©adv_£nd_out¡ªdšg_b©_ogm_·ck‘
);

447 
	`queue_d–ayed_wÜk
(
b©adv_ev’t_wÜkqueue
,

448 &
fÜw_·ck‘_aggr
->
d–ayed_wÜk
,

449 
£nd_time
 - 
jiff›s
);

452 
out
:

453 
	`b©adv_h¬dif_ä“_»f
(
if_šcomšg
);

454 
	}
}

457 
	$b©adv_iv_ogm_agg»g©e
(
b©adv_fÜw_·ck‘
 *
fÜw_·ck‘_aggr
,

458 cÚ¡ *
·ck‘_buff
,

459 
·ck‘_Ën
, 
boŞ
 
dœeù_lšk
)

461 *
skb_buff
;

462 
Ãw_dœeù_lšk_æag
;

464 
skb_buff
 = 
	`skb_put
(
fÜw_·ck‘_aggr
->
skb
, 
·ck‘_Ën
);

465 
	`memıy
(
skb_buff
, 
·ck‘_buff
, 
·ck‘_Ën
);

466 
fÜw_·ck‘_aggr
->
·ck‘_Ën
 +=…acket_len;

467 
fÜw_·ck‘_aggr
->
num_·ck‘s
++;

470 ià(
dœeù_lšk
) {

471 
Ãw_dœeù_lšk_æag
 = 
	`BIT
(
fÜw_·ck‘_aggr
->
num_·ck‘s
);

472 
fÜw_·ck‘_aggr
->
dœeù_lšk_æags
 |ğ
Ãw_dœeù_lšk_æag
;

474 
	}
}

476 
	$b©adv_iv_ogm_queue_add
(
b©adv_´iv
 *
b©_´iv
,

477 *
·ck‘_buff
,

478 
·ck‘_Ën
,

479 
b©adv_h¬d_içû
 *
if_šcomšg
,

480 
own_·ck‘
, 
£nd_time
)

485 
b©adv_fÜw_·ck‘
 *
fÜw_·ck‘_aggr
 = 
NULL
;

486 
b©adv_fÜw_·ck‘
 *
fÜw_·ck‘_pos
 = 
NULL
;

487 
hli¡_node
 *
tmp_node
;

488 
b©adv_ogm_·ck‘
 *batadv_ogm_packet;

489 
boŞ
 
dœeù_lšk
;

490 
max_agg»g©iÚ_jiff›s
;

492 
b©adv_ogm_·ck‘
 = (b©adv_ogm_·ck‘ *)
·ck‘_buff
;

493 
dœeù_lšk
 = 
b©adv_ogm_·ck‘
->
æags
 & 
BATADV_DIRECTLINK
 ? 1 : 0;

494 
max_agg»g©iÚ_jiff›s
 = 
	`m£cs_to_jiff›s
(
BATADV_MAX_AGGREGATION_MS
);

497 
	`¥š_lock_bh
(&
b©_´iv
->
fÜw_b©_li¡_lock
);

499 ià((
	`©omic_»ad
(&
b©_´iv
->
agg»g©ed_ogms
)è&& (!
own_·ck‘
)) {

500 
	`hli¡_fÜ_—ch_’Œy
(
fÜw_·ck‘_pos
, 
tmp_node
,

501 &
b©_´iv
->
fÜw_b©_li¡
, 
li¡
) {

502 ià(
	`b©adv_iv_ogm_ÿn_agg»g©e
(
b©adv_ogm_·ck‘
,

503 
b©_´iv
, 
·ck‘_Ën
,

504 
£nd_time
, 
dœeù_lšk
,

505 
if_šcomšg
,

506 
fÜw_·ck‘_pos
)) {

507 
fÜw_·ck‘_aggr
 = 
fÜw_·ck‘_pos
;

516 ià(!
fÜw_·ck‘_aggr
) {

518 
	`¥š_uÆock_bh
(&
b©_´iv
->
fÜw_b©_li¡_lock
);

524 ià(!
own_·ck‘
 && 
	`©omic_»ad
(&
b©_´iv
->
agg»g©ed_ogms
))

525 
£nd_time
 +ğ
max_agg»g©iÚ_jiff›s
;

527 
	`b©adv_iv_ogm_agg»g©e_Ãw
(
·ck‘_buff
, 
·ck‘_Ën
,

528 
£nd_time
, 
dœeù_lšk
,

529 
if_šcomšg
, 
own_·ck‘
);

531 
	`b©adv_iv_ogm_agg»g©e
(
fÜw_·ck‘_aggr
, 
·ck‘_buff
,

532 
·ck‘_Ën
, 
dœeù_lšk
);

533 
	`¥š_uÆock_bh
(&
b©_´iv
->
fÜw_b©_li¡_lock
);

535 
	}
}

537 
	$b©adv_iv_ogm_fÜw¬d
(
b©adv_Üig_node
 *
Üig_node
,

538 cÚ¡ 
‘hhdr
 *ethhdr,

539 
b©adv_ogm_·ck‘
 *batadv_ogm_packet,

540 
boŞ
 
is_sšgË_hİ_Ãigh
,

541 
boŞ
 
is_äom_be¡_Ãxt_hİ
,

542 
b©adv_h¬d_içû
 *
if_šcomšg
)

544 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
if_šcomšg
->
soá_içû
);

545 
ušt8_t
 
‰_num_chªges
;

547 ià(
b©adv_ogm_·ck‘
->
h—d”
.
‰l
 <= 1) {

548 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
, "ttlƒxceeded\n");

552 ià(!
is_äom_be¡_Ãxt_hİ
) {

559 ià(
is_sšgË_hİ_Ãigh
)

560 
b©adv_ogm_·ck‘
->
æags
 |ğ
BATADV_NOT_BEST_NEXT_HOP
;

565 
‰_num_chªges
 = 
b©adv_ogm_·ck‘
->tt_num_changes;

567 
b©adv_ogm_·ck‘
->
h—d”
.
‰l
--;

568 
	`memıy
(
b©adv_ogm_·ck‘
->
´ev_£nd”
, 
‘hhdr
->
h_sourû
, 
ETH_ALEN
);

571 
b©adv_ogm_·ck‘
->
tq
 = 
	`b©adv_hİ_³ÇÉy
(batadv_ogm_packet->tq,

572 
b©_´iv
);

574 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

576 
b©adv_ogm_·ck‘
->
tq
, b©adv_ogm_·ck‘->
h—d”
.
‰l
);

579 
b©adv_ogm_·ck‘
->
æags
 &ğ~
BATADV_PRIMARIES_FIRST_HOP
;

580 ià(
is_sšgË_hİ_Ãigh
)

581 
b©adv_ogm_·ck‘
->
æags
 |ğ
BATADV_DIRECTLINK
;

583 
b©adv_ogm_·ck‘
->
æags
 &ğ~
BATADV_DIRECTLINK
;

585 
	`b©adv_iv_ogm_queue_add
(
b©_´iv
, (*)
b©adv_ogm_·ck‘
,

586 
BATADV_OGM_HLEN
 + 
	`b©adv_‰_Ën
(
‰_num_chªges
),

587 
if_šcomšg
, 0, 
	`b©adv_iv_ogm_fwd_£nd_time
());

588 
	}
}

590 
	$b©adv_iv_ogm_scheduË
(
b©adv_h¬d_içû
 *
h¬d_içû
)

592 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
h¬d_içû
->
soá_içû
);

593 
b©adv_ogm_·ck‘
 *batadv_ogm_packet;

594 
b©adv_h¬d_içû
 *
´im¬y_if
;

595 
vis_£rv”
, 
‰_num_chªges
 = 0;

596 
ušt32_t
 
£qno
;

597 
ušt8_t
 
bªdwidth
;

599 
vis_£rv”
 = 
	`©omic_»ad
(&
b©_´iv
->
vis_mode
);

600 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

602 ià(
h¬d_içû
 =ğ
´im¬y_if
)

603 
‰_num_chªges
 = 
	`b©adv_‰_­³nd_diff
(
b©_´iv
,

604 &
h¬d_içû
->
·ck‘_buff
,

605 &
h¬d_içû
->
·ck‘_Ën
,

606 
BATADV_OGM_HLEN
);

608 
b©adv_ogm_·ck‘
 = (b©adv_ogm_·ck‘ *)
h¬d_içû
->
·ck‘_buff
;

611 
£qno
 = (
ušt32_t
)
	`©omic_»ad
(&
h¬d_içû
->seqno);

612 
b©adv_ogm_·ck‘
->
£qno
 = 
	`htÚl
(seqno);

613 
	`©omic_šc
(&
h¬d_içû
->
£qno
);

615 
b©adv_ogm_·ck‘
->
‰vn
 = 
	`©omic_»ad
(&
b©_´iv
->
‰
.
vn
);

616 
b©adv_ogm_·ck‘
->
‰_üc
 = 
	`htÚs
(
b©_´iv
->
‰
.
loÿl_üc
);

617 ià(
‰_num_chªges
 >= 0)

618 
b©adv_ogm_·ck‘
->
‰_num_chªges
 =t_num_changes;

620 ià(
vis_£rv”
 =ğ
BATADV_VIS_TYPE_SERVER_SYNC
)

621 
b©adv_ogm_·ck‘
->
æags
 |ğ
BATADV_VIS_SERVER
;

623 
b©adv_ogm_·ck‘
->
æags
 &ğ~
BATADV_VIS_SERVER
;

625 ià(
h¬d_içû
 =ğ
´im¬y_if
 &&

626 
	`©omic_»ad
(&
b©_´iv
->
gw_mode
è=ğ
BATADV_GW_MODE_SERVER
) {

627 
bªdwidth
 = (
ušt8_t
)
	`©omic_»ad
(&
b©_´iv
->
gw_bªdwidth
);

628 
b©adv_ogm_·ck‘
->
gw_æags
 = 
bªdwidth
;

630 
b©adv_ogm_·ck‘
->
gw_æags
 = 
BATADV_NO_FLAGS
;

633 
	`b©adv_¦ide_own_bÿ¡_wšdow
(
h¬d_içû
);

634 
	`b©adv_iv_ogm_queue_add
(
b©_´iv
, 
h¬d_içû
->
·ck‘_buff
,

635 
h¬d_içû
->
·ck‘_Ën
, hard_iface, 1,

636 
	`b©adv_iv_ogm_em™_£nd_time
(
b©_´iv
));

638 ià(
´im¬y_if
)

639 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

640 
	}
}

643 
	$b©adv_iv_ogm_Üig_upd©e
(
b©adv_´iv
 *
b©_´iv
,

644 
b©adv_Üig_node
 *
Üig_node
,

645 cÚ¡ 
‘hhdr
 *ethhdr,

646 cÚ¡ 
b©adv_ogm_·ck‘
 *batadv_ogm_packet,

647 
b©adv_h¬d_içû
 *
if_šcomšg
,

648 cÚ¡ *
‰_buff
,

649 
is_du¶iÿ‹
)

651 
b©adv_Ãigh_node
 *
Ãigh_node
 = 
NULL
, *
tmp_Ãigh_node
 = NULL;

652 
b©adv_Ãigh_node
 *
rou‹r
 = 
NULL
;

653 
b©adv_Üig_node
 *
Üig_node_tmp
;

654 
hli¡_node
 *
node
;

655 
if_num
;

656 
ušt8_t
 
sum_Üig
, 
sum_Ãigh
;

657 
ušt8_t
 *
Ãigh_addr
;

658 
ušt8_t
 
tq_avg
;

660 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

663 
	`rcu_»ad_lock
();

664 
	`hli¡_fÜ_—ch_’Œy_rcu
(
tmp_Ãigh_node
, 
node
,

665 &
Üig_node
->
Ãigh_li¡
, 
li¡
) {

666 
Ãigh_addr
 = 
tmp_Ãigh_node
->
addr
;

667 ià(
	`b©adv_com·»_‘h
(
Ãigh_addr
, 
‘hhdr
->
h_sourû
) &&

668 
tmp_Ãigh_node
->
if_šcomšg
 == if_incoming &&

669 
	`©omic_šc_nÙ_z”o
(&
tmp_Ãigh_node
->
»fcouÁ
)) {

670 ià(
Ãigh_node
)

671 
	`b©adv_Ãigh_node_ä“_»f
(
Ãigh_node
);

672 
Ãigh_node
 = 
tmp_Ãigh_node
;

676 ià(
is_du¶iÿ‹
)

679 
	`¥š_lock_bh
(&
tmp_Ãigh_node
->
lq_upd©e_lock
);

680 
	`b©adv_ršg_bufãr_£t
(
tmp_Ãigh_node
->
tq_»cv
,

681 &
tmp_Ãigh_node
->
tq_šdex
, 0);

682 
tq_avg
 = 
	`b©adv_ršg_bufãr_avg
(
tmp_Ãigh_node
->
tq_»cv
);

683 
tmp_Ãigh_node
->
tq_avg
 =q_avg;

684 
	`¥š_uÆock_bh
(&
tmp_Ãigh_node
->
lq_upd©e_lock
);

687 ià(!
Ãigh_node
) {

688 
b©adv_Üig_node
 *
Üig_tmp
;

690 
Üig_tmp
 = 
	`b©adv_g‘_Üig_node
(
b©_´iv
, 
‘hhdr
->
h_sourû
);

691 ià(!
Üig_tmp
)

692 
uÆock
;

694 
Ãigh_node
 = 
	`b©adv_iv_ogm_Ãigh_Ãw
(
if_šcomšg
,

695 
‘hhdr
->
h_sourû
,

696 
Üig_node
, 
Üig_tmp
,

697 
b©adv_ogm_·ck‘
->
£qno
);

699 
	`b©adv_Üig_node_ä“_»f
(
Üig_tmp
);

700 ià(!
Ãigh_node
)

701 
uÆock
;

703 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

706 
	`rcu_»ad_uÆock
();

708 
Üig_node
->
æags
 = 
b©adv_ogm_·ck‘
->flags;

709 
Ãigh_node
->
Ï¡_£’
 = 
jiff›s
;

711 
	`¥š_lock_bh
(&
Ãigh_node
->
lq_upd©e_lock
);

712 
	`b©adv_ršg_bufãr_£t
(
Ãigh_node
->
tq_»cv
,

713 &
Ãigh_node
->
tq_šdex
,

714 
b©adv_ogm_·ck‘
->
tq
);

715 
Ãigh_node
->
tq_avg
 = 
	`b©adv_ršg_bufãr_avg
Òeigh_node->
tq_»cv
);

716 
	`¥š_uÆock_bh
(&
Ãigh_node
->
lq_upd©e_lock
);

718 ià(!
is_du¶iÿ‹
) {

719 
Üig_node
->
Ï¡_‰l
 = 
b©adv_ogm_·ck‘
->
h—d”
.
‰l
;

720 
Ãigh_node
->
Ï¡_‰l
 = 
b©adv_ogm_·ck‘
->
h—d”
.
‰l
;

723 
	`b©adv_bÚdšg_ÿndid©e_add
(
Üig_node
, 
Ãigh_node
);

728 
rou‹r
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_node
);

729 ià(
rou‹r
 =ğ
Ãigh_node
)

730 
upd©e_‰
;

733 ià(
rou‹r
 && (rou‹r->
tq_avg
 > 
Ãigh_node
->tq_avg))

734 
upd©e_‰
;

739 ià(
rou‹r
 && (
Ãigh_node
->
tq_avg
 ==„outer->tq_avg)) {

740 
Üig_node_tmp
 = 
rou‹r
->
Üig_node
;

741 
	`¥š_lock_bh
(&
Üig_node_tmp
->
ogm_út_lock
);

742 
if_num
 = 
rou‹r
->
if_šcomšg
->if_num;

743 
sum_Üig
 = 
Üig_node_tmp
->
bÿ¡_own_sum
[
if_num
];

744 
	`¥š_uÆock_bh
(&
Üig_node_tmp
->
ogm_út_lock
);

746 
Üig_node_tmp
 = 
Ãigh_node
->
Üig_node
;

747 
	`¥š_lock_bh
(&
Üig_node_tmp
->
ogm_út_lock
);

748 
if_num
 = 
Ãigh_node
->
if_šcomšg
->if_num;

749 
sum_Ãigh
 = 
Üig_node_tmp
->
bÿ¡_own_sum
[
if_num
];

750 
	`¥š_uÆock_bh
(&
Üig_node_tmp
->
ogm_út_lock
);

752 ià(
sum_Üig
 >ğ
sum_Ãigh
)

753 
upd©e_‰
;

756 
	`b©adv_upd©e_rou‹
(
b©_´iv
, 
Üig_node
, 
Ãigh_node
);

758 
upd©e_‰
:

762 ià(((
b©adv_ogm_·ck‘
->
Üig
 !ğ
‘hhdr
->
h_sourû
) &&

763 (
b©adv_ogm_·ck‘
->
h—d”
.
‰l
 > 2)) ||

764 (
b©adv_ogm_·ck‘
->
æags
 & 
BATADV_PRIMARIES_FIRST_HOP
))

765 
	`b©adv_‰_upd©e_Üig
(
b©_´iv
, 
Üig_node
, 
‰_buff
,

766 
b©adv_ogm_·ck‘
->
‰_num_chªges
,

767 
b©adv_ogm_·ck‘
->
‰vn
,

768 
	`Áohs
(
b©adv_ogm_·ck‘
->
‰_üc
));

770 ià(
Üig_node
->
gw_æags
 !ğ
b©adv_ogm_·ck‘
->gw_flags)

771 
	`b©adv_gw_node_upd©e
(
b©_´iv
, 
Üig_node
,

772 
b©adv_ogm_·ck‘
->
gw_æags
);

774 
Üig_node
->
gw_æags
 = 
b©adv_ogm_·ck‘
->gw_flags;

777 ià((
Üig_node
->
gw_æags
) &&

778 (
	`©omic_»ad
(&
b©_´iv
->
gw_mode
è=ğ
BATADV_GW_MODE_CLIENT
) &&

779 (
	`©omic_»ad
(&
b©_´iv
->
gw_£l_şass
) > 2))

780 
	`b©adv_gw_check_–eùiÚ
(
b©_´iv
, 
Üig_node
);

782 
out
;

784 
uÆock
:

785 
	`rcu_»ad_uÆock
();

786 
out
:

787 ià(
Ãigh_node
)

788 
	`b©adv_Ãigh_node_ä“_»f
(
Ãigh_node
);

789 ià(
rou‹r
)

790 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r
);

791 
	}
}

793 
	$b©adv_iv_ogm_ÿlc_tq
(
b©adv_Üig_node
 *
Üig_node
,

794 
b©adv_Üig_node
 *
Üig_Ãigh_node
,

795 
b©adv_ogm_·ck‘
 *batadv_ogm_packet,

796 
b©adv_h¬d_içû
 *
if_šcomšg
)

798 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
if_šcomšg
->
soá_içû
);

799 
b©adv_Ãigh_node
 *
Ãigh_node
 = 
NULL
, *
tmp_Ãigh_node
;

800 
hli¡_node
 *
node
;

801 
ušt8_t
 
tÙ®_couÁ
;

802 
ušt8_t
 
Üig_eq_couÁ
, 
Ãigh_rq_couÁ
, 
Ãigh_rq_šv
, 
tq_own
;

803 
Ãigh_rq_šv_cube
, 
Ãigh_rq_max_cube
;

804 
tq_asym_³ÇÉy
, 
šv_asym_³ÇÉy
, 
»t
 = 0;

805 
combšed_tq
;

808 
	`rcu_»ad_lock
();

809 
	`hli¡_fÜ_—ch_’Œy_rcu
(
tmp_Ãigh_node
, 
node
,

810 &
Üig_Ãigh_node
->
Ãigh_li¡
, 
li¡
) {

812 ià(!
	`b©adv_com·»_‘h
(
tmp_Ãigh_node
->
addr
,

813 
Üig_Ãigh_node
->
Üig
))

816 ià(
tmp_Ãigh_node
->
if_šcomšg
 != if_incoming)

819 ià(!
	`©omic_šc_nÙ_z”o
(&
tmp_Ãigh_node
->
»fcouÁ
))

822 
Ãigh_node
 = 
tmp_Ãigh_node
;

825 
	`rcu_»ad_uÆock
();

827 ià(!
Ãigh_node
)

828 
Ãigh_node
 = 
	`b©adv_iv_ogm_Ãigh_Ãw
(
if_šcomšg
,

829 
Üig_Ãigh_node
->
Üig
,

830 
Üig_Ãigh_node
,

831 
Üig_Ãigh_node
,

832 
b©adv_ogm_·ck‘
->
£qno
);

834 ià(!
Ãigh_node
)

835 
out
;

838 ià(
Üig_node
 =ğ
Üig_Ãigh_node
)

839 
Ãigh_node
->
Ï¡_£’
 = 
jiff›s
;

841 
Üig_node
->
Ï¡_£’
 = 
jiff›s
;

844 
	`¥š_lock_bh
(&
Üig_node
->
ogm_út_lock
);

845 
Üig_eq_couÁ
 = 
Üig_Ãigh_node
->
bÿ¡_own_sum
[
if_šcomšg
->
if_num
];

846 
Ãigh_rq_couÁ
 = 
Ãigh_node
->
»®_·ck‘_couÁ
;

847 
	`¥š_uÆock_bh
(&
Üig_node
->
ogm_út_lock
);

850 ià(
Üig_eq_couÁ
 > 
Ãigh_rq_couÁ
)

851 
tÙ®_couÁ
 = 
Ãigh_rq_couÁ
;

853 
tÙ®_couÁ
 = 
Üig_eq_couÁ
;

858 ià(
tÙ®_couÁ
 < 
BATADV_TQ_LOCAL_BIDRECT_SEND_MINIMUM
 ||

859 
Ãigh_rq_couÁ
 < 
BATADV_TQ_LOCAL_BIDRECT_RECV_MINIMUM
)

860 
tq_own
 = 0;

866 
tq_own
 = (
BATADV_TQ_MAX_VALUE
 * 
tÙ®_couÁ
è/ 
Ãigh_rq_couÁ
;

873 
Ãigh_rq_šv
 = 
BATADV_TQ_LOCAL_WINDOW_SIZE
 - 
Ãigh_rq_couÁ
;

874 
Ãigh_rq_šv_cube
 = 
Ãigh_rq_šv
 *‚eigh_rq_inv *‚eigh_rq_inv;

875 
Ãigh_rq_max_cube
 = 
BATADV_TQ_LOCAL_WINDOW_SIZE
 *

876 
BATADV_TQ_LOCAL_WINDOW_SIZE
 *

877 
BATADV_TQ_LOCAL_WINDOW_SIZE
;

878 
šv_asym_³ÇÉy
 = 
BATADV_TQ_MAX_VALUE
 * 
Ãigh_rq_šv_cube
;

879 
šv_asym_³ÇÉy
 /ğ
Ãigh_rq_max_cube
;

880 
tq_asym_³ÇÉy
 = 
BATADV_TQ_MAX_VALUE
 - 
šv_asym_³ÇÉy
;

882 
combšed_tq
 = 
b©adv_ogm_·ck‘
->
tq
 * 
tq_own
 * 
tq_asym_³ÇÉy
;

883 
combšed_tq
 /ğ
BATADV_TQ_MAX_VALUE
 * BATADV_TQ_MAX_VALUE;

884 
b©adv_ogm_·ck‘
->
tq
 = 
combšed_tq
;

886 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

888 
Üig_node
->
Üig
, 
Üig_Ãigh_node
->Üig, 
tÙ®_couÁ
,

889 
Ãigh_rq_couÁ
, 
tq_own
,

890 
tq_asym_³ÇÉy
, 
b©adv_ogm_·ck‘
->
tq
);

895 ià(
b©adv_ogm_·ck‘
->
tq
 >ğ
BATADV_TQ_TOTAL_BIDRECT_LIMIT
)

896 
»t
 = 1;

898 
out
:

899 ià(
Ãigh_node
)

900 
	`b©adv_Ãigh_node_ä“_»f
(
Ãigh_node
);

901  
»t
;

902 
	}
}

913 
	$b©adv_iv_ogm_upd©e_£qnos
(cÚ¡ 
‘hhdr
 *ethhdr,

914 cÚ¡ 
b©adv_ogm_·ck‘
 *batadv_ogm_packet,

915 cÚ¡ 
b©adv_h¬d_içû
 *
if_šcomšg
)

917 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
if_šcomšg
->
soá_içû
);

918 
b©adv_Üig_node
 *
Üig_node
;

919 
b©adv_Ãigh_node
 *
tmp_Ãigh_node
;

920 
hli¡_node
 *
node
;

921 
is_du¶iÿ‹
 = 0;

922 
št32_t
 
£q_diff
;

923 
Ãed_upd©e
 = 0;

924 
£t_m¬k
, 
»t
 = -1;

925 
ušt32_t
 
£qno
 = 
	`Áohl
(
b©adv_ogm_·ck‘
->seqno);

926 
ušt8_t
 *
Ãigh_addr
;

927 
ušt8_t
 
·ck‘_couÁ
;

929 
Üig_node
 = 
	`b©adv_g‘_Üig_node
(
b©_´iv
, 
b©adv_ogm_·ck‘
->
Üig
);

930 ià(!
Üig_node
)

933 
	`¥š_lock_bh
(&
Üig_node
->
ogm_út_lock
);

934 
£q_diff
 = 
£qno
 - 
Üig_node
->
Ï¡_»®_£qno
;

937 ià(!
	`hli¡_em±y
(&
Üig_node
->
Ãigh_li¡
) &&

938 
	`b©adv_wšdow_´Ùeùed
(
b©_´iv
, 
£q_diff
,

939 &
Üig_node
->
b©mª_£qno_»£t
))

940 
out
;

942 
	`rcu_»ad_lock
();

943 
	`hli¡_fÜ_—ch_’Œy_rcu
(
tmp_Ãigh_node
, 
node
,

944 &
Üig_node
->
Ãigh_li¡
, 
li¡
) {

946 
is_du¶iÿ‹
 |ğ
	`b©adv_‹¡_b™
(
tmp_Ãigh_node
->
»®_b™s
,

947 
Üig_node
->
Ï¡_»®_£qno
,

948 
£qno
);

950 
Ãigh_addr
 = 
tmp_Ãigh_node
->
addr
;

951 ià(
	`b©adv_com·»_‘h
(
Ãigh_addr
, 
‘hhdr
->
h_sourû
) &&

952 
tmp_Ãigh_node
->
if_šcomšg
 == if_incoming)

953 
£t_m¬k
 = 1;

955 
£t_m¬k
 = 0;

958 
Ãed_upd©e
 |ğ
	`b©adv_b™_g‘_·ck‘
(
b©_´iv
,

959 
tmp_Ãigh_node
->
»®_b™s
,

960 
£q_diff
, 
£t_m¬k
);

962 
·ck‘_couÁ
 = 
	`b™m­_weight
(
tmp_Ãigh_node
->
»®_b™s
,

963 
BATADV_TQ_LOCAL_WINDOW_SIZE
);

964 
tmp_Ãigh_node
->
»®_·ck‘_couÁ
 = 
·ck‘_couÁ
;

966 
	`rcu_»ad_uÆock
();

968 ià(
Ãed_upd©e
) {

969 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

971 
Üig_node
->
Ï¡_»®_£qno
, 
£qno
);

972 
Üig_node
->
Ï¡_»®_£qno
 = 
£qno
;

975 
»t
 = 
is_du¶iÿ‹
;

977 
out
:

978 
	`¥š_uÆock_bh
(&
Üig_node
->
ogm_út_lock
);

979 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

980  
»t
;

981 
	}
}

983 
	$b©adv_iv_ogm_´oûss
(cÚ¡ 
‘hhdr
 *ethhdr,

984 
b©adv_ogm_·ck‘
 *batadv_ogm_packet,

985 cÚ¡ *
‰_buff
,

986 
b©adv_h¬d_içû
 *
if_šcomšg
)

988 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
if_šcomšg
->
soá_içû
);

989 
b©adv_h¬d_içû
 *
h¬d_içû
;

990 
b©adv_Üig_node
 *
Üig_Ãigh_node
, *
Üig_node
;

991 
b©adv_Ãigh_node
 *
rou‹r
 = 
NULL
, *
rou‹r_rou‹r
 = NULL;

992 
b©adv_Ãigh_node
 *
Üig_Ãigh_rou‹r
 = 
NULL
;

993 
has_dœeùlšk_æag
;

994 
is_my_addr
 = 0, 
is_my_Üig
 = 0, 
is_my_ŞdÜig
 = 0;

995 
is_brßdÿ¡
 = 0, 
is_bidœeù
;

996 
boŞ
 
is_sšgË_hİ_Ãigh
 = 
çl£
;

997 
boŞ
 
is_äom_be¡_Ãxt_hİ
 = 
çl£
;

998 
is_du¶iÿ‹
, 
§me£q
, 
simÏr_‰l
;

999 
ušt32_t
 
if_šcomšg_£qno
;

1000 
ušt8_t
 *
´ev_£nd”
;

1014 ià(
b©adv_ogm_·ck‘
->
h—d”
.
·ck‘_ty³
 !ğ
BATADV_IV_OGM
)

1018 
if_šcomšg_£qno
 = 
	`©omic_»ad
(&
if_šcomšg
->
£qno
);

1020 ià(
b©adv_ogm_·ck‘
->
æags
 & 
BATADV_DIRECTLINK
)

1021 
has_dœeùlšk_æag
 = 1;

1023 
has_dœeùlšk_æag
 = 0;

1025 ià(
	`b©adv_com·»_‘h
(
‘hhdr
->
h_sourû
, 
b©adv_ogm_·ck‘
->
Üig
))

1026 
is_sšgË_hİ_Ãigh
 = 
Œue
;

1028 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

1030 
‘hhdr
->
h_sourû
, 
if_šcomšg
->
Ãt_dev
->
Çme
,

1031 
if_šcomšg
->
Ãt_dev
->
dev_addr
, 
b©adv_ogm_·ck‘
->
Üig
,

1032 
b©adv_ogm_·ck‘
->
´ev_£nd”
,

1033 
	`Áohl
(
b©adv_ogm_·ck‘
->
£qno
), b©adv_ogm_·ck‘->
‰vn
,

1034 
	`Áohs
(
b©adv_ogm_·ck‘
->
‰_üc
),

1035 
b©adv_ogm_·ck‘
->
‰_num_chªges
, b©adv_ogm_·ck‘->
tq
,

1036 
b©adv_ogm_·ck‘
->
h—d”
.
‰l
,

1037 
b©adv_ogm_·ck‘
->
h—d”
.
v”siÚ
, 
has_dœeùlšk_æag
);

1039 
	`rcu_»ad_lock
();

1040 
	`li¡_fÜ_—ch_’Œy_rcu
(
h¬d_içû
, &
b©adv_h¬dif_li¡
, 
li¡
) {

1041 ià(
h¬d_içû
->
if_¡©us
 !ğ
BATADV_IF_ACTIVE
)

1044 ià(
h¬d_içû
->
soá_içû
 !ğ
if_šcomšg
->soft_iface)

1047 ià(
	`b©adv_com·»_‘h
(
‘hhdr
->
h_sourû
,

1048 
h¬d_içû
->
Ãt_dev
->
dev_addr
))

1049 
is_my_addr
 = 1;

1051 ià(
	`b©adv_com·»_‘h
(
b©adv_ogm_·ck‘
->
Üig
,

1052 
h¬d_içû
->
Ãt_dev
->
dev_addr
))

1053 
is_my_Üig
 = 1;

1055 ià(
	`b©adv_com·»_‘h
(
b©adv_ogm_·ck‘
->
´ev_£nd”
,

1056 
h¬d_içû
->
Ãt_dev
->
dev_addr
))

1057 
is_my_ŞdÜig
 = 1;

1059 ià(
	`is_brßdÿ¡_‘h”_addr
(
‘hhdr
->
h_sourû
))

1060 
is_brßdÿ¡
 = 1;

1062 
	`rcu_»ad_uÆock
();

1064 ià(
b©adv_ogm_·ck‘
->
h—d”
.
v”siÚ
 !ğ
BATADV_COMPAT_VERSION
) {

1065 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

1067 
b©adv_ogm_·ck‘
->
h—d”
.
v”siÚ
);

1071 ià(
is_my_addr
) {

1072 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

1074 
‘hhdr
->
h_sourû
);

1078 ià(
is_brßdÿ¡
) {

1079 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

1081 
‘hhdr
->
h_sourû
);

1085 ià(
is_my_Üig
) {

1086 *
wÜd
;

1087 
off£t
;

1088 
št32_t
 
b™_pos
;

1089 
št16_t
 
if_num
;

1090 
ušt8_t
 *
weight
;

1092 
Üig_Ãigh_node
 = 
	`b©adv_g‘_Üig_node
(
b©_´iv
,

1093 
‘hhdr
->
h_sourû
);

1094 ià(!
Üig_Ãigh_node
)

1101 ià(
has_dœeùlšk_æag
 &&

1102 
	`b©adv_com·»_‘h
(
if_šcomšg
->
Ãt_dev
->
dev_addr
,

1103 
b©adv_ogm_·ck‘
->
Üig
)) {

1104 
if_num
 = 
if_šcomšg
->if_num;

1105 
off£t
 = 
if_num
 * 
BATADV_NUM_WORDS
;

1107 
	`¥š_lock_bh
(&
Üig_Ãigh_node
->
ogm_út_lock
);

1108 
wÜd
 = &(
Üig_Ãigh_node
->
bÿ¡_own
[
off£t
]);

1109 
b™_pos
 = 
if_šcomšg_£qno
 - 2;

1110 
b™_pos
 -ğ
	`Áohl
(
b©adv_ogm_·ck‘
->
£qno
);

1111 
	`b©adv_£t_b™
(
wÜd
, 
b™_pos
);

1112 
weight
 = &
Üig_Ãigh_node
->
bÿ¡_own_sum
[
if_num
];

1113 *
weight
 = 
	`b™m­_weight
(
wÜd
,

1114 
BATADV_TQ_LOCAL_WINDOW_SIZE
);

1115 
	`¥š_uÆock_bh
(&
Üig_Ãigh_node
->
ogm_út_lock
);

1118 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

1120 
	`b©adv_Üig_node_ä“_»f
(
Üig_Ãigh_node
);

1124 ià(
is_my_ŞdÜig
) {

1125 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

1127 
‘hhdr
->
h_sourû
);

1131 ià(
b©adv_ogm_·ck‘
->
æags
 & 
BATADV_NOT_BEST_NEXT_HOP
) {

1132 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

1134 
‘hhdr
->
h_sourû
);

1138 
Üig_node
 = 
	`b©adv_g‘_Üig_node
(
b©_´iv
, 
b©adv_ogm_·ck‘
->
Üig
);

1139 ià(!
Üig_node
)

1142 
is_du¶iÿ‹
 = 
	`b©adv_iv_ogm_upd©e_£qnos
(
‘hhdr
, 
b©adv_ogm_·ck‘
,

1143 
if_šcomšg
);

1145 ià(
is_du¶iÿ‹
 == -1) {

1146 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

1148 
‘hhdr
->
h_sourû
);

1149 
out
;

1152 ià(
b©adv_ogm_·ck‘
->
tq
 == 0) {

1153 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

1155 
out
;

1158 
rou‹r
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_node
);

1159 ià(
rou‹r
)

1160 
rou‹r_rou‹r
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
rou‹r
->
Üig_node
);

1162 ià((
rou‹r
 &&„ou‹r->
tq_avg
 != 0) &&

1163 (
	`b©adv_com·»_‘h
(
rou‹r
->
addr
, 
‘hhdr
->
h_sourû
)))

1164 
is_äom_be¡_Ãxt_hİ
 = 
Œue
;

1166 
´ev_£nd”
 = 
b©adv_ogm_·ck‘
->prev_sender;

1168 ià(
rou‹r
 && 
rou‹r_rou‹r
 &&

1169 (
	`b©adv_com·»_‘h
(
rou‹r
->
addr
, 
´ev_£nd”
)) &&

1170 !(
	`b©adv_com·»_‘h
(
b©adv_ogm_·ck‘
->
Üig
, 
´ev_£nd”
)) &&

1171 (
	`b©adv_com·»_‘h
(
rou‹r
->
addr
, 
rou‹r_rou‹r
->addr))) {

1172 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

1174 
‘hhdr
->
h_sourû
);

1175 
out
;

1181 ià(
is_sšgË_hİ_Ãigh
)

1182 
Üig_Ãigh_node
 = 
Üig_node
;

1184 
Üig_Ãigh_node
 = 
	`b©adv_g‘_Üig_node
(
b©_´iv
,

1185 
‘hhdr
->
h_sourû
);

1187 ià(!
Üig_Ãigh_node
)

1188 
out
;

1190 
Üig_Ãigh_rou‹r
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_Ãigh_node
);

1195 ià(!
is_sšgË_hİ_Ãigh
 && (!
Üig_Ãigh_rou‹r
)) {

1196 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

1198 
out_Ãigh
;

1201 
is_bidœeù
 = 
	`b©adv_iv_ogm_ÿlc_tq
(
Üig_node
, 
Üig_Ãigh_node
,

1202 
b©adv_ogm_·ck‘
, 
if_šcomšg
);

1204 
	`b©adv_bÚdšg_§ve_´im¬y
(
Üig_node
, 
Üig_Ãigh_node
,

1205 
b©adv_ogm_·ck‘
);

1210 
§me£q
 = 
Üig_node
->
Ï¡_»®_£qno
 =ğ
	`Áohl
(
b©adv_ogm_·ck‘
->
£qno
);

1211 
simÏr_‰l
 = 
Üig_node
->
Ï¡_‰l
 - 3 <ğ
b©adv_ogm_·ck‘
->
h—d”
.
‰l
;

1212 ià(
is_bidœeù
 && (!
is_du¶iÿ‹
 || (
§me£q
 && 
simÏr_‰l
)))

1213 
	`b©adv_iv_ogm_Üig_upd©e
(
b©_´iv
, 
Üig_node
, 
‘hhdr
,

1214 
b©adv_ogm_·ck‘
, 
if_šcomšg
,

1215 
‰_buff
, 
is_du¶iÿ‹
);

1218 ià(
is_sšgË_hİ_Ãigh
) {

1221 
	`b©adv_iv_ogm_fÜw¬d
(
Üig_node
, 
‘hhdr
, 
b©adv_ogm_·ck‘
,

1222 
is_sšgË_hİ_Ãigh
,

1223 
is_äom_be¡_Ãxt_hİ
, 
if_šcomšg
);

1225 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

1227 
out_Ãigh
;

1231 ià(!
is_bidœeù
) {

1232 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

1234 
out_Ãigh
;

1237 ià(
is_du¶iÿ‹
) {

1238 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

1240 
out_Ãigh
;

1243 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

1245 
	`b©adv_iv_ogm_fÜw¬d
(
Üig_node
, 
‘hhdr
, 
b©adv_ogm_·ck‘
,

1246 
is_sšgË_hİ_Ãigh
, 
is_äom_be¡_Ãxt_hİ
,

1247 
if_šcomšg
);

1249 
out_Ãigh
:

1250 ià((
Üig_Ãigh_node
è&& (!
is_sšgË_hİ_Ãigh
))

1251 
	`b©adv_Üig_node_ä“_»f
(
Üig_Ãigh_node
);

1252 
out
:

1253 ià(
rou‹r
)

1254 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r
);

1255 ià(
rou‹r_rou‹r
)

1256 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r_rou‹r
);

1257 ià(
Üig_Ãigh_rou‹r
)

1258 
	`b©adv_Ãigh_node_ä“_»f
(
Üig_Ãigh_rou‹r
);

1260 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

1261 
	}
}

1263 
	$b©adv_iv_ogm_»ûive
(
sk_buff
 *
skb
,

1264 
b©adv_h¬d_içû
 *
if_šcomšg
)

1266 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
if_šcomšg
->
soá_içû
);

1267 
b©adv_ogm_·ck‘
 *batadv_ogm_packet;

1268 
‘hhdr
 *ethhdr;

1269 
buff_pos
 = 0, 
·ck‘_Ën
;

1270 *
‰_buff
, *
·ck‘_buff
;

1271 
boŞ
 
»t
;

1272 
ušt8_t
 *
·ck‘_pos
;

1274 
»t
 = 
	`b©adv_check_mªagem’t_·ck‘
(
skb
, 
if_šcomšg
, 
BATADV_OGM_HLEN
);

1275 ià(!
»t
)

1276  
NET_RX_DROP
;

1281 ià(
b©_´iv
->
b©_®go_İs
->
b©_ogm_em™
 !ğ
b©adv_iv_ogm_em™
)

1282  
NET_RX_DROP
;

1284 
	`b©adv_šc_couÁ”
(
b©_´iv
, 
BATADV_CNT_MGMT_RX
);

1285 
	`b©adv_add_couÁ”
(
b©_´iv
, 
BATADV_CNT_MGMT_RX_BYTES
,

1286 
skb
->
Ën
 + 
ETH_HLEN
);

1288 
·ck‘_Ën
 = 
	`skb_h—dËn
(
skb
);

1289 
‘hhdr
 = (‘hhd¸*)
	`skb_mac_h—d”
(
skb
);

1290 
·ck‘_buff
 = 
skb
->
d©a
;

1291 
b©adv_ogm_·ck‘
 = (b©adv_ogm_·ck‘ *)
·ck‘_buff
;

1295 
‰_buff
 = 
·ck‘_buff
 + 
buff_pos
 + 
BATADV_OGM_HLEN
;

1297 
	`b©adv_iv_ogm_´oûss
(
‘hhdr
, 
b©adv_ogm_·ck‘
, 
‰_buff
,

1298 
if_šcomšg
);

1300 
buff_pos
 +ğ
BATADV_OGM_HLEN
;

1301 
buff_pos
 +ğ
	`b©adv_‰_Ën
(
b©adv_ogm_·ck‘
->
‰_num_chªges
);

1303 
·ck‘_pos
 = 
·ck‘_buff
 + 
buff_pos
;

1304 
b©adv_ogm_·ck‘
 = (b©adv_ogm_·ck‘ *)
·ck‘_pos
;

1305 } 
	`b©adv_iv_ogm_aggr_·ck‘
(
buff_pos
, 
·ck‘_Ën
,

1306 
b©adv_ogm_·ck‘
->
‰_num_chªges
));

1308 
	`kä“_skb
(
skb
);

1309  
NET_RX_SUCCESS
;

1310 
	}
}

1312 
b©adv_®go_İs
 
b©adv_b©mª_iv
 
	g__»ad_mo¡ly
 = {

1313 .
Çme
 = "BATMAN_IV",

1314 .
	gb©_içû_’abË
 = 
b©adv_iv_ogm_içû_’abË
,

1315 .
	gb©_içû_di§bË
 = 
b©adv_iv_ogm_içû_di§bË
,

1316 .
	gb©_içû_upd©e_mac
 = 
b©adv_iv_ogm_içû_upd©e_mac
,

1317 .
	gb©_´im¬y_içû_£t
 = 
b©adv_iv_ogm_´im¬y_içû_£t
,

1318 .
	gb©_ogm_scheduË
 = 
b©adv_iv_ogm_scheduË
,

1319 .
	gb©_ogm_em™
 = 
b©adv_iv_ogm_em™
,

1322 
__š™
 
	$b©adv_iv_š™
()

1324 
»t
;

1327 
»t
 = 
	`b©adv_»cv_hªdËr_»gi¡”
(
BATADV_IV_OGM
,

1328 
b©adv_iv_ogm_»ûive
);

1329 ià(
»t
 < 0)

1330 
out
;

1332 
»t
 = 
	`b©adv_®go_»gi¡”
(&
b©adv_b©mª_iv
);

1333 ià(
»t
 < 0)

1334 
hªdËr_uÄegi¡”
;

1336 
out
;

1338 
hªdËr_uÄegi¡”
:

1339 
	`b©adv_»cv_hªdËr_uÄegi¡”
(
BATADV_IV_OGM
);

1340 
out
:

1341  
»t
;

1342 
	}
}

	@batman-adv.mod.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/v”magic.h
>

3 
	~<lšux/comp”.h
>

5 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

7 
moduË
 
__this_moduË


8 
__©Œibu‹__
((
£ùiÚ
(".gnu.linkonce.this_module"))) = {

9 .
Çme
 = 
KBUILD_MODNAME
,

10 .
	gš™
 = 
š™_moduË
,

11 #ifdeà
CONFIG_MODULE_UNLOAD


12 .
	gex™
 = 
ş—nup_moduË
,

14 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

17 cÚ¡ 
modv”siÚ_šfo
 
	g____v”siÚs
[]

18 
__u£d


19 
__©Œibu‹__
((
£ùiÚ
("__versions"))) = {

134 cÚ¡ 
	g__moduË_d•’ds
[]

135 
__u£d


136 
__©Œibu‹__
((
£ùiÚ
(".modinfo"))) =

140 
MODULE_INFO
(
¤cv”siÚ
, "29D17D295B91C9D40E44C30");

	@bitarray.c

20 
	~"maš.h
"

21 
	~"b™¬¿y.h
"

23 
	~<lšux/b™İs.h
>

26 
	$b©adv_b™m­_shiá_Ëá
(*
£q_b™s
, 
št32_t
 
n
)

28 ià(
n
 <ğ0 ||‚ >ğ
BATADV_TQ_LOCAL_WINDOW_SIZE
)

31 
	`b™m­_shiá_Ëá
(
£q_b™s
, seq_b™s, 
n
, 
BATADV_TQ_LOCAL_WINDOW_SIZE
);

32 
	}
}

41 
	$b©adv_b™_g‘_·ck‘
(*
´iv
, *
£q_b™s
,

42 
št32_t
 
£q_num_diff
, 
£t_m¬k
)

44 
b©adv_´iv
 *
b©_´iv
 = 
´iv
;

49 ià(
£q_num_diff
 <ğ0 && seq_num_difà> -
BATADV_TQ_LOCAL_WINDOW_SIZE
) {

50 ià(
£t_m¬k
)

51 
	`b©adv_£t_b™
(
£q_b™s
, -
£q_num_diff
);

58 ià(
£q_num_diff
 > 0 && seq_num_difà< 
BATADV_TQ_LOCAL_WINDOW_SIZE
) {

59 
	`b©adv_b™m­_shiá_Ëá
(
£q_b™s
, 
£q_num_diff
);

61 ià(
£t_m¬k
)

62 
	`b©adv_£t_b™
(
£q_b™s
, 0);

67 ià(
£q_num_diff
 >ğ
BATADV_TQ_LOCAL_WINDOW_SIZE
 &&

68 
£q_num_diff
 < 
BATADV_EXPECTED_SEQNO_RANGE
) {

69 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

71 
£q_num_diff
 - 1);

72 
	`b™m­_z”o
(
£q_b™s
, 
BATADV_TQ_LOCAL_WINDOW_SIZE
);

73 ià(
£t_m¬k
)

74 
	`b©adv_£t_b™
(
£q_b™s
, 0);

83 ià(
£q_num_diff
 <ğ-
BATADV_TQ_LOCAL_WINDOW_SIZE
 ||

84 
£q_num_diff
 >ğ
BATADV_EXPECTED_SEQNO_RANGE
) {

86 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

89 
	`b™m­_z”o
(
£q_b™s
, 
BATADV_TQ_LOCAL_WINDOW_SIZE
);

90 ià(
£t_m¬k
)

91 
	`b©adv_£t_b™
(
£q_b™s
, 0);

98 
	}
}

	@bitarray.h

20 #iâdeà
_NET_BATMAN_ADV_BITARRAY_H_


21 
	#_NET_BATMAN_ADV_BITARRAY_H_


	)

26 
šlše
 
	$b©adv_‹¡_b™
(cÚ¡ *
£q_b™s
,

27 
ušt32_t
 
Ï¡_£qno
, ušt32_ˆ
cu¼_£qno
)

29 
št32_t
 
diff
;

31 
diff
 = 
Ï¡_£qno
 - 
cu¼_£qno
;

32 ià(
diff
 < 0 || difà>ğ
BATADV_TQ_LOCAL_WINDOW_SIZE
)

35  
	`‹¡_b™
(
diff
, 
£q_b™s
) != 0;

36 
	}
}

39 
šlše
 
	$b©adv_£t_b™
(*
£q_b™s
, 
št32_t
 
n
)

42 ià(
n
 < 0 ||‚ >ğ
BATADV_TQ_LOCAL_WINDOW_SIZE
)

45 
	`£t_b™
(
n
, 
£q_b™s
);

46 
	}
}

51 
b©adv_b™_g‘_·ck‘
(*
´iv
, *
£q_b™s
,

52 
št32_t
 
£q_num_diff
, 
£t_m¬k
);

	@bridge_loop_avoidance.c

20 
	~"maš.h
"

21 
	~"hash.h
"

22 
	~"h¬d-š‹rçû.h
"

23 
	~"Üigš©Ü.h
"

24 
	~"bridge_loİ_avoidªû.h
"

25 
	~"Œª¦©iÚ-bË.h
"

26 
	~"£nd.h
"

28 
	~<lšux/‘h”deviû.h
>

29 
	~<lšux/üc16.h
>

30 
	~<lšux/if_¬p.h
>

31 
	~<Ãt/¬p.h
>

32 
	~<lšux/if_vÏn.h
>

34 cÚ¡ 
ušt8_t
 
	gb©adv_ªnounû_mac
[4] = {0x43, 0x05, 0x43, 0x05};

36 
b©adv_bÏ_³riodic_wÜk
(
wÜk_¡ruù
 *
wÜk
);

37 
b©adv_bÏ_£nd_ªnounû
(
b©adv_´iv
 *
b©_´iv
,

38 
b©adv_backbÚe_gw
 *
backbÚe_gw
);

41 
šlše
 
ušt32_t
 
	$b©adv_choo£_şaim
(cÚ¡ *
d©a
, 
ušt32_t
 
size
)

43 cÚ¡ *
key
 = 
d©a
;

44 
ušt32_t
 
hash
 = 0;

45 
size_t
 
i
;

47 
i
 = 0; i < 
ETH_ALEN
 + (); i++) {

48 
hash
 +ğ
key
[
i
];

49 
hash
 += (hash << 10);

50 
hash
 ^= (hash >> 6);

53 
hash
 += (hash << 3);

54 
hash
 ^= (hash >> 11);

55 
hash
 += (hash << 15);

57  
hash
 % 
size
;

58 
	}
}

61 
šlše
 
ušt32_t
 
	$b©adv_choo£_backbÚe_gw
(cÚ¡ *
d©a
,

62 
ušt32_t
 
size
)

64 cÚ¡ *
key
 = 
d©a
;

65 
ušt32_t
 
hash
 = 0;

66 
size_t
 
i
;

68 
i
 = 0; i < 
ETH_ALEN
 + (); i++) {

69 
hash
 +ğ
key
[
i
];

70 
hash
 += (hash << 10);

71 
hash
 ^= (hash >> 6);

74 
hash
 += (hash << 3);

75 
hash
 ^= (hash >> 11);

76 
hash
 += (hash << 15);

78  
hash
 % 
size
;

79 
	}
}

83 
	$b©adv_com·»_backbÚe_gw
(cÚ¡ 
hli¡_node
 *
node
,

84 cÚ¡ *
d©a2
)

86 cÚ¡ *
d©a1
 = 
	`cÚš”_of
(
node
, 
b©adv_backbÚe_gw
,

87 
hash_’Œy
);

89  (
	`memcmp
(
d©a1
, 
d©a2
, 
ETH_ALEN
 + ()) == 0 ? 1 : 0);

90 
	}
}

93 
	$b©adv_com·»_şaim
(cÚ¡ 
hli¡_node
 *
node
,

94 cÚ¡ *
d©a2
)

96 cÚ¡ *
d©a1
 = 
	`cÚš”_of
(
node
, 
b©adv_şaim
,

97 
hash_’Œy
);

99  (
	`memcmp
(
d©a1
, 
d©a2
, 
ETH_ALEN
 + ()) == 0 ? 1 : 0);

100 
	}
}

103 
	$b©adv_backbÚe_gw_ä“_»f
(
b©adv_backbÚe_gw
 *
backbÚe_gw
)

105 ià(
	`©omic_dec_ªd_‹¡
(&
backbÚe_gw
->
»fcouÁ
))

106 
	`kä“_rcu
(
backbÚe_gw
, 
rcu
);

107 
	}
}

110 
	$b©adv_şaim_ä“_rcu
(
rcu_h—d
 *
rcu
)

112 
b©adv_şaim
 *
şaim
;

114 
şaim
 = 
	`cÚš”_of
(
rcu
, 
b©adv_şaim
,„cu);

116 
	`b©adv_backbÚe_gw_ä“_»f
(
şaim
->
backbÚe_gw
);

117 
	`kä“
(
şaim
);

118 
	}
}

121 
	$b©adv_şaim_ä“_»f
(
b©adv_şaim
 *
şaim
)

123 ià(
	`©omic_dec_ªd_‹¡
(&
şaim
->
»fcouÁ
))

124 
	`ÿÎ_rcu
(&
şaim
->
rcu
, 
b©adv_şaim_ä“_rcu
);

125 
	}
}

133 
b©adv_şaim
 *
	$b©adv_şaim_hash_fšd
(
b©adv_´iv
 *
b©_´iv
,

134 
b©adv_şaim
 *
d©a
)

136 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
bÏ
.
şaim_hash
;

137 
hli¡_h—d
 *
h—d
;

138 
hli¡_node
 *
node
;

139 
b©adv_şaim
 *
şaim
;

140 
b©adv_şaim
 *
şaim_tmp
 = 
NULL
;

141 
šdex
;

143 ià(!
hash
)

144  
NULL
;

146 
šdex
 = 
	`b©adv_choo£_şaim
(
d©a
, 
hash
->
size
);

147 
h—d
 = &
hash
->
bË
[
šdex
];

149 
	`rcu_»ad_lock
();

150 
	`hli¡_fÜ_—ch_’Œy_rcu
(
şaim
, 
node
, 
h—d
, 
hash_’Œy
) {

151 ià(!
	`b©adv_com·»_şaim
(&
şaim
->
hash_’Œy
, 
d©a
))

154 ià(!
	`©omic_šc_nÙ_z”o
(&
şaim
->
»fcouÁ
))

157 
şaim_tmp
 = 
şaim
;

160 
	`rcu_»ad_uÆock
();

162  
şaim_tmp
;

163 
	}
}

173 
b©adv_backbÚe_gw
 *

174 
	$b©adv_backbÚe_hash_fšd
(
b©adv_´iv
 *
b©_´iv
,

175 
ušt8_t
 *
addr
, 
vid
)

177 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
bÏ
.
backbÚe_hash
;

178 
hli¡_h—d
 *
h—d
;

179 
hli¡_node
 *
node
;

180 
b©adv_backbÚe_gw
 
£¬ch_’Œy
, *
backbÚe_gw
;

181 
b©adv_backbÚe_gw
 *
backbÚe_gw_tmp
 = 
NULL
;

182 
šdex
;

184 ià(!
hash
)

185  
NULL
;

187 
	`memıy
(
£¬ch_’Œy
.
Üig
, 
addr
, 
ETH_ALEN
);

188 
£¬ch_’Œy
.
vid
 = vid;

190 
šdex
 = 
	`b©adv_choo£_backbÚe_gw
(&
£¬ch_’Œy
, 
hash
->
size
);

191 
h—d
 = &
hash
->
bË
[
šdex
];

193 
	`rcu_»ad_lock
();

194 
	`hli¡_fÜ_—ch_’Œy_rcu
(
backbÚe_gw
, 
node
, 
h—d
, 
hash_’Œy
) {

195 ià(!
	`b©adv_com·»_backbÚe_gw
(&
backbÚe_gw
->
hash_’Œy
,

196 &
£¬ch_’Œy
))

199 ià(!
	`©omic_šc_nÙ_z”o
(&
backbÚe_gw
->
»fcouÁ
))

202 
backbÚe_gw_tmp
 = 
backbÚe_gw
;

205 
	`rcu_»ad_uÆock
();

207  
backbÚe_gw_tmp
;

208 
	}
}

212 
	$b©adv_bÏ_d–_backbÚe_şaims
(
b©adv_backbÚe_gw
 *
backbÚe_gw
)

214 
b©adv_hashbË
 *
hash
;

215 
hli¡_node
 *
node
, *
node_tmp
;

216 
hli¡_h—d
 *
h—d
;

217 
b©adv_şaim
 *
şaim
;

218 
i
;

219 
¥šlock_t
 *
li¡_lock
;

221 
hash
 = 
backbÚe_gw
->
b©_´iv
->
bÏ
.
şaim_hash
;

222 ià(!
hash
)

225 
i
 = 0; i < 
hash
->
size
; i++) {

226 
h—d
 = &
hash
->
bË
[
i
];

227 
li¡_lock
 = &
hash
->
li¡_locks
[
i
];

229 
	`¥š_lock_bh
(
li¡_lock
);

230 
	`hli¡_fÜ_—ch_’Œy_§ã
(
şaim
, 
node
, 
node_tmp
,

231 
h—d
, 
hash_’Œy
) {

233 ià(
şaim
->
backbÚe_gw
 != backbone_gw)

236 
	`b©adv_şaim_ä“_»f
(
şaim
);

237 
	`hli¡_d–_rcu
(
node
);

239 
	`¥š_uÆock_bh
(
li¡_lock
);

243 
backbÚe_gw
->
üc
 = 
BATADV_BLA_CRC_INIT
;

244 
	}
}

253 
	$b©adv_bÏ_£nd_şaim
(
b©adv_´iv
 *
b©_´iv
, 
ušt8_t
 *
mac
,

254 
vid
, 
şaimty³
)

256 
sk_buff
 *
skb
;

257 
‘hhdr
 *ethhdr;

258 
b©adv_h¬d_içû
 *
´im¬y_if
;

259 
Ãt_deviû
 *
soá_içû
;

260 
ušt8_t
 *
hw_¤c
;

261 
b©adv_bÏ_şaim_d¡
 
loÿl_şaim_de¡
;

262 
__be32
 
z”o
 = 0;

264 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

265 ià(!
´im¬y_if
)

268 
	`memıy
(&
loÿl_şaim_de¡
, &
b©_´iv
->
bÏ
.
şaim_de¡
,

269 (
loÿl_şaim_de¡
));

270 
loÿl_şaim_de¡
.
ty³
 = 
şaimty³
;

272 
soá_içû
 = 
´im¬y_if
->soft_iface;

274 
skb
 = 
	`¬p_ü—‹
(
ARPOP_REPLY
, 
ETH_P_ARP
,

276 
z”o
,

277 
´im¬y_if
->
soá_içû
,

279 
z”o
,

281 
NULL
,

283 
´im¬y_if
->
Ãt_dev
->
dev_addr
,

288 (
ušt8_t
 *)&
loÿl_şaim_de¡
);

290 ià(!
skb
)

291 
out
;

293 
‘hhdr
 = (‘hhd¸*)
skb
->
d©a
;

294 
hw_¤c
 = (
ušt8_t
 *)
‘hhdr
 + 
ETH_HLEN
 + (
¬phdr
);

297 
şaimty³
) {

298 
BATADV_CLAIM_TYPE_CLAIM
:

302 
	`memıy
(
‘hhdr
->
h_sourû
, 
mac
, 
ETH_ALEN
);

303 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
b©_´iv
,

304 "bÏ_£nd_şaim(): CLAIM %pM oÀvid %d\n", 
mac
, 
vid
);

306 
BATADV_CLAIM_TYPE_UNCLAIM
:

310 
	`memıy
(
hw_¤c
, 
mac
, 
ETH_ALEN
);

311 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
b©_´iv
,

312 "bÏ_£nd_şaim(): UNCLAIM %pM oÀvid %d\n", 
mac
,

313 
vid
);

315 
BATADV_CLAIM_TYPE_ANNOUNCE
:

319 
	`memıy
(
hw_¤c
, 
mac
, 
ETH_ALEN
);

320 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
b©_´iv
,

322 
‘hhdr
->
h_sourû
, 
vid
);

324 
BATADV_CLAIM_TYPE_REQUEST
:

329 
	`memıy
(
hw_¤c
, 
mac
, 
ETH_ALEN
);

330 
	`memıy
(
‘hhdr
->
h_de¡
, 
mac
, 
ETH_ALEN
);

331 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
b©_´iv
,

333 
‘hhdr
->
h_sourû
,ƒthhdr->
h_de¡
, 
vid
);

338 ià(
vid
 != -1)

339 
skb
 = 
	`vÏn_š£¹_g
(skb, 
vid
);

341 
	`skb_»£t_mac_h—d”
(
skb
);

342 
skb
->
´ÙocŞ
 = 
	`‘h_ty³_Œªs
(skb, 
soá_içû
);

343 
	`b©adv_šc_couÁ”
(
b©_´iv
, 
BATADV_CNT_RX
);

344 
	`b©adv_add_couÁ”
(
b©_´iv
, 
BATADV_CNT_RX_BYTES
,

345 
skb
->
Ën
 + 
ETH_HLEN
);

346 
soá_içû
->
Ï¡_rx
 = 
jiff›s
;

348 
	`Ãtif_rx
(
skb
);

349 
out
:

350 ià(
´im¬y_if
)

351 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

352 
	}
}

363 
b©adv_backbÚe_gw
 *

364 
	$b©adv_bÏ_g‘_backbÚe_gw
(
b©adv_´iv
 *
b©_´iv
, 
ušt8_t
 *
Üig
,

365 
vid
)

367 
b©adv_backbÚe_gw
 *
’Œy
;

368 
b©adv_Üig_node
 *
Üig_node
;

369 
hash_added
;

371 
’Œy
 = 
	`b©adv_backbÚe_hash_fšd
(
b©_´iv
, 
Üig
, 
vid
);

373 ià(
’Œy
)

374  
’Œy
;

376 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
b©_´iv
,

378 
Üig
, 
vid
);

380 
’Œy
 = 
	`kz®loc
((*’Œy), 
GFP_ATOMIC
);

381 ià(!
’Œy
)

382  
NULL
;

384 
’Œy
->
vid
 = vid;

385 
’Œy
->
Ï¡time
 = 
jiff›s
;

386 
’Œy
->
üc
 = 
BATADV_BLA_CRC_INIT
;

387 
’Œy
->
b©_´iv
 = bat_priv;

388 
	`©omic_£t
(&
’Œy
->
»que¡_£Á
, 0);

389 
	`memıy
(
’Œy
->
Üig
, orig, 
ETH_ALEN
);

392 
	`©omic_£t
(&
’Œy
->
»fcouÁ
, 2);

394 
hash_added
 = 
	`b©adv_hash_add
(
b©_´iv
->
bÏ
.
backbÚe_hash
,

395 
b©adv_com·»_backbÚe_gw
,

396 
b©adv_choo£_backbÚe_gw
, 
’Œy
,

397 &
’Œy
->
hash_’Œy
);

399 ià(
	`uÆik–y
(
hash_added
 != 0)) {

401 
	`kä“
(
’Œy
);

402  
NULL
;

406 
Üig_node
 = 
	`b©adv_Üig_hash_fšd
(
b©_´iv
, 
Üig
);

407 ià(
Üig_node
) {

408 
	`b©adv_‰_glob®_d–_Üig
(
b©_´iv
, 
Üig_node
,

410 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

412  
’Œy
;

413 
	}
}

419 
	$b©adv_bÏ_upd©e_own_backbÚe_gw
(
b©adv_´iv
 *
b©_´iv
,

420 
b©adv_h¬d_içû
 *
´im¬y_if
,

421 
vid
)

423 
b©adv_backbÚe_gw
 *
backbÚe_gw
;

425 
backbÚe_gw
 = 
	`b©adv_bÏ_g‘_backbÚe_gw
(
b©_´iv
,

426 
´im¬y_if
->
Ãt_dev
->
dev_addr
,

427 
vid
);

428 ià(
	`uÆik–y
(!
backbÚe_gw
))

431 
backbÚe_gw
->
Ï¡time
 = 
jiff›s
;

432 
	`b©adv_backbÚe_gw_ä“_»f
(
backbÚe_gw
);

433 
	}
}

441 
	$b©adv_bÏ_ªsw”_»que¡
(
b©adv_´iv
 *
b©_´iv
,

442 
b©adv_h¬d_içû
 *
´im¬y_if
,

443 
vid
)

445 
hli¡_node
 *
node
;

446 
hli¡_h—d
 *
h—d
;

447 
b©adv_hashbË
 *
hash
;

448 
b©adv_şaim
 *
şaim
;

449 
b©adv_backbÚe_gw
 *
backbÚe_gw
;

450 
i
;

452 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
b©_´iv
,

455 
backbÚe_gw
 = 
	`b©adv_backbÚe_hash_fšd
(
b©_´iv
,

456 
´im¬y_if
->
Ãt_dev
->
dev_addr
,

457 
vid
);

458 ià(!
backbÚe_gw
)

461 
hash
 = 
b©_´iv
->
bÏ
.
şaim_hash
;

462 
i
 = 0; i < 
hash
->
size
; i++) {

463 
h—d
 = &
hash
->
bË
[
i
];

465 
	`rcu_»ad_lock
();

466 
	`hli¡_fÜ_—ch_’Œy_rcu
(
şaim
, 
node
, 
h—d
, 
hash_’Œy
) {

468 ià(
şaim
->
backbÚe_gw
 != backbone_gw)

471 
	`b©adv_bÏ_£nd_şaim
(
b©_´iv
, 
şaim
->
addr
, cÏim->
vid
,

472 
BATADV_CLAIM_TYPE_CLAIM
);

474 
	`rcu_»ad_uÆock
();

478 
	`b©adv_bÏ_£nd_ªnounû
(
b©_´iv
, 
backbÚe_gw
);

479 
	`b©adv_backbÚe_gw_ä“_»f
(
backbÚe_gw
);

480 
	}
}

488 
	$b©adv_bÏ_£nd_»que¡
(
b©adv_backbÚe_gw
 *
backbÚe_gw
)

491 
	`b©adv_bÏ_d–_backbÚe_şaims
(
backbÚe_gw
);

493 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
backbÚe_gw
->
b©_´iv
,

494 "S’dšg REQUESTØ%pM\n", 
backbÚe_gw
->
Üig
);

497 
	`b©adv_bÏ_£nd_şaim
(
backbÚe_gw
->
b©_´iv
, backbÚe_gw->
Üig
,

498 
backbÚe_gw
->
vid
, 
BATADV_CLAIM_TYPE_REQUEST
);

501 ià(!
	`©omic_»ad
(&
backbÚe_gw
->
»que¡_£Á
)) {

502 
	`©omic_šc
(&
backbÚe_gw
->
b©_´iv
->
bÏ
.
num_»que¡s
);

503 
	`©omic_£t
(&
backbÚe_gw
->
»que¡_£Á
, 1);

505 
	}
}

513 
	$b©adv_bÏ_£nd_ªnounû
(
b©adv_´iv
 *
b©_´iv
,

514 
b©adv_backbÚe_gw
 *
backbÚe_gw
)

516 
ušt8_t
 
mac
[
ETH_ALEN
];

517 
__be16
 
üc
;

519 
	`memıy
(
mac
, 
b©adv_ªnounû_mac
, 4);

520 
üc
 = 
	`htÚs
(
backbÚe_gw
->crc);

521 
	`memıy
(&
mac
[4], &
üc
, 2);

523 
	`b©adv_bÏ_£nd_şaim
(
b©_´iv
, 
mac
, 
backbÚe_gw
->
vid
,

524 
BATADV_CLAIM_TYPE_ANNOUNCE
);

526 
	}
}

535 
	$b©adv_bÏ_add_şaim
(
b©adv_´iv
 *
b©_´iv
,

536 cÚ¡ 
ušt8_t
 *
mac
, cÚ¡ 
vid
,

537 
b©adv_backbÚe_gw
 *
backbÚe_gw
)

539 
b©adv_şaim
 *
şaim
;

540 
b©adv_şaim
 
£¬ch_şaim
;

541 
hash_added
;

543 
	`memıy
(
£¬ch_şaim
.
addr
, 
mac
, 
ETH_ALEN
);

544 
£¬ch_şaim
.
vid
 = vid;

545 
şaim
 = 
	`b©adv_şaim_hash_fšd
(
b©_´iv
, &
£¬ch_şaim
);

548 ià(!
şaim
) {

549 
şaim
 = 
	`kz®loc
((*şaim), 
GFP_ATOMIC
);

550 ià(!
şaim
)

553 
	`memıy
(
şaim
->
addr
, 
mac
, 
ETH_ALEN
);

554 
şaim
->
vid
 = vid;

555 
şaim
->
Ï¡time
 = 
jiff›s
;

556 
şaim
->
backbÚe_gw
 = backbone_gw;

558 
	`©omic_£t
(&
şaim
->
»fcouÁ
, 2);

559 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
b©_´iv
,

561 
mac
, 
vid
);

562 
hash_added
 = 
	`b©adv_hash_add
(
b©_´iv
->
bÏ
.
şaim_hash
,

563 
b©adv_com·»_şaim
,

564 
b©adv_choo£_şaim
, 
şaim
,

565 &
şaim
->
hash_’Œy
);

567 ià(
	`uÆik–y
(
hash_added
 != 0)) {

569 
	`kä“
(
şaim
);

573 
şaim
->
Ï¡time
 = 
jiff›s
;

574 ià(
şaim
->
backbÚe_gw
 == backbone_gw)

576 
şaim_ä“_»f
;

578 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
b©_´iv
,

580 
mac
, 
vid
);

582 
şaim
->
backbÚe_gw
->
üc
 ^ğ
	`üc16
(0, cÏim->
addr
, 
ETH_ALEN
);

583 
	`b©adv_backbÚe_gw_ä“_»f
(
şaim
->
backbÚe_gw
);

587 
	`©omic_šc
(&
backbÚe_gw
->
»fcouÁ
);

588 
şaim
->
backbÚe_gw
 = backbone_gw;

590 
backbÚe_gw
->
üc
 ^ğ
	`üc16
(0, 
şaim
->
addr
, 
ETH_ALEN
);

591 
backbÚe_gw
->
Ï¡time
 = 
jiff›s
;

593 
şaim_ä“_»f
:

594 
	`b©adv_şaim_ä“_»f
(
şaim
);

595 
	}
}

600 
	$b©adv_bÏ_d–_şaim
(
b©adv_´iv
 *
b©_´iv
,

601 cÚ¡ 
ušt8_t
 *
mac
, cÚ¡ 
vid
)

603 
b©adv_şaim
 
£¬ch_şaim
, *
şaim
;

605 
	`memıy
(
£¬ch_şaim
.
addr
, 
mac
, 
ETH_ALEN
);

606 
£¬ch_şaim
.
vid
 = vid;

607 
şaim
 = 
	`b©adv_şaim_hash_fšd
(
b©_´iv
, &
£¬ch_şaim
);

608 ià(!
şaim
)

611 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
b©_´iv
, "bla_del_claim(): %pM, vid %d\n",

612 
mac
, 
vid
);

614 
	`b©adv_hash_»move
(
b©_´iv
->
bÏ
.
şaim_hash
, 
b©adv_com·»_şaim
,

615 
b©adv_choo£_şaim
, 
şaim
);

616 
	`b©adv_şaim_ä“_»f
(
şaim
);

618 
şaim
->
backbÚe_gw
->
üc
 ^ğ
	`üc16
(0, cÏim->
addr
, 
ETH_ALEN
);

621 
	`b©adv_şaim_ä“_»f
(
şaim
);

622 
	}
}

625 
	$b©adv_hªdË_ªnounû
(
b©adv_´iv
 *
b©_´iv
,

626 
ušt8_t
 *
ª_addr
, ušt8_ˆ*
backbÚe_addr
,

627 
vid
)

629 
b©adv_backbÚe_gw
 *
backbÚe_gw
;

630 
ušt16_t
 
üc
;

632 ià(
	`memcmp
(
ª_addr
, 
b©adv_ªnounû_mac
, 4) != 0)

635 
backbÚe_gw
 = 
	`b©adv_bÏ_g‘_backbÚe_gw
(
b©_´iv
, 
backbÚe_addr
, 
vid
);

637 ià(
	`uÆik–y
(!
backbÚe_gw
))

642 
backbÚe_gw
->
Ï¡time
 = 
jiff›s
;

643 
üc
 = 
	`Áohs
(*((
__be16
 *)(&
ª_addr
[4])));

645 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
b©_´iv
,

647 
vid
, 
backbÚe_gw
->
Üig
, 
üc
);

649 ià(
backbÚe_gw
->
üc
 != crc) {

650 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
backbÚe_gw
->
b©_´iv
,

652 
backbÚe_gw
->
Üig
, backbÚe_gw->
vid
,

653 
backbÚe_gw
->
üc
, crc);

655 
	`b©adv_bÏ_£nd_»que¡
(
backbÚe_gw
);

660 ià(
	`©omic_»ad
(&
backbÚe_gw
->
»que¡_£Á
)) {

661 
	`©omic_dec
(&
backbÚe_gw
->
b©_´iv
->
bÏ
.
num_»que¡s
);

662 
	`©omic_£t
(&
backbÚe_gw
->
»que¡_£Á
, 0);

666 
	`b©adv_backbÚe_gw_ä“_»f
(
backbÚe_gw
);

668 
	}
}

671 
	$b©adv_hªdË_»que¡
(
b©adv_´iv
 *
b©_´iv
,

672 
b©adv_h¬d_içû
 *
´im¬y_if
,

673 
ušt8_t
 *
backbÚe_addr
,

674 
‘hhdr
 *‘hhdr, 
vid
)

677 ià(!
	`b©adv_com·»_‘h
(
backbÚe_addr
, 
‘hhdr
->
h_de¡
))

683 ià(!
	`b©adv_com·»_‘h
(
‘hhdr
->
h_de¡
, 
´im¬y_if
->
Ãt_dev
->
dev_addr
))

686 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
b©_´iv
,

688 
vid
, 
‘hhdr
->
h_sourû
);

690 
	`b©adv_bÏ_ªsw”_»que¡
(
b©_´iv
, 
´im¬y_if
, 
vid
);

692 
	}
}

695 
	$b©adv_hªdË_unşaim
(
b©adv_´iv
 *
b©_´iv
,

696 
b©adv_h¬d_içû
 *
´im¬y_if
,

697 
ušt8_t
 *
backbÚe_addr
,

698 
ušt8_t
 *
şaim_addr
, 
vid
)

700 
b©adv_backbÚe_gw
 *
backbÚe_gw
;

703 ià(
´im¬y_if
 && 
	`b©adv_com·»_‘h
(
backbÚe_addr
,

704 
´im¬y_if
->
Ãt_dev
->
dev_addr
))

705 
	`b©adv_bÏ_£nd_şaim
(
b©_´iv
, 
şaim_addr
, 
vid
,

706 
BATADV_CLAIM_TYPE_UNCLAIM
);

708 
backbÚe_gw
 = 
	`b©adv_backbÚe_hash_fšd
(
b©_´iv
, 
backbÚe_addr
, 
vid
);

710 ià(!
backbÚe_gw
)

714 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
b©_´iv
,

716 
şaim_addr
, 
vid
, 
backbÚe_gw
->
Üig
);

718 
	`b©adv_bÏ_d–_şaim
(
b©_´iv
, 
şaim_addr
, 
vid
);

719 
	`b©adv_backbÚe_gw_ä“_»f
(
backbÚe_gw
);

721 
	}
}

724 
	$b©adv_hªdË_şaim
(
b©adv_´iv
 *
b©_´iv
,

725 
b©adv_h¬d_içû
 *
´im¬y_if
,

726 
ušt8_t
 *
backbÚe_addr
, ušt8_ˆ*
şaim_addr
,

727 
vid
)

729 
b©adv_backbÚe_gw
 *
backbÚe_gw
;

733 
backbÚe_gw
 = 
	`b©adv_bÏ_g‘_backbÚe_gw
(
b©_´iv
, 
backbÚe_addr
, 
vid
);

735 ià(
	`uÆik–y
(!
backbÚe_gw
))

739 
	`b©adv_bÏ_add_şaim
(
b©_´iv
, 
şaim_addr
, 
vid
, 
backbÚe_gw
);

740 ià(
	`b©adv_com·»_‘h
(
backbÚe_addr
, 
´im¬y_if
->
Ãt_dev
->
dev_addr
))

741 
	`b©adv_bÏ_£nd_şaim
(
b©_´iv
, 
şaim_addr
, 
vid
,

742 
BATADV_CLAIM_TYPE_CLAIM
);

746 
	`b©adv_backbÚe_gw_ä“_»f
(
backbÚe_gw
);

748 
	}
}

766 
	$b©adv_check_şaim_group
(
b©adv_´iv
 *
b©_´iv
,

767 
b©adv_h¬d_içû
 *
´im¬y_if
,

768 
ušt8_t
 *
hw_¤c
, ušt8_ˆ*
hw_d¡
,

769 
‘hhdr
 *ethhdr)

771 
ušt8_t
 *
backbÚe_addr
;

772 
b©adv_Üig_node
 *
Üig_node
;

773 
b©adv_bÏ_şaim_d¡
 *
bÏ_d¡
, *
bÏ_d¡_own
;

775 
bÏ_d¡
 = (
b©adv_bÏ_şaim_d¡
 *)
hw_d¡
;

776 
bÏ_d¡_own
 = &
b©_´iv
->
bÏ
.
şaim_de¡
;

779 ià(
	`memcmp
(
bÏ_d¡
->
magic
, 
bÏ_d¡_own
->magic,

780 (
bÏ_d¡
->
magic
)) != 0)

786 
bÏ_d¡
->
ty³
) {

787 
BATADV_CLAIM_TYPE_CLAIM
:

788 
backbÚe_addr
 = 
hw_¤c
;

790 
BATADV_CLAIM_TYPE_REQUEST
:

791 
BATADV_CLAIM_TYPE_ANNOUNCE
:

792 
BATADV_CLAIM_TYPE_UNCLAIM
:

793 
backbÚe_addr
 = 
‘hhdr
->
h_sourû
;

800 ià(
	`b©adv_com·»_‘h
(
backbÚe_addr
, 
´im¬y_if
->
Ãt_dev
->
dev_addr
))

804 ià(
bÏ_d¡
->
group
 =ğ
bÏ_d¡_own
->group)

808 
Üig_node
 = 
	`b©adv_Üig_hash_fšd
(
b©_´iv
, 
backbÚe_addr
);

813 ià(!
Üig_node
)

817 ià(
	`Áohs
(
bÏ_d¡
->
group
è>‚tohs(
bÏ_d¡_own
->group)) {

818 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
b©_´iv
,

820 
	`Áohs
(
bÏ_d¡
->
group
));

821 
bÏ_d¡_own
->
group
 = 
bÏ_d¡
->group;

824 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

827 
	}
}

838 
	$b©adv_bÏ_´oûss_şaim
(
b©adv_´iv
 *
b©_´iv
,

839 
b©adv_h¬d_içû
 *
´im¬y_if
,

840 
sk_buff
 *
skb
)

842 
‘hhdr
 *ethhdr;

843 
vÏn_‘hhdr
 *
vhdr
;

844 
¬phdr
 *arphdr;

845 
ušt8_t
 *
hw_¤c
, *
hw_d¡
;

846 
b©adv_bÏ_şaim_d¡
 *
bÏ_d¡
;

847 
ušt16_t
 
´Ùo
;

848 
h—dËn
;

849 
vid
 = -1;

850 
»t
;

852 
‘hhdr
 = (‘hhd¸*)
	`skb_mac_h—d”
(
skb
);

854 ià(
	`Áohs
(
‘hhdr
->
h_´Ùo
è=ğ
ETH_P_8021Q
) {

855 
vhdr
 = (
vÏn_‘hhdr
 *)
‘hhdr
;

856 
vid
 = 
	`Áohs
(
vhdr
->
h_vÏn_TCI
è& 
VLAN_VID_MASK
;

857 
´Ùo
 = 
	`Áohs
(
vhdr
->
h_vÏn_’ÿpsuÏ‹d_´Ùo
);

858 
h—dËn
 = (*
vhdr
);

860 
´Ùo
 = 
	`Áohs
(
‘hhdr
->
h_´Ùo
);

861 
h—dËn
 = 
ETH_HLEN
;

864 ià(
´Ùo
 !ğ
ETH_P_ARP
)

869 ià(
	`uÆik–y
(!
	`pskb_may_puÎ
(
skb
, 
h—dËn
 + 
	`¬p_hdr_Ën
(skb->
dev
))))

873 
‘hhdr
 = (‘hhd¸*)
	`skb_mac_h—d”
(
skb
);

874 
¬phdr
 = (¬phd¸*)((
ušt8_t
 *)
‘hhdr
 + 
h—dËn
);

879 ià(
¬phdr
->
¬_hrd
 !ğ
	`htÚs
(
ARPHRD_ETHER
))

881 ià(
¬phdr
->
¬_´o
 !ğ
	`htÚs
(
ETH_P_IP
))

883 ià(
¬phdr
->
¬_hÊ
 !ğ
ETH_ALEN
)

885 ià(
¬phdr
->
¬_¶n
 != 4)

888 
hw_¤c
 = (
ušt8_t
 *)
¬phdr
 + (arphdr);

889 
hw_d¡
 = 
hw_¤c
 + 
ETH_ALEN
 + 4;

890 
bÏ_d¡
 = (
b©adv_bÏ_şaim_d¡
 *)
hw_d¡
;

893 
»t
 = 
	`b©adv_check_şaim_group
(
b©_´iv
, 
´im¬y_if
, 
hw_¤c
, 
hw_d¡
,

894 
‘hhdr
);

895 ià(
»t
 == 1)

896 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
b©_´iv
,

898 
‘hhdr
->
h_sourû
, 
vid
, 
hw_¤c
, 
hw_d¡
);

900 ià(
»t
 < 2)

901  
»t
;

904 
	`b©adv_bÏ_upd©e_own_backbÚe_gw
(
b©_´iv
, 
´im¬y_if
, 
vid
);

907 
bÏ_d¡
->
ty³
) {

908 
BATADV_CLAIM_TYPE_CLAIM
:

909 ià(
	`b©adv_hªdË_şaim
(
b©_´iv
, 
´im¬y_if
, 
hw_¤c
,

910 
‘hhdr
->
h_sourû
, 
vid
))

913 
BATADV_CLAIM_TYPE_UNCLAIM
:

914 ià(
	`b©adv_hªdË_unşaim
(
b©_´iv
, 
´im¬y_if
,

915 
‘hhdr
->
h_sourû
, 
hw_¤c
, 
vid
))

919 
BATADV_CLAIM_TYPE_ANNOUNCE
:

920 ià(
	`b©adv_hªdË_ªnounû
(
b©_´iv
, 
hw_¤c
, 
‘hhdr
->
h_sourû
,

921 
vid
))

924 
BATADV_CLAIM_TYPE_REQUEST
:

925 ià(
	`b©adv_hªdË_»que¡
(
b©_´iv
, 
´im¬y_if
, 
hw_¤c
, 
‘hhdr
,

926 
vid
))

931 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
b©_´iv
,

933 
‘hhdr
->
h_sourû
, 
vid
, 
hw_¤c
, 
hw_d¡
);

935 
	}
}

940 
	$b©adv_bÏ_purge_backbÚe_gw
(
b©adv_´iv
 *
b©_´iv
, 
now
)

942 
b©adv_backbÚe_gw
 *
backbÚe_gw
;

943 
hli¡_node
 *
node
, *
node_tmp
;

944 
hli¡_h—d
 *
h—d
;

945 
b©adv_hashbË
 *
hash
;

946 
¥šlock_t
 *
li¡_lock
;

947 
i
;

949 
hash
 = 
b©_´iv
->
bÏ
.
backbÚe_hash
;

950 ià(!
hash
)

953 
i
 = 0; i < 
hash
->
size
; i++) {

954 
h—d
 = &
hash
->
bË
[
i
];

955 
li¡_lock
 = &
hash
->
li¡_locks
[
i
];

957 
	`¥š_lock_bh
(
li¡_lock
);

958 
	`hli¡_fÜ_—ch_’Œy_§ã
(
backbÚe_gw
, 
node
, 
node_tmp
,

959 
h—d
, 
hash_’Œy
) {

960 ià(
now
)

961 
purge_now
;

962 ià(!
	`b©adv_has_timed_out
(
backbÚe_gw
->
Ï¡time
,

963 
BATADV_BLA_BACKBONE_TIMEOUT
))

966 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
backbÚe_gw
->
b©_´iv
,

968 
backbÚe_gw
->
Üig
);

970 
purge_now
:

972 ià(
	`©omic_»ad
(&
backbÚe_gw
->
»que¡_£Á
))

973 
	`©omic_dec
(&
b©_´iv
->
bÏ
.
num_»que¡s
);

975 
	`b©adv_bÏ_d–_backbÚe_şaims
(
backbÚe_gw
);

977 
	`hli¡_d–_rcu
(
node
);

978 
	`b©adv_backbÚe_gw_ä“_»f
(
backbÚe_gw
);

980 
	`¥š_uÆock_bh
(
li¡_lock
);

982 
	}
}

993 
	$b©adv_bÏ_purge_şaims
(
b©adv_´iv
 *
b©_´iv
,

994 
b©adv_h¬d_içû
 *
´im¬y_if
,

995 
now
)

997 
b©adv_şaim
 *
şaim
;

998 
hli¡_node
 *
node
;

999 
hli¡_h—d
 *
h—d
;

1000 
b©adv_hashbË
 *
hash
;

1001 
i
;

1003 
hash
 = 
b©_´iv
->
bÏ
.
şaim_hash
;

1004 ià(!
hash
)

1007 
i
 = 0; i < 
hash
->
size
; i++) {

1008 
h—d
 = &
hash
->
bË
[
i
];

1010 
	`rcu_»ad_lock
();

1011 
	`hli¡_fÜ_—ch_’Œy_rcu
(
şaim
, 
node
, 
h—d
, 
hash_’Œy
) {

1012 ià(
now
)

1013 
purge_now
;

1014 ià(!
	`b©adv_com·»_‘h
(
şaim
->
backbÚe_gw
->
Üig
,

1015 
´im¬y_if
->
Ãt_dev
->
dev_addr
))

1017 ià(!
	`b©adv_has_timed_out
(
şaim
->
Ï¡time
,

1018 
BATADV_BLA_CLAIM_TIMEOUT
))

1021 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
b©_´iv
,

1023 
şaim
->
addr
, cÏim->
vid
);

1025 
purge_now
:

1026 
	`b©adv_hªdË_unşaim
(
b©_´iv
, 
´im¬y_if
,

1027 
şaim
->
backbÚe_gw
->
Üig
,

1028 
şaim
->
addr
, cÏim->
vid
);

1030 
	`rcu_»ad_uÆock
();

1032 
	}
}

1042 
	$b©adv_bÏ_upd©e_Üig_add»ss
(
b©adv_´iv
 *
b©_´iv
,

1043 
b©adv_h¬d_içû
 *
´im¬y_if
,

1044 
b©adv_h¬d_içû
 *
Şdif
)

1046 
b©adv_backbÚe_gw
 *
backbÚe_gw
;

1047 
hli¡_node
 *
node
;

1048 
hli¡_h—d
 *
h—d
;

1049 
b©adv_hashbË
 *
hash
;

1050 
__be16
 
group
;

1051 
i
;

1054 
group
 = 
	`htÚs
(
	`üc16
(0, 
´im¬y_if
->
Ãt_dev
->
dev_addr
, 
ETH_ALEN
));

1055 
b©_´iv
->
bÏ
.
şaim_de¡
.
group
 = group;

1057 ià(!
Şdif
) {

1058 
	`b©adv_bÏ_purge_şaims
(
b©_´iv
, 
NULL
, 1);

1059 
	`b©adv_bÏ_purge_backbÚe_gw
(
b©_´iv
, 1);

1063 
hash
 = 
b©_´iv
->
bÏ
.
backbÚe_hash
;

1064 ià(!
hash
)

1067 
i
 = 0; i < 
hash
->
size
; i++) {

1068 
h—d
 = &
hash
->
bË
[
i
];

1070 
	`rcu_»ad_lock
();

1071 
	`hli¡_fÜ_—ch_’Œy_rcu
(
backbÚe_gw
, 
node
, 
h—d
, 
hash_’Œy
) {

1073 ià(!
	`b©adv_com·»_‘h
(
backbÚe_gw
->
Üig
,

1074 
Şdif
->
Ãt_dev
->
dev_addr
))

1077 
	`memıy
(
backbÚe_gw
->
Üig
,

1078 
´im¬y_if
->
Ãt_dev
->
dev_addr
, 
ETH_ALEN
);

1082 
	`b©adv_bÏ_£nd_ªnounû
(
b©_´iv
, 
backbÚe_gw
);

1084 
	`rcu_»ad_uÆock
();

1086 
	}
}

1091 
	$b©adv_bÏ_¡¬t_tim”
(
b©adv_´iv
 *
b©_´iv
)

1093 
	`INIT_DELAYED_WORK
(&
b©_´iv
->
bÏ
.
wÜk
, 
b©adv_bÏ_³riodic_wÜk
);

1094 
	`queue_d–ayed_wÜk
(
b©adv_ev’t_wÜkqueue
, &
b©_´iv
->
bÏ
.
wÜk
,

1095 
	`m£cs_to_jiff›s
(
BATADV_BLA_PERIOD_LENGTH
));

1096 
	}
}

1102 
	$b©adv_bÏ_³riodic_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1104 
d–ayed_wÜk
 *delayed_work;

1105 
b©adv_´iv
 *
b©_´iv
;

1106 
b©adv_´iv_bÏ
 *
´iv_bÏ
;

1107 
hli¡_node
 *
node
;

1108 
hli¡_h—d
 *
h—d
;

1109 
b©adv_backbÚe_gw
 *
backbÚe_gw
;

1110 
b©adv_hashbË
 *
hash
;

1111 
b©adv_h¬d_içû
 *
´im¬y_if
;

1112 
i
;

1114 
d–ayed_wÜk
 = 
	`cÚš”_of
(
wÜk
, delayed_work, work);

1115 
´iv_bÏ
 = 
	`cÚš”_of
(
d–ayed_wÜk
, 
b©adv_´iv_bÏ
, 
wÜk
);

1116 
b©_´iv
 = 
	`cÚš”_of
(
´iv_bÏ
, 
b©adv_´iv
, 
bÏ
);

1117 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

1118 ià(!
´im¬y_if
)

1119 
out
;

1121 
	`b©adv_bÏ_purge_şaims
(
b©_´iv
, 
´im¬y_if
, 0);

1122 
	`b©adv_bÏ_purge_backbÚe_gw
(
b©_´iv
, 0);

1124 ià(!
	`©omic_»ad
(&
b©_´iv
->
bridge_loİ_avoidªû
))

1125 
out
;

1127 
hash
 = 
b©_´iv
->
bÏ
.
backbÚe_hash
;

1128 ià(!
hash
)

1129 
out
;

1131 
i
 = 0; i < 
hash
->
size
; i++) {

1132 
h—d
 = &
hash
->
bË
[
i
];

1134 
	`rcu_»ad_lock
();

1135 
	`hli¡_fÜ_—ch_’Œy_rcu
(
backbÚe_gw
, 
node
, 
h—d
, 
hash_’Œy
) {

1136 ià(!
	`b©adv_com·»_‘h
(
backbÚe_gw
->
Üig
,

1137 
´im¬y_if
->
Ãt_dev
->
dev_addr
))

1140 
backbÚe_gw
->
Ï¡time
 = 
jiff›s
;

1142 
	`b©adv_bÏ_£nd_ªnounû
(
b©_´iv
, 
backbÚe_gw
);

1144 
	`rcu_»ad_uÆock
();

1146 
out
:

1147 ià(
´im¬y_if
)

1148 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

1150 
	`b©adv_bÏ_¡¬t_tim”
(
b©_´iv
);

1151 
	}
}

1158 
lock_şass_key
 
	gb©adv_şaim_hash_lock_şass_key
;

1159 
lock_şass_key
 
	gb©adv_backbÚe_hash_lock_şass_key
;

1162 
	$b©adv_bÏ_š™
(
b©adv_´iv
 *
b©_´iv
)

1164 
i
;

1165 
ušt8_t
 
şaim_de¡
[
ETH_ALEN
] = {0xff, 0x43, 0x05, 0x00, 0x00, 0x00};

1166 
b©adv_h¬d_içû
 *
´im¬y_if
;

1167 
ušt16_t
 
üc
;

1168 
’Œytime
;

1170 
	`¥š_lock_š™
(&
b©_´iv
->
bÏ
.
bÿ¡_du¶i¡_lock
);

1172 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
b©_´iv
, "bla hash„egistering\n");

1175 
	`memıy
(&
b©_´iv
->
bÏ
.
şaim_de¡
.
magic
, claim_dest, 3);

1176 
b©_´iv
->
bÏ
.
şaim_de¡
.
ty³
 = 0;

1177 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

1178 ià(
´im¬y_if
) {

1179 
üc
 = 
	`üc16
(0, 
´im¬y_if
->
Ãt_dev
->
dev_addr
, 
ETH_ALEN
);

1180 
b©_´iv
->
bÏ
.
şaim_de¡
.
group
 = 
	`htÚs
(
üc
);

1181 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

1183 
b©_´iv
->
bÏ
.
şaim_de¡
.
group
 = 0;

1187 
’Œytime
 = 
jiff›s
 - 
	`m£cs_to_jiff›s
(
BATADV_DUPLIST_TIMEOUT
);

1188 
i
 = 0; i < 
BATADV_DUPLIST_SIZE
; i++)

1189 
b©_´iv
->
bÏ
.
bÿ¡_du¶i¡
[
i
].
’Œytime
 =ƒntrytime;

1190 
b©_´iv
->
bÏ
.
bÿ¡_du¶i¡_cu¼
 = 0;

1192 ià(
b©_´iv
->
bÏ
.
şaim_hash
)

1195 
b©_´iv
->
bÏ
.
şaim_hash
 = 
	`b©adv_hash_Ãw
(128);

1196 
b©_´iv
->
bÏ
.
backbÚe_hash
 = 
	`b©adv_hash_Ãw
(32);

1198 ià(!
b©_´iv
->
bÏ
.
şaim_hash
 || !b©_´iv->bÏ.
backbÚe_hash
)

1199  -
ENOMEM
;

1201 
	`b©adv_hash_£t_lock_şass
(
b©_´iv
->
bÏ
.
şaim_hash
,

1202 &
b©adv_şaim_hash_lock_şass_key
);

1203 
	`b©adv_hash_£t_lock_şass
(
b©_´iv
->
bÏ
.
backbÚe_hash
,

1204 &
b©adv_backbÚe_hash_lock_şass_key
);

1206 
	`b©adv_dbg
(
BATADV_DBG_BLA
, 
b©_´iv
, "bla hashes initialized\n");

1208 
	`b©adv_bÏ_¡¬t_tim”
(
b©_´iv
);

1210 
	}
}

1227 
	$b©adv_bÏ_check_bÿ¡_du¶i¡
(
b©adv_´iv
 *
b©_´iv
,

1228 
b©adv_bÿ¡_·ck‘
 *
bÿ¡_·ck‘
,

1229 
bÿ¡_·ck‘_Ën
)

1231 
i
, 
Ëngth
, 
cu¼
, 
»t
 = 0;

1232 
ušt8_t
 *
cÚ‹Á
;

1233 
ušt16_t
 
üc
;

1234 
b©adv_bÿ¡_du¶i¡_’Œy
 *
’Œy
;

1236 
Ëngth
 = 
bÿ¡_·ck‘_Ën
 - (*
bÿ¡_·ck‘
);

1237 
cÚ‹Á
 = (
ušt8_t
 *)
bÿ¡_·ck‘
;

1238 
cÚ‹Á
 +ğ(*
bÿ¡_·ck‘
);

1241 
üc
 = 
	`üc16
(0, 
cÚ‹Á
, 
Ëngth
);

1243 
	`¥š_lock_bh
(&
b©_´iv
->
bÏ
.
bÿ¡_du¶i¡_lock
);

1245 
i
 = 0; i < 
BATADV_DUPLIST_SIZE
; i++) {

1246 
cu¼
 = (
b©_´iv
->
bÏ
.
bÿ¡_du¶i¡_cu¼
 + 
i
);

1247 
cu¼
 %ğ
BATADV_DUPLIST_SIZE
;

1248 
’Œy
 = &
b©_´iv
->
bÏ
.
bÿ¡_du¶i¡
[
cu¼
];

1253 ià(
	`b©adv_has_timed_out
(
’Œy
->
’Œytime
,

1254 
BATADV_DUPLIST_TIMEOUT
))

1257 ià(
’Œy
->
üc
 != crc)

1260 ià(
	`b©adv_com·»_‘h
(
’Œy
->
Üig
, 
bÿ¡_·ck‘
->orig))

1266 
»t
 = 1;

1267 
out
;

1272 
cu¼
 = (
b©_´iv
->
bÏ
.
bÿ¡_du¶i¡_cu¼
 + 
BATADV_DUPLIST_SIZE
 - 1);

1273 
cu¼
 %ğ
BATADV_DUPLIST_SIZE
;

1274 
’Œy
 = &
b©_´iv
->
bÏ
.
bÿ¡_du¶i¡
[
cu¼
];

1275 
’Œy
->
üc
 = crc;

1276 
’Œy
->
’Œytime
 = 
jiff›s
;

1277 
	`memıy
(
’Œy
->
Üig
, 
bÿ¡_·ck‘
->Üig, 
ETH_ALEN
);

1278 
b©_´iv
->
bÏ
.
bÿ¡_du¶i¡_cu¼
 = 
cu¼
;

1280 
out
:

1281 
	`¥š_uÆock_bh
(&
b©_´iv
->
bÏ
.
bÿ¡_du¶i¡_lock
);

1283  
»t
;

1284 
	}
}

1295 
	$b©adv_bÏ_is_backbÚe_gw_Üig
(
b©adv_´iv
 *
b©_´iv
, 
ušt8_t
 *
Üig
)

1297 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
bÏ
.
backbÚe_hash
;

1298 
hli¡_h—d
 *
h—d
;

1299 
hli¡_node
 *
node
;

1300 
b©adv_backbÚe_gw
 *
backbÚe_gw
;

1301 
i
;

1303 ià(!
	`©omic_»ad
(&
b©_´iv
->
bridge_loİ_avoidªû
))

1306 ià(!
hash
)

1309 
i
 = 0; i < 
hash
->
size
; i++) {

1310 
h—d
 = &
hash
->
bË
[
i
];

1312 
	`rcu_»ad_lock
();

1313 
	`hli¡_fÜ_—ch_’Œy_rcu
(
backbÚe_gw
, 
node
, 
h—d
, 
hash_’Œy
) {

1314 ià(
	`b©adv_com·»_‘h
(
backbÚe_gw
->
Üig
, orig)) {

1315 
	`rcu_»ad_uÆock
();

1319 
	`rcu_»ad_uÆock
();

1323 
	}
}

1336 
	$b©adv_bÏ_is_backbÚe_gw
(
sk_buff
 *
skb
,

1337 
b©adv_Üig_node
 *
Üig_node
, 
hdr_size
)

1339 
‘hhdr
 *ethhdr;

1340 
vÏn_‘hhdr
 *
vhdr
;

1341 
b©adv_backbÚe_gw
 *
backbÚe_gw
;

1342 
vid
 = -1;

1344 ià(!
	`©omic_»ad
(&
Üig_node
->
b©_´iv
->
bridge_loİ_avoidªû
))

1348 ià(!
	`pskb_may_puÎ
(
skb
, 
hdr_size
 + 
ETH_HLEN
))

1351 
‘hhdr
 = (‘hhd¸*)(((
ušt8_t
 *)
skb
->
d©a
è+ 
hdr_size
);

1353 ià(
	`Áohs
(
‘hhdr
->
h_´Ùo
è=ğ
ETH_P_8021Q
) {

1354 ià(!
	`pskb_may_puÎ
(
skb
, 
hdr_size
 + (
vÏn_‘hhdr
)))

1357 
vhdr
 = (
vÏn_‘hhdr
 *)(
skb
->
d©a
 + 
hdr_size
);

1358 
vid
 = 
	`Áohs
(
vhdr
->
h_vÏn_TCI
è& 
VLAN_VID_MASK
;

1362 
backbÚe_gw
 = 
	`b©adv_backbÚe_hash_fšd
(
Üig_node
->
b©_´iv
,

1363 
Üig_node
->
Üig
, 
vid
);

1364 ià(!
backbÚe_gw
)

1367 
	`b©adv_backbÚe_gw_ä“_»f
(
backbÚe_gw
);

1369 
	}
}

1372 
	$b©adv_bÏ_ä“
(
b©adv_´iv
 *
b©_´iv
)

1374 
b©adv_h¬d_içû
 *
´im¬y_if
;

1376 
	`ÿnûl_d–ayed_wÜk_sync
(&
b©_´iv
->
bÏ
.
wÜk
);

1377 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

1379 ià(
b©_´iv
->
bÏ
.
şaim_hash
) {

1380 
	`b©adv_bÏ_purge_şaims
(
b©_´iv
, 
´im¬y_if
, 1);

1381 
	`b©adv_hash_de¡roy
(
b©_´iv
->
bÏ
.
şaim_hash
);

1382 
b©_´iv
->
bÏ
.
şaim_hash
 = 
NULL
;

1384 ià(
b©_´iv
->
bÏ
.
backbÚe_hash
) {

1385 
	`b©adv_bÏ_purge_backbÚe_gw
(
b©_´iv
, 1);

1386 
	`b©adv_hash_de¡roy
(
b©_´iv
->
bÏ
.
backbÚe_hash
);

1387 
b©_´iv
->
bÏ
.
backbÚe_hash
 = 
NULL
;

1389 ià(
´im¬y_if
)

1390 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

1391 
	}
}

1408 
	$b©adv_bÏ_rx
(
b©adv_´iv
 *
b©_´iv
, 
sk_buff
 *
skb
, 
vid
,

1409 
boŞ
 
is_bÿ¡
)

1411 
‘hhdr
 *ethhdr;

1412 
b©adv_şaim
 
£¬ch_şaim
, *
şaim
 = 
NULL
;

1413 
b©adv_h¬d_içû
 *
´im¬y_if
;

1414 
»t
;

1416 
‘hhdr
 = (‘hhd¸*)
	`skb_mac_h—d”
(
skb
);

1418 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

1419 ià(!
´im¬y_if
)

1420 
hªdËd
;

1422 ià(!
	`©omic_»ad
(&
b©_´iv
->
bridge_loİ_avoidªû
))

1423 
®low
;

1426 ià(
	`uÆik–y
(
	`©omic_»ad
(&
b©_´iv
->
bÏ
.
num_»que¡s
)))

1428 ià(
	`is_muÉiÿ¡_‘h”_addr
(
‘hhdr
->
h_de¡
è&& 
is_bÿ¡
)

1429 
hªdËd
;

1431 
	`memıy
(
£¬ch_şaim
.
addr
, 
‘hhdr
->
h_sourû
, 
ETH_ALEN
);

1432 
£¬ch_şaim
.
vid
 = vid;

1433 
şaim
 = 
	`b©adv_şaim_hash_fšd
(
b©_´iv
, &
£¬ch_şaim
);

1435 ià(!
şaim
) {

1439 
	`b©adv_hªdË_şaim
(
b©_´iv
, 
´im¬y_if
,

1440 
´im¬y_if
->
Ãt_dev
->
dev_addr
,

1441 
‘hhdr
->
h_sourû
, 
vid
);

1442 
®low
;

1446 ià(
	`b©adv_com·»_‘h
(
şaim
->
backbÚe_gw
->
Üig
,

1447 
´im¬y_if
->
Ãt_dev
->
dev_addr
)) {

1449 
şaim
->
Ï¡time
 = 
jiff›s
;

1450 
®low
;

1454 ià(
	`is_muÉiÿ¡_‘h”_addr
(
‘hhdr
->
h_de¡
è&& 
is_bÿ¡
) {

1461 
hªdËd
;

1467 
	`b©adv_hªdË_şaim
(
b©_´iv
, 
´im¬y_if
,

1468 
´im¬y_if
->
Ãt_dev
->
dev_addr
,

1469 
‘hhdr
->
h_sourû
, 
vid
);

1470 
®low
;

1472 
®low
:

1473 
	`b©adv_bÏ_upd©e_own_backbÚe_gw
(
b©_´iv
, 
´im¬y_if
, 
vid
);

1474 
»t
 = 0;

1475 
out
;

1477 
hªdËd
:

1478 
	`kä“_skb
(
skb
);

1479 
»t
 = 1;

1481 
out
:

1482 ià(
´im¬y_if
)

1483 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

1484 ià(
şaim
)

1485 
	`b©adv_şaim_ä“_»f
(
şaim
);

1486  
»t
;

1487 
	}
}

1503 
	$b©adv_bÏ_tx
(
b©adv_´iv
 *
b©_´iv
, 
sk_buff
 *
skb
, 
vid
)

1505 
‘hhdr
 *ethhdr;

1506 
b©adv_şaim
 
£¬ch_şaim
, *
şaim
 = 
NULL
;

1507 
b©adv_h¬d_içû
 *
´im¬y_if
;

1508 
»t
 = 0;

1510 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

1511 ià(!
´im¬y_if
)

1512 
out
;

1514 ià(!
	`©omic_»ad
(&
b©_´iv
->
bridge_loİ_avoidªû
))

1515 
®low
;

1518 
	`skb_»£t_mac_h—d”
(
skb
);

1520 ià(
	`b©adv_bÏ_´oûss_şaim
(
b©_´iv
, 
´im¬y_if
, 
skb
))

1521 
hªdËd
;

1523 
‘hhdr
 = (‘hhd¸*)
	`skb_mac_h—d”
(
skb
);

1525 ià(
	`uÆik–y
(
	`©omic_»ad
(&
b©_´iv
->
bÏ
.
num_»que¡s
)))

1527 ià(
	`is_muÉiÿ¡_‘h”_addr
(
‘hhdr
->
h_de¡
))

1528 
hªdËd
;

1530 
	`memıy
(
£¬ch_şaim
.
addr
, 
‘hhdr
->
h_sourû
, 
ETH_ALEN
);

1531 
£¬ch_şaim
.
vid
 = vid;

1533 
şaim
 = 
	`b©adv_şaim_hash_fšd
(
b©_´iv
, &
£¬ch_şaim
);

1536 ià(!
şaim
)

1537 
®low
;

1540 ià(
	`b©adv_com·»_‘h
(
şaim
->
backbÚe_gw
->
Üig
,

1541 
´im¬y_if
->
Ãt_dev
->
dev_addr
)) {

1545 
	`b©adv_hªdË_unşaim
(
b©_´iv
, 
´im¬y_if
,

1546 
´im¬y_if
->
Ãt_dev
->
dev_addr
,

1547 
‘hhdr
->
h_sourû
, 
vid
);

1548 
®low
;

1552 ià(
	`is_muÉiÿ¡_‘h”_addr
(
‘hhdr
->
h_de¡
)) {

1556 
hªdËd
;

1561 
®low
;

1563 
®low
:

1564 
	`b©adv_bÏ_upd©e_own_backbÚe_gw
(
b©_´iv
, 
´im¬y_if
, 
vid
);

1565 
»t
 = 0;

1566 
out
;

1567 
hªdËd
:

1568 
»t
 = 1;

1569 
out
:

1570 ià(
´im¬y_if
)

1571 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

1572 ià(
şaim
)

1573 
	`b©adv_şaim_ä“_»f
(
şaim
);

1574  
»t
;

1575 
	}
}

1577 
	$b©adv_bÏ_şaim_bË_£q_´št_‹xt
(
£q_fe
 *
£q
, *
off£t
)

1579 
Ãt_deviû
 *
Ãt_dev
 = (Ãt_deviû *)
£q
->
´iv©e
;

1580 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
Ãt_dev
);

1581 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
bÏ
.
şaim_hash
;

1582 
b©adv_şaim
 *
şaim
;

1583 
b©adv_h¬d_içû
 *
´im¬y_if
;

1584 
hli¡_node
 *
node
;

1585 
hli¡_h—d
 *
h—d
;

1586 
ušt32_t
 
i
;

1587 
boŞ
 
is_own
;

1588 
»t
 = 0;

1589 
ušt8_t
 *
´im¬y_addr
;

1591 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

1592 ià(!
´im¬y_if
) {

1593 
»t
 = 
	`£q_´štf
(
£q
,

1595 
Ãt_dev
->
Çme
);

1596 
out
;

1599 ià(
´im¬y_if
->
if_¡©us
 !ğ
BATADV_IF_ACTIVE
) {

1600 
»t
 = 
	`£q_´štf
(
£q
,

1602 
Ãt_dev
->
Çme
);

1603 
out
;

1606 
´im¬y_addr
 = 
´im¬y_if
->
Ãt_dev
->
dev_addr
;

1607 
	`£q_´štf
(
£q
,

1609 
Ãt_dev
->
Çme
, 
´im¬y_addr
,

1610 
	`Áohs
(
b©_´iv
->
bÏ
.
şaim_de¡
.
group
));

1611 
	`£q_´štf
(
£q
, " %-17s %-5s %-17s [o] (%-4s)\n",

1613 
i
 = 0; i < 
hash
->
size
; i++) {

1614 
h—d
 = &
hash
->
bË
[
i
];

1616 
	`rcu_»ad_lock
();

1617 
	`hli¡_fÜ_—ch_’Œy_rcu
(
şaim
, 
node
, 
h—d
, 
hash_’Œy
) {

1618 
is_own
 = 
	`b©adv_com·»_‘h
(
şaim
->
backbÚe_gw
->
Üig
,

1619 
´im¬y_addr
);

1620 
	`£q_´štf
(
£q
, " * %pM on % 5d by %pM [%c] (%04x)\n",

1621 
şaim
->
addr
, cÏim->
vid
,

1622 
şaim
->
backbÚe_gw
->
Üig
,

1623 (
is_own
 ? 'x' : ' '),

1624 
şaim
->
backbÚe_gw
->
üc
);

1626 
	`rcu_»ad_uÆock
();

1628 
out
:

1629 ià(
´im¬y_if
)

1630 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

1631  
»t
;

1632 
	}
}

1634 
	$b©adv_bÏ_backbÚe_bË_£q_´št_‹xt
(
£q_fe
 *
£q
, *
off£t
)

1636 
Ãt_deviû
 *
Ãt_dev
 = (Ãt_deviû *)
£q
->
´iv©e
;

1637 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
Ãt_dev
);

1638 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
bÏ
.
backbÚe_hash
;

1639 
b©adv_backbÚe_gw
 *
backbÚe_gw
;

1640 
b©adv_h¬d_içû
 *
´im¬y_if
;

1641 
hli¡_node
 *
node
;

1642 
hli¡_h—d
 *
h—d
;

1643 
£cs
, 
m£cs
;

1644 
ušt32_t
 
i
;

1645 
boŞ
 
is_own
;

1646 
»t
 = 0;

1647 
ušt8_t
 *
´im¬y_addr
;

1649 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

1650 ià(!
´im¬y_if
) {

1651 
»t
 = 
	`£q_´štf
(
£q
,

1653 
Ãt_dev
->
Çme
);

1654 
out
;

1657 ià(
´im¬y_if
->
if_¡©us
 !ğ
BATADV_IF_ACTIVE
) {

1658 
»t
 = 
	`£q_´štf
(
£q
,

1660 
Ãt_dev
->
Çme
);

1661 
out
;

1664 
´im¬y_addr
 = 
´im¬y_if
->
Ãt_dev
->
dev_addr
;

1665 
	`£q_´štf
(
£q
,

1667 
Ãt_dev
->
Çme
, 
´im¬y_addr
,

1668 
	`Áohs
(
b©_´iv
->
bÏ
.
şaim_de¡
.
group
));

1669 
	`£q_´štf
(
£q
, " %-17s %-5s %-9s (%-4s)\n",

1671 
i
 = 0; i < 
hash
->
size
; i++) {

1672 
h—d
 = &
hash
->
bË
[
i
];

1674 
	`rcu_»ad_lock
();

1675 
	`hli¡_fÜ_—ch_’Œy_rcu
(
backbÚe_gw
, 
node
, 
h—d
, 
hash_’Œy
) {

1676 
m£cs
 = 
	`jiff›s_to_m£cs
(
jiff›s
 -

1677 
backbÚe_gw
->
Ï¡time
);

1678 
£cs
 = 
m£cs
 / 1000;

1679 
m£cs
 = msecs % 1000;

1681 
is_own
 = 
	`b©adv_com·»_‘h
(
backbÚe_gw
->
Üig
,

1682 
´im¬y_addr
);

1683 ià(
is_own
)

1686 
	`£q_´štf
(
£q
,

1688 
backbÚe_gw
->
Üig
, backbÚe_gw->
vid
,

1689 
£cs
, 
m£cs
, 
backbÚe_gw
->
üc
);

1691 
	`rcu_»ad_uÆock
();

1693 
out
:

1694 ià(
´im¬y_if
)

1695 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

1696  
»t
;

1697 
	}
}

	@bridge_loop_avoidance.h

20 #iâdeà
_NET_BATMAN_ADV_BLA_H_


21 
	#_NET_BATMAN_ADV_BLA_H_


	)

23 #ifdeà
CONFIG_BATMAN_ADV_BLA


24 
b©adv_bÏ_rx
(
b©adv_´iv
 *
b©_´iv
, 
sk_buff
 *
skb
, 
vid
,

25 
boŞ
 
is_bÿ¡
);

26 
b©adv_bÏ_tx
(
b©adv_´iv
 *
b©_´iv
, 
sk_buff
 *
skb
, 
vid
);

27 
b©adv_bÏ_is_backbÚe_gw
(
sk_buff
 *
skb
,

28 
b©adv_Üig_node
 *
Üig_node
, 
hdr_size
);

29 
b©adv_bÏ_şaim_bË_£q_´št_‹xt
(
£q_fe
 *
£q
, *
off£t
);

30 
b©adv_bÏ_backbÚe_bË_£q_´št_‹xt
(
£q_fe
 *
£q
,

31 *
off£t
);

32 
b©adv_bÏ_is_backbÚe_gw_Üig
(
b©adv_´iv
 *
b©_´iv
, 
ušt8_t
 *
Üig
);

33 
b©adv_bÏ_check_bÿ¡_du¶i¡
(
b©adv_´iv
 *
b©_´iv
,

34 
b©adv_bÿ¡_·ck‘
 *
bÿ¡_·ck‘
,

35 
hdr_size
);

36 
b©adv_bÏ_upd©e_Üig_add»ss
(
b©adv_´iv
 *
b©_´iv
,

37 
b©adv_h¬d_içû
 *
´im¬y_if
,

38 
b©adv_h¬d_içû
 *
Şdif
);

39 
b©adv_bÏ_š™
(
b©adv_´iv
 *
b©_´iv
);

40 
b©adv_bÏ_ä“
(
b©adv_´iv
 *
b©_´iv
);

42 
	#BATADV_BLA_CRC_INIT
 0

	)

45 
šlše
 
	$b©adv_bÏ_rx
(
b©adv_´iv
 *
b©_´iv
,

46 
sk_buff
 *
skb
, 
vid
, 
boŞ
 
is_bÿ¡
)

49 
	}
}

51 
šlše
 
	$b©adv_bÏ_tx
(
b©adv_´iv
 *
b©_´iv
,

52 
sk_buff
 *
skb
, 
vid
)

55 
	}
}

57 
šlše
 
	$b©adv_bÏ_is_backbÚe_gw
(
sk_buff
 *
skb
,

58 
b©adv_Üig_node
 *
Üig_node
,

59 
hdr_size
)

62 
	}
}

64 
šlše
 
	$b©adv_bÏ_şaim_bË_£q_´št_‹xt
(
£q_fe
 *
£q
,

65 *
off£t
)

68 
	}
}

70 
šlše
 
	$b©adv_bÏ_backbÚe_bË_£q_´št_‹xt
(
£q_fe
 *
£q
,

71 *
off£t
)

74 
	}
}

76 
šlše
 
	$b©adv_bÏ_is_backbÚe_gw_Üig
(
b©adv_´iv
 *
b©_´iv
,

77 
ušt8_t
 *
Üig
)

80 
	}
}

82 
šlše
 

83 
	$b©adv_bÏ_check_bÿ¡_du¶i¡
(
b©adv_´iv
 *
b©_´iv
,

84 
b©adv_bÿ¡_·ck‘
 *
bÿ¡_·ck‘
,

85 
hdr_size
)

88 
	}
}

90 
šlše
 

91 
	$b©adv_bÏ_upd©e_Üig_add»ss
(
b©adv_´iv
 *
b©_´iv
,

92 
b©adv_h¬d_içû
 *
´im¬y_if
,

93 
b©adv_h¬d_içû
 *
Şdif
)

95 
	}
}

97 
šlše
 
	$b©adv_bÏ_š™
(
b©adv_´iv
 *
b©_´iv
)

100 
	}
}

102 
šlše
 
	$b©adv_bÏ_ä“
(
b©adv_´iv
 *
b©_´iv
)

104 
	}
}

	@compat-autoconf.h

1 #undeà
CONFIG_BATMAN_ADV_DEBUG


2 #undeà
__’abËd_CONFIG_BATMAN_ADV_DEBUG


3 #undeà
__’abËd_CONFIG_BATMAN_ADV_DEBUG_MODULE


4 
	#__’abËd_CONFIG_BATMAN_ADV_DEBUG
 0

	)

5 
	#__’abËd_CONFIG_BATMAN_ADV_DEBUG_MODULE
 0

	)

6 #undeà
CONFIG_BATMAN_ADV_BLA


7 #undeà
__’abËd_CONFIG_BATMAN_ADV_BLA


8 #undeà
__’abËd_CONFIG_BATMAN_ADV_BLA_MODULE


9 
	#CONFIG_BATMAN_ADV_BLA
 1

	)

10 
	#__’abËd_CONFIG_BATMAN_ADV_BLA
 1

	)

11 
	#__’abËd_CONFIG_BATMAN_ADV_BLA_MODULE
 0

	)

	@compat.c

24 
	~<lšux/š.h
>

25 
	~<lšux/v”siÚ.h
>

26 
	~"maš.h
"

28 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 0, 0)

30 
	$b©adv_ä“_rcu_gw_node
(
rcu_h—d
 *
rcu
)

32 
b©adv_gw_node
 *
gw_node
;

34 
gw_node
 = 
	`cÚš”_of
(
rcu
, 
b©adv_gw_node
,„cu);

35 
	`kä“
(
gw_node
);

36 
	}
}

38 
	$b©adv_ä“_rcu_Ãigh_node
(
rcu_h—d
 *
rcu
)

40 
b©adv_Ãigh_node
 *
Ãigh_node
;

42 
Ãigh_node
 = 
	`cÚš”_of
(
rcu
, 
b©adv_Ãigh_node
,„cu);

43 
	`kä“
(
Ãigh_node
);

44 
	}
}

46 
	$b©adv_ä“_rcu_‰_loÿl_’Œy
(
rcu_h—d
 *
rcu
)

48 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ_’Œy
;

49 
b©adv_‰_loÿl_’Œy
 *
‰_loÿl_’Œy
;

51 
‰_commÚ_’Œy
 = 
	`cÚš”_of
(
rcu
, 
b©adv_‰_commÚ_’Œy
,„cu);

52 
‰_loÿl_’Œy
 = 
	`cÚš”_of
(
‰_commÚ_’Œy
,

53 
b©adv_‰_loÿl_’Œy
, 
commÚ
);

54 
	`kä“
(
‰_loÿl_’Œy
);

55 
	}
}

57 #ifdeà
CONFIG_BATMAN_ADV_BLA


58 
	$b©adv_ä“_rcu_backbÚe_gw
(
rcu_h—d
 *
rcu
)

60 
b©adv_backbÚe_gw
 *
backbÚe_gw
;

62 
backbÚe_gw
 = 
	`cÚš”_of
(
rcu
, 
b©adv_backbÚe_gw
,„cu);

63 
	`kä“
(
backbÚe_gw
);

64 
	}
}

	@compat.h

24 #iâdeà
_NET_BATMAN_ADV_COMPAT_H_


25 
	#_NET_BATMAN_ADV_COMPAT_H_


	)

27 
	~<lšux/v”siÚ.h
>

29 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 30)

31 #undeà
__®loc_³rıu


32 
	#__®loc_³rıu
(
size
, 
®ign
) \

33 
	`³rıu_®loc_mask
((
size
), 
GFP_KERNEL
, 
ıu_possibË_m­
)

	)

38 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 31)

40 
	#__com·t__moduË_·¿m_ÿÎ
(
p1
, 
p2
, 
p3
, 
p4
, 
p5
, 
p6
, 
p7
) \

41 
	`__moduË_·¿m_ÿÎ
(
p1
, 
p2
, 
p3
, 
p4
, 
p5
, 
p7
)

	)

45 
	#__com·t__moduË_·¿m_ÿÎ
(
p1
, 
p2
, 
p3
, 
p4
, 
p5
, 
p6
, 
p7
) \

46 
	`__moduË_·¿m_ÿÎ
(
p1
, 
p2
, 
p3
, 
p4
, 
p5
, 
p6
, 
p7
)

	)

51 #ià(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 33))

52 
	~<lšux/autocÚf.h
>

54 
	~<g’”©ed/autocÚf.h
>

56 
	~"com·t-autocÚf.h
"

58 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 33)

60 
	#__®ways_unu£d
 
	`__©Œibu‹__
((
unu£d
))

	)

61 
	#__³rıu


	)

63 
	#skb_iif
 
iif


	)

68 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 34)

70 
	#hli¡_fœ¡_rcu
(
h—d
è(*((
hli¡_node
 **)(&(h—d)->
fœ¡
)))

	)

71 
	#hli¡_Ãxt_rcu
(
node
è(*((
hli¡_node
 **)(&Òode)->
Ãxt
)))

	)

73 
	#__hli¡_fÜ_—ch_rcu
(
pos
, 
h—d
) \

74 
pos
 = 
	`rcu_d”eã»nû
(
	`hli¡_fœ¡_rcu
(
h—d
)); \

75 
pos
 && ({ 
	`´eãtch
Õos->
Ãxt
); 1; }); \

76 
pos
 = 
	`rcu_d”eã»nû
(
	`hli¡_Ãxt_rcu
Õos)))

	)

78 
	#rcu_d”eã»nû_´Ùeùed
(
p
, 
c
èÕ)

	)

82 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 35)

84 
	#´_w¬n
 
´_w¬nšg


	)

90 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 36)

92 
	#__rcu


	)

93 
	#IFF_BRIDGE_PORT
 0 || (
h¬d_içû
->
Ãt_dev
->
br_pÜt
 ? 1 : 0)

	)

95 
	sk”Ãl_·¿m_İs
 {

97 (*
	m£t
)(cÚ¡ *
	mv®
, cÚ¡ 
k”Ãl_·¿m
 *
	mkp
);

99 (*
	mg‘
)(*
	mbufãr
, 
k”Ãl_·¿m
 *
	mkp
);

101 (*
	mä“
)(*
	m¬g
);

104 
	#moduË_·¿m_cb
(
Çme
, 
İs
, 
¬g
, 
³rm
) \

105 
__com·t_£t_·¿m_
##
	`Çme
(cÚ¡ *
v®
, \

106 
k”Ãl_·¿m
 *
kp
) \

107 {  (
İs
)->
	`£t
(
v®
, 
kp
); } \

108 
__com·t_g‘_·¿m_
##
	`Çme
(*
bufãr
, \

109 
k”Ãl_·¿m
 *
kp
) \

110 {  (
İs
)->
	`g‘
(
bufãr
, 
kp
); } \

111 
	`__com·t__moduË_·¿m_ÿÎ
(
MODULE_PARAM_PREFIX
, 
Çme
, \

112 
__com·t_£t_·¿m_
##
Çme
, \

113 
__com·t_g‘_·¿m_
##
Çme
, 
¬g
, \

114 
	`__§me_ty³
((
¬g
), 
boŞ
 *), 
³rm
)

	)

116 
šlše
 
	$b©adv_·¿m_£t_cİy¡ršg
(cÚ¡ *
v®
,

117 cÚ¡ 
k”Ãl_·¿m
 *
kp
)

119  
	`·¿m_£t_cİy¡ršg
(
v®
, (
k”Ãl_·¿m
 *)
kp
);

120 
	}
}

121 
	#·¿m_£t_cİy¡ršg
 
b©adv_·¿m_£t_cİy¡ršg


	)

124 
	#addr_assign_ty³
 
ifšdex


	)

125 
	#NET_ADDR_RANDOM
 0

	)

130 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 39)

132 
	#k¡¹oul
 
¡riù_¡¹oul


	)

133 
	#k¡¹Ş
 
¡riù_¡¹Ş


	)

138 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 0, 0)

140 
	#kä“_rcu
(
±r
, 
rcu_h—d
è
	`ÿÎ_rcu
(&±r->rcu_h—d, 
b©adv_ä“_rcu_
##±r)

	)

141 
	#vÏn_š£¹_g
(
skb
, 
vid
è
	`__vÏn_put_g
(skb, vid)

	)

143 
b©adv_ä“_rcu_gw_node
(
rcu_h—d
 *
rcu
);

144 
b©adv_ä“_rcu_Ãigh_node
(
rcu_h—d
 *
rcu
);

145 
b©adv_ä“_rcu_‰_loÿl_’Œy
(
rcu_h—d
 *
rcu
);

146 
b©adv_ä“_rcu_backbÚe_gw
(
rcu_h—d
 *
rcu
);

148 
šlše
 
	$skb_»£t_mac_Ën
(
sk_buff
 *
skb
)

150 
skb
->
mac_Ën
 = skb->
ÃtwÜk_h—d”
 - skb->
mac_h—d”
;

151 
	}
}

156 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 4, 0)

158 
šlše
 
	$‘h_hw_addr_¿ndom
(
Ãt_deviû
 *
dev
)

160 
	`¿ndom_‘h”_addr
(
dev
->
dev_addr
);

161 
	}
}

165 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(3, 8, 0)

173 
	#skb_sh¬e_check
(
skb
, 
b
) \

175 
sk_buff
 *
_t_skb
; \

176 
_t_skb
 = 
	`skb_sh¬e_check
(
skb
, 
b
); \

177 ià(
_t_skb
) \

178 
	`skb_»£t_mac_Ën
(
_t_skb
); \

179 
_t_skb
; \

180 })

	)

	@debugfs.c

20 
	~"maš.h
"

22 
	~<lšux/debugfs.h
>

24 
	~"debugfs.h
"

25 
	~"Œª¦©iÚ-bË.h
"

26 
	~"Üigš©Ü.h
"

27 
	~"h¬d-š‹rçû.h
"

28 
	~"g©eway_commÚ.h
"

29 
	~"g©eway_ş›Á.h
"

30 
	~"soá-š‹rçû.h
"

31 
	~"vis.h
"

32 
	~"icmp_sock‘.h
"

33 
	~"bridge_loİ_avoidªû.h
"

35 
d’Œy
 *
	gb©adv_debugfs
;

37 #ifdeà
CONFIG_BATMAN_ADV_DEBUG


38 
	#BATADV_LOG_BUFF_MASK
 (
b©adv_log_buff_Ën
 - 1)

	)

40 cÚ¡ 
	gb©adv_log_buff_Ën
 = 
BATADV_LOG_BUF_LEN
;

42 *
	$b©adv_log_ch¬_addr
(
b©adv_debug_log
 *
debug_log
,

43 
size_t
 
idx
)

45  &
debug_log
->
log_buff
[
idx
 & 
BATADV_LOG_BUFF_MASK
];

46 
	}
}

48 
	$b©adv_em™_log_ch¬
(
b©adv_debug_log
 *
debug_log
, 
c
)

50 *
ch¬_addr
;

52 
ch¬_addr
 = 
	`b©adv_log_ch¬_addr
(
debug_log
, debug_log->
log_’d
);

53 *
ch¬_addr
 = 
c
;

54 
debug_log
->
log_’d
++;

56 ià(
debug_log
->
log_’d
 - debug_log->
log_¡¬t
 > 
b©adv_log_buff_Ën
)

57 
debug_log
->
log_¡¬t
 = debug_log->
log_’d
 - 
b©adv_log_buff_Ën
;

58 
	}
}

60 
	$__´štf
(2, 3)

61 
	$b©adv_fdebug_log
(
b©adv_debug_log
 *
debug_log
,

62 cÚ¡ *
fmt
, ...)

64 
va_li¡
 
¬gs
;

65 
debug_log_buf
[256];

66 *
p
;

68 ià(!
debug_log
)

71 
	`¥š_lock_bh
(&
debug_log
->
lock
);

72 
	`va_¡¬t
(
¬gs
, 
fmt
);

73 
	`vsú´štf
(
debug_log_buf
, (debug_log_buf), 
fmt
, 
¬gs
);

74 
	`va_’d
(
¬gs
);

76 
p
 = 
debug_log_buf
; *p != 0;…++)

77 
	`b©adv_em™_log_ch¬
(
debug_log
, *
p
);

79 
	`¥š_uÆock_bh
(&
debug_log
->
lock
);

81 
	`wake_up
(&
debug_log
->
queue_wa™
);

84 
	}
}

86 
	$b©adv_debug_log
(
b©adv_´iv
 *
b©_´iv
, cÚ¡ *
fmt
, ...)

88 
va_li¡
 
¬gs
;

89 
tmp_log_buf
[256];

91 
	`va_¡¬t
(
¬gs
, 
fmt
);

92 
	`vsú´štf
(
tmp_log_buf
, Ñmp_log_buf), 
fmt
, 
¬gs
);

93 
	`b©adv_fdebug_log
(
b©_´iv
->
debug_log
, "[%10u] %s",

94 
	`jiff›s_to_m£cs
(
jiff›s
), 
tmp_log_buf
);

95 
	`va_’d
(
¬gs
);

98 
	}
}

100 
	$b©adv_log_İ’
(
šode
 *šode, 
fe
 *file)

102 
	`nÚ£ekabË_İ’
(
šode
, 
fe
);

103 
fe
->
´iv©e_d©a
 = 
šode
->
i_´iv©e
;

104 
	`b©adv_šc_moduË_couÁ
();

106 
	}
}

108 
	$b©adv_log_»Ëa£
(
šode
 *šode, 
fe
 *file)

110 
	`b©adv_dec_moduË_couÁ
();

112 
	}
}

114 
	$b©adv_log_em±y
(
b©adv_debug_log
 *
debug_log
)

116  !(
debug_log
->
log_¡¬t
 - debug_log->
log_’d
);

117 
	}
}

119 
ssize_t
 
	$b©adv_log_»ad
(
fe
 *fe, 
__u£r
 *
buf
,

120 
size_t
 
couÁ
, 
loff_t
 *
µos
)

122 
b©adv_´iv
 *
b©_´iv
 = 
fe
->
´iv©e_d©a
;

123 
b©adv_debug_log
 *
debug_log
 = 
b©_´iv
->debug_log;

124 
”rÜ
, 
i
 = 0;

125 *
ch¬_addr
;

126 
c
;

128 ià((
fe
->
f_æags
 & 
O_NONBLOCK
è&& 
	`b©adv_log_em±y
(
debug_log
))

129  -
EAGAIN
;

131 ià(!
buf
)

132  -
EINVAL
;

134 ià(
couÁ
 == 0)

137 ià(!
	`acûss_ok
(
VERIFY_WRITE
, 
buf
, 
couÁ
))

138  -
EFAULT
;

140 
”rÜ
 = 
	`wa™_ev’t_š‹¼u±ibË
(
debug_log
->
queue_wa™
,

141 (!
	`b©adv_log_em±y
(
debug_log
)));

143 ià(
”rÜ
)

144  
”rÜ
;

146 
	`¥š_lock_bh
(&
debug_log
->
lock
);

148 (!
”rÜ
è&& (
i
 < 
couÁ
) &&

149 (
debug_log
->
log_¡¬t
 !ğdebug_log->
log_’d
)) {

150 
ch¬_addr
 = 
	`b©adv_log_ch¬_addr
(
debug_log
,

151 
debug_log
->
log_¡¬t
);

152 
c
 = *
ch¬_addr
;

154 
debug_log
->
log_¡¬t
++;

156 
	`¥š_uÆock_bh
(&
debug_log
->
lock
);

158 
”rÜ
 = 
	`__put_u£r
(
c
, 
buf
);

160 
	`¥š_lock_bh
(&
debug_log
->
lock
);

162 
buf
++;

163 
i
++;

167 
	`¥š_uÆock_bh
(&
debug_log
->
lock
);

169 ià(!
”rÜ
)

170  
i
;

172  
”rÜ
;

173 
	}
}

175 
	$b©adv_log_pŞl
(
fe
 *fe, 
pŞl_bË
 *
wa™
)

177 
b©adv_´iv
 *
b©_´iv
 = 
fe
->
´iv©e_d©a
;

178 
b©adv_debug_log
 *
debug_log
 = 
b©_´iv
->debug_log;

180 
	`pŞl_wa™
(
fe
, &
debug_log
->
queue_wa™
, 
wa™
);

182 ià(!
	`b©adv_log_em±y
(
debug_log
))

183  
POLLIN
 | 
POLLRDNORM
;

186 
	}
}

188 cÚ¡ 
fe_İ”©iÚs
 
	gb©adv_log_fİs
 = {

189 .
İ’
 = 
b©adv_log_İ’
,

190 .
	g»Ëa£
 = 
b©adv_log_»Ëa£
,

191 .
	g»ad
 = 
b©adv_log_»ad
,

192 .
	gpŞl
 = 
b©adv_log_pŞl
,

193 .
	gÎ£ek
 = 
no_Î£ek
,

196 
	$b©adv_debug_log_£tup
(
b©adv_´iv
 *
b©_´iv
)

198 
d’Œy
 *
d
;

200 ià(!
b©_´iv
->
debug_dœ
)

201 
”r
;

203 
b©_´iv
->
debug_log
 = 
	`kz®loc
((*b©_´iv->debug_log), 
GFP_ATOMIC
);

204 ià(!
b©_´iv
->
debug_log
)

205 
”r
;

207 
	`¥š_lock_š™
(&
b©_´iv
->
debug_log
->
lock
);

208 
	`š™_wa™queue_h—d
(&
b©_´iv
->
debug_log
->
queue_wa™
);

210 
d
 = 
	`debugfs_ü—‹_fe
("log", 
S_IFREG
 | 
S_IRUSR
,

211 
b©_´iv
->
debug_dœ
, bat_priv,

212 &
b©adv_log_fİs
);

213 ià(!
d
)

214 
”r
;

218 
”r
:

219  -
ENOMEM
;

220 
	}
}

222 
	$b©adv_debug_log_ş—nup
(
b©adv_´iv
 *
b©_´iv
)

224 
	`kä“
(
b©_´iv
->
debug_log
);

225 
b©_´iv
->
debug_log
 = 
NULL
;

226 
	}
}

228 
	$b©adv_debug_log_£tup
(
b©adv_´iv
 *
b©_´iv
)

230 
b©_´iv
->
debug_log
 = 
NULL
;

232 
	}
}

234 
	$b©adv_debug_log_ş—nup
(
b©adv_´iv
 *
b©_´iv
)

237 
	}
}

240 
	$b©adv_®gÜ™hms_İ’
(
šode
 *šode, 
fe
 *file)

242  
	`sšgË_İ’
(
fe
, 
b©adv_®go_£q_´št_‹xt
, 
NULL
);

243 
	}
}

245 
	$b©adv_Üigš©Üs_İ’
(
šode
 *šode, 
fe
 *file)

247 
Ãt_deviû
 *
Ãt_dev
 = (Ãt_deviû *)
šode
->
i_´iv©e
;

248  
	`sšgË_İ’
(
fe
, 
b©adv_Üig_£q_´št_‹xt
, 
Ãt_dev
);

249 
	}
}

251 
	$b©adv_g©eways_İ’
(
šode
 *šode, 
fe
 *file)

253 
Ãt_deviû
 *
Ãt_dev
 = (Ãt_deviû *)
šode
->
i_´iv©e
;

254  
	`sšgË_İ’
(
fe
, 
b©adv_gw_ş›Á_£q_´št_‹xt
, 
Ãt_dev
);

255 
	}
}

257 
	$b©adv_Œª¡abË_glob®_İ’
(
šode
 *šode, 
fe
 *file)

259 
Ãt_deviû
 *
Ãt_dev
 = (Ãt_deviû *)
šode
->
i_´iv©e
;

260  
	`sšgË_İ’
(
fe
, 
b©adv_‰_glob®_£q_´št_‹xt
, 
Ãt_dev
);

261 
	}
}

263 #ifdeà
CONFIG_BATMAN_ADV_BLA


264 
	$b©adv_bÏ_şaim_bË_İ’
(
šode
 *šode, 
fe
 *file)

266 
Ãt_deviû
 *
Ãt_dev
 = (Ãt_deviû *)
šode
->
i_´iv©e
;

267  
	`sšgË_İ’
(
fe
, 
b©adv_bÏ_şaim_bË_£q_´št_‹xt
,

268 
Ãt_dev
);

269 
	}
}

271 
	$b©adv_bÏ_backbÚe_bË_İ’
(
šode
 *inode,

272 
fe
 *file)

274 
Ãt_deviû
 *
Ãt_dev
 = (Ãt_deviû *)
šode
->
i_´iv©e
;

275  
	`sšgË_İ’
(
fe
, 
b©adv_bÏ_backbÚe_bË_£q_´št_‹xt
,

276 
Ãt_dev
);

277 
	}
}

281 
	$b©adv_Œª¡abË_loÿl_İ’
(
šode
 *šode, 
fe
 *file)

283 
Ãt_deviû
 *
Ãt_dev
 = (Ãt_deviû *)
šode
->
i_´iv©e
;

284  
	`sšgË_İ’
(
fe
, 
b©adv_‰_loÿl_£q_´št_‹xt
, 
Ãt_dev
);

285 
	}
}

287 
	$b©adv_vis_d©a_İ’
(
šode
 *šode, 
fe
 *file)

289 
Ãt_deviû
 *
Ãt_dev
 = (Ãt_deviû *)
šode
->
i_´iv©e
;

290  
	`sšgË_İ’
(
fe
, 
b©adv_vis_£q_´št_‹xt
, 
Ãt_dev
);

291 
	}
}

293 
	sb©adv_debugšfo
 {

294 
©Œibu‹
 
	m©Œ
;

295 cÚ¡ 
fe_İ”©iÚs
 
	mfİs
;

298 
	#BATADV_DEBUGINFO
(
_Çme
, 
_mode
, 
_İ’
) \

299 
b©adv_debugšfo
 
b©adv_debugšfo_
##
_Çme
 = { \

300 .
©Œ
 = { .
Çme
 = 
	`__¡ršgify
(
_Çme
), \

301 .
mode
 = 
_mode
, }, \

302 .
fİs
 = { .
owÃr
 = 
THIS_MODULE
, \

303 .
İ’
 = 
_İ’
, \

304 .
»ad
 = 
£q_»ad
, \

305 .
Î£ek
 = 
£q_l£ek
, \

306 .
»Ëa£
 = 
sšgË_»Ëa£
, \

308 };

	)

310 
BATADV_DEBUGINFO
(
routšg_®gos
, 
S_IRUGO
, 
b©adv_®gÜ™hms_İ’
);

311 
BATADV_DEBUGINFO
(
Üigš©Üs
, 
S_IRUGO
, 
b©adv_Üigš©Üs_İ’
);

312 
BATADV_DEBUGINFO
(
g©eways
, 
S_IRUGO
, 
b©adv_g©eways_İ’
);

313 
BATADV_DEBUGINFO
(
Œª¡abË_glob®
, 
S_IRUGO
,

314 
b©adv_Œª¡abË_glob®_İ’
);

315 #ifdeà
CONFIG_BATMAN_ADV_BLA


316 
BATADV_DEBUGINFO
(
bÏ_şaim_bË
, 
S_IRUGO
, 
b©adv_bÏ_şaim_bË_İ’
);

317 
BATADV_DEBUGINFO
(
bÏ_backbÚe_bË
, 
S_IRUGO
,

318 
b©adv_bÏ_backbÚe_bË_İ’
);

320 
BATADV_DEBUGINFO
(
Œª¡abË_loÿl
, 
S_IRUGO
,

321 
b©adv_Œª¡abË_loÿl_İ’
);

322 
BATADV_DEBUGINFO
(
vis_d©a
, 
S_IRUGO
, 
b©adv_vis_d©a_İ’
);

324 
b©adv_debugšfo
 *
	gb©adv_mesh_debugšfos
[] = {

325 &
b©adv_debugšfo_Üigš©Üs
,

326 &
b©adv_debugšfo_g©eways
,

327 &
b©adv_debugšfo_Œª¡abË_glob®
,

328 #ifdeà
CONFIG_BATMAN_ADV_BLA


329 &
b©adv_debugšfo_bÏ_şaim_bË
,

330 &
b©adv_debugšfo_bÏ_backbÚe_bË
,

332 &
b©adv_debugšfo_Œª¡abË_loÿl
,

333 &
b©adv_debugšfo_vis_d©a
,

334 
NULL
,

337 
	$b©adv_debugfs_š™
()

339 
b©adv_debugšfo
 *
b©_debug
;

340 
d’Œy
 *
fe
;

342 
b©adv_debugfs
 = 
	`debugfs_ü—‹_dœ
(
BATADV_DEBUGFS_SUBDIR
, 
NULL
);

343 ià(
b©adv_debugfs
 =ğ
	`ERR_PTR
(-
ENODEV
))

344 
b©adv_debugfs
 = 
NULL
;

346 ià(!
b©adv_debugfs
)

347 
out
;

349 
b©_debug
 = &
b©adv_debugšfo_routšg_®gos
;

350 
fe
 = 
	`debugfs_ü—‹_fe
(
b©_debug
->
©Œ
.
Çme
,

351 
S_IFREG
 | 
b©_debug
->
©Œ
.
mode
,

352 
b©adv_debugfs
, 
NULL
, &
b©_debug
->
fİs
);

353 ià(!
fe
)

354 
	`´_”r
("Cª'ˆadd debugf fe: %s\n", 
b©_debug
->
©Œ
.
Çme
);

356 
out
:

358 
	}
}

360 
	$b©adv_debugfs_de¡roy
()

362 ià(
b©adv_debugfs
) {

363 
	`debugfs_»move_»cursive
(
b©adv_debugfs
);

364 
b©adv_debugfs
 = 
NULL
;

366 
	}
}

368 
	$b©adv_debugfs_add_meshif
(
Ãt_deviû
 *
dev
)

370 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
dev
);

371 
b©adv_debugšfo
 **
b©_debug
;

372 
d’Œy
 *
fe
;

374 ià(!
b©adv_debugfs
)

375 
out
;

377 
b©_´iv
->
debug_dœ
 = 
	`debugfs_ü—‹_dœ
(
dev
->
Çme
, 
b©adv_debugfs
);

378 ià(!
b©_´iv
->
debug_dœ
)

379 
out
;

381 ià(
	`b©adv_sock‘_£tup
(
b©_´iv
) < 0)

382 
»m_©Œ
;

384 ià(
	`b©adv_debug_log_£tup
(
b©_´iv
) < 0)

385 
»m_©Œ
;

387 
b©_debug
 = 
b©adv_mesh_debugšfos
; *bat_debug; ++bat_debug) {

388 
fe
 = 
	`debugfs_ü—‹_fe
(((*
b©_debug
)->
©Œ
).
Çme
,

389 
S_IFREG
 | ((*
b©_debug
)->
©Œ
).
mode
,

390 
b©_´iv
->
debug_dœ
,

391 
dev
, &(*
b©_debug
)->
fİs
);

392 ià(!
fe
) {

393 
	`b©adv_”r
(
dev
, "Can't‡dd debugfs file: %s/%s\n",

394 
dev
->
Çme
, ((*
b©_debug
)->
©Œ
).name);

395 
»m_©Œ
;

400 
»m_©Œ
:

401 
	`debugfs_»move_»cursive
(
b©_´iv
->
debug_dœ
);

402 
b©_´iv
->
debug_dœ
 = 
NULL
;

403 
out
:

404 #ifdeà
CONFIG_DEBUG_FS


405  -
ENOMEM
;

409 
	}
}

411 
	$b©adv_debugfs_d–_meshif
(
Ãt_deviû
 *
dev
)

413 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
dev
);

415 
	`b©adv_debug_log_ş—nup
(
b©_´iv
);

417 ià(
b©adv_debugfs
) {

418 
	`debugfs_»move_»cursive
(
b©_´iv
->
debug_dœ
);

419 
b©_´iv
->
debug_dœ
 = 
NULL
;

421 
	}
}

	@debugfs.h

20 #iâdeà
_NET_BATMAN_ADV_DEBUGFS_H_


21 
	#_NET_BATMAN_ADV_DEBUGFS_H_


	)

23 
	#BATADV_DEBUGFS_SUBDIR
 "b©mª_adv"

	)

25 
b©adv_debugfs_š™
();

26 
b©adv_debugfs_de¡roy
();

27 
b©adv_debugfs_add_meshif
(
Ãt_deviû
 *
dev
);

28 
b©adv_debugfs_d–_meshif
(
Ãt_deviû
 *
dev
);

	@gateway_client.c

20 
	~"maš.h
"

21 
	~"sysfs.h
"

22 
	~"g©eway_ş›Á.h
"

23 
	~"g©eway_commÚ.h
"

24 
	~"h¬d-š‹rçû.h
"

25 
	~"Üigš©Ü.h
"

26 
	~"Œª¦©iÚ-bË.h
"

27 
	~"routšg.h
"

28 
	~<lšux/.h
>

29 
	~<lšux/v6.h
>

30 
	~<lšux/udp.h
>

31 
	~<lšux/if_vÏn.h
>

36 
	#BATADV_DHCP_OPTIONS_OFFSET
 240

	)

37 
	#BATADV_DHCP_REQUEST
 3

	)

39 
	$b©adv_gw_node_ä“_»f
(
b©adv_gw_node
 *
gw_node
)

41 ià(
	`©omic_dec_ªd_‹¡
(&
gw_node
->
»fcouÁ
))

42 
	`kä“_rcu
(
gw_node
, 
rcu
);

43 
	}
}

45 
b©adv_gw_node
 *

46 
	$b©adv_gw_g‘_£Ëùed_gw_node
(
b©adv_´iv
 *
b©_´iv
)

48 
b©adv_gw_node
 *
gw_node
;

50 
	`rcu_»ad_lock
();

51 
gw_node
 = 
	`rcu_d”eã»nû
(
b©_´iv
->
gw
.
cu¼_gw
);

52 ià(!
gw_node
)

53 
out
;

55 ià(!
	`©omic_šc_nÙ_z”o
(&
gw_node
->
»fcouÁ
))

56 
gw_node
 = 
NULL
;

58 
out
:

59 
	`rcu_»ad_uÆock
();

60  
gw_node
;

61 
	}
}

63 
b©adv_Üig_node
 *

64 
	$b©adv_gw_g‘_£Ëùed_Üig
(
b©adv_´iv
 *
b©_´iv
)

66 
b©adv_gw_node
 *
gw_node
;

67 
b©adv_Üig_node
 *
Üig_node
 = 
NULL
;

69 
gw_node
 = 
	`b©adv_gw_g‘_£Ëùed_gw_node
(
b©_´iv
);

70 ià(!
gw_node
)

71 
out
;

73 
	`rcu_»ad_lock
();

74 
Üig_node
 = 
gw_node
->orig_node;

75 ià(!
Üig_node
)

76 
uÆock
;

78 ià(!
	`©omic_šc_nÙ_z”o
(&
Üig_node
->
»fcouÁ
))

79 
Üig_node
 = 
NULL
;

81 
uÆock
:

82 
	`rcu_»ad_uÆock
();

83 
out
:

84 ià(
gw_node
)

85 
	`b©adv_gw_node_ä“_»f
(
gw_node
);

86  
Üig_node
;

87 
	}
}

89 
	$b©adv_gw_£Ëù
(
b©adv_´iv
 *
b©_´iv
,

90 
b©adv_gw_node
 *
Ãw_gw_node
)

92 
b©adv_gw_node
 *
cu¼_gw_node
;

94 
	`¥š_lock_bh
(&
b©_´iv
->
gw
.
li¡_lock
);

96 ià(
Ãw_gw_node
 && !
	`©omic_šc_nÙ_z”o
(&Ãw_gw_node->
»fcouÁ
))

97 
Ãw_gw_node
 = 
NULL
;

99 
cu¼_gw_node
 = 
	`rcu_d”eã»nû_´Ùeùed
(
b©_´iv
->
gw
.
cu¼_gw
, 1);

100 
	`rcu_assign_poš‹r
(
b©_´iv
->
gw
.
cu¼_gw
, 
Ãw_gw_node
);

102 ià(
cu¼_gw_node
)

103 
	`b©adv_gw_node_ä“_»f
(
cu¼_gw_node
);

105 
	`¥š_uÆock_bh
(&
b©_´iv
->
gw
.
li¡_lock
);

106 
	}
}

108 
	$b©adv_gw_de£Ëù
(
b©adv_´iv
 *
b©_´iv
)

110 
	`©omic_£t
(&
b©_´iv
->
gw
.
»£Ëù
, 1);

111 
	}
}

113 
b©adv_gw_node
 *

114 
	$b©adv_gw_g‘_be¡_gw_node
(
b©adv_´iv
 *
b©_´iv
)

116 
b©adv_Ãigh_node
 *
rou‹r
;

117 
hli¡_node
 *
node
;

118 
b©adv_gw_node
 *
gw_node
, *
cu¼_gw
 = 
NULL
;

119 
ušt32_t
 
max_gw_çùÜ
 = 0, 
tmp_gw_çùÜ
 = 0;

120 
ušt32_t
 
gw_divisÜ
;

121 
ušt8_t
 
max_tq
 = 0;

122 
down
, 
up
;

123 
ušt8_t
 
tq_avg
;

124 
b©adv_Üig_node
 *
Üig_node
;

126 
gw_divisÜ
 = 
BATADV_TQ_LOCAL_WINDOW_SIZE
 * BATADV_TQ_LOCAL_WINDOW_SIZE;

127 
gw_divisÜ
 *= 64;

129 
	`rcu_»ad_lock
();

130 
	`hli¡_fÜ_—ch_’Œy_rcu
(
gw_node
, 
node
, &
b©_´iv
->
gw
.
li¡
,†ist) {

131 ià(
gw_node
->
d–‘ed
)

134 
Üig_node
 = 
gw_node
->orig_node;

135 
rou‹r
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_node
);

136 ià(!
rou‹r
)

139 ià(!
	`©omic_šc_nÙ_z”o
(&
gw_node
->
»fcouÁ
))

140 
Ãxt
;

142 
tq_avg
 = 
rou‹r
->tq_avg;

144 
	`©omic_»ad
(&
b©_´iv
->
gw_£l_şass
)) {

146 
	`b©adv_gw_bªdwidth_to_kb™
(
Üig_node
->
gw_æags
,

147 &
down
, &
up
);

149 
tmp_gw_çùÜ
 = 
tq_avg
 *q_avg * 
down
 * 100 * 100;

150 
tmp_gw_çùÜ
 /ğ
gw_divisÜ
;

152 ià((
tmp_gw_çùÜ
 > 
max_gw_çùÜ
) ||

153 ((
tmp_gw_çùÜ
 =ğ
max_gw_çùÜ
) &&

154 (
tq_avg
 > 
max_tq
))) {

155 ià(
cu¼_gw
)

156 
	`b©adv_gw_node_ä“_»f
(
cu¼_gw
);

157 
cu¼_gw
 = 
gw_node
;

158 
	`©omic_šc
(&
cu¼_gw
->
»fcouÁ
);

169 ià(
tq_avg
 > 
max_tq
) {

170 ià(
cu¼_gw
)

171 
	`b©adv_gw_node_ä“_»f
(
cu¼_gw
);

172 
cu¼_gw
 = 
gw_node
;

173 
	`©omic_šc
(&
cu¼_gw
->
»fcouÁ
);

178 ià(
tq_avg
 > 
max_tq
)

179 
max_tq
 = 
tq_avg
;

181 ià(
tmp_gw_çùÜ
 > 
max_gw_çùÜ
)

182 
max_gw_çùÜ
 = 
tmp_gw_çùÜ
;

184 
	`b©adv_gw_node_ä“_»f
(
gw_node
);

186 
Ãxt
:

187 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r
);

189 
	`rcu_»ad_uÆock
();

191  
cu¼_gw
;

192 
	}
}

194 
	$b©adv_gw_–eùiÚ
(
b©adv_´iv
 *
b©_´iv
)

196 
b©adv_gw_node
 *
cu¼_gw
 = 
NULL
, *
Ãxt_gw
 = NULL;

197 
b©adv_Ãigh_node
 *
rou‹r
 = 
NULL
;

198 
gw_addr
[18] = { '\0' };

205 ià(
	`©omic_»ad
(&
b©_´iv
->
gw_mode
è!ğ
BATADV_GW_MODE_CLIENT
)

206 
out
;

208 
cu¼_gw
 = 
	`b©adv_gw_g‘_£Ëùed_gw_node
(
b©_´iv
);

210 ià(!
	`b©adv_©omic_dec_nÙ_z”o
(&
b©_´iv
->
gw
.
»£Ëù
è&& 
cu¼_gw
)

211 
out
;

213 
Ãxt_gw
 = 
	`b©adv_gw_g‘_be¡_gw_node
(
b©_´iv
);

215 ià(
cu¼_gw
 =ğ
Ãxt_gw
)

216 
out
;

218 ià(
Ãxt_gw
) {

219 
	`¥rštf
(
gw_addr
, "%pM", 
Ãxt_gw
->
Üig_node
->
Üig
);

221 
rou‹r
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Ãxt_gw
->
Üig_node
);

222 ià(!
rou‹r
) {

223 
	`b©adv_gw_de£Ëù
(
b©_´iv
);

224 
out
;

228 ià((
cu¼_gw
è&& (!
Ãxt_gw
)) {

229 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

231 
	`b©adv_throw_uev’t
(
b©_´iv
, 
BATADV_UEV_GW
, 
BATADV_UEV_DEL
,

232 
NULL
);

233 } ià((!
cu¼_gw
è&& (
Ãxt_gw
)) {

234 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

236 
Ãxt_gw
->
Üig_node
->
Üig
,

237 
Ãxt_gw
->
Üig_node
->
gw_æags
, 
rou‹r
->
tq_avg
);

238 
	`b©adv_throw_uev’t
(
b©_´iv
, 
BATADV_UEV_GW
, 
BATADV_UEV_ADD
,

239 
gw_addr
);

241 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

243 
Ãxt_gw
->
Üig_node
->
Üig
,

244 
Ãxt_gw
->
Üig_node
->
gw_æags
, 
rou‹r
->
tq_avg
);

245 
	`b©adv_throw_uev’t
(
b©_´iv
, 
BATADV_UEV_GW
, 
BATADV_UEV_CHANGE
,

246 
gw_addr
);

249 
	`b©adv_gw_£Ëù
(
b©_´iv
, 
Ãxt_gw
);

251 
out
:

252 ià(
cu¼_gw
)

253 
	`b©adv_gw_node_ä“_»f
(
cu¼_gw
);

254 ià(
Ãxt_gw
)

255 
	`b©adv_gw_node_ä“_»f
(
Ãxt_gw
);

256 ià(
rou‹r
)

257 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r
);

258 
	}
}

260 
	$b©adv_gw_check_–eùiÚ
(
b©adv_´iv
 *
b©_´iv
,

261 
b©adv_Üig_node
 *
Üig_node
)

263 
b©adv_Üig_node
 *
cu¼_gw_Üig
;

264 
b©adv_Ãigh_node
 *
rou‹r_gw
 = 
NULL
, *
rou‹r_Üig
 = NULL;

265 
ušt8_t
 
gw_tq_avg
, 
Üig_tq_avg
;

267 
cu¼_gw_Üig
 = 
	`b©adv_gw_g‘_£Ëùed_Üig
(
b©_´iv
);

268 ià(!
cu¼_gw_Üig
)

269 
de£Ëù
;

271 
rou‹r_gw
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
cu¼_gw_Üig
);

272 ià(!
rou‹r_gw
)

273 
de£Ëù
;

276 ià(
cu¼_gw_Üig
 =ğ
Üig_node
)

277 
out
;

279 
rou‹r_Üig
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_node
);

280 ià(!
rou‹r_Üig
)

281 
out
;

283 
gw_tq_avg
 = 
rou‹r_gw
->
tq_avg
;

284 
Üig_tq_avg
 = 
rou‹r_Üig
->
tq_avg
;

287 ià(
Üig_tq_avg
 < 
gw_tq_avg
)

288 
out
;

293 ià((
	`©omic_»ad
(&
b©_´iv
->
gw_£l_şass
) > 3) &&

294 (
Üig_tq_avg
 - 
gw_tq_avg
 < 
	`©omic_»ad
(&
b©_´iv
->
gw_£l_şass
)))

295 
out
;

297 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

299 
gw_tq_avg
, 
Üig_tq_avg
);

301 
de£Ëù
:

302 
	`b©adv_gw_de£Ëù
(
b©_´iv
);

303 
out
:

304 ià(
cu¼_gw_Üig
)

305 
	`b©adv_Üig_node_ä“_»f
(
cu¼_gw_Üig
);

306 ià(
rou‹r_gw
)

307 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r_gw
);

308 ià(
rou‹r_Üig
)

309 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r_Üig
);

312 
	}
}

314 
	$b©adv_gw_node_add
(
b©adv_´iv
 *
b©_´iv
,

315 
b©adv_Üig_node
 *
Üig_node
,

316 
ušt8_t
 
Ãw_gwæags
)

318 
b©adv_gw_node
 *
gw_node
;

319 
down
, 
up
;

321 
gw_node
 = 
	`kz®loc
((*gw_node), 
GFP_ATOMIC
);

322 ià(!
gw_node
)

325 
	`INIT_HLIST_NODE
(&
gw_node
->
li¡
);

326 
gw_node
->
Üig_node
 = orig_node;

327 
	`©omic_£t
(&
gw_node
->
»fcouÁ
, 1);

329 
	`¥š_lock_bh
(&
b©_´iv
->
gw
.
li¡_lock
);

330 
	`hli¡_add_h—d_rcu
(&
gw_node
->
li¡
, &
b©_´iv
->
gw
.list);

331 
	`¥š_uÆock_bh
(&
b©_´iv
->
gw
.
li¡_lock
);

333 
	`b©adv_gw_bªdwidth_to_kb™
(
Ãw_gwæags
, &
down
, &
up
);

334 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

336 
Üig_node
->
Üig
, 
Ãw_gwæags
,

337 (
down
 > 2048 ? down / 1024 : down),

338 (
down
 > 2048 ? "MBit" : "KBit"),

339 (
up
 > 2048 ? up / 1024 : up),

340 (
up
 > 2048 ? "MBit" : "KBit"));

341 
	}
}

343 
	$b©adv_gw_node_upd©e
(
b©adv_´iv
 *
b©_´iv
,

344 
b©adv_Üig_node
 *
Üig_node
,

345 
ušt8_t
 
Ãw_gwæags
)

347 
hli¡_node
 *
node
;

348 
b©adv_gw_node
 *
gw_node
, *
cu¼_gw
;

355 
cu¼_gw
 = 
	`b©adv_gw_g‘_£Ëùed_gw_node
(
b©_´iv
);

357 
	`rcu_»ad_lock
();

358 
	`hli¡_fÜ_—ch_’Œy_rcu
(
gw_node
, 
node
, &
b©_´iv
->
gw
.
li¡
,†ist) {

359 ià(
gw_node
->
Üig_node
 != orig_node)

362 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

364 
Üig_node
->
Üig
, 
gw_node
->Üig_node->
gw_æags
,

365 
Ãw_gwæags
);

367 
gw_node
->
d–‘ed
 = 0;

369 ià(
Ãw_gwæags
 =ğ
BATADV_NO_FLAGS
) {

370 
gw_node
->
d–‘ed
 = 
jiff›s
;

371 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

373 
Üig_node
->
Üig
);

375 ià(
gw_node
 =ğ
cu¼_gw
)

376 
de£Ëù
;

379 
uÆock
;

382 ià(
Ãw_gwæags
 =ğ
BATADV_NO_FLAGS
)

383 
uÆock
;

385 
	`b©adv_gw_node_add
(
b©_´iv
, 
Üig_node
, 
Ãw_gwæags
);

386 
uÆock
;

388 
de£Ëù
:

389 
	`b©adv_gw_de£Ëù
(
b©_´iv
);

390 
uÆock
:

391 
	`rcu_»ad_uÆock
();

393 ià(
cu¼_gw
)

394 
	`b©adv_gw_node_ä“_»f
(
cu¼_gw
);

395 
	}
}

397 
	$b©adv_gw_node_d–‘e
(
b©adv_´iv
 *
b©_´iv
,

398 
b©adv_Üig_node
 *
Üig_node
)

400 
	`b©adv_gw_node_upd©e
(
b©_´iv
, 
Üig_node
, 0);

401 
	}
}

403 
	$b©adv_gw_node_purge
(
b©adv_´iv
 *
b©_´iv
)

405 
b©adv_gw_node
 *
gw_node
, *
cu¼_gw
;

406 
hli¡_node
 *
node
, *
node_tmp
;

407 
timeout
 = 
	`m£cs_to_jiff›s
(2 * 
BATADV_PURGE_TIMEOUT
);

408 
do_de£Ëù
 = 0;

410 
cu¼_gw
 = 
	`b©adv_gw_g‘_£Ëùed_gw_node
(
b©_´iv
);

412 
	`¥š_lock_bh
(&
b©_´iv
->
gw
.
li¡_lock
);

414 
	`hli¡_fÜ_—ch_’Œy_§ã
(
gw_node
, 
node
, 
node_tmp
,

415 &
b©_´iv
->
gw
.
li¡
,†ist) {

416 ià(((!
gw_node
->
d–‘ed
) ||

417 (
	`time_befÜe
(
jiff›s
, 
gw_node
->
d–‘ed
 + 
timeout
))) &&

418 
	`©omic_»ad
(&
b©_´iv
->
mesh_¡©e
è=ğ
BATADV_MESH_ACTIVE
)

421 ià(
cu¼_gw
 =ğ
gw_node
)

422 
do_de£Ëù
 = 1;

424 
	`hli¡_d–_rcu
(&
gw_node
->
li¡
);

425 
	`b©adv_gw_node_ä“_»f
(
gw_node
);

428 
	`¥š_uÆock_bh
(&
b©_´iv
->
gw
.
li¡_lock
);

431 ià(
do_de£Ëù
)

432 
	`b©adv_gw_de£Ëù
(
b©_´iv
);

434 ià(
cu¼_gw
)

435 
	`b©adv_gw_node_ä“_»f
(
cu¼_gw
);

436 
	}
}

439 
	$b©adv_wr™e_bufãr_‹xt
(
b©adv_´iv
 *
b©_´iv
,

440 
£q_fe
 *
£q
,

441 cÚ¡ 
b©adv_gw_node
 *
gw_node
)

443 
b©adv_gw_node
 *
cu¼_gw
;

444 
b©adv_Ãigh_node
 *
rou‹r
;

445 
down
, 
up
, 
»t
 = -1;

447 
	`b©adv_gw_bªdwidth_to_kb™
(
gw_node
->
Üig_node
->
gw_æags
, &
down
, &
up
);

449 
rou‹r
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
gw_node
->
Üig_node
);

450 ià(!
rou‹r
)

451 
out
;

453 
cu¼_gw
 = 
	`b©adv_gw_g‘_£Ëùed_gw_node
(
b©_´iv
);

455 
»t
 = 
	`£q_´štf
(
£q
, "%s %pM (%3i) %pM [%10s]: %3i - %i%s/%i%s\n",

456 (
cu¼_gw
 =ğ
gw_node
 ? "=>" : " "),

457 
gw_node
->
Üig_node
->
Üig
,

458 
rou‹r
->
tq_avg
,„ou‹r->
addr
,

459 
rou‹r
->
if_šcomšg
->
Ãt_dev
->
Çme
,

460 
gw_node
->
Üig_node
->
gw_æags
,

461 (
down
 > 2048 ? down / 1024 : down),

462 (
down
 > 2048 ? "MBit" : "KBit"),

463 (
up
 > 2048 ? up / 1024 : up),

464 (
up
 > 2048 ? "MBit" : "KBit"));

466 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r
);

467 ià(
cu¼_gw
)

468 
	`b©adv_gw_node_ä“_»f
(
cu¼_gw
);

469 
out
:

470  
»t
;

471 
	}
}

473 
	$b©adv_gw_ş›Á_£q_´št_‹xt
(
£q_fe
 *
£q
, *
off£t
)

475 
Ãt_deviû
 *
Ãt_dev
 = (Ãt_deviû *)
£q
->
´iv©e
;

476 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
Ãt_dev
);

477 
b©adv_h¬d_içû
 *
´im¬y_if
;

478 
b©adv_gw_node
 *
gw_node
;

479 
hli¡_node
 *
node
;

480 
gw_couÁ
 = 0, 
»t
 = 0;

482 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

483 ià(!
´im¬y_if
) {

484 
»t
 = 
	`£q_´štf
(
£q
,

486 
Ãt_dev
->
Çme
);

487 
out
;

490 ià(
´im¬y_if
->
if_¡©us
 !ğ
BATADV_IF_ACTIVE
) {

491 
»t
 = 
	`£q_´štf
(
£q
,

493 
Ãt_dev
->
Çme
);

494 
out
;

497 
	`£q_´štf
(
£q
,

499 "G©eway", "#", 
BATADV_TQ_MAX_VALUE
, "Nexthop", "outgoingIF",

500 
BATADV_SOURCE_VERSION
, 
´im¬y_if
->
Ãt_dev
->
Çme
,

501 
´im¬y_if
->
Ãt_dev
->
dev_addr
,‚‘_dev->
Çme
);

503 
	`rcu_»ad_lock
();

504 
	`hli¡_fÜ_—ch_’Œy_rcu
(
gw_node
, 
node
, &
b©_´iv
->
gw
.
li¡
,†ist) {

505 ià(
gw_node
->
d–‘ed
)

509 ià(
	`b©adv_wr™e_bufãr_‹xt
(
b©_´iv
, 
£q
, 
gw_node
) < 0)

512 
gw_couÁ
++;

514 
	`rcu_»ad_uÆock
();

516 ià(
gw_couÁ
 == 0)

517 
	`£q_´štf
(
£q
, "No gateways in„ange ...\n");

519 
out
:

520 ià(
´im¬y_if
)

521 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

522  
»t
;

523 
	}
}

525 
boŞ
 
	$b©adv_is_ty³_dhı»que¡
(
sk_buff
 *
skb
, 
h—d”_Ën
)

527 
»t
 = 
çl£
;

528 *
p
;

529 
pkt_Ën
;

531 ià(
	`skb_lš—rize
(
skb
) < 0)

532 
out
;

534 
pkt_Ën
 = 
	`skb_h—dËn
(
skb
);

536 ià(
pkt_Ën
 < 
h—d”_Ën
 + 
BATADV_DHCP_OPTIONS_OFFSET
 + 1)

537 
out
;

539 
p
 = 
skb
->
d©a
 + 
h—d”_Ën
 + 
BATADV_DHCP_OPTIONS_OFFSET
;

540 
pkt_Ën
 -ğ
h—d”_Ën
 + 
BATADV_DHCP_OPTIONS_OFFSET
 + 1;

547 *
p
 !ğ255 && !
»t
) {

549 ià(*
p
 == 53) {

553 ià(
pkt_Ën
 < 2)

554 
out
;

555 
p
 += 2;

558 ià(*
p
 =ğ
BATADV_DHCP_REQUEST
)

559 
»t
 = 
Œue
;

561 } ià(*
p
 == 0) {

563 ià(
pkt_Ën
 < 1)

564 
out
;

565 
pkt_Ën
--;

566 
p
++;

569 ià(
pkt_Ën
 < 1)

570 
out
;

571 
pkt_Ën
--;

572 
p
++;

575 ià(
pkt_Ën
 < 1 + (*
p
))

576 
out
;

577 
pkt_Ën
 -ğ1 + (*
p
);

578 
p
 += 1 + (*p);

581 
out
:

582  
»t
;

583 
	}
}

585 
boŞ
 
	$b©adv_gw_is_dhı_rg‘
(
sk_buff
 *
skb
, *
h—d”_Ën
)

587 
‘hhdr
 *ethhdr;

588 
hdr
 *iphdr;

589 
v6hdr
 *ipv6hdr;

590 
udphdr
 *udphdr;

593 ià(!
	`pskb_may_puÎ
(
skb
, *
h—d”_Ën
 + 
ETH_HLEN
))

594  
çl£
;

595 
‘hhdr
 = (‘hhd¸*)
skb
->
d©a
;

596 *
h—d”_Ën
 +ğ
ETH_HLEN
;

599 ià(
	`Áohs
(
‘hhdr
->
h_´Ùo
è=ğ
ETH_P_8021Q
) {

600 ià(!
	`pskb_may_puÎ
(
skb
, *
h—d”_Ën
 + 
VLAN_HLEN
))

601  
çl£
;

602 
‘hhdr
 = (‘hhd¸*)(
skb
->
d©a
 + 
VLAN_HLEN
);

603 *
h—d”_Ën
 +ğ
VLAN_HLEN
;

607 
	`Áohs
(
‘hhdr
->
h_´Ùo
)) {

608 
ETH_P_IP
:

609 ià(!
	`pskb_may_puÎ
(
skb
, *
h—d”_Ën
 + (*
hdr
)))

610  
çl£
;

611 
hdr
 = (hd¸*)(
skb
->
d©a
 + *
h—d”_Ën
);

612 *
h—d”_Ën
 +ğ
hdr
->
ihl
 * 4;

615 ià(
hdr
->
´ÙocŞ
 !ğ
IPPROTO_UDP
)

616  
çl£
;

619 
ETH_P_IPV6
:

620 ià(!
	`pskb_may_puÎ
(
skb
, *
h—d”_Ën
 + (*
v6hdr
)))

621  
çl£
;

622 
v6hdr
 = (v6hd¸*)(
skb
->
d©a
 + *
h—d”_Ën
);

623 *
h—d”_Ën
 +ğ(*
v6hdr
);

626 ià(
v6hdr
->
Ãxthdr
 !ğ
IPPROTO_UDP
)

627  
çl£
;

631  
çl£
;

634 ià(!
	`pskb_may_puÎ
(
skb
, *
h—d”_Ën
 + (*
udphdr
)))

635  
çl£
;

636 
udphdr
 = (udphd¸*)(
skb
->
d©a
 + *
h—d”_Ën
);

637 *
h—d”_Ën
 +ğ(*
udphdr
);

640 ià((
	`Áohs
(
‘hhdr
->
h_´Ùo
è=ğ
ETH_P_IP
) &&

641 (
	`Áohs
(
udphdr
->
de¡
) != 67))

642  
çl£
;

644 ià((
	`Áohs
(
‘hhdr
->
h_´Ùo
è=ğ
ETH_P_IPV6
) &&

645 (
	`Áohs
(
udphdr
->
de¡
) != 547))

646  
çl£
;

648  
Œue
;

649 
	}
}

651 
boŞ
 
	$b©adv_gw_out_of_¿nge
(
b©adv_´iv
 *
b©_´iv
,

652 
sk_buff
 *
skb
, 
‘hhdr
 *ethhdr)

654 
b©adv_Ãigh_node
 *
Ãigh_cu¼
 = 
NULL
, *
Ãigh_Şd
 = NULL;

655 
b©adv_Üig_node
 *
Üig_d¡_node
 = 
NULL
;

656 
b©adv_gw_node
 *
cu¼_gw
 = 
NULL
;

657 
boŞ
 
»t
, 
out_of_¿nge
 = 
çl£
;

658 
h—d”_Ën
 = 0;

659 
ušt8_t
 
cu¼_tq_avg
;

661 
»t
 = 
	`b©adv_gw_is_dhı_rg‘
(
skb
, &
h—d”_Ën
);

662 ià(!
»t
)

663 
out
;

665 
Üig_d¡_node
 = 
	`b©adv_Œª¡abË_£¬ch
(
b©_´iv
, 
‘hhdr
->
h_sourû
,

666 
‘hhdr
->
h_de¡
);

667 ià(!
Üig_d¡_node
)

668 
out
;

670 ià(!
Üig_d¡_node
->
gw_æags
)

671 
out
;

673 
»t
 = 
	`b©adv_is_ty³_dhı»que¡
(
skb
, 
h—d”_Ën
);

674 ià(!
»t
)

675 
out
;

677 
	`©omic_»ad
(&
b©_´iv
->
gw_mode
)) {

678 
BATADV_GW_MODE_SERVER
:

682 
cu¼_tq_avg
 = 
BATADV_TQ_MAX_VALUE
;

684 
BATADV_GW_MODE_CLIENT
:

685 
cu¼_gw
 = 
	`b©adv_gw_g‘_£Ëùed_gw_node
(
b©_´iv
);

686 ià(!
cu¼_gw
)

687 
out
;

690 ià(
cu¼_gw
->
Üig_node
 =ğ
Üig_d¡_node
)

691 
out
;

697 
Ãigh_cu¼
 = 
	`b©adv_fšd_rou‹r
(
b©_´iv
, 
cu¼_gw
->
Üig_node
,

698 
NULL
);

699 ià(!
Ãigh_cu¼
)

700 
out
;

702 
cu¼_tq_avg
 = 
Ãigh_cu¼
->
tq_avg
;

704 
BATADV_GW_MODE_OFF
:

706 
out
;

709 
Ãigh_Şd
 = 
	`b©adv_fšd_rou‹r
(
b©_´iv
, 
Üig_d¡_node
, 
NULL
);

710 ià(!
Ãigh_Şd
)

711 
out
;

713 ià(
cu¼_tq_avg
 - 
Ãigh_Şd
->
tq_avg
 > 
BATADV_GW_THRESHOLD
)

714 
out_of_¿nge
 = 
Œue
;

716 
out
:

717 ià(
Üig_d¡_node
)

718 
	`b©adv_Üig_node_ä“_»f
(
Üig_d¡_node
);

719 ià(
cu¼_gw
)

720 
	`b©adv_gw_node_ä“_»f
(
cu¼_gw
);

721 ià(
Ãigh_Şd
)

722 
	`b©adv_Ãigh_node_ä“_»f
(
Ãigh_Şd
);

723 ià(
Ãigh_cu¼
)

724 
	`b©adv_Ãigh_node_ä“_»f
(
Ãigh_cu¼
);

725  
out_of_¿nge
;

726 
	}
}

	@gateway_client.h

20 #iâdeà
_NET_BATMAN_ADV_GATEWAY_CLIENT_H_


21 
	#_NET_BATMAN_ADV_GATEWAY_CLIENT_H_


	)

23 
b©adv_gw_de£Ëù
(
b©adv_´iv
 *
b©_´iv
);

24 
b©adv_gw_–eùiÚ
(
b©adv_´iv
 *
b©_´iv
);

25 
b©adv_Üig_node
 *

26 
b©adv_gw_g‘_£Ëùed_Üig
(
b©adv_´iv
 *
b©_´iv
);

27 
b©adv_gw_check_–eùiÚ
(
b©adv_´iv
 *
b©_´iv
,

28 
b©adv_Üig_node
 *
Üig_node
);

29 
b©adv_gw_node_upd©e
(
b©adv_´iv
 *
b©_´iv
,

30 
b©adv_Üig_node
 *
Üig_node
,

31 
ušt8_t
 
Ãw_gwæags
);

32 
b©adv_gw_node_d–‘e
(
b©adv_´iv
 *
b©_´iv
,

33 
b©adv_Üig_node
 *
Üig_node
);

34 
b©adv_gw_node_purge
(
b©adv_´iv
 *
b©_´iv
);

35 
b©adv_gw_ş›Á_£q_´št_‹xt
(
£q_fe
 *
£q
, *
off£t
);

36 
boŞ
 
b©adv_gw_is_dhı_rg‘
(
sk_buff
 *
skb
, *
h—d”_Ën
);

37 
boŞ
 
b©adv_gw_out_of_¿nge
(
b©adv_´iv
 *
b©_´iv
,

38 
sk_buff
 *
skb
, 
‘hhdr
 *ethhdr);

	@gateway_common.c

20 
	~"maš.h
"

21 
	~"g©eway_commÚ.h
"

22 
	~"g©eway_ş›Á.h
"

25 
	$b©adv_kb™_to_gw_bªdwidth
(
down
, 
up
, *
gw_¤v_şass
)

27 
mdown
 = 0, 
tdown
, 
tup
, 
difã»nû
;

28 
ušt8_t
 
sb™
, 
·¹
;

30 *
gw_¤v_şass
 = 0;

31 
difã»nû
 = 0x0FFFFFFF;

34 
sb™
 = 0; sbit < 2; sbit++) {

35 
·¹
 = 0;…art < 16;…art++) {

36 
tdown
 = 32 * (
sb™
 + 2è* (1 << 
·¹
);

38 ià(
	`abs
(
tdown
 - 
down
è< 
difã»nû
) {

39 *
gw_¤v_şass
 = (
sb™
 << 7è+ (
·¹
 << 3);

40 
difã»nû
 = 
	`abs
(
tdown
 - 
down
);

41 
mdown
 = 
tdown
;

47 
difã»nû
 = 0x0FFFFFFF;

49 
·¹
 = 0;…art < 8;…art++) {

50 
tup
 = ((
·¹
 + 1è* (
mdown
)) / 8;

52 ià(
	`abs
(
tup
 - 
up
è< 
difã»nû
) {

53 *
gw_¤v_şass
 = (*gw_¤v_şas & 0xF8è| 
·¹
;

54 
difã»nû
 = 
	`abs
(
tup
 - 
up
);

57 
	}
}

60 
	$b©adv_gw_bªdwidth_to_kb™
(
ušt8_t
 
gw_¤v_şass
, *
down
, *
up
)

62 
sb™
 = (
gw_¤v_şass
 & 0x80) >> 7;

63 
d·¹
 = (
gw_¤v_şass
 & 0x78) >> 3;

64 
u·¹
 = (
gw_¤v_şass
 & 0x07);

66 ià(!
gw_¤v_şass
) {

67 *
down
 = 0;

68 *
up
 = 0;

72 *
down
 = 32 * (
sb™
 + 2è* (1 << 
d·¹
);

73 *
up
 = ((
u·¹
 + 1è* (*
down
)) / 8;

74 
	}
}

76 
boŞ
 
	$b©adv_·r£_gw_bªdwidth
(
Ãt_deviû
 *
Ãt_dev
, *
buff
,

77 *
up
, *
down
)

79 
»t
, 
muÉi
 = 1;

80 *
¦ash_±r
, *
tmp_±r
;

81 
ldown
, 
lup
;

83 
¦ash_±r
 = 
	`¡rchr
(
buff
, '/');

84 ià(
¦ash_±r
)

85 *
¦ash_±r
 = 0;

87 ià(
	`¡¾’
(
buff
) > 4) {

88 
tmp_±r
 = 
buff
 + 
	`¡¾’
(buff) - 4;

90 ià(
	`¡ºicmp
(
tmp_±r
, "mbit", 4) == 0)

91 
muÉi
 = 1024;

93 ià((
	`¡ºicmp
(
tmp_±r
, "kbit", 4) == 0) ||

94 (
muÉi
 > 1))

95 *
tmp_±r
 = '\0';

98 
»t
 = 
	`k¡¹Ş
(
buff
, 10, &
ldown
);

99 ià(
»t
) {

100 
	`b©adv_”r
(
Ãt_dev
,

102 
buff
);

103  
çl£
;

106 *
down
 = 
ldown
 * 
muÉi
;

109 ià(
¦ash_±r
) {

110 
muÉi
 = 1;

112 ià(
	`¡¾’
(
¦ash_±r
 + 1) > 4) {

113 
tmp_±r
 = 
¦ash_±r
 + 1 - 4 + 
	`¡¾’
(slash_ptr + 1);

115 ià(
	`¡ºicmp
(
tmp_±r
, "mbit", 4) == 0)

116 
muÉi
 = 1024;

118 ià((
	`¡ºicmp
(
tmp_±r
, "kbit", 4) == 0) ||

119 (
muÉi
 > 1))

120 *
tmp_±r
 = '\0';

123 
»t
 = 
	`k¡¹Ş
(
¦ash_±r
 + 1, 10, &
lup
);

124 ià(
»t
) {

125 
	`b©adv_”r
(
Ãt_dev
,

127 
¦ash_±r
 + 1);

128  
çl£
;

131 *
up
 = 
lup
 * 
muÉi
;

134  
Œue
;

135 
	}
}

137 
ssize_t
 
	$b©adv_gw_bªdwidth_£t
(
Ãt_deviû
 *
Ãt_dev
, *
buff
,

138 
size_t
 
couÁ
)

140 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
Ãt_dev
);

141 
gw_bªdwidth_tmp
 = 0;

142 
up
 = 0, 
down
 = 0;

143 
boŞ
 
»t
;

145 
»t
 = 
	`b©adv_·r£_gw_bªdwidth
(
Ãt_dev
, 
buff
, &
up
, &
down
);

146 ià(!
»t
)

147 
’d
;

149 ià((!
down
) || (down < 256))

150 
down
 = 2000;

152 ià(!
up
)

153 
up
 = 
down
 / 5;

155 
	`b©adv_kb™_to_gw_bªdwidth
(
down
, 
up
, &
gw_bªdwidth_tmp
);

161 
	`b©adv_gw_bªdwidth_to_kb™
((
ušt8_t
)
gw_bªdwidth_tmp
, &
down
, &
up
);

163 ià(
	`©omic_»ad
(&
b©_´iv
->
gw_bªdwidth
è=ğ
gw_bªdwidth_tmp
)

164  
couÁ
;

166 
	`b©adv_gw_de£Ëù
(
b©_´iv
);

167 
	`b©adv_šfo
(
Ãt_dev
,

169 
	`©omic_»ad
(&
b©_´iv
->
gw_bªdwidth
), 
gw_bªdwidth_tmp
,

170 (
down
 > 2048 ? down / 1024 : down),

171 (
down
 > 2048 ? "MBit" : "KBit"),

172 (
up
 > 2048 ? up / 1024 : up),

173 (
up
 > 2048 ? "MBit" : "KBit"));

175 
	`©omic_£t
(&
b©_´iv
->
gw_bªdwidth
, 
gw_bªdwidth_tmp
);

177 
’d
:

178  
couÁ
;

179 
	}
}

	@gateway_common.h

20 #iâdeà
_NET_BATMAN_ADV_GATEWAY_COMMON_H_


21 
	#_NET_BATMAN_ADV_GATEWAY_COMMON_H_


	)

23 
	eb©adv_gw_modes
 {

24 
	mBATADV_GW_MODE_OFF
,

25 
	mBATADV_GW_MODE_CLIENT
,

26 
	mBATADV_GW_MODE_SERVER
,

29 
	#BATADV_GW_MODE_OFF_NAME
 "off"

	)

30 
	#BATADV_GW_MODE_CLIENT_NAME
 "ş›Á"

	)

31 
	#BATADV_GW_MODE_SERVER_NAME
 "£rv”"

	)

33 
b©adv_gw_bªdwidth_to_kb™
(
ušt8_t
 
gw_şass
, *
down
, *
up
);

34 
ssize_t
 
b©adv_gw_bªdwidth_£t
(
Ãt_deviû
 *
Ãt_dev
, *
buff
,

35 
size_t
 
couÁ
);

	@hard-interface.c

20 
	~"maš.h
"

21 
	~"h¬d-š‹rçû.h
"

22 
	~"soá-š‹rçû.h
"

23 
	~"£nd.h
"

24 
	~"Œª¦©iÚ-bË.h
"

25 
	~"routšg.h
"

26 
	~"sysfs.h
"

27 
	~"Üigš©Ü.h
"

28 
	~"hash.h
"

29 
	~"bridge_loİ_avoidªû.h
"

31 
	~<lšux/if_¬p.h
>

33 
	$b©adv_h¬dif_ä“_rcu
(
rcu_h—d
 *
rcu
)

35 
b©adv_h¬d_içû
 *
h¬d_içû
;

37 
h¬d_içû
 = 
	`cÚš”_of
(
rcu
, 
b©adv_h¬d_içû
,„cu);

38 
	`dev_put
(
h¬d_içû
->
Ãt_dev
);

39 
	`kä“
(
h¬d_içû
);

40 
	}
}

42 
b©adv_h¬d_içû
 *

43 
	$b©adv_h¬dif_g‘_by_Ãtdev
(cÚ¡ 
Ãt_deviû
 *
Ãt_dev
)

45 
b©adv_h¬d_içû
 *
h¬d_içû
;

47 
	`rcu_»ad_lock
();

48 
	`li¡_fÜ_—ch_’Œy_rcu
(
h¬d_içû
, &
b©adv_h¬dif_li¡
, 
li¡
) {

49 ià(
h¬d_içû
->
Ãt_dev
 ==‚et_dev &&

50 
	`©omic_šc_nÙ_z”o
(&
h¬d_içû
->
»fcouÁ
))

51 
out
;

54 
h¬d_içû
 = 
NULL
;

56 
out
:

57 
	`rcu_»ad_uÆock
();

58  
h¬d_içû
;

59 
	}
}

61 
	$b©adv_is_v®id_içû
(cÚ¡ 
Ãt_deviû
 *
Ãt_dev
)

63 ià(
Ãt_dev
->
æags
 & 
IFF_LOOPBACK
)

66 ià(
Ãt_dev
->
ty³
 !ğ
ARPHRD_ETHER
)

69 ià(
Ãt_dev
->
addr_Ën
 !ğ
ETH_ALEN
)

73 ià(
	`b©adv_soáif_is_v®id
(
Ãt_dev
))

77 
	}
}

79 
b©adv_h¬d_içû
 *

80 
	$b©adv_h¬dif_g‘_aùive
(cÚ¡ 
Ãt_deviû
 *
soá_içû
)

82 
b©adv_h¬d_içû
 *
h¬d_içû
;

84 
	`rcu_»ad_lock
();

85 
	`li¡_fÜ_—ch_’Œy_rcu
(
h¬d_içû
, &
b©adv_h¬dif_li¡
, 
li¡
) {

86 ià(
h¬d_içû
->
soá_içû
 != soft_iface)

89 ià(
h¬d_içû
->
if_¡©us
 =ğ
BATADV_IF_ACTIVE
 &&

90 
	`©omic_šc_nÙ_z”o
(&
h¬d_içû
->
»fcouÁ
))

91 
out
;

94 
h¬d_içû
 = 
NULL
;

96 
out
:

97 
	`rcu_»ad_uÆock
();

98  
h¬d_içû
;

99 
	}
}

101 
	$b©adv_´im¬y_if_upd©e_addr
(
b©adv_´iv
 *
b©_´iv
,

102 
b©adv_h¬d_içû
 *
Şdif
)

104 
b©adv_vis_·ck‘
 *
vis_·ck‘
;

105 
b©adv_h¬d_içû
 *
´im¬y_if
;

106 
sk_buff
 *
skb
;

108 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

109 ià(!
´im¬y_if
)

110 
out
;

112 
skb
 = 
b©_´iv
->
vis
.
my_šfo
->
skb_·ck‘
;

113 
vis_·ck‘
 = (
b©adv_vis_·ck‘
 *)
skb
->
d©a
;

114 
	`memıy
(
vis_·ck‘
->
vis_Üig
, 
´im¬y_if
->
Ãt_dev
->
dev_addr
, 
ETH_ALEN
);

115 
	`memıy
(
vis_·ck‘
->
£nd”_Üig
,

116 
´im¬y_if
->
Ãt_dev
->
dev_addr
, 
ETH_ALEN
);

118 
	`b©adv_bÏ_upd©e_Üig_add»ss
(
b©_´iv
, 
´im¬y_if
, 
Şdif
);

119 
out
:

120 ià(
´im¬y_if
)

121 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

122 
	}
}

124 
	$b©adv_´im¬y_if_£Ëù
(
b©adv_´iv
 *
b©_´iv
,

125 
b©adv_h¬d_içû
 *
Ãw_h¬d_içû
)

127 
b©adv_h¬d_içû
 *
cu¼_h¬d_içû
;

129 
	`ASSERT_RTNL
();

131 ià(
Ãw_h¬d_içû
 && !
	`©omic_šc_nÙ_z”o
(&Ãw_h¬d_içû->
»fcouÁ
))

132 
Ãw_h¬d_içû
 = 
NULL
;

134 
cu¼_h¬d_içû
 = 
	`rcu_d”eã»nû_´Ùeùed
(
b©_´iv
->
´im¬y_if
, 1);

135 
	`rcu_assign_poš‹r
(
b©_´iv
->
´im¬y_if
, 
Ãw_h¬d_içû
);

137 ià(!
Ãw_h¬d_içû
)

138 
out
;

140 
b©_´iv
->
b©_®go_İs
->
	`b©_´im¬y_içû_£t
(
Ãw_h¬d_içû
);

141 
	`b©adv_´im¬y_if_upd©e_addr
(
b©_´iv
, 
cu¼_h¬d_içû
);

143 
out
:

144 ià(
cu¼_h¬d_içû
)

145 
	`b©adv_h¬dif_ä“_»f
(
cu¼_h¬d_içû
);

146 
	}
}

148 
boŞ


149 
	$b©adv_h¬dif_is_içû_up
(cÚ¡ 
b©adv_h¬d_içû
 *
h¬d_içû
)

151 ià(
h¬d_içû
->
Ãt_dev
->
æags
 & 
IFF_UP
)

152  
Œue
;

154  
çl£
;

155 
	}
}

157 
	$b©adv_check_known_mac_addr
(cÚ¡ 
Ãt_deviû
 *
Ãt_dev
)

159 cÚ¡ 
b©adv_h¬d_içû
 *
h¬d_içû
;

161 
	`rcu_»ad_lock
();

162 
	`li¡_fÜ_—ch_’Œy_rcu
(
h¬d_içû
, &
b©adv_h¬dif_li¡
, 
li¡
) {

163 ià((
h¬d_içû
->
if_¡©us
 !ğ
BATADV_IF_ACTIVE
) &&

164 (
h¬d_içû
->
if_¡©us
 !ğ
BATADV_IF_TO_BE_ACTIVATED
))

167 ià(
h¬d_içû
->
Ãt_dev
 ==‚et_dev)

170 ià(!
	`b©adv_com·»_‘h
(
h¬d_içû
->
Ãt_dev
->
dev_addr
,

171 
Ãt_dev
->
dev_addr
))

174 
	`´_w¬n
("The‚ewly‡dded mac‡ddress (%pM)‡lreadyƒxists on: %s\n",

175 
Ãt_dev
->
dev_addr
, 
h¬d_içû
->Ãt_dev->
Çme
);

176 
	`´_w¬n
("It is strongly„ecommendedo keep mac‡ddresses uniqueo‡void…roblems!\n");

178 
	`rcu_»ad_uÆock
();

179 
	}
}

181 
	$b©adv_h¬dif_mš_mtu
(
Ãt_deviû
 *
soá_içû
)

183 cÚ¡ 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
soá_içû
);

184 cÚ¡ 
b©adv_h¬d_içû
 *
h¬d_içû
;

188 
mš_mtu
 = 
ETH_DATA_LEN
;

190 ià(
	`©omic_»ad
(&
b©_´iv
->
äagm’tiÚ
))

191 
out
;

193 
	`rcu_»ad_lock
();

194 
	`li¡_fÜ_—ch_’Œy_rcu
(
h¬d_içû
, &
b©adv_h¬dif_li¡
, 
li¡
) {

195 ià((
h¬d_içû
->
if_¡©us
 !ğ
BATADV_IF_ACTIVE
) &&

196 (
h¬d_içû
->
if_¡©us
 !ğ
BATADV_IF_TO_BE_ACTIVATED
))

199 ià(
h¬d_içû
->
soá_içû
 != soft_iface)

202 
mš_mtu
 = 
	`mš_t
(,

203 
h¬d_içû
->
Ãt_dev
->
mtu
 - 
BATADV_HEADER_LEN
,

204 
mš_mtu
);

206 
	`rcu_»ad_uÆock
();

207 
out
:

208  
mš_mtu
;

209 
	}
}

212 
	$b©adv_upd©e_mš_mtu
(
Ãt_deviû
 *
soá_içû
)

214 
mš_mtu
;

216 
mš_mtu
 = 
	`b©adv_h¬dif_mš_mtu
(
soá_içû
);

217 ià(
soá_içû
->
mtu
 !ğ
mš_mtu
)

218 
soá_içû
->
mtu
 = 
mš_mtu
;

219 
	}
}

222 
	$b©adv_h¬dif_aùiv©e_š‹rçû
(
b©adv_h¬d_içû
 *
h¬d_içû
)

224 
b©adv_´iv
 *
b©_´iv
;

225 
b©adv_h¬d_içû
 *
´im¬y_if
 = 
NULL
;

227 ià(
h¬d_içû
->
if_¡©us
 !ğ
BATADV_IF_INACTIVE
)

228 
out
;

230 
b©_´iv
 = 
	`Ãtdev_´iv
(
h¬d_içû
->
soá_içû
);

232 
b©_´iv
->
b©_®go_İs
->
	`b©_içû_upd©e_mac
(
h¬d_içû
);

233 
h¬d_içû
->
if_¡©us
 = 
BATADV_IF_TO_BE_ACTIVATED
;

238 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

239 ià(!
´im¬y_if
)

240 
	`b©adv_´im¬y_if_£Ëù
(
b©_´iv
, 
h¬d_içû
);

242 
	`b©adv_šfo
(
h¬d_içû
->
soá_içû
, "Interface‡ctivated: %s\n",

243 
h¬d_içû
->
Ãt_dev
->
Çme
);

245 
	`b©adv_upd©e_mš_mtu
(
h¬d_içû
->
soá_içû
);

247 
out
:

248 ià(
´im¬y_if
)

249 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

250 
	}
}

253 
	$b©adv_h¬dif_d—ùiv©e_š‹rçû
(
b©adv_h¬d_içû
 *
h¬d_içû
)

255 ià((
h¬d_içû
->
if_¡©us
 !ğ
BATADV_IF_ACTIVE
) &&

256 (
h¬d_içû
->
if_¡©us
 !ğ
BATADV_IF_TO_BE_ACTIVATED
))

259 
h¬d_içû
->
if_¡©us
 = 
BATADV_IF_INACTIVE
;

261 
	`b©adv_šfo
(
h¬d_içû
->
soá_içû
, "Interface deactivated: %s\n",

262 
h¬d_içû
->
Ãt_dev
->
Çme
);

264 
	`b©adv_upd©e_mš_mtu
(
h¬d_içû
->
soá_içû
);

265 
	}
}

267 
	$b©adv_h¬dif_’abË_š‹rçû
(
b©adv_h¬d_içû
 *
h¬d_içû
,

268 cÚ¡ *
içû_Çme
)

270 
b©adv_´iv
 *
b©_´iv
;

271 
Ãt_deviû
 *
soá_içû
;

272 
__be16
 
‘h”ty³
 = 
	`__cÚ¡ªt_htÚs
(
BATADV_ETH_P_BATMAN
);

273 
»t
;

275 ià(
h¬d_içû
->
if_¡©us
 !ğ
BATADV_IF_NOT_IN_USE
)

276 
out
;

278 ià(!
	`©omic_šc_nÙ_z”o
(&
h¬d_içû
->
»fcouÁ
))

279 
out
;

282 ià(
h¬d_içû
->
Ãt_dev
->
´iv_æags
 & 
IFF_BRIDGE_PORT
)

283 
	`´_”r
("You‡re‡boutoƒnable batman-adv on '%s' which‡lready is…art of‡ bridge. Unless you knowƒxactly what you‡re doinghis is…robably wrong‡nd won't workhe way youhink it would.\n",

284 
h¬d_içû
->
Ãt_dev
->
Çme
);

286 
soá_içû
 = 
	`dev_g‘_by_Çme
(&
š™_Ãt
, 
içû_Çme
);

288 ià(!
soá_içû
) {

289 
soá_içû
 = 
	`b©adv_soáif_ü—‹
(
içû_Çme
);

291 ià(!
soá_içû
) {

292 
»t
 = -
ENOMEM
;

293 
”r
;

297 
	`dev_hŞd
(
soá_içû
);

300 ià(!
	`b©adv_soáif_is_v®id
(
soá_içû
)) {

301 
	`´_”r
("Can't create batman mesh interface %s:‡lreadyƒxists‡s„egular interface\n",

302 
soá_içû
->
Çme
);

303 
»t
 = -
EINVAL
;

304 
”r_dev
;

307 
h¬d_içû
->
soá_içû
 = soft_iface;

308 
b©_´iv
 = 
	`Ãtdev_´iv
(
h¬d_içû
->
soá_içû
);

310 
»t
 = 
b©_´iv
->
b©_®go_İs
->
	`b©_içû_’abË
(
h¬d_içû
);

311 ià(
»t
 < 0)

312 
”r_dev
;

314 
h¬d_içû
->
if_num
 = 
b©_´iv
->
num_içûs
;

315 
b©_´iv
->
num_içûs
++;

316 
h¬d_içû
->
if_¡©us
 = 
BATADV_IF_INACTIVE
;

317 
»t
 = 
	`b©adv_Üig_hash_add_if
(
h¬d_içû
, 
b©_´iv
->
num_içûs
);

318 ià(
»t
 < 0) {

319 
b©_´iv
->
b©_®go_İs
->
	`b©_içû_di§bË
(
h¬d_içû
);

320 
b©_´iv
->
num_içûs
--;

321 
h¬d_içû
->
if_¡©us
 = 
BATADV_IF_NOT_IN_USE
;

322 
”r_dev
;

325 
h¬d_içû
->
b©mª_adv_±y³
.
ty³
 = 
‘h”ty³
;

326 
h¬d_içû
->
b©mª_adv_±y³
.
func
 = 
b©adv_b©mª_skb_»cv
;

327 
h¬d_içû
->
b©mª_adv_±y³
.
dev
 = h¬d_içû->
Ãt_dev
;

328 
	`dev_add_·ck
(&
h¬d_içû
->
b©mª_adv_±y³
);

330 
	`©omic_£t
(&
h¬d_içû
->
äag_£qno
, 1);

331 
	`b©adv_šfo
(
h¬d_içû
->
soá_içû
, "Adding interface: %s\n",

332 
h¬d_içû
->
Ãt_dev
->
Çme
);

334 ià(
	`©omic_»ad
(&
b©_´iv
->
äagm’tiÚ
) &&

335 
h¬d_içû
->
Ãt_dev
->
mtu
 < 
ETH_DATA_LEN
 + 
BATADV_HEADER_LEN
)

336 
	`b©adv_šfo
(
h¬d_içû
->
soá_içû
,

338 
h¬d_içû
->
Ãt_dev
->
Çme
, h¬d_içû->Ãt_dev->
mtu
,

339 
ETH_DATA_LEN
 + 
BATADV_HEADER_LEN
);

341 ià(!
	`©omic_»ad
(&
b©_´iv
->
äagm’tiÚ
) &&

342 
h¬d_içû
->
Ãt_dev
->
mtu
 < 
ETH_DATA_LEN
 + 
BATADV_HEADER_LEN
)

343 
	`b©adv_šfo
(
h¬d_içû
->
soá_içû
,

345 
h¬d_içû
->
Ãt_dev
->
Çme
, h¬d_içû->Ãt_dev->
mtu
,

346 
ETH_DATA_LEN
 + 
BATADV_HEADER_LEN
);

348 ià(
	`b©adv_h¬dif_is_içû_up
(
h¬d_içû
))

349 
	`b©adv_h¬dif_aùiv©e_š‹rçû
(
h¬d_içû
);

351 
	`b©adv_”r
(
h¬d_içû
->
soá_içû
,

353 
h¬d_içû
->
Ãt_dev
->
Çme
);

356 
	`b©adv_scheduË_b©_ogm
(
h¬d_içû
);

358 
out
:

361 
”r_dev
:

362 
	`dev_put
(
soá_içû
);

363 
”r
:

364 
	`b©adv_h¬dif_ä“_»f
(
h¬d_içû
);

365  
»t
;

366 
	}
}

368 
	$b©adv_h¬dif_di§bË_š‹rçû
(
b©adv_h¬d_içû
 *
h¬d_içû
)

370 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
h¬d_içû
->
soá_içû
);

371 
b©adv_h¬d_içû
 *
´im¬y_if
 = 
NULL
;

373 ià(
h¬d_içû
->
if_¡©us
 =ğ
BATADV_IF_ACTIVE
)

374 
	`b©adv_h¬dif_d—ùiv©e_š‹rçû
(
h¬d_içû
);

376 ià(
h¬d_içû
->
if_¡©us
 !ğ
BATADV_IF_INACTIVE
)

377 
out
;

379 
	`b©adv_šfo
(
h¬d_içû
->
soá_içû
, "Removing interface: %s\n",

380 
h¬d_içû
->
Ãt_dev
->
Çme
);

381 
	`dev_»move_·ck
(&
h¬d_içû
->
b©mª_adv_±y³
);

383 
b©_´iv
->
num_içûs
--;

384 
	`b©adv_Üig_hash_d–_if
(
h¬d_içû
, 
b©_´iv
->
num_içûs
);

386 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

387 ià(
h¬d_içû
 =ğ
´im¬y_if
) {

388 
b©adv_h¬d_içû
 *
Ãw_if
;

390 
Ãw_if
 = 
	`b©adv_h¬dif_g‘_aùive
(
h¬d_içû
->
soá_içû
);

391 
	`b©adv_´im¬y_if_£Ëù
(
b©_´iv
, 
Ãw_if
);

393 ià(
Ãw_if
)

394 
	`b©adv_h¬dif_ä“_»f
(
Ãw_if
);

397 
b©_´iv
->
b©_®go_İs
->
	`b©_içû_di§bË
(
h¬d_içû
);

398 
h¬d_içû
->
if_¡©us
 = 
BATADV_IF_NOT_IN_USE
;

401 
	`b©adv_purge_Üig_»f
(
b©_´iv
);

402 
	`b©adv_purge_out¡ªdšg_·ck‘s
(
b©_´iv
, 
h¬d_içû
);

403 
	`dev_put
(
h¬d_içû
->
soá_içû
);

406 ià(!
b©_´iv
->
num_içûs
)

407 
	`b©adv_soáif_de¡roy
(
h¬d_içû
->
soá_içû
);

409 
h¬d_içû
->
soá_içû
 = 
NULL
;

410 
	`b©adv_h¬dif_ä“_»f
(
h¬d_içû
);

412 
out
:

413 ià(
´im¬y_if
)

414 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

415 
	}
}

417 
b©adv_h¬d_içû
 *

418 
	$b©adv_h¬dif_add_š‹rçû
(
Ãt_deviû
 *
Ãt_dev
)

420 
b©adv_h¬d_içû
 *
h¬d_içû
;

421 
»t
;

423 
	`ASSERT_RTNL
();

425 
»t
 = 
	`b©adv_is_v®id_içû
(
Ãt_dev
);

426 ià(
»t
 != 1)

427 
out
;

429 
	`dev_hŞd
(
Ãt_dev
);

431 
h¬d_içû
 = 
	`km®loc
((*h¬d_içû), 
GFP_ATOMIC
);

432 ià(!
h¬d_içû
)

433 
»Ëa£_dev
;

435 
»t
 = 
	`b©adv_sysfs_add_h¬dif
(&
h¬d_içû
->
h¬dif_obj
, 
Ãt_dev
);

436 ià(
»t
)

437 
ä“_if
;

439 
h¬d_içû
->
if_num
 = -1;

440 
h¬d_içû
->
Ãt_dev
 =‚et_dev;

441 
h¬d_içû
->
soá_içû
 = 
NULL
;

442 
h¬d_içû
->
if_¡©us
 = 
BATADV_IF_NOT_IN_USE
;

443 
	`INIT_LIST_HEAD
(&
h¬d_içû
->
li¡
);

445 
	`©omic_£t
(&
h¬d_içû
->
»fcouÁ
, 2);

447 
	`b©adv_check_known_mac_addr
(
h¬d_içû
->
Ãt_dev
);

448 
	`li¡_add__rcu
(&
h¬d_içû
->
li¡
, &
b©adv_h¬dif_li¡
);

453 
	`©omic_£t
(&
h¬d_içû
->
£qno
, 1);

454 
h¬d_içû
->
·ck‘_buff
 = 
NULL
;

456  
h¬d_içû
;

458 
ä“_if
:

459 
	`kä“
(
h¬d_içû
);

460 
»Ëa£_dev
:

461 
	`dev_put
(
Ãt_dev
);

462 
out
:

463  
NULL
;

464 
	}
}

466 
	$b©adv_h¬dif_»move_š‹rçû
(
b©adv_h¬d_içû
 *
h¬d_içû
)

468 
	`ASSERT_RTNL
();

471 ià(
h¬d_içû
->
if_¡©us
 !ğ
BATADV_IF_NOT_IN_USE
)

472 
	`b©adv_h¬dif_di§bË_š‹rçû
(
h¬d_içû
);

474 ià(
h¬d_içû
->
if_¡©us
 !ğ
BATADV_IF_NOT_IN_USE
)

477 
h¬d_içû
->
if_¡©us
 = 
BATADV_IF_TO_BE_REMOVED
;

478 
	`b©adv_sysfs_d–_h¬dif
(&
h¬d_içû
->
h¬dif_obj
);

479 
	`b©adv_h¬dif_ä“_»f
(
h¬d_içû
);

480 
	}
}

482 
	$b©adv_h¬dif_»move_š‹rçûs
()

484 
b©adv_h¬d_içû
 *
h¬d_içû
, *
h¬d_içû_tmp
;

486 
	`¹Æ_lock
();

487 
	`li¡_fÜ_—ch_’Œy_§ã
(
h¬d_içû
, 
h¬d_içû_tmp
,

488 &
b©adv_h¬dif_li¡
, 
li¡
) {

489 
	`li¡_d–_rcu
(&
h¬d_içû
->
li¡
);

490 
	`b©adv_h¬dif_»move_š‹rçû
(
h¬d_içû
);

492 
	`¹Æ_uÆock
();

493 
	}
}

495 
	$b©adv_h¬d_if_ev’t
(
nÙif›r_block
 *
this
,

496 
ev’t
, *
±r
)

498 
Ãt_deviû
 *
Ãt_dev
 = 
±r
;

499 
b©adv_h¬d_içû
 *
h¬d_içû
;

500 
b©adv_h¬d_içû
 *
´im¬y_if
 = 
NULL
;

501 
b©adv_´iv
 *
b©_´iv
;

503 
h¬d_içû
 = 
	`b©adv_h¬dif_g‘_by_Ãtdev
(
Ãt_dev
);

504 ià(!
h¬d_içû
 && 
ev’t
 =ğ
NETDEV_REGISTER
)

505 
h¬d_içû
 = 
	`b©adv_h¬dif_add_š‹rçû
(
Ãt_dev
);

507 ià(!
h¬d_içû
)

508 
out
;

510 
ev’t
) {

511 
NETDEV_UP
:

512 
	`b©adv_h¬dif_aùiv©e_š‹rçû
(
h¬d_içû
);

514 
NETDEV_GOING_DOWN
:

515 
NETDEV_DOWN
:

516 
	`b©adv_h¬dif_d—ùiv©e_š‹rçû
(
h¬d_içû
);

518 
NETDEV_UNREGISTER
:

519 
	`li¡_d–_rcu
(&
h¬d_içû
->
li¡
);

521 
	`b©adv_h¬dif_»move_š‹rçû
(
h¬d_içû
);

523 
NETDEV_CHANGEMTU
:

524 ià(
h¬d_içû
->
soá_içû
)

525 
	`b©adv_upd©e_mš_mtu
(
h¬d_içû
->
soá_içû
);

527 
NETDEV_CHANGEADDR
:

528 ià(
h¬d_içû
->
if_¡©us
 =ğ
BATADV_IF_NOT_IN_USE
)

529 
h¬dif_put
;

531 
	`b©adv_check_known_mac_addr
(
h¬d_içû
->
Ãt_dev
);

533 
b©_´iv
 = 
	`Ãtdev_´iv
(
h¬d_içû
->
soá_içû
);

534 
b©_´iv
->
b©_®go_İs
->
	`b©_içû_upd©e_mac
(
h¬d_içû
);

536 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

537 ià(!
´im¬y_if
)

538 
h¬dif_put
;

540 ià(
h¬d_içû
 =ğ
´im¬y_if
)

541 
	`b©adv_´im¬y_if_upd©e_addr
(
b©_´iv
, 
NULL
);

547 
h¬dif_put
:

548 
	`b©adv_h¬dif_ä“_»f
(
h¬d_içû
);

549 
out
:

550 ià(
´im¬y_if
)

551 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

552  
NOTIFY_DONE
;

553 
	}
}

558 
boŞ
 
	$b©adv_is_wifi_içû
(
ifšdex
)

560 
Ãt_deviû
 *Ãt_deviû = 
NULL
;

561 
boŞ
 
»t
 = 
çl£
;

563 ià(
ifšdex
 =ğ
BATADV_NULL_IFINDEX
)

564 
out
;

566 
Ãt_deviû
 = 
	`dev_g‘_by_šdex
(&
š™_Ãt
, 
ifšdex
);

567 ià(!
Ãt_deviû
)

568 
out
;

570 #ifdeà
CONFIG_WIRELESS_EXT


574 ià(
Ãt_deviû
->
wœ–ess_hªdËrs
)

575 
»t
 = 
Œue
;

579 ià(
Ãt_deviû
->
›“80211_±r
)

580 
»t
 = 
Œue
;

581 
out
:

582 ià(
Ãt_deviû
)

583 
	`dev_put
(
Ãt_deviû
);

584  
»t
;

585 
	}
}

587 
nÙif›r_block
 
	gb©adv_h¬d_if_nÙif›r
 = {

588 .
nÙif›r_ÿÎ
 = 
b©adv_h¬d_if_ev’t
,

	@hard-interface.h

20 #iâdeà
_NET_BATMAN_ADV_HARD_INTERFACE_H_


21 
	#_NET_BATMAN_ADV_HARD_INTERFACE_H_


	)

23 
	eb©adv_h¬d_if_¡©e
 {

24 
	mBATADV_IF_NOT_IN_USE
,

25 
	mBATADV_IF_TO_BE_REMOVED
,

26 
	mBATADV_IF_INACTIVE
,

27 
	mBATADV_IF_ACTIVE
,

28 
	mBATADV_IF_TO_BE_ACTIVATED
,

29 
	mBATADV_IF_I_WANT_YOU
,

32 
nÙif›r_block
 
b©adv_h¬d_if_nÙif›r
;

34 
b©adv_h¬d_içû
*

35 
b©adv_h¬dif_g‘_by_Ãtdev
(cÚ¡ 
Ãt_deviû
 *
Ãt_dev
);

36 
b©adv_h¬dif_’abË_š‹rçû
(
b©adv_h¬d_içû
 *
h¬d_içû
,

37 cÚ¡ *
içû_Çme
);

38 
b©adv_h¬dif_di§bË_š‹rçû
(
b©adv_h¬d_içû
 *
h¬d_içû
);

39 
b©adv_h¬dif_»move_š‹rçûs
();

40 
b©adv_h¬dif_mš_mtu
(
Ãt_deviû
 *
soá_içû
);

41 
b©adv_upd©e_mš_mtu
(
Ãt_deviû
 *
soá_içû
);

42 
b©adv_h¬dif_ä“_rcu
(
rcu_h—d
 *
rcu
);

43 
boŞ
 
b©adv_is_wifi_içû
(
ifšdex
);

45 
šlše
 

46 
	$b©adv_h¬dif_ä“_»f
(
b©adv_h¬d_içû
 *
h¬d_içû
)

48 ià(
	`©omic_dec_ªd_‹¡
(&
h¬d_içû
->
»fcouÁ
))

49 
	`ÿÎ_rcu
(&
h¬d_içû
->
rcu
, 
b©adv_h¬dif_ä“_rcu
);

50 
	}
}

52 
šlše
 
b©adv_h¬d_içû
 *

53 
	$b©adv_´im¬y_if_g‘_£Ëùed
(
b©adv_´iv
 *
b©_´iv
)

55 
b©adv_h¬d_içû
 *
h¬d_içû
;

57 
	`rcu_»ad_lock
();

58 
h¬d_içû
 = 
	`rcu_d”eã»nû
(
b©_´iv
->
´im¬y_if
);

59 ià(!
h¬d_içû
)

60 
out
;

62 ià(!
	`©omic_šc_nÙ_z”o
(&
h¬d_içû
->
»fcouÁ
))

63 
h¬d_içû
 = 
NULL
;

65 
out
:

66 
	`rcu_»ad_uÆock
();

67  
h¬d_içû
;

68 
	}
}

	@hash.c

20 
	~"maš.h
"

21 
	~"hash.h
"

24 
	$b©adv_hash_š™
(
b©adv_hashbË
 *
hash
)

26 
ušt32_t
 
i
;

28 
i
 = 0; i < 
hash
->
size
; i++) {

29 
	`INIT_HLIST_HEAD
(&
hash
->
bË
[
i
]);

30 
	`¥š_lock_š™
(&
hash
->
li¡_locks
[
i
]);

32 
	}
}

35 
	$b©adv_hash_de¡roy
(
b©adv_hashbË
 *
hash
)

37 
	`kä“
(
hash
->
li¡_locks
);

38 
	`kä“
(
hash
->
bË
);

39 
	`kä“
(
hash
);

40 
	}
}

43 
b©adv_hashbË
 *
	$b©adv_hash_Ãw
(
ušt32_t
 
size
)

45 
b©adv_hashbË
 *
hash
;

47 
hash
 = 
	`km®loc
((*hash), 
GFP_ATOMIC
);

48 ià(!
hash
)

49  
NULL
;

51 
hash
->
bË
 = 
	`km®loc
((*hash->bËè* 
size
, 
GFP_ATOMIC
);

52 ià(!
hash
->
bË
)

53 
ä“_hash
;

55 
hash
->
li¡_locks
 = 
	`km®loc
((*hash->li¡_locksè* 
size
,

56 
GFP_ATOMIC
);

57 ià(!
hash
->
li¡_locks
)

58 
ä“_bË
;

60 
hash
->
size
 = size;

61 
	`b©adv_hash_š™
(
hash
);

62  
hash
;

64 
ä“_bË
:

65 
	`kä“
(
hash
->
bË
);

66 
ä“_hash
:

67 
	`kä“
(
hash
);

68  
NULL
;

69 
	}
}

71 
	$b©adv_hash_£t_lock_şass
(
b©adv_hashbË
 *
hash
,

72 
lock_şass_key
 *
key
)

74 
ušt32_t
 
i
;

76 
i
 = 0; i < 
hash
->
size
; i++)

77 
	`lockd•_£t_şass
(&
hash
->
li¡_locks
[
i
], 
key
);

78 
	}
}

	@hash.h

20 #iâdeà
_NET_BATMAN_ADV_HASH_H_


21 
	#_NET_BATMAN_ADV_HASH_H_


	)

23 
	~<lšux/li¡.h
>

28 (*
	tb©adv_hashd©a_com·»_cb
)(cÚ¡ 
	thli¡_node
 *,

35 
	$ušt32_t
 (*
	tb©adv_hashd©a_choo£_cb
)(cÚ¡ *, 
	tušt32_t
);

36 (*
	tb©adv_hashd©a_ä“_cb
)(
	thli¡_node
 *, *);

38 
	sb©adv_hashbË
 {

39 
hli¡_h—d
 *
bË
;

40 
¥šlock_t
 *
li¡_locks
;

41 
ušt32_t
 
size
;

45 
b©adv_hashbË
 *
	`b©adv_hash_Ãw
(
ušt32_t
 
size
);

48 
	`b©adv_hash_£t_lock_şass
(
b©adv_hashbË
 *
hash
,

49 
lock_şass_key
 *
key
);

52 
	`b©adv_hash_de¡roy
(
b©adv_hashbË
 *
hash
);

58 
šlše
 
	$b©adv_hash_d–‘e
(
b©adv_hashbË
 *
hash
,

59 
b©adv_hashd©a_ä“_cb
 
ä“_cb
,

60 *
¬g
)

62 
hli¡_h—d
 *
h—d
;

63 
hli¡_node
 *
node
, *
node_tmp
;

64 
¥šlock_t
 *
li¡_lock
;

65 
ušt32_t
 
i
;

67 
i
 = 0; i < 
hash
->
size
; i++) {

68 
h—d
 = &
hash
->
bË
[
i
];

69 
li¡_lock
 = &
hash
->
li¡_locks
[
i
];

71 
	`¥š_lock_bh
(
li¡_lock
);

72 
	`hli¡_fÜ_—ch_§ã
(
node
, 
node_tmp
, 
h—d
) {

73 
	`hli¡_d–_rcu
(
node
);

75 ià(
ä“_cb
)

76 
	`ä“_cb
(
node
, 
¬g
);

78 
	`¥š_uÆock_bh
(
li¡_lock
);

81 
	`b©adv_hash_de¡roy
(
hash
);

82 
	}
}

95 
šlše
 
	$b©adv_hash_add
(
b©adv_hashbË
 *
hash
,

96 
b©adv_hashd©a_com·»_cb
 
com·»
,

97 
b©adv_hashd©a_choo£_cb
 
choo£
,

98 cÚ¡ *
d©a
,

99 
hli¡_node
 *
d©a_node
)

101 
ušt32_t
 
šdex
;

102 
»t
 = -1;

103 
hli¡_h—d
 *
h—d
;

104 
hli¡_node
 *
node
;

105 
¥šlock_t
 *
li¡_lock
;

107 ià(!
hash
)

108 
out
;

110 
šdex
 = 
	`choo£
(
d©a
, 
hash
->
size
);

111 
h—d
 = &
hash
->
bË
[
šdex
];

112 
li¡_lock
 = &
hash
->
li¡_locks
[
šdex
];

114 
	`¥š_lock_bh
(
li¡_lock
);

116 
	`hli¡_fÜ_—ch
(
node
, 
h—d
) {

117 ià(!
	`com·»
(
node
, 
d©a
))

120 
»t
 = 1;

121 
uÆock
;

125 
	`hli¡_add_h—d_rcu
(
d©a_node
, 
h—d
);

127 
»t
 = 0;

129 
uÆock
:

130 
	`¥š_uÆock_bh
(
li¡_lock
);

131 
out
:

132  
»t
;

133 
	}
}

140 
šlše
 *
	$b©adv_hash_»move
(
b©adv_hashbË
 *
hash
,

141 
b©adv_hashd©a_com·»_cb
 
com·»
,

142 
b©adv_hashd©a_choo£_cb
 
choo£
,

143 *
d©a
)

145 
ušt32_t
 
šdex
;

146 
hli¡_node
 *
node
;

147 
hli¡_h—d
 *
h—d
;

148 *
d©a_§ve
 = 
NULL
;

150 
šdex
 = 
	`choo£
(
d©a
, 
hash
->
size
);

151 
h—d
 = &
hash
->
bË
[
šdex
];

153 
	`¥š_lock_bh
(&
hash
->
li¡_locks
[
šdex
]);

154 
	`hli¡_fÜ_—ch
(
node
, 
h—d
) {

155 ià(!
	`com·»
(
node
, 
d©a
))

158 
d©a_§ve
 = 
node
;

159 
	`hli¡_d–_rcu
(
node
);

162 
	`¥š_uÆock_bh
(&
hash
->
li¡_locks
[
šdex
]);

164  
d©a_§ve
;

165 
	}
}

	@icmp_socket.c

20 
	~"maš.h
"

21 
	~<lšux/debugfs.h
>

22 
	~<lšux/¦ab.h
>

23 
	~"icmp_sock‘.h
"

24 
	~"£nd.h
"

25 
	~"hash.h
"

26 
	~"Üigš©Ü.h
"

27 
	~"h¬d-š‹rçû.h
"

29 
b©adv_sock‘_ş›Á
 *
	gb©adv_sock‘_ş›Á_hash
[256];

31 
b©adv_sock‘_add_·ck‘
(
b©adv_sock‘_ş›Á
 *
sock‘_ş›Á
,

32 
b©adv_icmp_·ck‘_¼
 *
icmp_·ck‘
,

33 
size_t
 
icmp_Ën
);

35 
	$b©adv_sock‘_š™
()

37 
	`mem£t
(
b©adv_sock‘_ş›Á_hash
, 0, (batadv_socket_client_hash));

38 
	}
}

40 
	$b©adv_sock‘_İ’
(
šode
 *šode, 
fe
 *file)

42 
i
;

43 
b©adv_sock‘_ş›Á
 *
sock‘_ş›Á
;

45 
	`nÚ£ekabË_İ’
(
šode
, 
fe
);

47 
sock‘_ş›Á
 = 
	`km®loc
((*sock‘_ş›Á), 
GFP_KERNEL
);

49 ià(!
sock‘_ş›Á
)

50  -
ENOMEM
;

52 
i
 = 0; i < 
	`ARRAY_SIZE
(
b©adv_sock‘_ş›Á_hash
); i++) {

53 ià(!
b©adv_sock‘_ş›Á_hash
[
i
]) {

54 
b©adv_sock‘_ş›Á_hash
[
i
] = 
sock‘_ş›Á
;

59 ià(
i
 =ğ
	`ARRAY_SIZE
(
b©adv_sock‘_ş›Á_hash
)) {

60 
	`´_”r
("Error - can't‡dd‡nother…acket client: maximum‚umber of clients„eached\n");

61 
	`kä“
(
sock‘_ş›Á
);

62  -
EXFULL
;

65 
	`INIT_LIST_HEAD
(&
sock‘_ş›Á
->
queue_li¡
);

66 
sock‘_ş›Á
->
queue_Ën
 = 0;

67 
sock‘_ş›Á
->
šdex
 = 
i
;

68 
sock‘_ş›Á
->
b©_´iv
 = 
šode
->
i_´iv©e
;

69 
	`¥š_lock_š™
(&
sock‘_ş›Á
->
lock
);

70 
	`š™_wa™queue_h—d
(&
sock‘_ş›Á
->
queue_wa™
);

72 
fe
->
´iv©e_d©a
 = 
sock‘_ş›Á
;

74 
	`b©adv_šc_moduË_couÁ
();

76 
	}
}

78 
	$b©adv_sock‘_»Ëa£
(
šode
 *šode, 
fe
 *file)

80 
b©adv_sock‘_ş›Á
 *
sock‘_ş›Á
 = 
fe
->
´iv©e_d©a
;

81 
b©adv_sock‘_·ck‘
 *
sock‘_·ck‘
;

82 
li¡_h—d
 *
li¡_pos
, *
li¡_pos_tmp
;

84 
	`¥š_lock_bh
(&
sock‘_ş›Á
->
lock
);

87 
	`li¡_fÜ_—ch_§ã
(
li¡_pos
, 
li¡_pos_tmp
, &
sock‘_ş›Á
->
queue_li¡
) {

88 
sock‘_·ck‘
 = 
	`li¡_’Œy
(
li¡_pos
,

89 
b©adv_sock‘_·ck‘
, 
li¡
);

91 
	`li¡_d–
(
li¡_pos
);

92 
	`kä“
(
sock‘_·ck‘
);

95 
b©adv_sock‘_ş›Á_hash
[
sock‘_ş›Á
->
šdex
] = 
NULL
;

96 
	`¥š_uÆock_bh
(&
sock‘_ş›Á
->
lock
);

98 
	`kä“
(
sock‘_ş›Á
);

99 
	`b©adv_dec_moduË_couÁ
();

102 
	}
}

104 
ssize_t
 
	$b©adv_sock‘_»ad
(
fe
 *fe, 
__u£r
 *
buf
,

105 
size_t
 
couÁ
, 
loff_t
 *
µos
)

107 
b©adv_sock‘_ş›Á
 *
sock‘_ş›Á
 = 
fe
->
´iv©e_d©a
;

108 
b©adv_sock‘_·ck‘
 *
sock‘_·ck‘
;

109 
size_t
 
·ck‘_Ën
;

110 
”rÜ
;

112 ià((
fe
->
f_æags
 & 
O_NONBLOCK
è&& (
sock‘_ş›Á
->
queue_Ën
 == 0))

113  -
EAGAIN
;

115 ià((!
buf
è|| (
couÁ
 < (
b©adv_icmp_·ck‘
)))

116  -
EINVAL
;

118 ià(!
	`acûss_ok
(
VERIFY_WRITE
, 
buf
, 
couÁ
))

119  -
EFAULT
;

121 
”rÜ
 = 
	`wa™_ev’t_š‹¼u±ibË
(
sock‘_ş›Á
->
queue_wa™
,

122 
sock‘_ş›Á
->
queue_Ën
);

124 ià(
”rÜ
)

125  
”rÜ
;

127 
	`¥š_lock_bh
(&
sock‘_ş›Á
->
lock
);

129 
sock‘_·ck‘
 = 
	`li¡_fœ¡_’Œy
(&
sock‘_ş›Á
->
queue_li¡
,

130 
b©adv_sock‘_·ck‘
, 
li¡
);

131 
	`li¡_d–
(&
sock‘_·ck‘
->
li¡
);

132 
sock‘_ş›Á
->
queue_Ën
--;

134 
	`¥š_uÆock_bh
(&
sock‘_ş›Á
->
lock
);

136 
·ck‘_Ën
 = 
	`mš
(
couÁ
, 
sock‘_·ck‘
->
icmp_Ën
);

137 
”rÜ
 = 
	`cİy_to_u£r
(
buf
, &
sock‘_·ck‘
->
icmp_·ck‘
, 
·ck‘_Ën
);

139 
	`kä“
(
sock‘_·ck‘
);

141 ià(
”rÜ
)

142  -
EFAULT
;

144  
·ck‘_Ën
;

145 
	}
}

147 
ssize_t
 
	$b©adv_sock‘_wr™e
(
fe
 *fe, cÚ¡ 
__u£r
 *
buff
,

148 
size_t
 
Ën
, 
loff_t
 *
off
)

150 
b©adv_sock‘_ş›Á
 *
sock‘_ş›Á
 = 
fe
->
´iv©e_d©a
;

151 
b©adv_´iv
 *
b©_´iv
 = 
sock‘_ş›Á
->bat_priv;

152 
b©adv_h¬d_içû
 *
´im¬y_if
 = 
NULL
;

153 
sk_buff
 *
skb
;

154 
b©adv_icmp_·ck‘_¼
 *
icmp_·ck‘
;

156 
b©adv_Üig_node
 *
Üig_node
 = 
NULL
;

157 
b©adv_Ãigh_node
 *
Ãigh_node
 = 
NULL
;

158 
size_t
 
·ck‘_Ën
 = (
b©adv_icmp_·ck‘
);

160 ià(
Ën
 < (
b©adv_icmp_·ck‘
)) {

161 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

163  -
EINVAL
;

166 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

168 ià(!
´im¬y_if
) {

169 
Ën
 = -
EFAULT
;

170 
out
;

173 ià(
Ën
 >ğ(
b©adv_icmp_·ck‘_¼
))

174 
·ck‘_Ën
 = (
b©adv_icmp_·ck‘_¼
);

176 
skb
 = 
	`dev_®loc_skb
(
·ck‘_Ën
 + 
ETH_HLEN
);

177 ià(!
skb
) {

178 
Ën
 = -
ENOMEM
;

179 
out
;

182 
	`skb_»£rve
(
skb
, 
ETH_HLEN
);

183 
icmp_·ck‘
 = (
b©adv_icmp_·ck‘_¼
 *)
	`skb_put
(
skb
, 
·ck‘_Ën
);

185 ià(
	`cİy_äom_u£r
(
icmp_·ck‘
, 
buff
, 
·ck‘_Ën
)) {

186 
Ën
 = -
EFAULT
;

187 
ä“_skb
;

190 ià(
icmp_·ck‘
->
h—d”
.
·ck‘_ty³
 !ğ
BATADV_ICMP
) {

191 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

193 
Ën
 = -
EINVAL
;

194 
ä“_skb
;

197 ià(
icmp_·ck‘
->
msg_ty³
 !ğ
BATADV_ECHO_REQUEST
) {

198 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

200 
Ën
 = -
EINVAL
;

201 
ä“_skb
;

204 
icmp_·ck‘
->
uid
 = 
sock‘_ş›Á
->
šdex
;

206 ià(
icmp_·ck‘
->
h—d”
.
v”siÚ
 !ğ
BATADV_COMPAT_VERSION
) {

207 
icmp_·ck‘
->
msg_ty³
 = 
BATADV_PARAMETER_PROBLEM
;

208 
icmp_·ck‘
->
h—d”
.
v”siÚ
 = 
BATADV_COMPAT_VERSION
;

209 
	`b©adv_sock‘_add_·ck‘
(
sock‘_ş›Á
, 
icmp_·ck‘
,

210 
·ck‘_Ën
);

211 
ä“_skb
;

214 ià(
	`©omic_»ad
(&
b©_´iv
->
mesh_¡©e
è!ğ
BATADV_MESH_ACTIVE
)

215 
d¡_uÄ—ch
;

217 
Üig_node
 = 
	`b©adv_Üig_hash_fšd
(
b©_´iv
, 
icmp_·ck‘
->
d¡
);

218 ià(!
Üig_node
)

219 
d¡_uÄ—ch
;

221 
Ãigh_node
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_node
);

222 ià(!
Ãigh_node
)

223 
d¡_uÄ—ch
;

225 ià(!
Ãigh_node
->
if_šcomšg
)

226 
d¡_uÄ—ch
;

228 ià(
Ãigh_node
->
if_šcomšg
->
if_¡©us
 !ğ
BATADV_IF_ACTIVE
)

229 
d¡_uÄ—ch
;

231 
	`memıy
(
icmp_·ck‘
->
Üig
,

232 
´im¬y_if
->
Ãt_dev
->
dev_addr
, 
ETH_ALEN
);

234 ià(
·ck‘_Ën
 =ğ(
b©adv_icmp_·ck‘_¼
))

235 
	`memıy
(
icmp_·ck‘
->
¼
,

236 
Ãigh_node
->
if_šcomšg
->
Ãt_dev
->
dev_addr
, 
ETH_ALEN
);

238 
	`b©adv_£nd_skb_·ck‘
(
skb
, 
Ãigh_node
->
if_šcomšg
,‚eigh_node->
addr
);

239 
out
;

241 
d¡_uÄ—ch
:

242 
icmp_·ck‘
->
msg_ty³
 = 
BATADV_DESTINATION_UNREACHABLE
;

243 
	`b©adv_sock‘_add_·ck‘
(
sock‘_ş›Á
, 
icmp_·ck‘
, 
·ck‘_Ën
);

244 
ä“_skb
:

245 
	`kä“_skb
(
skb
);

246 
out
:

247 ià(
´im¬y_if
)

248 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

249 ià(
Ãigh_node
)

250 
	`b©adv_Ãigh_node_ä“_»f
(
Ãigh_node
);

251 ià(
Üig_node
)

252 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

253  
Ën
;

254 
	}
}

256 
	$b©adv_sock‘_pŞl
(
fe
 *fe, 
pŞl_bË
 *
wa™
)

258 
b©adv_sock‘_ş›Á
 *
sock‘_ş›Á
 = 
fe
->
´iv©e_d©a
;

260 
	`pŞl_wa™
(
fe
, &
sock‘_ş›Á
->
queue_wa™
, 
wa™
);

262 ià(
sock‘_ş›Á
->
queue_Ën
 > 0)

263  
POLLIN
 | 
POLLRDNORM
;

266 
	}
}

268 cÚ¡ 
fe_İ”©iÚs
 
	gb©adv_fİs
 = {

269 .
owÃr
 = 
THIS_MODULE
,

270 .
	gİ’
 = 
b©adv_sock‘_İ’
,

271 .
	g»Ëa£
 = 
b©adv_sock‘_»Ëa£
,

272 .
	g»ad
 = 
b©adv_sock‘_»ad
,

273 .
	gwr™e
 = 
b©adv_sock‘_wr™e
,

274 .
	gpŞl
 = 
b©adv_sock‘_pŞl
,

275 .
	gÎ£ek
 = 
no_Î£ek
,

278 
	$b©adv_sock‘_£tup
(
b©adv_´iv
 *
b©_´iv
)

280 
d’Œy
 *
d
;

282 ià(!
b©_´iv
->
debug_dœ
)

283 
”r
;

285 
d
 = 
	`debugfs_ü—‹_fe
(
BATADV_ICMP_SOCKET
, 
S_IFREG
 | 
S_IWUSR
 | 
S_IRUSR
,

286 
b©_´iv
->
debug_dœ
, b©_´iv, &
b©adv_fİs
);

287 ià(!
d
)

288 
”r
;

292 
”r
:

293  -
ENOMEM
;

294 
	}
}

296 
	$b©adv_sock‘_add_·ck‘
(
b©adv_sock‘_ş›Á
 *
sock‘_ş›Á
,

297 
b©adv_icmp_·ck‘_¼
 *
icmp_·ck‘
,

298 
size_t
 
icmp_Ën
)

300 
b©adv_sock‘_·ck‘
 *
sock‘_·ck‘
;

302 
sock‘_·ck‘
 = 
	`km®loc
((*sock‘_·ck‘), 
GFP_ATOMIC
);

304 ià(!
sock‘_·ck‘
)

307 
	`INIT_LIST_HEAD
(&
sock‘_·ck‘
->
li¡
);

308 
	`memıy
(&
sock‘_·ck‘
->
icmp_·ck‘
, icmp_·ck‘, 
icmp_Ën
);

309 
sock‘_·ck‘
->
icmp_Ën
 = icmp_len;

311 
	`¥š_lock_bh
(&
sock‘_ş›Á
->
lock
);

316 ià(!
b©adv_sock‘_ş›Á_hash
[
icmp_·ck‘
->
uid
]) {

317 
	`¥š_uÆock_bh
(&
sock‘_ş›Á
->
lock
);

318 
	`kä“
(
sock‘_·ck‘
);

322 
	`li¡_add_
(&
sock‘_·ck‘
->
li¡
, &
sock‘_ş›Á
->
queue_li¡
);

323 
sock‘_ş›Á
->
queue_Ën
++;

325 ià(
sock‘_ş›Á
->
queue_Ën
 > 100) {

326 
sock‘_·ck‘
 = 
	`li¡_fœ¡_’Œy
(&
sock‘_ş›Á
->
queue_li¡
,

327 
b©adv_sock‘_·ck‘
,

328 
li¡
);

330 
	`li¡_d–
(&
sock‘_·ck‘
->
li¡
);

331 
	`kä“
(
sock‘_·ck‘
);

332 
sock‘_ş›Á
->
queue_Ën
--;

335 
	`¥š_uÆock_bh
(&
sock‘_ş›Á
->
lock
);

337 
	`wake_up
(&
sock‘_ş›Á
->
queue_wa™
);

338 
	}
}

340 
	$b©adv_sock‘_»ûive_·ck‘
(
b©adv_icmp_·ck‘_¼
 *
icmp_·ck‘
,

341 
size_t
 
icmp_Ën
)

343 
b©adv_sock‘_ş›Á
 *
hash
;

345 
hash
 = 
b©adv_sock‘_ş›Á_hash
[
icmp_·ck‘
->
uid
];

346 ià(
hash
)

347 
	`b©adv_sock‘_add_·ck‘
(
hash
, 
icmp_·ck‘
, 
icmp_Ën
);

348 
	}
}

	@icmp_socket.h

20 #iâdeà
_NET_BATMAN_ADV_ICMP_SOCKET_H_


21 
	#_NET_BATMAN_ADV_ICMP_SOCKET_H_


	)

23 
	#BATADV_ICMP_SOCKET
 "sock‘"

	)

25 
b©adv_sock‘_š™
();

26 
b©adv_sock‘_£tup
(
b©adv_´iv
 *
b©_´iv
);

27 
b©adv_sock‘_»ûive_·ck‘
(
b©adv_icmp_·ck‘_¼
 *
icmp_·ck‘
,

28 
size_t
 
icmp_Ën
);

	@main.c

20 
	~"maš.h
"

21 
	~"sysfs.h
"

22 
	~"debugfs.h
"

23 
	~"routšg.h
"

24 
	~"£nd.h
"

25 
	~"Üigš©Ü.h
"

26 
	~"soá-š‹rçû.h
"

27 
	~"icmp_sock‘.h
"

28 
	~"Œª¦©iÚ-bË.h
"

29 
	~"h¬d-š‹rçû.h
"

30 
	~"g©eway_ş›Á.h
"

31 
	~"bridge_loİ_avoidªû.h
"

32 
	~"vis.h
"

33 
	~"hash.h
"

34 
	~"b©_®go.h
"

40 
li¡_h—d
 
	gb©adv_h¬dif_li¡
;

41 (*
b©adv_rx_hªdËr
[256])(
sk_buff
 *,

42 
b©adv_h¬d_içû
 *);

43 
b©adv_routšg_®go
[20] = "BATMAN_IV";

44 
hli¡_h—d
 
b©adv_®go_li¡
;

46 
b©adv_brßdÿ¡_addr
[] = {0xff, 0xff, 0xff, 0xff, 0xff, 0xff
	}
};

48 
wÜkqueue_¡ruù
 *
	gb©adv_ev’t_wÜkqueue
;

50 
b©adv_»cv_hªdËr_š™
();

52 
__š™
 
	$b©adv_š™
()

54 
	`INIT_LIST_HEAD
(&
b©adv_h¬dif_li¡
);

55 
	`INIT_HLIST_HEAD
(&
b©adv_®go_li¡
);

57 
	`b©adv_»cv_hªdËr_š™
();

59 
	`b©adv_iv_š™
();

61 
b©adv_ev’t_wÜkqueue
 = 
	`ü—‹_sšgËth»ad_wÜkqueue
("bat_events");

63 ià(!
b©adv_ev’t_wÜkqueue
)

64  -
ENOMEM
;

66 
	`b©adv_sock‘_š™
();

67 
	`b©adv_debugfs_š™
();

69 
	`»gi¡”_Ãtdeviû_nÙif›r
(&
b©adv_h¬d_if_nÙif›r
);

71 
	`´_šfo
("B.A.T.M.A.N.‡dvanced %s (compatibility version %i)†oaded\n",

72 
BATADV_SOURCE_VERSION
, 
BATADV_COMPAT_VERSION
);

75 
	}
}

77 
__ex™
 
	$b©adv_ex™
()

79 
	`b©adv_debugfs_de¡roy
();

80 
	`uÄegi¡”_Ãtdeviû_nÙif›r
(&
b©adv_h¬d_if_nÙif›r
);

81 
	`b©adv_h¬dif_»move_š‹rçûs
();

83 
	`æush_wÜkqueue
(
b©adv_ev’t_wÜkqueue
);

84 
	`de¡roy_wÜkqueue
(
b©adv_ev’t_wÜkqueue
);

85 
b©adv_ev’t_wÜkqueue
 = 
NULL
;

87 
	`rcu_b¬r›r
();

88 
	}
}

90 
	$b©adv_mesh_š™
(
Ãt_deviû
 *
soá_içû
)

92 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
soá_içû
);

93 
»t
;

95 
	`¥š_lock_š™
(&
b©_´iv
->
fÜw_b©_li¡_lock
);

96 
	`¥š_lock_š™
(&
b©_´iv
->
fÜw_bÿ¡_li¡_lock
);

97 
	`¥š_lock_š™
(&
b©_´iv
->
‰
.
chªges_li¡_lock
);

98 
	`¥š_lock_š™
(&
b©_´iv
->
‰
.
»q_li¡_lock
);

99 
	`¥š_lock_š™
(&
b©_´iv
->
‰
.
rßm_li¡_lock
);

100 
	`¥š_lock_š™
(&
b©_´iv
->
‰
.
Ï¡_chªge£t_lock
);

101 
	`¥š_lock_š™
(&
b©_´iv
->
gw
.
li¡_lock
);

102 
	`¥š_lock_š™
(&
b©_´iv
->
vis
.
hash_lock
);

103 
	`¥š_lock_š™
(&
b©_´iv
->
vis
.
li¡_lock
);

105 
	`INIT_HLIST_HEAD
(&
b©_´iv
->
fÜw_b©_li¡
);

106 
	`INIT_HLIST_HEAD
(&
b©_´iv
->
fÜw_bÿ¡_li¡
);

107 
	`INIT_HLIST_HEAD
(&
b©_´iv
->
gw
.
li¡
);

108 
	`INIT_LIST_HEAD
(&
b©_´iv
->
‰
.
chªges_li¡
);

109 
	`INIT_LIST_HEAD
(&
b©_´iv
->
‰
.
»q_li¡
);

110 
	`INIT_LIST_HEAD
(&
b©_´iv
->
‰
.
rßm_li¡
);

112 
»t
 = 
	`b©adv_Üigš©Ü_š™
(
b©_´iv
);

113 ià(
»t
 < 0)

114 
”r
;

116 
»t
 = 
	`b©adv_‰_š™
(
b©_´iv
);

117 ià(
»t
 < 0)

118 
”r
;

120 
	`b©adv_‰_loÿl_add
(
soá_içû
, soá_içû->
dev_addr
,

121 
BATADV_NULL_IFINDEX
);

123 
»t
 = 
	`b©adv_vis_š™
(
b©_´iv
);

124 ià(
»t
 < 0)

125 
”r
;

127 
»t
 = 
	`b©adv_bÏ_š™
(
b©_´iv
);

128 ià(
»t
 < 0)

129 
”r
;

131 
	`©omic_£t
(&
b©_´iv
->
gw
.
»£Ëù
, 0);

132 
	`©omic_£t
(&
b©_´iv
->
mesh_¡©e
, 
BATADV_MESH_ACTIVE
);

136 
”r
:

137 
	`b©adv_mesh_ä“
(
soá_içû
);

138  
»t
;

139 
	}
}

141 
	$b©adv_mesh_ä“
(
Ãt_deviû
 *
soá_içû
)

143 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
soá_içû
);

145 
	`©omic_£t
(&
b©_´iv
->
mesh_¡©e
, 
BATADV_MESH_DEACTIVATING
);

147 
	`b©adv_purge_out¡ªdšg_·ck‘s
(
b©_´iv
, 
NULL
);

149 
	`b©adv_vis_qu™
(
b©_´iv
);

151 
	`b©adv_gw_node_purge
(
b©_´iv
);

152 
	`b©adv_Üigš©Ü_ä“
(
b©_´iv
);

154 
	`b©adv_‰_ä“
(
b©_´iv
);

156 
	`b©adv_bÏ_ä“
(
b©_´iv
);

158 
	`ä“_³rıu
(
b©_´iv
->
b©_couÁ”s
);

160 
	`©omic_£t
(&
b©_´iv
->
mesh_¡©e
, 
BATADV_MESH_INACTIVE
);

161 
	}
}

163 
	$b©adv_šc_moduË_couÁ
()

165 
	`Œy_moduË_g‘
(
THIS_MODULE
);

166 
	}
}

168 
	$b©adv_dec_moduË_couÁ
()

170 
	`moduË_put
(
THIS_MODULE
);

171 
	}
}

173 
	$b©adv_is_my_mac
(cÚ¡ 
ušt8_t
 *
addr
)

175 cÚ¡ 
b©adv_h¬d_içû
 *
h¬d_içû
;

177 
	`rcu_»ad_lock
();

178 
	`li¡_fÜ_—ch_’Œy_rcu
(
h¬d_içû
, &
b©adv_h¬dif_li¡
, 
li¡
) {

179 ià(
h¬d_içû
->
if_¡©us
 !ğ
BATADV_IF_ACTIVE
)

182 ià(
	`b©adv_com·»_‘h
(
h¬d_içû
->
Ãt_dev
->
dev_addr
, 
addr
)) {

183 
	`rcu_»ad_uÆock
();

187 
	`rcu_»ad_uÆock
();

189 
	}
}

191 
	$b©adv_»cv_unhªdËd_·ck‘
(
sk_buff
 *
skb
,

192 
b©adv_h¬d_içû
 *
»cv_if
)

194  
NET_RX_DROP
;

195 
	}
}

200 
	$b©adv_b©mª_skb_»cv
(
sk_buff
 *
skb
, 
Ãt_deviû
 *
dev
,

201 
·ck‘_ty³
 *
±y³
,

202 
Ãt_deviû
 *
Üig_dev
)

204 
b©adv_´iv
 *
b©_´iv
;

205 
b©adv_ogm_·ck‘
 *batadv_ogm_packet;

206 
b©adv_h¬d_içû
 *
h¬d_içû
;

207 
ušt8_t
 
idx
;

208 
»t
;

210 
h¬d_içû
 = 
	`cÚš”_of
(
±y³
, 
b©adv_h¬d_içû
,

211 
b©mª_adv_±y³
);

212 
skb
 = 
	`skb_sh¬e_check
(skb, 
GFP_ATOMIC
);

215 ià(!
skb
)

216 
”r_out
;

219 ià(
	`uÆik–y
(!
	`pskb_may_puÎ
(
skb
, 2)))

220 
”r_ä“
;

223 ià(
	`uÆik–y
(
skb
->
mac_Ën
 !ğ
ETH_HLEN
 || !
	`skb_mac_h—d”
(skb)))

224 
”r_ä“
;

226 ià(!
h¬d_içû
->
soá_içû
)

227 
”r_ä“
;

229 
b©_´iv
 = 
	`Ãtdev_´iv
(
h¬d_içû
->
soá_içû
);

231 ià(
	`©omic_»ad
(&
b©_´iv
->
mesh_¡©e
è!ğ
BATADV_MESH_ACTIVE
)

232 
”r_ä“
;

235 ià(
h¬d_içû
->
if_¡©us
 !ğ
BATADV_IF_ACTIVE
)

236 
”r_ä“
;

238 
b©adv_ogm_·ck‘
 = (b©adv_ogm_·ck‘ *)
skb
->
d©a
;

240 ià(
b©adv_ogm_·ck‘
->
h—d”
.
v”siÚ
 !ğ
BATADV_COMPAT_VERSION
) {

241 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

243 
b©adv_ogm_·ck‘
->
h—d”
.
v”siÚ
);

244 
”r_ä“
;

250 
idx
 = 
b©adv_ogm_·ck‘
->
h—d”
.
·ck‘_ty³
;

251 
»t
 = (*
b©adv_rx_hªdËr
[
idx
])(
skb
, 
h¬d_içû
);

253 ià(
»t
 =ğ
NET_RX_DROP
)

254 
	`kä“_skb
(
skb
);

260  
NET_RX_SUCCESS
;

262 
”r_ä“
:

263 
	`kä“_skb
(
skb
);

264 
”r_out
:

265  
NET_RX_DROP
;

266 
	}
}

268 
	$b©adv_»cv_hªdËr_š™
()

270 
i
;

272 
i
 = 0; i < 
	`ARRAY_SIZE
(
b©adv_rx_hªdËr
); i++)

273 
b©adv_rx_hªdËr
[
i
] = 
b©adv_»cv_unhªdËd_·ck‘
;

276 
b©adv_rx_hªdËr
[
BATADV_ICMP
] = 
b©adv_»cv_icmp_·ck‘
;

278 
b©adv_rx_hªdËr
[
BATADV_UNICAST
] = 
b©adv_»cv_uniÿ¡_·ck‘
;

280 
b©adv_rx_hªdËr
[
BATADV_UNICAST_FRAG
] = 
b©adv_»cv_uÿ¡_äag_·ck‘
;

282 
b©adv_rx_hªdËr
[
BATADV_BCAST
] = 
b©adv_»cv_bÿ¡_·ck‘
;

284 
b©adv_rx_hªdËr
[
BATADV_VIS
] = 
b©adv_»cv_vis_·ck‘
;

286 
b©adv_rx_hªdËr
[
BATADV_TT_QUERY
] = 
b©adv_»cv_‰_qu”y
;

288 
b©adv_rx_hªdËr
[
BATADV_ROAM_ADV
] = 
b©adv_»cv_rßm_adv
;

289 
	}
}

292 
b©adv_»cv_hªdËr_»gi¡”
(
ušt8_t
 
·ck‘_ty³
,

293 (*
»cv_hªdËr
)(
sk_buff
 *,

294 
b©adv_h¬d_içû
 *))

296 ià(
b©adv_rx_hªdËr
[
·ck‘_ty³
] !ğ&
b©adv_»cv_unhªdËd_·ck‘
)

297  -
EBUSY
;

299 
b©adv_rx_hªdËr
[
·ck‘_ty³
] = 
»cv_hªdËr
;

301 
	}
}

303 
	$b©adv_»cv_hªdËr_uÄegi¡”
(
ušt8_t
 
·ck‘_ty³
)

305 
b©adv_rx_hªdËr
[
·ck‘_ty³
] = 
b©adv_»cv_unhªdËd_·ck‘
;

306 
	}
}

308 
b©adv_®go_İs
 *
	$b©adv_®go_g‘
(*
Çme
)

310 
b©adv_®go_İs
 *
b©_®go_İs
 = 
NULL
, *
b©_®go_İs_tmp
;

311 
hli¡_node
 *
node
;

313 
	`hli¡_fÜ_—ch_’Œy
(
b©_®go_İs_tmp
, 
node
, &
b©adv_®go_li¡
, 
li¡
) {

314 ià(
	`¡rcmp
(
b©_®go_İs_tmp
->
Çme
,‚ame) != 0)

317 
b©_®go_İs
 = 
b©_®go_İs_tmp
;

321  
b©_®go_İs
;

322 
	}
}

324 
	$b©adv_®go_»gi¡”
(
b©adv_®go_İs
 *
b©_®go_İs
)

326 
b©adv_®go_İs
 *
b©_®go_İs_tmp
;

327 
»t
;

329 
b©_®go_İs_tmp
 = 
	`b©adv_®go_g‘
(
b©_®go_İs
->
Çme
);

330 ià(
b©_®go_İs_tmp
) {

331 
	`´_šfo
("Tryingo„egister‡lready„egistered„outing‡lgorithm: %s\n",

332 
b©_®go_İs
->
Çme
);

333 
»t
 = -
EEXIST
;

334 
out
;

338 ià(!
b©_®go_İs
->
b©_içû_’abË
 ||

339 !
b©_®go_İs
->
b©_içû_di§bË
 ||

340 !
b©_®go_İs
->
b©_içû_upd©e_mac
 ||

341 !
b©_®go_İs
->
b©_´im¬y_içû_£t
 ||

342 !
b©_®go_İs
->
b©_ogm_scheduË
 ||

343 !
b©_®go_İs
->
b©_ogm_em™
) {

344 
	`´_šfo
("Routing‡lgo '%s' does‚ot implement„equired ops\n",

345 
b©_®go_İs
->
Çme
);

346 
»t
 = -
EINVAL
;

347 
out
;

350 
	`INIT_HLIST_NODE
(&
b©_®go_İs
->
li¡
);

351 
	`hli¡_add_h—d
(&
b©_®go_İs
->
li¡
, &
b©adv_®go_li¡
);

352 
»t
 = 0;

354 
out
:

355  
»t
;

356 
	}
}

358 
	$b©adv_®go_£Ëù
(
b©adv_´iv
 *
b©_´iv
, *
Çme
)

360 
b©adv_®go_İs
 *
b©_®go_İs
;

361 
»t
 = -
EINVAL
;

363 
b©_®go_İs
 = 
	`b©adv_®go_g‘
(
Çme
);

364 ià(!
b©_®go_İs
)

365 
out
;

367 
b©_´iv
->
b©_®go_İs
 = bat_algo_ops;

368 
»t
 = 0;

370 
out
:

371  
»t
;

372 
	}
}

374 
	$b©adv_®go_£q_´št_‹xt
(
£q_fe
 *
£q
, *
off£t
)

376 
b©adv_®go_İs
 *
b©_®go_İs
;

377 
hli¡_node
 *
node
;

379 
	`£q_´štf
(
£q
, "Available„outing‡lgorithms:\n");

381 
	`hli¡_fÜ_—ch_’Œy
(
b©_®go_İs
, 
node
, &
b©adv_®go_li¡
, 
li¡
) {

382 
	`£q_´štf
(
£q
, "%s\n", 
b©_®go_İs
->
Çme
);

386 
	}
}

388 
	$b©adv_·¿m_£t_¿
(cÚ¡ *
v®
, cÚ¡ 
k”Ãl_·¿m
 *
kp
)

390 
b©adv_®go_İs
 *
b©_®go_İs
;

391 *
®go_Çme
 = (*)
v®
;

392 
size_t
 
Çme_Ën
 = 
	`¡¾’
(
®go_Çme
);

394 ià(
®go_Çme
[
Çme_Ën
 - 1] == '\n')

395 
®go_Çme
[
Çme_Ën
 - 1] = '\0';

397 
b©_®go_İs
 = 
	`b©adv_®go_g‘
(
®go_Çme
);

398 ià(!
b©_®go_İs
) {

399 
	`´_”r
("Routšg‡lgÜ™hm '%s' i nÙ suµÜ‹d\n", 
®go_Çme
);

400  -
EINVAL
;

403  
	`·¿m_£t_cİy¡ršg
(
®go_Çme
, 
kp
);

404 
	}
}

406 cÚ¡ 
k”Ãl_·¿m_İs
 
	gb©adv_·¿m_İs_¿
 = {

407 .
£t
 = 
b©adv_·¿m_£t_¿
,

408 .
	gg‘
 = 
·¿m_g‘_¡ršg
,

411 
k·¿m_¡ršg
 
	gb©adv_·¿m_¡ršg_¿
 = {

412 .
maxËn
 = (
b©adv_routšg_®go
),

413 .
	g¡ršg
 = 
b©adv_routšg_®go
,

416 
moduË_·¿m_cb
(
routšg_®go
, &
b©adv_·¿m_İs_¿
, &
b©adv_·¿m_¡ršg_¿
,

418 
moduË_š™
(
b©adv_š™
);

419 
moduË_ex™
(
b©adv_ex™
);

421 
MODULE_LICENSE
("GPL");

423 
MODULE_AUTHOR
(
BATADV_DRIVER_AUTHOR
);

424 
MODULE_DESCRIPTION
(
BATADV_DRIVER_DESC
);

425 
MODULE_SUPPORTED_DEVICE
(
BATADV_DRIVER_DEVICE
);

426 
MODULE_VERSION
(
BATADV_SOURCE_VERSION
);

	@main.h

20 #iâdeà
_NET_BATMAN_ADV_MAIN_H_


21 
	#_NET_BATMAN_ADV_MAIN_H_


	)

23 
	#BATADV_DRIVER_AUTHOR
 "Marek Lindner <lindner_marek@yahoo.de>, " \

24 "SimÚ Wund”lich <siwu@hrz.tu-chemn™z.de>"

	)

25 
	#BATADV_DRIVER_DESC
 "B.A.T.M.A.N.‡dvªûd"

	)

26 
	#BATADV_DRIVER_DEVICE
 "b©mª-adv"

	)

28 #iâdeà
BATADV_SOURCE_VERSION


29 
	#BATADV_SOURCE_VERSION
 "2012.4.0"

	)

34 
	#BATADV_TQ_MAX_VALUE
 255

	)

35 
	#BATADV_JITTER
 20

	)

38 
	#BATADV_TTL
 50

	)

43 
	#BATADV_PURGE_TIMEOUT
 200000

	)

44 
	#BATADV_TT_LOCAL_TIMEOUT
 3600000

	)

45 
	#BATADV_TT_CLIENT_ROAM_TIMEOUT
 600000

	)

46 
	#BATADV_TT_CLIENT_TEMP_TIMEOUT
 600000

	)

50 
	#BATADV_TQ_LOCAL_WINDOW_SIZE
 64

	)

52 
	#BATADV_TT_REQUEST_TIMEOUT
 3000

	)

54 
	#BATADV_TQ_GLOBAL_WINDOW_SIZE
 5

	)

55 
	#BATADV_TQ_LOCAL_BIDRECT_SEND_MINIMUM
 1

	)

56 
	#BATADV_TQ_LOCAL_BIDRECT_RECV_MINIMUM
 1

	)

57 
	#BATADV_TQ_TOTAL_BIDRECT_LIMIT
 1

	)

60 
	#BATADV_TT_OGM_APPEND_MAX
 3

	)

65 
	#BATADV_ROAMING_MAX_TIME
 20000

	)

66 
	#BATADV_ROAMING_MAX_COUNT
 5

	)

68 
	#BATADV_NO_FLAGS
 0

	)

70 
	#BATADV_NULL_IFINDEX
 0

	)

72 
	#BATADV_NUM_WORDS
 
	`BITS_TO_LONGS
(
BATADV_TQ_LOCAL_WINDOW_SIZE
)

	)

74 
	#BATADV_LOG_BUF_LEN
 8192

	)

76 
	#BATADV_VIS_INTERVAL
 5000

	)

81 
	#BATADV_BONDING_TQ_THRESHOLD
 50

	)

86 
	#BATADV_MAX_AGGREGATION_BYTES
 512

	)

87 
	#BATADV_MAX_AGGREGATION_MS
 100

	)

89 
	#BATADV_BLA_PERIOD_LENGTH
 10000

	)

90 
	#BATADV_BLA_BACKBONE_TIMEOUT
 (
BATADV_BLA_PERIOD_LENGTH
 * 3)

	)

91 
	#BATADV_BLA_CLAIM_TIMEOUT
 (
BATADV_BLA_PERIOD_LENGTH
 * 10)

	)

93 
	#BATADV_DUPLIST_SIZE
 16

	)

94 
	#BATADV_DUPLIST_TIMEOUT
 500

	)

96 
	#BATADV_RESET_PROTECTION_MS
 30000

	)

97 
	#BATADV_EXPECTED_SEQNO_RANGE
 65536

	)

99 
	eb©adv_mesh_¡©e
 {

100 
	mBATADV_MESH_INACTIVE
,

101 
	mBATADV_MESH_ACTIVE
,

102 
	mBATADV_MESH_DEACTIVATING
,

105 
	#BATADV_BCAST_QUEUE_LEN
 256

	)

106 
	#BATADV_BATMAN_QUEUE_LEN
 256

	)

108 
	eb©adv_uev_aùiÚ
 {

109 
	mBATADV_UEV_ADD
 = 0,

110 
	mBATADV_UEV_DEL
,

111 
	mBATADV_UEV_CHANGE
,

114 
	eb©adv_uev_ty³
 {

115 
	mBATADV_UEV_GW
 = 0,

118 
	#BATADV_GW_THRESHOLD
 50

	)

121 #ifdeà
´_fmt


122 #undeà
´_fmt


125 
	#´_fmt
(
fmt
è
KBUILD_MODNAME
 ": " 
	)
fmt

129 
	~<lšux/mu‹x.h
>

130 
	~<lšux/moduË.h
>

131 
	~<lšux/Ãtdeviû.h
>

132 
	~<lšux/‘h”deviû.h
>

133 
	~<lšux/if_‘h”.h
>

134 
	~<lšux/pŞl.h
>

135 
	~<lšux/kth»ad.h
>

136 
	~<lšux/pkt_sched.h
>

137 
	~<lšux/wÜkqueue.h
>

138 
	~<lšux/³rıu.h
>

139 
	~<lšux/¦ab.h
>

140 
	~<Ãt/sock.h
>

141 
	~<lšux/jiff›s.h
>

142 
	~<lšux/£q_fe.h
>

143 
	~"com·t.h
"

145 
	~"ty³s.h
"

147 
b©adv_routšg_®go
[];

148 
li¡_h—d
 
b©adv_h¬dif_li¡
;

150 
b©adv_brßdÿ¡_addr
[];

151 
wÜkqueue_¡ruù
 *
b©adv_ev’t_wÜkqueue
;

153 
b©adv_mesh_š™
(
Ãt_deviû
 *
soá_içû
);

154 
b©adv_mesh_ä“
(
Ãt_deviû
 *
soá_içû
);

155 
b©adv_šc_moduË_couÁ
();

156 
b©adv_dec_moduË_couÁ
();

157 
b©adv_is_my_mac
(cÚ¡ 
ušt8_t
 *
addr
);

158 
b©adv_b©mª_skb_»cv
(
sk_buff
 *
skb
, 
Ãt_deviû
 *
dev
,

159 
·ck‘_ty³
 *
±y³
,

160 
Ãt_deviû
 *
Üig_dev
);

162 
b©adv_»cv_hªdËr_»gi¡”
(
ušt8_t
 
·ck‘_ty³
,

163 (*
»cv_hªdËr
)(
sk_buff
 *,

164 
b©adv_h¬d_içû
 *));

165 
	`b©adv_»cv_hªdËr_uÄegi¡”
(
ušt8_t
 
·ck‘_ty³
);

166 
	`b©adv_®go_»gi¡”
(
b©adv_®go_İs
 *
b©_®go_İs
);

167 
	`b©adv_®go_£Ëù
(
b©adv_´iv
 *
b©_´iv
, *
Çme
);

168 
	`b©adv_®go_£q_´št_‹xt
(
£q_fe
 *
£q
, *
off£t
);

171 
	eb©adv_dbg_Ëv–
 {

172 
BATADV_DBG_BATMAN
 = 
	`BIT
(0),

173 
BATADV_DBG_ROUTES
 = 
	`BIT
(1),

174 
BATADV_DBG_TT
 = 
	`BIT
(2),

175 
BATADV_DBG_BLA
 = 
	`BIT
(3),

176 
BATADV_DBG_ALL
 = 15,

179 #ifdeà
CONFIG_BATMAN_ADV_DEBUG


180 
	$b©adv_debug_log
(
b©adv_´iv
 *
b©_´iv
, cÚ¡ *
fmt
, ...)

181 
	`__´štf
(2, 3);

183 
	#b©adv_dbg
(
ty³
, 
b©_´iv
, 
fmt
, 
¬g
...) \

185 ià(
	`©omic_»ad
(&
b©_´iv
->
log_Ëv–
è& 
ty³
) \

186 
	`b©adv_debug_log
(
b©_´iv
, 
fmt
, ## 
¬g
);\

187 
	}
} \

188 0)

	)

190 
	$__´štf
(3, 4)

191 
šlše
 
	$b©adv_dbg
(
ty³
 
__®ways_unu£d
,

192 
b©adv_´iv
 *
b©_´iv
 
__®ways_unu£d
,

193 cÚ¡ *
fmt
 
__®ways_unu£d
, ...)

195 
	}
}

198 
	#b©adv_šfo
(
Ãt_dev
, 
fmt
, 
¬g
...) \

200 
Ãt_deviû
 *
_Ãtdev
 = (
Ãt_dev
); \

201 
b©adv_´iv
 *
_b©´iv
 = 
	`Ãtdev_´iv
(
_Ãtdev
); \

202 
	`b©adv_dbg
(
BATADV_DBG_ALL
, 
_b©´iv
, 
fmt
, ## 
¬g
); \

203 
	`´_šfo
("%s: " 
fmt
, 
_Ãtdev
->
Çme
, ## 
¬g
); \

204 } 0)

	)

205 
	#b©adv_”r
(
Ãt_dev
, 
fmt
, 
¬g
...) \

207 
Ãt_deviû
 *
_Ãtdev
 = (
Ãt_dev
); \

208 
b©adv_´iv
 *
_b©´iv
 = 
	`Ãtdev_´iv
(
_Ãtdev
); \

209 
	`b©adv_dbg
(
BATADV_DBG_ALL
, 
_b©´iv
, 
fmt
, ## 
¬g
); \

210 
	`´_”r
("%s: " 
fmt
, 
_Ãtdev
->
Çme
, ## 
¬g
); \

211 } 0)

	)

217 
šlše
 
	$b©adv_com·»_‘h
(cÚ¡ *
d©a1
, cÚ¡ *
d©a2
)

219  (
	`memcmp
(
d©a1
, 
d©a2
, 
ETH_ALEN
) == 0 ? 1 : 0);

220 
	}
}

229 
šlše
 
boŞ
 
	$b©adv_has_timed_out
(
time¡amp
,

230 
timeout
)

232  
	`time_is_befÜe_jiff›s
(
time¡amp
 + 
	`m£cs_to_jiff›s
(
timeout
));

233 
	}
}

235 
	#b©adv_©omic_dec_nÙ_z”o
(
v
è
	`©omic_add_uÆess
((v), -1, 0)

	)

238 
	#b©adv_sm®Ë¡_sigÃd_št
(
x
è(1u << (7u + 8u * ((xè- 1u)))

	)

250 
	#b©adv_£q_befÜe
(
x
, 
y
è({
	`ty³of
(xè
_d1
 = (x); \

251 
	`ty³of
(
y
è
_d2
 = (y); \

252 
	`ty³of
(
x
è
_dummy
 = (
_d1
 - 
_d2
); \

253 (è(&
_d1
 =ğ&
_d2
); \

254 
_dummy
 > 
	`b©adv_sm®Ë¡_sigÃd_št
(_dummy); })

	)

255 
	#b©adv_£q_aá”
(
x
, 
y
è
	`b©adv_£q_befÜe
(y, x)

	)

258 
šlše
 
	$b©adv_add_couÁ”
(
b©adv_´iv
 *
b©_´iv
, 
size_t
 
idx
,

259 
size_t
 
couÁ
)

261 
ıu
 = 
	`g‘_ıu
();

262 
	`³r_ıu_±r
(
b©_´iv
->
b©_couÁ”s
, 
ıu
)[
idx
] +ğ
couÁ
;

263 
	`put_ıu
();

264 
	}
}

266 
	#b©adv_šc_couÁ”
(
b
, 
i
è
	`b©adv_add_couÁ”
(b, i, 1)

	)

269 
šlše
 
ušt64_t
 
	$b©adv_sum_couÁ”
(
b©adv_´iv
 *
b©_´iv
,

270 
size_t
 
idx
)

272 
ušt64_t
 *
couÁ”s
, 
sum
 = 0;

273 
ıu
;

275 
	`fÜ_—ch_possibË_ıu
(
ıu
) {

276 
couÁ”s
 = 
	`³r_ıu_±r
(
b©_´iv
->
b©_couÁ”s
, 
ıu
);

277 
sum
 +ğ
couÁ”s
[
idx
];

280  
sum
;

281 
	}
}

	@originator.c

20 
	~"maš.h
"

21 
	~"Üigš©Ü.h
"

22 
	~"hash.h
"

23 
	~"Œª¦©iÚ-bË.h
"

24 
	~"routšg.h
"

25 
	~"g©eway_ş›Á.h
"

26 
	~"h¬d-š‹rçû.h
"

27 
	~"uniÿ¡.h
"

28 
	~"soá-š‹rçû.h
"

29 
	~"bridge_loİ_avoidªû.h
"

31 
b©adv_purge_Üig
(
wÜk_¡ruù
 *
wÜk
);

33 
	$b©adv_¡¬t_purge_tim”
(
b©adv_´iv
 *
b©_´iv
)

35 
	`INIT_DELAYED_WORK
(&
b©_´iv
->
Üig_wÜk
, 
b©adv_purge_Üig
);

36 
	`queue_d–ayed_wÜk
(
b©adv_ev’t_wÜkqueue
,

37 &
b©_´iv
->
Üig_wÜk
, 
	`m£cs_to_jiff›s
(1000));

38 
	}
}

41 
	$b©adv_com·»_Üig
(cÚ¡ 
hli¡_node
 *
node
, cÚ¡ *
d©a2
)

43 cÚ¡ *
d©a1
 = 
	`cÚš”_of
(
node
, 
b©adv_Üig_node
,

44 
hash_’Œy
);

46  (
	`memcmp
(
d©a1
, 
d©a2
, 
ETH_ALEN
) == 0 ? 1 : 0);

47 
	}
}

49 
	$b©adv_Üigš©Ü_š™
(
b©adv_´iv
 *
b©_´iv
)

51 ià(
b©_´iv
->
Üig_hash
)

54 
b©_´iv
->
Üig_hash
 = 
	`b©adv_hash_Ãw
(1024);

56 ià(!
b©_´iv
->
Üig_hash
)

57 
”r
;

59 
	`b©adv_¡¬t_purge_tim”
(
b©_´iv
);

62 
”r
:

63  -
ENOMEM
;

64 
	}
}

66 
	$b©adv_Ãigh_node_ä“_»f
(
b©adv_Ãigh_node
 *
Ãigh_node
)

68 ià(
	`©omic_dec_ªd_‹¡
(&
Ãigh_node
->
»fcouÁ
))

69 
	`kä“_rcu
(
Ãigh_node
, 
rcu
);

70 
	}
}

73 
b©adv_Ãigh_node
 *

74 
	$b©adv_Üig_node_g‘_rou‹r
(
b©adv_Üig_node
 *
Üig_node
)

76 
b©adv_Ãigh_node
 *
rou‹r
;

78 
	`rcu_»ad_lock
();

79 
rou‹r
 = 
	`rcu_d”eã»nû
(
Üig_node
->router);

81 ià(
rou‹r
 && !
	`©omic_šc_nÙ_z”o
(&rou‹r->
»fcouÁ
))

82 
rou‹r
 = 
NULL
;

84 
	`rcu_»ad_uÆock
();

85  
rou‹r
;

86 
	}
}

88 
b©adv_Ãigh_node
 *

89 
	$b©adv_Ãigh_node_Ãw
(
b©adv_h¬d_içû
 *
h¬d_içû
,

90 cÚ¡ 
ušt8_t
 *
Ãigh_addr
, 
ušt32_t
 
£qno
)

92 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
h¬d_içû
->
soá_içû
);

93 
b©adv_Ãigh_node
 *
Ãigh_node
;

95 
Ãigh_node
 = 
	`kz®loc
((*Ãigh_node), 
GFP_ATOMIC
);

96 ià(!
Ãigh_node
)

97 
out
;

99 
	`INIT_HLIST_NODE
(&
Ãigh_node
->
li¡
);

101 
	`memıy
(
Ãigh_node
->
addr
, 
Ãigh_addr
, 
ETH_ALEN
);

102 
	`¥š_lock_š™
(&
Ãigh_node
->
lq_upd©e_lock
);

105 
	`©omic_£t
(&
Ãigh_node
->
»fcouÁ
, 2);

107 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

109 
Ãigh_addr
, 
£qno
);

111 
out
:

112  
Ãigh_node
;

113 
	}
}

115 
	$b©adv_Üig_node_ä“_rcu
(
rcu_h—d
 *
rcu
)

117 
hli¡_node
 *
node
, *
node_tmp
;

118 
b©adv_Ãigh_node
 *
Ãigh_node
, *
tmp_Ãigh_node
;

119 
b©adv_Üig_node
 *
Üig_node
;

121 
Üig_node
 = 
	`cÚš”_of
(
rcu
, 
b©adv_Üig_node
,„cu);

123 
	`¥š_lock_bh
(&
Üig_node
->
Ãigh_li¡_lock
);

126 
	`li¡_fÜ_—ch_’Œy_§ã
(
Ãigh_node
, 
tmp_Ãigh_node
,

127 &
Üig_node
->
bÚd_li¡
, 
bÚdšg_li¡
) {

128 
	`li¡_d–_rcu
(&
Ãigh_node
->
bÚdšg_li¡
);

129 
	`b©adv_Ãigh_node_ä“_»f
(
Ãigh_node
);

133 
	`hli¡_fÜ_—ch_’Œy_§ã
(
Ãigh_node
, 
node
, 
node_tmp
,

134 &
Üig_node
->
Ãigh_li¡
, 
li¡
) {

135 
	`hli¡_d–_rcu
(&
Ãigh_node
->
li¡
);

136 
	`b©adv_Ãigh_node_ä“_»f
(
Ãigh_node
);

139 
	`¥š_uÆock_bh
(&
Üig_node
->
Ãigh_li¡_lock
);

141 
	`b©adv_äag_li¡_ä“
(&
Üig_node
->
äag_li¡
);

142 
	`b©adv_‰_glob®_d–_Üig
(
Üig_node
->
b©_´iv
, orig_node,

145 
	`kä“
(
Üig_node
->
‰_buff
);

146 
	`kä“
(
Üig_node
->
bÿ¡_own
);

147 
	`kä“
(
Üig_node
->
bÿ¡_own_sum
);

148 
	`kä“
(
Üig_node
);

149 
	}
}

151 
	$b©adv_Üig_node_ä“_»f
(
b©adv_Üig_node
 *
Üig_node
)

153 ià(
	`©omic_dec_ªd_‹¡
(&
Üig_node
->
»fcouÁ
))

154 
	`ÿÎ_rcu
(&
Üig_node
->
rcu
, 
b©adv_Üig_node_ä“_rcu
);

155 
	}
}

157 
	$b©adv_Üigš©Ü_ä“
(
b©adv_´iv
 *
b©_´iv
)

159 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
Üig_hash
;

160 
hli¡_node
 *
node
, *
node_tmp
;

161 
hli¡_h—d
 *
h—d
;

162 
¥šlock_t
 *
li¡_lock
;

163 
b©adv_Üig_node
 *
Üig_node
;

164 
ušt32_t
 
i
;

166 ià(!
hash
)

169 
	`ÿnûl_d–ayed_wÜk_sync
(&
b©_´iv
->
Üig_wÜk
);

171 
b©_´iv
->
Üig_hash
 = 
NULL
;

173 
i
 = 0; i < 
hash
->
size
; i++) {

174 
h—d
 = &
hash
->
bË
[
i
];

175 
li¡_lock
 = &
hash
->
li¡_locks
[
i
];

177 
	`¥š_lock_bh
(
li¡_lock
);

178 
	`hli¡_fÜ_—ch_’Œy_§ã
(
Üig_node
, 
node
, 
node_tmp
,

179 
h—d
, 
hash_’Œy
) {

181 
	`hli¡_d–_rcu
(
node
);

182 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

184 
	`¥š_uÆock_bh
(
li¡_lock
);

187 
	`b©adv_hash_de¡roy
(
hash
);

188 
	}
}

193 
b©adv_Üig_node
 *
	$b©adv_g‘_Üig_node
(
b©adv_´iv
 *
b©_´iv
,

194 cÚ¡ 
ušt8_t
 *
addr
)

196 
b©adv_Üig_node
 *
Üig_node
;

197 
size
;

198 
hash_added
;

199 
»£t_time
;

201 
Üig_node
 = 
	`b©adv_Üig_hash_fšd
(
b©_´iv
, 
addr
);

202 ià(
Üig_node
)

203  
Üig_node
;

205 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

206 "C»©šg‚ew origš©Ü: %pM\n", 
addr
);

208 
Üig_node
 = 
	`kz®loc
((*Üig_node), 
GFP_ATOMIC
);

209 ià(!
Üig_node
)

210  
NULL
;

212 
	`INIT_HLIST_HEAD
(&
Üig_node
->
Ãigh_li¡
);

213 
	`INIT_LIST_HEAD
(&
Üig_node
->
bÚd_li¡
);

214 
	`¥š_lock_š™
(&
Üig_node
->
ogm_út_lock
);

215 
	`¥š_lock_š™
(&
Üig_node
->
bÿ¡_£qno_lock
);

216 
	`¥š_lock_š™
(&
Üig_node
->
Ãigh_li¡_lock
);

217 
	`¥š_lock_š™
(&
Üig_node
->
‰_buff_lock
);

220 
	`©omic_£t
(&
Üig_node
->
»fcouÁ
, 2);

222 
Üig_node
->
‰_š™Ÿli£d
 = 
çl£
;

223 
Üig_node
->
‰_poss_chªge
 = 
çl£
;

224 
Üig_node
->
b©_´iv
 = bat_priv;

225 
	`memıy
(
Üig_node
->
Üig
, 
addr
, 
ETH_ALEN
);

226 
Üig_node
->
rou‹r
 = 
NULL
;

227 
Üig_node
->
‰_üc
 = 0;

228 
	`©omic_£t
(&
Üig_node
->
Ï¡_‰vn
, 0);

229 
Üig_node
->
‰_buff
 = 
NULL
;

230 
Üig_node
->
‰_buff_Ën
 = 0;

231 
	`©omic_£t
(&
Üig_node
->
‰_size
, 0);

232 
»£t_time
 = 
jiff›s
 - 1 - 
	`m£cs_to_jiff›s
(
BATADV_RESET_PROTECTION_MS
);

233 
Üig_node
->
bÿ¡_£qno_»£t
 = 
»£t_time
;

234 
Üig_node
->
b©mª_£qno_»£t
 = 
»£t_time
;

236 
	`©omic_£t
(&
Üig_node
->
bÚd_ÿndid©es
, 0);

238 
size
 = 
b©_´iv
->
num_içûs
 * (è* 
BATADV_NUM_WORDS
;

240 
Üig_node
->
bÿ¡_own
 = 
	`kz®loc
(
size
, 
GFP_ATOMIC
);

241 ià(!
Üig_node
->
bÿ¡_own
)

242 
ä“_Üig_node
;

244 
size
 = 
b©_´iv
->
num_içûs
 * (
ušt8_t
);

245 
Üig_node
->
bÿ¡_own_sum
 = 
	`kz®loc
(
size
, 
GFP_ATOMIC
);

247 
	`INIT_LIST_HEAD
(&
Üig_node
->
äag_li¡
);

248 
Üig_node
->
Ï¡_äag_·ck‘
 = 0;

250 ià(!
Üig_node
->
bÿ¡_own_sum
)

251 
ä“_bÿ¡_own
;

253 
hash_added
 = 
	`b©adv_hash_add
(
b©_´iv
->
Üig_hash
, 
b©adv_com·»_Üig
,

254 
b©adv_choo£_Üig
, 
Üig_node
,

255 &
Üig_node
->
hash_’Œy
);

256 ià(
hash_added
 != 0)

257 
ä“_bÿ¡_own_sum
;

259  
Üig_node
;

260 
ä“_bÿ¡_own_sum
:

261 
	`kä“
(
Üig_node
->
bÿ¡_own_sum
);

262 
ä“_bÿ¡_own
:

263 
	`kä“
(
Üig_node
->
bÿ¡_own
);

264 
ä“_Üig_node
:

265 
	`kä“
(
Üig_node
);

266  
NULL
;

267 
	}
}

269 
boŞ


270 
	$b©adv_purge_Üig_ÃighbÜs
(
b©adv_´iv
 *
b©_´iv
,

271 
b©adv_Üig_node
 *
Üig_node
,

272 
b©adv_Ãigh_node
 **
be¡_Ãigh_node
)

274 
hli¡_node
 *
node
, *
node_tmp
;

275 
b©adv_Ãigh_node
 *
Ãigh_node
;

276 
boŞ
 
Ãigh_purged
 = 
çl£
;

277 
Ï¡_£’
;

278 
b©adv_h¬d_içû
 *
if_šcomšg
;

280 *
be¡_Ãigh_node
 = 
NULL
;

282 
	`¥š_lock_bh
(&
Üig_node
->
Ãigh_li¡_lock
);

285 
	`hli¡_fÜ_—ch_’Œy_§ã
(
Ãigh_node
, 
node
, 
node_tmp
,

286 &
Üig_node
->
Ãigh_li¡
, 
li¡
) {

288 
Ï¡_£’
 = 
Ãigh_node
->last_seen;

289 
if_šcomšg
 = 
Ãigh_node
->if_incoming;

291 ià((
	`b©adv_has_timed_out
(
Ï¡_£’
, 
BATADV_PURGE_TIMEOUT
)) ||

292 (
if_šcomšg
->
if_¡©us
 =ğ
BATADV_IF_INACTIVE
) ||

293 (
if_šcomšg
->
if_¡©us
 =ğ
BATADV_IF_NOT_IN_USE
) ||

294 (
if_šcomšg
->
if_¡©us
 =ğ
BATADV_IF_TO_BE_REMOVED
)) {

296 ià((
if_šcomšg
->
if_¡©us
 =ğ
BATADV_IF_INACTIVE
) ||

297 (
if_šcomšg
->
if_¡©us
 =ğ
BATADV_IF_NOT_IN_USE
) ||

298 (
if_šcomšg
->
if_¡©us
 =ğ
BATADV_IF_TO_BE_REMOVED
))

299 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

301 
Üig_node
->
Üig
, 
Ãigh_node
->
addr
,

302 
if_šcomšg
->
Ãt_dev
->
Çme
);

304 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

306 
Üig_node
->
Üig
, 
Ãigh_node
->
addr
,

307 
	`jiff›s_to_m£cs
(
Ï¡_£’
));

309 
Ãigh_purged
 = 
Œue
;

311 
	`hli¡_d–_rcu
(&
Ãigh_node
->
li¡
);

312 
	`b©adv_bÚdšg_ÿndid©e_d–
(
Üig_node
, 
Ãigh_node
);

313 
	`b©adv_Ãigh_node_ä“_»f
(
Ãigh_node
);

315 ià((!*
be¡_Ãigh_node
) ||

316 (
Ãigh_node
->
tq_avg
 > (*
be¡_Ãigh_node
)->tq_avg))

317 *
be¡_Ãigh_node
 = 
Ãigh_node
;

321 
	`¥š_uÆock_bh
(&
Üig_node
->
Ãigh_li¡_lock
);

322  
Ãigh_purged
;

323 
	}
}

325 
boŞ
 
	$b©adv_purge_Üig_node
(
b©adv_´iv
 *
b©_´iv
,

326 
b©adv_Üig_node
 *
Üig_node
)

328 
b©adv_Ãigh_node
 *
be¡_Ãigh_node
;

330 ià(
	`b©adv_has_timed_out
(
Üig_node
->
Ï¡_£’
,

331 2 * 
BATADV_PURGE_TIMEOUT
)) {

332 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

334 
Üig_node
->
Üig
,

335 
	`jiff›s_to_m£cs
(
Üig_node
->
Ï¡_£’
));

336  
Œue
;

338 ià(
	`b©adv_purge_Üig_ÃighbÜs
(
b©_´iv
, 
Üig_node
,

339 &
be¡_Ãigh_node
))

340 
	`b©adv_upd©e_rou‹
(
b©_´iv
, 
Üig_node
,

341 
be¡_Ãigh_node
);

344  
çl£
;

345 
	}
}

347 
	$_b©adv_purge_Üig
(
b©adv_´iv
 *
b©_´iv
)

349 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
Üig_hash
;

350 
hli¡_node
 *
node
, *
node_tmp
;

351 
hli¡_h—d
 *
h—d
;

352 
¥šlock_t
 *
li¡_lock
;

353 
b©adv_Üig_node
 *
Üig_node
;

354 
ušt32_t
 
i
;

356 ià(!
hash
)

360 
i
 = 0; i < 
hash
->
size
; i++) {

361 
h—d
 = &
hash
->
bË
[
i
];

362 
li¡_lock
 = &
hash
->
li¡_locks
[
i
];

364 
	`¥š_lock_bh
(
li¡_lock
);

365 
	`hli¡_fÜ_—ch_’Œy_§ã
(
Üig_node
, 
node
, 
node_tmp
,

366 
h—d
, 
hash_’Œy
) {

367 ià(
	`b©adv_purge_Üig_node
(
b©_´iv
, 
Üig_node
)) {

368 ià(
Üig_node
->
gw_æags
)

369 
	`b©adv_gw_node_d–‘e
(
b©_´iv
,

370 
Üig_node
);

371 
	`hli¡_d–_rcu
(
node
);

372 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

376 ià(
	`b©adv_has_timed_out
(
Üig_node
->
Ï¡_äag_·ck‘
,

377 
BATADV_FRAG_TIMEOUT
))

378 
	`b©adv_äag_li¡_ä“
(&
Üig_node
->
äag_li¡
);

380 
	`¥š_uÆock_bh
(
li¡_lock
);

383 
	`b©adv_gw_node_purge
(
b©_´iv
);

384 
	`b©adv_gw_–eùiÚ
(
b©_´iv
);

385 
	}
}

387 
	$b©adv_purge_Üig
(
wÜk_¡ruù
 *
wÜk
)

389 
d–ayed_wÜk
 *delayed_work;

390 
b©adv_´iv
 *
b©_´iv
;

392 
d–ayed_wÜk
 = 
	`cÚš”_of
(
wÜk
, delayed_work, work);

393 
b©_´iv
 = 
	`cÚš”_of
(
d–ayed_wÜk
, 
b©adv_´iv
, 
Üig_wÜk
);

394 
	`_b©adv_purge_Üig
(
b©_´iv
);

395 
	`b©adv_¡¬t_purge_tim”
(
b©_´iv
);

396 
	}
}

398 
	$b©adv_purge_Üig_»f
(
b©adv_´iv
 *
b©_´iv
)

400 
	`_b©adv_purge_Üig
(
b©_´iv
);

401 
	}
}

403 
	$b©adv_Üig_£q_´št_‹xt
(
£q_fe
 *
£q
, *
off£t
)

405 
Ãt_deviû
 *
Ãt_dev
 = (Ãt_deviû *)
£q
->
´iv©e
;

406 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
Ãt_dev
);

407 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
Üig_hash
;

408 
hli¡_node
 *
node
, *
node_tmp
;

409 
hli¡_h—d
 *
h—d
;

410 
b©adv_h¬d_içû
 *
´im¬y_if
;

411 
b©adv_Üig_node
 *
Üig_node
;

412 
b©adv_Ãigh_node
 *
Ãigh_node
, *
Ãigh_node_tmp
;

413 
b©mª_couÁ
 = 0;

414 
Ï¡_£’_£cs
;

415 
Ï¡_£’_m£cs
;

416 
Ï¡_£’_jiff›s
;

417 
ušt32_t
 
i
;

418 
»t
 = 0;

420 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

422 ià(!
´im¬y_if
) {

423 
»t
 = 
	`£q_´štf
(
£q
,

425 
Ãt_dev
->
Çme
);

426 
out
;

429 ià(
´im¬y_if
->
if_¡©us
 !ğ
BATADV_IF_ACTIVE
) {

430 
»t
 = 
	`£q_´štf
(
£q
,

432 
Ãt_dev
->
Çme
);

433 
out
;

436 
	`£q_´štf
(
£q
, "[B.A.T.M.A.N.‡dv %s, MainIF/MAC: %s/%pM (%s)]\n",

437 
BATADV_SOURCE_VERSION
, 
´im¬y_if
->
Ãt_dev
->
Çme
,

438 
´im¬y_if
->
Ãt_dev
->
dev_addr
,‚‘_dev->
Çme
);

439 
	`£q_´štf
(
£q
, " %-15s %s (%s/%i) %17s [%10s]: %20s ...\n",

440 "Origš©Ü", "Ï¡-£’", "#", 
BATADV_TQ_MAX_VALUE
,

443 
i
 = 0; i < 
hash
->
size
; i++) {

444 
h—d
 = &
hash
->
bË
[
i
];

446 
	`rcu_»ad_lock
();

447 
	`hli¡_fÜ_—ch_’Œy_rcu
(
Üig_node
, 
node
, 
h—d
, 
hash_’Œy
) {

448 
Ãigh_node
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_node
);

449 ià(!
Ãigh_node
)

452 ià(
Ãigh_node
->
tq_avg
 == 0)

453 
Ãxt
;

455 
Ï¡_£’_jiff›s
 = 
jiff›s
 - 
Üig_node
->
Ï¡_£’
;

456 
Ï¡_£’_m£cs
 = 
	`jiff›s_to_m£cs
(
Ï¡_£’_jiff›s
);

457 
Ï¡_£’_£cs
 = 
Ï¡_£’_m£cs
 / 1000;

458 
Ï¡_£’_m£cs
 =†ast_seen_msecs % 1000;

460 
	`£q_´štf
(
£q
, "%pM %4i.%03is (%3i) %pM [%10s]:",

461 
Üig_node
->
Üig
, 
Ï¡_£’_£cs
,

462 
Ï¡_£’_m£cs
, 
Ãigh_node
->
tq_avg
,

463 
Ãigh_node
->
addr
,

464 
Ãigh_node
->
if_šcomšg
->
Ãt_dev
->
Çme
);

466 
	`hli¡_fÜ_—ch_’Œy_rcu
(
Ãigh_node_tmp
, 
node_tmp
,

467 &
Üig_node
->
Ãigh_li¡
, 
li¡
) {

468 
	`£q_´štf
(
£q
, " %pM (%3i)",

469 
Ãigh_node_tmp
->
addr
,

470 
Ãigh_node_tmp
->
tq_avg
);

473 
	`£q_´štf
(
£q
, "\n");

474 
b©mª_couÁ
++;

476 
Ãxt
:

477 
	`b©adv_Ãigh_node_ä“_»f
(
Ãigh_node
);

479 
	`rcu_»ad_uÆock
();

482 ià(
b©mª_couÁ
 == 0)

483 
	`£q_´štf
(
£q
, "No batman‚odes in„ange ...\n");

485 
out
:

486 ià(
´im¬y_if
)

487 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

488  
»t
;

489 
	}
}

491 
	$b©adv_Üig_node_add_if
(
b©adv_Üig_node
 *
Üig_node
,

492 
max_if_num
)

494 *
d©a_±r
;

495 
size_t
 
d©a_size
, 
Şd_size
;

497 
d©a_size
 = 
max_if_num
 * (è* 
BATADV_NUM_WORDS
;

498 
Şd_size
 = (
max_if_num
 - 1è* (è* 
BATADV_NUM_WORDS
;

499 
d©a_±r
 = 
	`km®loc
(
d©a_size
, 
GFP_ATOMIC
);

500 ià(!
d©a_±r
)

501  -
ENOMEM
;

503 
	`memıy
(
d©a_±r
, 
Üig_node
->
bÿ¡_own
, 
Şd_size
);

504 
	`kä“
(
Üig_node
->
bÿ¡_own
);

505 
Üig_node
->
bÿ¡_own
 = 
d©a_±r
;

507 
d©a_±r
 = 
	`km®loc
(
max_if_num
 * (
ušt8_t
), 
GFP_ATOMIC
);

508 ià(!
d©a_±r
)

509  -
ENOMEM
;

511 
	`memıy
(
d©a_±r
, 
Üig_node
->
bÿ¡_own_sum
,

512 (
max_if_num
 - 1è* (
ušt8_t
));

513 
	`kä“
(
Üig_node
->
bÿ¡_own_sum
);

514 
Üig_node
->
bÿ¡_own_sum
 = 
d©a_±r
;

517 
	}
}

519 
	$b©adv_Üig_hash_add_if
(
b©adv_h¬d_içû
 *
h¬d_içû
,

520 
max_if_num
)

522 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
h¬d_içû
->
soá_içû
);

523 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
Üig_hash
;

524 
hli¡_node
 *
node
;

525 
hli¡_h—d
 *
h—d
;

526 
b©adv_Üig_node
 *
Üig_node
;

527 
ušt32_t
 
i
;

528 
»t
;

533 
i
 = 0; i < 
hash
->
size
; i++) {

534 
h—d
 = &
hash
->
bË
[
i
];

536 
	`rcu_»ad_lock
();

537 
	`hli¡_fÜ_—ch_’Œy_rcu
(
Üig_node
, 
node
, 
h—d
, 
hash_’Œy
) {

538 
	`¥š_lock_bh
(&
Üig_node
->
ogm_út_lock
);

539 
»t
 = 
	`b©adv_Üig_node_add_if
(
Üig_node
, 
max_if_num
);

540 
	`¥š_uÆock_bh
(&
Üig_node
->
ogm_út_lock
);

542 ià(
»t
 =ğ-
ENOMEM
)

543 
”r
;

545 
	`rcu_»ad_uÆock
();

550 
”r
:

551 
	`rcu_»ad_uÆock
();

552  -
ENOMEM
;

553 
	}
}

555 
	$b©adv_Üig_node_d–_if
(
b©adv_Üig_node
 *
Üig_node
,

556 
max_if_num
, 
d–_if_num
)

558 *
d©a_±r
 = 
NULL
;

559 
chunk_size
;

562 ià(
max_if_num
 == 0)

563 
ä“_bÿ¡_own
;

565 
chunk_size
 = (è* 
BATADV_NUM_WORDS
;

566 
d©a_±r
 = 
	`km®loc
(
max_if_num
 * 
chunk_size
, 
GFP_ATOMIC
);

567 ià(!
d©a_±r
)

568  -
ENOMEM
;

571 
	`memıy
(
d©a_±r
, 
Üig_node
->
bÿ¡_own
, 
d–_if_num
 * 
chunk_size
);

574 
	`memıy
((*)
d©a_±r
 + 
d–_if_num
 * 
chunk_size
,

575 
Üig_node
->
bÿ¡_own
 + ((
d–_if_num
 + 1è* 
chunk_size
),

576 (
max_if_num
 - 
d–_if_num
è* 
chunk_size
);

578 
ä“_bÿ¡_own
:

579 
	`kä“
(
Üig_node
->
bÿ¡_own
);

580 
Üig_node
->
bÿ¡_own
 = 
d©a_±r
;

582 ià(
max_if_num
 == 0)

583 
ä“_own_sum
;

585 
d©a_±r
 = 
	`km®loc
(
max_if_num
 * (
ušt8_t
), 
GFP_ATOMIC
);

586 ià(!
d©a_±r
)

587  -
ENOMEM
;

589 
	`memıy
(
d©a_±r
, 
Üig_node
->
bÿ¡_own_sum
,

590 
d–_if_num
 * (
ušt8_t
));

592 
	`memıy
((*)
d©a_±r
 + 
d–_if_num
 * (
ušt8_t
),

593 
Üig_node
->
bÿ¡_own_sum
 + ((
d–_if_num
 + 1è* (
ušt8_t
)),

594 (
max_if_num
 - 
d–_if_num
è* (
ušt8_t
));

596 
ä“_own_sum
:

597 
	`kä“
(
Üig_node
->
bÿ¡_own_sum
);

598 
Üig_node
->
bÿ¡_own_sum
 = 
d©a_±r
;

601 
	}
}

603 
	$b©adv_Üig_hash_d–_if
(
b©adv_h¬d_içû
 *
h¬d_içû
,

604 
max_if_num
)

606 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
h¬d_içû
->
soá_içû
);

607 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
Üig_hash
;

608 
hli¡_node
 *
node
;

609 
hli¡_h—d
 *
h—d
;

610 
b©adv_h¬d_içû
 *
h¬d_içû_tmp
;

611 
b©adv_Üig_node
 *
Üig_node
;

612 
ušt32_t
 
i
;

613 
»t
;

618 
i
 = 0; i < 
hash
->
size
; i++) {

619 
h—d
 = &
hash
->
bË
[
i
];

621 
	`rcu_»ad_lock
();

622 
	`hli¡_fÜ_—ch_’Œy_rcu
(
Üig_node
, 
node
, 
h—d
, 
hash_’Œy
) {

623 
	`¥š_lock_bh
(&
Üig_node
->
ogm_út_lock
);

624 
»t
 = 
	`b©adv_Üig_node_d–_if
(
Üig_node
, 
max_if_num
,

625 
h¬d_içû
->
if_num
);

626 
	`¥š_uÆock_bh
(&
Üig_node
->
ogm_út_lock
);

628 ià(
»t
 =ğ-
ENOMEM
)

629 
”r
;

631 
	`rcu_»ad_uÆock
();

635 
	`rcu_»ad_lock
();

636 
	`li¡_fÜ_—ch_’Œy_rcu
(
h¬d_içû_tmp
, &
b©adv_h¬dif_li¡
, 
li¡
) {

637 ià(
h¬d_içû_tmp
->
if_¡©us
 =ğ
BATADV_IF_NOT_IN_USE
)

640 ià(
h¬d_içû
 =ğ
h¬d_içû_tmp
)

643 ià(
h¬d_içû
->
soá_içû
 !ğ
h¬d_içû_tmp
->soft_iface)

646 ià(
h¬d_içû_tmp
->
if_num
 > 
h¬d_içû
->if_num)

647 
h¬d_içû_tmp
->
if_num
--;

649 
	`rcu_»ad_uÆock
();

651 
h¬d_içû
->
if_num
 = -1;

654 
”r
:

655 
	`rcu_»ad_uÆock
();

656  -
ENOMEM
;

657 
	}
}

	@originator.h

20 #iâdeà
_NET_BATMAN_ADV_ORIGINATOR_H_


21 
	#_NET_BATMAN_ADV_ORIGINATOR_H_


	)

23 
	~"hash.h
"

25 
b©adv_Üigš©Ü_š™
(
b©adv_´iv
 *
b©_´iv
);

26 
b©adv_Üigš©Ü_ä“
(
b©adv_´iv
 *
b©_´iv
);

27 
b©adv_purge_Üig_»f
(
b©adv_´iv
 *
b©_´iv
);

28 
b©adv_Üig_node_ä“_»f
(
b©adv_Üig_node
 *
Üig_node
);

29 
b©adv_Üig_node
 *
b©adv_g‘_Üig_node
(
b©adv_´iv
 *
b©_´iv
,

30 cÚ¡ 
ušt8_t
 *
addr
);

31 
b©adv_Ãigh_node
 *

32 
b©adv_Ãigh_node_Ãw
(
b©adv_h¬d_içû
 *
h¬d_içû
,

33 cÚ¡ 
ušt8_t
 *
Ãigh_addr
, 
ušt32_t
 
£qno
);

34 
b©adv_Ãigh_node_ä“_»f
(
b©adv_Ãigh_node
 *
Ãigh_node
);

35 
b©adv_Ãigh_node
 *

36 
b©adv_Üig_node_g‘_rou‹r
(
b©adv_Üig_node
 *
Üig_node
);

37 
b©adv_Üig_£q_´št_‹xt
(
£q_fe
 *
£q
, *
off£t
);

38 
b©adv_Üig_hash_add_if
(
b©adv_h¬d_içû
 *
h¬d_içû
,

39 
max_if_num
);

40 
b©adv_Üig_hash_d–_if
(
b©adv_h¬d_içû
 *
h¬d_içû
,

41 
max_if_num
);

47 
šlše
 
ušt32_t
 
	$b©adv_choo£_Üig
(cÚ¡ *
d©a
, 
ušt32_t
 
size
)

49 cÚ¡ *
key
 = 
d©a
;

50 
ušt32_t
 
hash
 = 0;

51 
size_t
 
i
;

53 
i
 = 0; i < 6; i++) {

54 
hash
 +ğ
key
[
i
];

55 
hash
 += (hash << 10);

56 
hash
 ^= (hash >> 6);

59 
hash
 += (hash << 3);

60 
hash
 ^= (hash >> 11);

61 
hash
 += (hash << 15);

63  
hash
 % 
size
;

64 
	}
}

66 
šlše
 
b©adv_Üig_node
 *

67 
	$b©adv_Üig_hash_fšd
(
b©adv_´iv
 *
b©_´iv
, cÚ¡ *
d©a
)

69 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
Üig_hash
;

70 
hli¡_h—d
 *
h—d
;

71 
hli¡_node
 *
node
;

72 
b©adv_Üig_node
 *
Üig_node
, *
Üig_node_tmp
 = 
NULL
;

73 
šdex
;

75 ià(!
hash
)

76  
NULL
;

78 
šdex
 = 
	`b©adv_choo£_Üig
(
d©a
, 
hash
->
size
);

79 
h—d
 = &
hash
->
bË
[
šdex
];

81 
	`rcu_»ad_lock
();

82 
	`hli¡_fÜ_—ch_’Œy_rcu
(
Üig_node
, 
node
, 
h—d
, 
hash_’Œy
) {

83 ià(!
	`b©adv_com·»_‘h
(
Üig_node
, 
d©a
))

86 ià(!
	`©omic_šc_nÙ_z”o
(&
Üig_node
->
»fcouÁ
))

89 
Üig_node_tmp
 = 
Üig_node
;

92 
	`rcu_»ad_uÆock
();

94  
Üig_node_tmp
;

95 
	}
}

	@packet.h

20 #iâdeà
_NET_BATMAN_ADV_PACKET_H_


21 
	#_NET_BATMAN_ADV_PACKET_H_


	)

23 
	#BATADV_ETH_P_BATMAN
 0x4305

	)

25 
	eb©adv_·ck‘ty³
 {

26 
	mBATADV_IV_OGM
 = 0x01,

27 
	mBATADV_ICMP
 = 0x02,

28 
	mBATADV_UNICAST
 = 0x03,

29 
	mBATADV_BCAST
 = 0x04,

30 
	mBATADV_VIS
 = 0x05,

31 
	mBATADV_UNICAST_FRAG
 = 0x06,

32 
	mBATADV_TT_QUERY
 = 0x07,

33 
	mBATADV_ROAM_ADV
 = 0x08,

37 
	#BATADV_COMPAT_VERSION
 14

	)

39 
	eb©adv_iv_æags
 {

40 
	mBATADV_NOT_BEST_NEXT_HOP
 = 
BIT
(3),

41 
	mBATADV_PRIMARIES_FIRST_HOP
 = 
BIT
(4),

42 
	mBATADV_VIS_SERVER
 = 
BIT
(5),

43 
	mBATADV_DIRECTLINK
 = 
BIT
(6),

47 
	eb©adv_icmp_·ck‘ty³
 {

48 
	mBATADV_ECHO_REPLY
 = 0,

49 
	mBATADV_DESTINATION_UNREACHABLE
 = 3,

50 
	mBATADV_ECHO_REQUEST
 = 8,

51 
	mBATADV_TTL_EXCEEDED
 = 11,

52 
	mBATADV_PARAMETER_PROBLEM
 = 12,

56 
	eb©adv_vis_·ck‘ty³
 {

57 
	mBATADV_VIS_TYPE_SERVER_SYNC
 = 0,

58 
	mBATADV_VIS_TYPE_CLIENT_UPDATE
 = 1,

62 
	eb©adv_uniÿ¡_äag_æags
 {

63 
	mBATADV_UNI_FRAG_HEAD
 = 
BIT
(0),

64 
	mBATADV_UNI_FRAG_LARGETAIL
 = 
BIT
(1),

68 
	#BATADV_TT_QUERY_TYPE_MASK
 0x3

	)

70 
	eb©adv_‰_qu”y_·ck‘ty³
 {

71 
	mBATADV_TT_REQUEST
 = 0,

72 
	mBATADV_TT_RESPONSE
 = 1,

76 
	eb©adv_‰_qu”y_æags
 {

77 
	mBATADV_TT_FULL_TABLE
 = 
BIT
(2),

84 
	eb©adv_‰_ş›Á_æags
 {

85 
	mBATADV_TT_CLIENT_DEL
 = 
BIT
(0),

86 
	mBATADV_TT_CLIENT_ROAM
 = 
BIT
(1),

87 
	mBATADV_TT_CLIENT_WIFI
 = 
BIT
(2),

88 
	mBATADV_TT_CLIENT_TEMP
 = 
BIT
(3),

89 
	mBATADV_TT_CLIENT_NOPURGE
 = 
BIT
(8),

90 
	mBATADV_TT_CLIENT_NEW
 = 
BIT
(9),

91 
	mBATADV_TT_CLIENT_PENDING
 = 
BIT
(10),

95 
	eb©adv_bÏ_şaimäame
 {

96 
	mBATADV_CLAIM_TYPE_CLAIM
 = 0x00,

97 
	mBATADV_CLAIM_TYPE_UNCLAIM
 = 0x01,

98 
	mBATADV_CLAIM_TYPE_ANNOUNCE
 = 0x02,

99 
	mBATADV_CLAIM_TYPE_REQUEST
 = 0x03,

105 
	sb©adv_bÏ_şaim_d¡
 {

106 
ušt8_t
 
	mmagic
[3];

107 
ušt8_t
 
	mty³
;

108 
__be16
 
	mgroup
;

109 } 
	g__·cked
;

111 
	sb©adv_h—d”
 {

112 
ušt8_t
 
	m·ck‘_ty³
;

113 
ušt8_t
 
	mv”siÚ
;

114 
ušt8_t
 
	m‰l
;

115 } 
	g__·cked
;

117 
	sb©adv_ogm_·ck‘
 {

118 
b©adv_h—d”
 
	mh—d”
;

119 
ušt8_t
 
	mæags
;

120 
__be32
 
	m£qno
;

121 
ušt8_t
 
	mÜig
[
ETH_ALEN
];

122 
ušt8_t
 
	m´ev_£nd”
[
ETH_ALEN
];

123 
ušt8_t
 
	mgw_æags
;

124 
ušt8_t
 
	mtq
;

125 
ušt8_t
 
	m‰_num_chªges
;

126 
ušt8_t
 
	m‰vn
;

127 
__be16
 
	m‰_üc
;

128 } 
	g__·cked
;

130 
	#BATADV_OGM_HLEN
 (
b©adv_ogm_·ck‘
)

	)

132 
	sb©adv_icmp_·ck‘
 {

133 
b©adv_h—d”
 
	mh—d”
;

134 
ušt8_t
 
	mmsg_ty³
;

135 
ušt8_t
 
	md¡
[
ETH_ALEN
];

136 
ušt8_t
 
	mÜig
[
ETH_ALEN
];

137 
__be16
 
	m£qno
;

138 
ušt8_t
 
	muid
;

139 
ušt8_t
 
	m»£rved
;

140 } 
	g__·cked
;

142 
	#BATADV_RR_LEN
 16

	)

147 
	sb©adv_icmp_·ck‘_¼
 {

148 
b©adv_h—d”
 
	mh—d”
;

149 
ušt8_t
 
	mmsg_ty³
;

150 
ušt8_t
 
	md¡
[
ETH_ALEN
];

151 
ušt8_t
 
	mÜig
[
ETH_ALEN
];

152 
__be16
 
	m£qno
;

153 
ušt8_t
 
	muid
;

154 
ušt8_t
 
	m¼_cur
;

155 
ušt8_t
 
	m¼
[
BATADV_RR_LEN
][
ETH_ALEN
];

156 } 
	g__·cked
;

158 
	sb©adv_uniÿ¡_·ck‘
 {

159 
b©adv_h—d”
 
	mh—d”
;

160 
ušt8_t
 
	m‰vn
;

161 
ušt8_t
 
	mde¡
[
ETH_ALEN
];

162 } 
	g__·cked
;

164 
	sb©adv_uniÿ¡_äag_·ck‘
 {

165 
b©adv_h—d”
 
	mh—d”
;

166 
ušt8_t
 
	m‰vn
;

167 
ušt8_t
 
	mde¡
[
ETH_ALEN
];

168 
ušt8_t
 
	mæags
;

169 
ušt8_t
 
	m®ign
;

170 
ušt8_t
 
	mÜig
[
ETH_ALEN
];

171 
__be16
 
	m£qno
;

172 } 
	g__·cked
;

174 
	sb©adv_bÿ¡_·ck‘
 {

175 
b©adv_h—d”
 
	mh—d”
;

176 
ušt8_t
 
	m»£rved
;

177 
__be32
 
	m£qno
;

178 
ušt8_t
 
	mÜig
[
ETH_ALEN
];

179 } 
	g__·cked
;

181 
	sb©adv_vis_·ck‘
 {

182 
b©adv_h—d”
 
	mh—d”
;

183 
ušt8_t
 
	mvis_ty³
;

184 
__be32
 
	m£qno
;

185 
ušt8_t
 
	m’Œ›s
;

186 
ušt8_t
 
	m»£rved
;

187 
ušt8_t
 
	mvis_Üig
[
ETH_ALEN
];

188 
ušt8_t
 
	mrg‘_Üig
[
ETH_ALEN
];

189 
ušt8_t
 
	m£nd”_Üig
[
ETH_ALEN
];

190 } 
	g__·cked
;

192 
	sb©adv_‰_qu”y_·ck‘
 {

193 
b©adv_h—d”
 
	mh—d”
;

198 
ušt8_t
 
	mæags
;

199 
ušt8_t
 
	md¡
[
ETH_ALEN
];

200 
ušt8_t
 
	m¤c
[
ETH_ALEN
];

207 
ušt8_t
 
	m‰vn
;

213 
__be16
 
	m‰_d©a
;

214 } 
	g__·cked
;

216 
	sb©adv_rßm_adv_·ck‘
 {

217 
b©adv_h—d”
 
	mh—d”
;

218 
ušt8_t
 
	m»£rved
;

219 
ušt8_t
 
	md¡
[
ETH_ALEN
];

220 
ušt8_t
 
	m¤c
[
ETH_ALEN
];

221 
ušt8_t
 
	mş›Á
[
ETH_ALEN
];

222 } 
	g__·cked
;

224 
	sb©adv_‰_chªge
 {

225 
ušt8_t
 
	mæags
;

226 
ušt8_t
 
	maddr
[
ETH_ALEN
];

227 } 
	g__·cked
;

	@ring_buffer.c

20 
	~"maš.h
"

21 
	~"ršg_bufãr.h
"

23 
	$b©adv_ršg_bufãr_£t
(
ušt8_t
 
lq_»cv
[], ušt8_ˆ*
lq_šdex
,

24 
ušt8_t
 
v®ue
)

26 
lq_»cv
[*
lq_šdex
] = 
v®ue
;

27 *
lq_šdex
 = (*lq_šdex + 1è% 
BATADV_TQ_GLOBAL_WINDOW_SIZE
;

28 
	}
}

30 
ušt8_t
 
	$b©adv_ršg_bufãr_avg
(cÚ¡ 
ušt8_t
 
lq_»cv
[])

32 cÚ¡ 
ušt8_t
 *
±r
;

33 
ušt16_t
 
couÁ
 = 0, 
i
 = 0, 
sum
 = 0;

35 
±r
 = 
lq_»cv
;

37 
i
 < 
BATADV_TQ_GLOBAL_WINDOW_SIZE
) {

38 ià(*
±r
 != 0) {

39 
couÁ
++;

40 
sum
 +ğ*
±r
;

43 
i
++;

44 
±r
++;

47 ià(
couÁ
 == 0)

50  (
ušt8_t
)(
sum
 / 
couÁ
);

51 
	}
}

	@ring_buffer.h

20 #iâdeà
_NET_BATMAN_ADV_RING_BUFFER_H_


21 
	#_NET_BATMAN_ADV_RING_BUFFER_H_


	)

23 
b©adv_ršg_bufãr_£t
(
ušt8_t
 
lq_»cv
[], ušt8_ˆ*
lq_šdex
,

24 
ušt8_t
 
v®ue
);

25 
ušt8_t
 
b©adv_ršg_bufãr_avg
(cÚ¡ ušt8_ˆ
lq_»cv
[]);

	@routing.c

20 
	~"maš.h
"

21 
	~"routšg.h
"

22 
	~"£nd.h
"

23 
	~"soá-š‹rçû.h
"

24 
	~"h¬d-š‹rçû.h
"

25 
	~"icmp_sock‘.h
"

26 
	~"Œª¦©iÚ-bË.h
"

27 
	~"Üigš©Ü.h
"

28 
	~"vis.h
"

29 
	~"uniÿ¡.h
"

30 
	~"bridge_loİ_avoidªû.h
"

32 
b©adv_rou‹_uniÿ¡_·ck‘
(
sk_buff
 *
skb
,

33 
b©adv_h¬d_içû
 *
»cv_if
);

35 
	$b©adv_¦ide_own_bÿ¡_wšdow
(
b©adv_h¬d_içû
 *
h¬d_içû
)

37 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
h¬d_içû
->
soá_içû
);

38 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
Üig_hash
;

39 
hli¡_node
 *
node
;

40 
hli¡_h—d
 *
h—d
;

41 
b©adv_Üig_node
 *
Üig_node
;

42 *
wÜd
;

43 
ušt32_t
 
i
;

44 
size_t
 
wÜd_šdex
;

45 
ušt8_t
 *
w
;

47 
i
 = 0; i < 
hash
->
size
; i++) {

48 
h—d
 = &
hash
->
bË
[
i
];

50 
	`rcu_»ad_lock
();

51 
	`hli¡_fÜ_—ch_’Œy_rcu
(
Üig_node
, 
node
, 
h—d
, 
hash_’Œy
) {

52 
	`¥š_lock_bh
(&
Üig_node
->
ogm_út_lock
);

53 
wÜd_šdex
 = 
h¬d_içû
->
if_num
 * 
BATADV_NUM_WORDS
;

54 
wÜd
 = &(
Üig_node
->
bÿ¡_own
[
wÜd_šdex
]);

56 
	`b©adv_b™_g‘_·ck‘
(
b©_´iv
, 
wÜd
, 1, 0);

57 
w
 = &
Üig_node
->
bÿ¡_own_sum
[
h¬d_içû
->
if_num
];

58 *
w
 = 
	`b™m­_weight
(
wÜd
, 
BATADV_TQ_LOCAL_WINDOW_SIZE
);

59 
	`¥š_uÆock_bh
(&
Üig_node
->
ogm_út_lock
);

61 
	`rcu_»ad_uÆock
();

63 
	}
}

65 
	$_b©adv_upd©e_rou‹
(
b©adv_´iv
 *
b©_´iv
,

66 
b©adv_Üig_node
 *
Üig_node
,

67 
b©adv_Ãigh_node
 *
Ãigh_node
)

69 
b©adv_Ãigh_node
 *
cu¼_rou‹r
;

71 
cu¼_rou‹r
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_node
);

74 ià((
cu¼_rou‹r
è&& (!
Ãigh_node
)) {

75 
	`b©adv_dbg
(
BATADV_DBG_ROUTES
, 
b©_´iv
,

76 "D–‘šg„ou‹ow¬ds: %pM\n", 
Üig_node
->
Üig
);

77 
	`b©adv_‰_glob®_d–_Üig
(
b©_´iv
, 
Üig_node
,

81 } ià((!
cu¼_rou‹r
è&& (
Ãigh_node
)) {

83 
	`b©adv_dbg
(
BATADV_DBG_ROUTES
, 
b©_´iv
,

85 
Üig_node
->
Üig
, 
Ãigh_node
->
addr
);

87 } ià(
Ãigh_node
 && 
cu¼_rou‹r
) {

88 
	`b©adv_dbg
(
BATADV_DBG_ROUTES
, 
b©_´iv
,

90 
Üig_node
->
Üig
, 
Ãigh_node
->
addr
,

91 
cu¼_rou‹r
->
addr
);

94 ià(
cu¼_rou‹r
)

95 
	`b©adv_Ãigh_node_ä“_»f
(
cu¼_rou‹r
);

98 ià(
Ãigh_node
 && !
	`©omic_šc_nÙ_z”o
(&Ãigh_node->
»fcouÁ
))

99 
Ãigh_node
 = 
NULL
;

101 
	`¥š_lock_bh
(&
Üig_node
->
Ãigh_li¡_lock
);

102 
	`rcu_assign_poš‹r
(
Üig_node
->
rou‹r
, 
Ãigh_node
);

103 
	`¥š_uÆock_bh
(&
Üig_node
->
Ãigh_li¡_lock
);

106 ià(
cu¼_rou‹r
)

107 
	`b©adv_Ãigh_node_ä“_»f
(
cu¼_rou‹r
);

108 
	}
}

110 
	$b©adv_upd©e_rou‹
(
b©adv_´iv
 *
b©_´iv
,

111 
b©adv_Üig_node
 *
Üig_node
,

112 
b©adv_Ãigh_node
 *
Ãigh_node
)

114 
b©adv_Ãigh_node
 *
rou‹r
 = 
NULL
;

116 ià(!
Üig_node
)

117 
out
;

119 
rou‹r
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_node
);

121 ià(
rou‹r
 !ğ
Ãigh_node
)

122 
	`_b©adv_upd©e_rou‹
(
b©_´iv
, 
Üig_node
, 
Ãigh_node
);

124 
out
:

125 ià(
rou‹r
)

126 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r
);

127 
	}
}

130 
	$b©adv_bÚdšg_ÿndid©e_d–
(
b©adv_Üig_node
 *
Üig_node
,

131 
b©adv_Ãigh_node
 *
Ãigh_node
)

134 ià(
	`li¡_em±y
(&
Ãigh_node
->
bÚdšg_li¡
))

135 
out
;

137 
	`li¡_d–_rcu
(&
Ãigh_node
->
bÚdšg_li¡
);

138 
	`INIT_LIST_HEAD
(&
Ãigh_node
->
bÚdšg_li¡
);

139 
	`b©adv_Ãigh_node_ä“_»f
(
Ãigh_node
);

140 
	`©omic_dec
(&
Üig_node
->
bÚd_ÿndid©es
);

142 
out
:

144 
	}
}

146 
	$b©adv_bÚdšg_ÿndid©e_add
(
b©adv_Üig_node
 *
Üig_node
,

147 
b©adv_Ãigh_node
 *
Ãigh_node
)

149 
hli¡_node
 *
node
;

150 
b©adv_Ãigh_node
 *
tmp_Ãigh_node
, *
rou‹r
 = 
NULL
;

151 
ušt8_t
 
š‹rã»nû_ÿndid©e
 = 0;

153 
	`¥š_lock_bh
(&
Üig_node
->
Ãigh_li¡_lock
);

156 ià(!
	`b©adv_com·»_‘h
(
Üig_node
->
Üig
,

157 
Ãigh_node
->
Üig_node
->
´im¬y_addr
))

158 
ÿndid©e_d–
;

160 
rou‹r
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_node
);

161 ià(!
rou‹r
)

162 
ÿndid©e_d–
;

165 ià(
Ãigh_node
->
tq_avg
 < 
rou‹r
->tq_avg - 
BATADV_BONDING_TQ_THRESHOLD
)

166 
ÿndid©e_d–
;

172 
	`hli¡_fÜ_—ch_’Œy_rcu
(
tmp_Ãigh_node
, 
node
,

173 &
Üig_node
->
Ãigh_li¡
, 
li¡
) {

175 ià(
tmp_Ãigh_node
 =ğ
Ãigh_node
)

181 ià(
	`li¡_em±y
(&
tmp_Ãigh_node
->
bÚdšg_li¡
))

184 ià((
Ãigh_node
->
if_šcomšg
 =ğ
tmp_Ãigh_node
->if_incoming) ||

185 (
	`b©adv_com·»_‘h
(
Ãigh_node
->
addr
,

186 
tmp_Ãigh_node
->
addr
))) {

187 
š‹rã»nû_ÿndid©e
 = 1;

193 ià(
š‹rã»nû_ÿndid©e
)

194 
ÿndid©e_d–
;

197 ià(!
	`li¡_em±y
(&
Ãigh_node
->
bÚdšg_li¡
))

198 
out
;

200 ià(!
	`©omic_šc_nÙ_z”o
(&
Ãigh_node
->
»fcouÁ
))

201 
out
;

203 
	`li¡_add_rcu
(&
Ãigh_node
->
bÚdšg_li¡
, &
Üig_node
->
bÚd_li¡
);

204 
	`©omic_šc
(&
Üig_node
->
bÚd_ÿndid©es
);

205 
out
;

207 
ÿndid©e_d–
:

208 
	`b©adv_bÚdšg_ÿndid©e_d–
(
Üig_node
, 
Ãigh_node
);

210 
out
:

211 
	`¥š_uÆock_bh
(&
Üig_node
->
Ãigh_li¡_lock
);

213 ià(
rou‹r
)

214 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r
);

215 
	}
}

219 
	$b©adv_bÚdšg_§ve_´im¬y
(cÚ¡ 
b©adv_Üig_node
 *
Üig_node
,

220 
b©adv_Üig_node
 *
Üig_Ãigh_node
,

221 cÚ¡ 
b©adv_ogm_·ck‘
 *
b©mª_ogm_·ck‘
)

223 ià(!(
b©mª_ogm_·ck‘
->
æags
 & 
BATADV_PRIMARIES_FIRST_HOP
))

226 
	`memıy
(
Üig_Ãigh_node
->
´im¬y_addr
, 
Üig_node
->
Üig
, 
ETH_ALEN
);

227 
	}
}

234 
	$b©adv_wšdow_´Ùeùed
(
b©adv_´iv
 *
b©_´iv
, 
št32_t
 
£q_num_diff
,

235 *
Ï¡_»£t
)

237 ià(
£q_num_diff
 <ğ-
BATADV_TQ_LOCAL_WINDOW_SIZE
 ||

238 
£q_num_diff
 >ğ
BATADV_EXPECTED_SEQNO_RANGE
) {

239 ià(!
	`b©adv_has_timed_out
(*
Ï¡_»£t
,

240 
BATADV_RESET_PROTECTION_MS
))

243 *
Ï¡_»£t
 = 
jiff›s
;

244 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

249 
	}
}

251 
boŞ
 
	$b©adv_check_mªagem’t_·ck‘
(
sk_buff
 *
skb
,

252 
b©adv_h¬d_içû
 *
h¬d_içû
,

253 
h—d”_Ën
)

255 
‘hhdr
 *ethhdr;

258 ià(
	`uÆik–y
(!
	`pskb_may_puÎ
(
skb
, 
h—d”_Ën
)))

259  
çl£
;

261 
‘hhdr
 = (‘hhd¸*)
	`skb_mac_h—d”
(
skb
);

264 ià(!
	`is_brßdÿ¡_‘h”_addr
(
‘hhdr
->
h_de¡
))

265  
çl£
;

268 ià(
	`is_brßdÿ¡_‘h”_addr
(
‘hhdr
->
h_sourû
))

269  
çl£
;

272 ià(
	`skb_cow
(
skb
, 0) < 0)

273  
çl£
;

276 ià(
	`skb_lš—rize
(
skb
) < 0)

277  
çl£
;

279  
Œue
;

280 
	}
}

282 
	$b©adv_»cv_my_icmp_·ck‘
(
b©adv_´iv
 *
b©_´iv
,

283 
sk_buff
 *
skb
, 
size_t
 
icmp_Ën
)

285 
b©adv_h¬d_içû
 *
´im¬y_if
 = 
NULL
;

286 
b©adv_Üig_node
 *
Üig_node
 = 
NULL
;

287 
b©adv_Ãigh_node
 *
rou‹r
 = 
NULL
;

288 
b©adv_icmp_·ck‘_¼
 *
icmp_·ck‘
;

289 
»t
 = 
NET_RX_DROP
;

291 
icmp_·ck‘
 = (
b©adv_icmp_·ck‘_¼
 *)
skb
->
d©a
;

294 ià(
icmp_·ck‘
->
msg_ty³
 !ğ
BATADV_ECHO_REQUEST
) {

295 
	`b©adv_sock‘_»ûive_·ck‘
(
icmp_·ck‘
, 
icmp_Ën
);

296 
out
;

299 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

300 ià(!
´im¬y_if
)

301 
out
;

305 
Üig_node
 = 
	`b©adv_Üig_hash_fšd
(
b©_´iv
, 
icmp_·ck‘
->
Üig
);

306 ià(!
Üig_node
)

307 
out
;

309 
rou‹r
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_node
);

310 ià(!
rou‹r
)

311 
out
;

314 ià(
	`skb_cow
(
skb
, 
ETH_HLEN
) < 0)

315 
out
;

317 
icmp_·ck‘
 = (
b©adv_icmp_·ck‘_¼
 *)
skb
->
d©a
;

319 
	`memıy
(
icmp_·ck‘
->
d¡
, icmp_·ck‘->
Üig
, 
ETH_ALEN
);

320 
	`memıy
(
icmp_·ck‘
->
Üig
, 
´im¬y_if
->
Ãt_dev
->
dev_addr
, 
ETH_ALEN
);

321 
icmp_·ck‘
->
msg_ty³
 = 
BATADV_ECHO_REPLY
;

322 
icmp_·ck‘
->
h—d”
.
‰l
 = 
BATADV_TTL
;

324 
	`b©adv_£nd_skb_·ck‘
(
skb
, 
rou‹r
->
if_šcomšg
,„ou‹r->
addr
);

325 
»t
 = 
NET_RX_SUCCESS
;

327 
out
:

328 ià(
´im¬y_if
)

329 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

330 ià(
rou‹r
)

331 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r
);

332 ià(
Üig_node
)

333 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

334  
»t
;

335 
	}
}

337 
	$b©adv_»cv_icmp_‰l_exûeded
(
b©adv_´iv
 *
b©_´iv
,

338 
sk_buff
 *
skb
)

340 
b©adv_h¬d_içû
 *
´im¬y_if
 = 
NULL
;

341 
b©adv_Üig_node
 *
Üig_node
 = 
NULL
;

342 
b©adv_Ãigh_node
 *
rou‹r
 = 
NULL
;

343 
b©adv_icmp_·ck‘
 *
icmp_·ck‘
;

344 
»t
 = 
NET_RX_DROP
;

346 
icmp_·ck‘
 = (
b©adv_icmp_·ck‘
 *)
skb
->
d©a
;

349 ià(
icmp_·ck‘
->
msg_ty³
 !ğ
BATADV_ECHO_REQUEST
) {

350 
	`´_debug
("Warning - can't forward icmp…acket from %pMo %pM:tlƒxceeded\n",

351 
icmp_·ck‘
->
Üig
, icmp_·ck‘->
d¡
);

352 
out
;

355 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

356 ià(!
´im¬y_if
)

357 
out
;

360 
Üig_node
 = 
	`b©adv_Üig_hash_fšd
(
b©_´iv
, 
icmp_·ck‘
->
Üig
);

361 ià(!
Üig_node
)

362 
out
;

364 
rou‹r
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_node
);

365 ià(!
rou‹r
)

366 
out
;

369 ià(
	`skb_cow
(
skb
, 
ETH_HLEN
) < 0)

370 
out
;

372 
icmp_·ck‘
 = (
b©adv_icmp_·ck‘
 *)
skb
->
d©a
;

374 
	`memıy
(
icmp_·ck‘
->
d¡
, icmp_·ck‘->
Üig
, 
ETH_ALEN
);

375 
	`memıy
(
icmp_·ck‘
->
Üig
, 
´im¬y_if
->
Ãt_dev
->
dev_addr
, 
ETH_ALEN
);

376 
icmp_·ck‘
->
msg_ty³
 = 
BATADV_TTL_EXCEEDED
;

377 
icmp_·ck‘
->
h—d”
.
‰l
 = 
BATADV_TTL
;

379 
	`b©adv_£nd_skb_·ck‘
(
skb
, 
rou‹r
->
if_šcomšg
,„ou‹r->
addr
);

380 
»t
 = 
NET_RX_SUCCESS
;

382 
out
:

383 ià(
´im¬y_if
)

384 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

385 ià(
rou‹r
)

386 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r
);

387 ià(
Üig_node
)

388 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

389  
»t
;

390 
	}
}

393 
	$b©adv_»cv_icmp_·ck‘
(
sk_buff
 *
skb
,

394 
b©adv_h¬d_içû
 *
»cv_if
)

396 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
»cv_if
->
soá_içû
);

397 
b©adv_icmp_·ck‘_¼
 *
icmp_·ck‘
;

398 
‘hhdr
 *ethhdr;

399 
b©adv_Üig_node
 *
Üig_node
 = 
NULL
;

400 
b©adv_Ãigh_node
 *
rou‹r
 = 
NULL
;

401 
hdr_size
 = (
b©adv_icmp_·ck‘
);

402 
»t
 = 
NET_RX_DROP
;

405 ià(
skb
->
Ën
 >ğ(
b©adv_icmp_·ck‘_¼
))

406 
hdr_size
 = (
b©adv_icmp_·ck‘_¼
);

409 ià(
	`uÆik–y
(!
	`pskb_may_puÎ
(
skb
, 
hdr_size
)))

410 
out
;

412 
‘hhdr
 = (‘hhd¸*)
	`skb_mac_h—d”
(
skb
);

415 ià(
	`is_brßdÿ¡_‘h”_addr
(
‘hhdr
->
h_de¡
))

416 
out
;

419 ià(
	`is_brßdÿ¡_‘h”_addr
(
‘hhdr
->
h_sourû
))

420 
out
;

423 ià(!
	`b©adv_is_my_mac
(
‘hhdr
->
h_de¡
))

424 
out
;

426 
icmp_·ck‘
 = (
b©adv_icmp_·ck‘_¼
 *)
skb
->
d©a
;

429 ià((
hdr_size
 =ğ(
b©adv_icmp_·ck‘_¼
)) &&

430 (
icmp_·ck‘
->
¼_cur
 < 
BATADV_RR_LEN
)) {

431 
	`memıy
(&(
icmp_·ck‘
->
¼
[icmp_·ck‘->
¼_cur
]),

432 
‘hhdr
->
h_de¡
, 
ETH_ALEN
);

433 
icmp_·ck‘
->
¼_cur
++;

437 ià(
	`b©adv_is_my_mac
(
icmp_·ck‘
->
d¡
))

438  
	`b©adv_»cv_my_icmp_·ck‘
(
b©_´iv
, 
skb
, 
hdr_size
);

441 ià(
icmp_·ck‘
->
h—d”
.
‰l
 < 2)

442  
	`b©adv_»cv_icmp_‰l_exûeded
(
b©_´iv
, 
skb
);

445 
Üig_node
 = 
	`b©adv_Üig_hash_fšd
(
b©_´iv
, 
icmp_·ck‘
->
d¡
);

446 ià(!
Üig_node
)

447 
out
;

449 
rou‹r
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_node
);

450 ià(!
rou‹r
)

451 
out
;

454 ià(
	`skb_cow
(
skb
, 
ETH_HLEN
) < 0)

455 
out
;

457 
icmp_·ck‘
 = (
b©adv_icmp_·ck‘_¼
 *)
skb
->
d©a
;

460 
icmp_·ck‘
->
h—d”
.
‰l
--;

463 
	`b©adv_£nd_skb_·ck‘
(
skb
, 
rou‹r
->
if_šcomšg
,„ou‹r->
addr
);

464 
»t
 = 
NET_RX_SUCCESS
;

466 
out
:

467 ià(
rou‹r
)

468 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r
);

469 ià(
Üig_node
)

470 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

471  
»t
;

472 
	}
}

480 
b©adv_Ãigh_node
 *

481 
	$b©adv_fšd_bÚd_rou‹r
(
b©adv_Üig_node
 *
´im¬y_Üig
,

482 cÚ¡ 
b©adv_h¬d_içû
 *
»cv_if
)

484 
b©adv_Ãigh_node
 *
tmp_Ãigh_node
;

485 
b©adv_Ãigh_node
 *
rou‹r
 = 
NULL
, *
fœ¡_ÿndid©e
 = NULL;

487 
	`rcu_»ad_lock
();

488 
	`li¡_fÜ_—ch_’Œy_rcu
(
tmp_Ãigh_node
, &
´im¬y_Üig
->
bÚd_li¡
,

489 
bÚdšg_li¡
) {

490 ià(!
fœ¡_ÿndid©e
)

491 
fœ¡_ÿndid©e
 = 
tmp_Ãigh_node
;

494 ià(
tmp_Ãigh_node
->
if_šcomšg
 =ğ
»cv_if
)

497 ià(!
	`©omic_šc_nÙ_z”o
(&
tmp_Ãigh_node
->
»fcouÁ
))

500 
rou‹r
 = 
tmp_Ãigh_node
;

505 ià(!
rou‹r
 && 
fœ¡_ÿndid©e
 &&

506 
	`©omic_šc_nÙ_z”o
(&
fœ¡_ÿndid©e
->
»fcouÁ
))

507 
rou‹r
 = 
fœ¡_ÿndid©e
;

509 ià(!
rou‹r
)

510 
out
;

515 
	`¥š_lock_bh
(&
´im¬y_Üig
->
Ãigh_li¡_lock
);

519 
	`li¡_d–_rcu
(&
´im¬y_Üig
->
bÚd_li¡
);

520 
	`li¡_add_rcu
(&
´im¬y_Üig
->
bÚd_li¡
,

521 &
rou‹r
->
bÚdšg_li¡
);

522 
	`¥š_uÆock_bh
(&
´im¬y_Üig
->
Ãigh_li¡_lock
);

524 
out
:

525 
	`rcu_»ad_uÆock
();

526  
rou‹r
;

527 
	}
}

535 
b©adv_Ãigh_node
 *

536 
	$b©adv_fšd_içÉ”_rou‹r
(
b©adv_Üig_node
 *
´im¬y_Üig
,

537 cÚ¡ 
b©adv_h¬d_içû
 *
»cv_if
)

539 
b©adv_Ãigh_node
 *
tmp_Ãigh_node
;

540 
b©adv_Ãigh_node
 *
rou‹r
 = 
NULL
, *
fœ¡_ÿndid©e
 = NULL;

542 
	`rcu_»ad_lock
();

543 
	`li¡_fÜ_—ch_’Œy_rcu
(
tmp_Ãigh_node
, &
´im¬y_Üig
->
bÚd_li¡
,

544 
bÚdšg_li¡
) {

545 ià(!
fœ¡_ÿndid©e
)

546 
fœ¡_ÿndid©e
 = 
tmp_Ãigh_node
;

549 ià(
tmp_Ãigh_node
->
if_šcomšg
 =ğ
»cv_if
)

552 ià(!
	`©omic_šc_nÙ_z”o
(&
tmp_Ãigh_node
->
»fcouÁ
))

558 ià((!
rou‹r
) ||

559 (
tmp_Ãigh_node
->
tq_avg
 > 
rou‹r
->tq_avg)) {

563 ià(
rou‹r
)

564 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r
);

566 
rou‹r
 = 
tmp_Ãigh_node
;

567 
	`©omic_šc_nÙ_z”o
(&
rou‹r
->
»fcouÁ
);

570 
	`b©adv_Ãigh_node_ä“_»f
(
tmp_Ãigh_node
);

574 ià(!
rou‹r
 && 
fœ¡_ÿndid©e
 &&

575 
	`©omic_šc_nÙ_z”o
(&
fœ¡_ÿndid©e
->
»fcouÁ
))

576 
rou‹r
 = 
fœ¡_ÿndid©e
;

578 
	`rcu_»ad_uÆock
();

579  
rou‹r
;

580 
	}
}

582 
	$b©adv_check_uniÿ¡_·ck‘
(
sk_buff
 *
skb
, 
hdr_size
)

584 
‘hhdr
 *ethhdr;

587 ià(
	`uÆik–y
(!
	`pskb_may_puÎ
(
skb
, 
hdr_size
)))

590 
‘hhdr
 = (‘hhd¸*)
	`skb_mac_h—d”
(
skb
);

593 ià(
	`is_brßdÿ¡_‘h”_addr
(
‘hhdr
->
h_de¡
))

597 ià(
	`is_brßdÿ¡_‘h”_addr
(
‘hhdr
->
h_sourû
))

601 ià(!
	`b©adv_is_my_mac
(
‘hhdr
->
h_de¡
))

605 
	}
}

607 
	$b©adv_»cv_‰_qu”y
(
sk_buff
 *
skb
, 
b©adv_h¬d_içû
 *
»cv_if
)

609 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
»cv_if
->
soá_içû
);

610 
b©adv_‰_qu”y_·ck‘
 *
‰_qu”y
;

611 
ušt16_t
 
‰_size
;

612 
hdr_size
 = (*
‰_qu”y
);

613 
‰_æag
;

614 
size_t
 
·ck‘_size
;

616 ià(
	`b©adv_check_uniÿ¡_·ck‘
(
skb
, 
hdr_size
) < 0)

617  
NET_RX_DROP
;

620 ià(
	`skb_cow
(
skb
, (
b©adv_‰_qu”y_·ck‘
)) < 0)

621 
out
;

623 
‰_qu”y
 = (
b©adv_‰_qu”y_·ck‘
 *)
skb
->
d©a
;

625 
‰_qu”y
->
æags
 & 
BATADV_TT_QUERY_TYPE_MASK
) {

626 
BATADV_TT_REQUEST
:

627 
	`b©adv_šc_couÁ”
(
b©_´iv
, 
BATADV_CNT_TT_REQUEST_RX
);

632 ià(!
	`b©adv_£nd_‰_»¥Ú£
(
b©_´iv
, 
‰_qu”y
)) {

633 ià(
‰_qu”y
->
æags
 & 
BATADV_TT_FULL_TABLE
)

634 
‰_æag
 = 'F';

636 
‰_æag
 = '.';

638 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

640 
‰_qu”y
->
d¡
,

641 
‰_æag
);

642  
	`b©adv_rou‹_uniÿ¡_·ck‘
(
skb
, 
»cv_if
);

645 
BATADV_TT_RESPONSE
:

646 
	`b©adv_šc_couÁ”
(
b©_´iv
, 
BATADV_CNT_TT_RESPONSE_RX
);

648 ià(
	`b©adv_is_my_mac
(
‰_qu”y
->
d¡
)) {

652 ià(
	`skb_lš—rize
(
skb
) < 0)

653 
out
;

655 
‰_qu”y
 = (
b©adv_‰_qu”y_·ck‘
 *)
skb
->
d©a
;

657 
‰_size
 = 
	`b©adv_‰_Ën
(
	`Áohs
(
‰_qu”y
->
‰_d©a
));

660 
·ck‘_size
 = (
b©adv_‰_qu”y_·ck‘
);

661 
·ck‘_size
 +ğ
‰_size
;

662 ià(
	`uÆik–y
(
	`skb_h—dËn
(
skb
è< 
·ck‘_size
))

663 
out
;

665 
	`b©adv_hªdË_‰_»¥Ú£
(
b©_´iv
, 
‰_qu”y
);

667 ià(
‰_qu”y
->
æags
 & 
BATADV_TT_FULL_TABLE
)

668 
‰_æag
 = 'F';

670 
‰_æag
 = '.';

671 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

673 
‰_qu”y
->
d¡
,

674 
‰_æag
);

675  
	`b©adv_rou‹_uniÿ¡_·ck‘
(
skb
, 
»cv_if
);

680 
out
:

682  
NET_RX_DROP
;

683 
	}
}

685 
	$b©adv_»cv_rßm_adv
(
sk_buff
 *
skb
, 
b©adv_h¬d_içû
 *
»cv_if
)

687 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
»cv_if
->
soá_içû
);

688 
b©adv_rßm_adv_·ck‘
 *
rßm_adv_·ck‘
;

689 
b©adv_Üig_node
 *
Üig_node
;

690 
‘hhdr
 *ethhdr;

693 ià(
	`uÆik–y
(!
	`pskb_may_puÎ
(
skb
,

694 (
b©adv_rßm_adv_·ck‘
))))

695 
out
;

697 
‘hhdr
 = (‘hhd¸*)
	`skb_mac_h—d”
(
skb
);

700 ià(
	`is_brßdÿ¡_‘h”_addr
(
‘hhdr
->
h_de¡
))

701 
out
;

704 ià(
	`is_brßdÿ¡_‘h”_addr
(
‘hhdr
->
h_sourû
))

705 
out
;

707 
	`b©adv_šc_couÁ”
(
b©_´iv
, 
BATADV_CNT_TT_ROAM_ADV_RX
);

709 
rßm_adv_·ck‘
 = (
b©adv_rßm_adv_·ck‘
 *)
skb
->
d©a
;

711 ià(!
	`b©adv_is_my_mac
(
rßm_adv_·ck‘
->
d¡
))

712  
	`b©adv_rou‹_uniÿ¡_·ck‘
(
skb
, 
»cv_if
);

718 ià(
	`b©adv_bÏ_is_backbÚe_gw_Üig
(
b©_´iv
, 
rßm_adv_·ck‘
->
¤c
))

719 
out
;

721 
Üig_node
 = 
	`b©adv_Üig_hash_fšd
(
b©_´iv
, 
rßm_adv_·ck‘
->
¤c
);

722 ià(!
Üig_node
)

723 
out
;

725 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

727 
rßm_adv_·ck‘
->
¤c
,„ßm_adv_·ck‘->
ş›Á
);

729 
	`b©adv_‰_glob®_add
(
b©_´iv
, 
Üig_node
, 
rßm_adv_·ck‘
->
ş›Á
,

730 
BATADV_TT_CLIENT_ROAM
,

731 
	`©omic_»ad
(&
Üig_node
->
Ï¡_‰vn
) + 1);

737 
b©_´iv
->
‰
.
poss_chªge
 = 
Œue
;

739 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

740 
out
:

742  
NET_RX_DROP
;

743 
	}
}

749 
b©adv_Ãigh_node
 *

750 
	$b©adv_fšd_rou‹r
(
b©adv_´iv
 *
b©_´iv
,

751 
b©adv_Üig_node
 *
Üig_node
,

752 cÚ¡ 
b©adv_h¬d_içû
 *
»cv_if
)

754 
b©adv_Üig_node
 *
´im¬y_Üig_node
;

755 
b©adv_Üig_node
 *
rou‹r_Üig
;

756 
b©adv_Ãigh_node
 *
rou‹r
;

757 
ušt8_t
 
z”o_mac
[
ETH_ALEN
] = {0, 0, 0, 0, 0, 0};

758 
bÚdšg_’abËd
;

759 
ušt8_t
 *
´im¬y_addr
;

761 ià(!
Üig_node
)

762  
NULL
;

764 
rou‹r
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_node
);

765 ià(!
rou‹r
)

766 
”r
;

771 
bÚdšg_’abËd
 = 
	`©omic_»ad
(&
b©_´iv
->
bÚdšg
);

773 
	`rcu_»ad_lock
();

775 
rou‹r_Üig
 = 
rou‹r
->
Üig_node
;

776 ià(!
rou‹r_Üig
)

777 
”r_uÆock
;

779 ià((!
»cv_if
è&& (!
bÚdšg_’abËd
))

780 
»tuº_rou‹r
;

782 
´im¬y_addr
 = 
rou‹r_Üig
->primary_addr;

787 ià(
	`b©adv_com·»_‘h
(
´im¬y_addr
, 
z”o_mac
))

788 
»tuº_rou‹r
;

793 ià(
	`b©adv_com·»_‘h
(
´im¬y_addr
, 
rou‹r_Üig
->
Üig
)) {

794 
´im¬y_Üig_node
 = 
rou‹r_Üig
;

796 
´im¬y_Üig_node
 = 
	`b©adv_Üig_hash_fšd
(
b©_´iv
,

797 
´im¬y_addr
);

798 ià(!
´im¬y_Üig_node
)

799 
»tuº_rou‹r
;

801 
	`b©adv_Üig_node_ä“_»f
(
´im¬y_Üig_node
);

807 ià(
	`©omic_»ad
(&
´im¬y_Üig_node
->
bÚd_ÿndid©es
) < 2)

808 
»tuº_rou‹r
;

814 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r
);

816 ià(
bÚdšg_’abËd
)

817 
rou‹r
 = 
	`b©adv_fšd_bÚd_rou‹r
(
´im¬y_Üig_node
, 
»cv_if
);

819 
rou‹r
 = 
	`b©adv_fšd_içÉ”_rou‹r
(
´im¬y_Üig_node
, 
»cv_if
);

821 
»tuº_rou‹r
:

822 ià(
rou‹r
 &&„ou‹r->
if_šcomšg
->
if_¡©us
 !ğ
BATADV_IF_ACTIVE
)

823 
”r_uÆock
;

825 
	`rcu_»ad_uÆock
();

826  
rou‹r
;

827 
”r_uÆock
:

828 
	`rcu_»ad_uÆock
();

829 
”r
:

830 ià(
rou‹r
)

831 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r
);

832  
NULL
;

833 
	}
}

835 
	$b©adv_rou‹_uniÿ¡_·ck‘
(
sk_buff
 *
skb
,

836 
b©adv_h¬d_içû
 *
»cv_if
)

838 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
»cv_if
->
soá_içû
);

839 
b©adv_Üig_node
 *
Üig_node
 = 
NULL
;

840 
b©adv_Ãigh_node
 *
Ãigh_node
 = 
NULL
;

841 
b©adv_uniÿ¡_·ck‘
 *
uniÿ¡_·ck‘
;

842 
‘hhdr
 *‘hhd¸ğ(‘hhd¸*)
	`skb_mac_h—d”
(
skb
);

843 
»t
 = 
NET_RX_DROP
;

844 
sk_buff
 *
Ãw_skb
;

846 
uniÿ¡_·ck‘
 = (
b©adv_uniÿ¡_·ck‘
 *)
skb
->
d©a
;

849 ià(
uniÿ¡_·ck‘
->
h—d”
.
‰l
 < 2) {

850 
	`´_debug
("Warning - can't forward unicast…acket from %pMo %pM:tlƒxceeded\n",

851 
‘hhdr
->
h_sourû
, 
uniÿ¡_·ck‘
->
de¡
);

852 
out
;

856 
Üig_node
 = 
	`b©adv_Üig_hash_fšd
(
b©_´iv
, 
uniÿ¡_·ck‘
->
de¡
);

858 ià(!
Üig_node
)

859 
out
;

862 
Ãigh_node
 = 
	`b©adv_fšd_rou‹r
(
b©_´iv
, 
Üig_node
, 
»cv_if
);

864 ià(!
Ãigh_node
)

865 
out
;

868 ià(
	`skb_cow
(
skb
, 
ETH_HLEN
) < 0)

869 
out
;

871 
uniÿ¡_·ck‘
 = (
b©adv_uniÿ¡_·ck‘
 *)
skb
->
d©a
;

873 ià(
uniÿ¡_·ck‘
->
h—d”
.
·ck‘_ty³
 =ğ
BATADV_UNICAST
 &&

874 
	`©omic_»ad
(&
b©_´iv
->
äagm’tiÚ
) &&

875 
skb
->
Ën
 > 
Ãigh_node
->
if_šcomšg
->
Ãt_dev
->
mtu
) {

876 
»t
 = 
	`b©adv_äag_£nd_skb
(
skb
, 
b©_´iv
,

877 
Ãigh_node
->
if_šcomšg
,

878 
Ãigh_node
->
addr
);

879 
out
;

882 ià(
uniÿ¡_·ck‘
->
h—d”
.
·ck‘_ty³
 =ğ
BATADV_UNICAST_FRAG
 &&

883 
	`b©adv_äag_ÿn_»as£mbË
(
skb
,

884 
Ãigh_node
->
if_šcomšg
->
Ãt_dev
->
mtu
)) {

886 
»t
 = 
	`b©adv_äag_»as£mbË_skb
(
skb
, 
b©_´iv
, &
Ãw_skb
);

888 ià(
»t
 =ğ
NET_RX_DROP
)

889 
out
;

892 ià(!
Ãw_skb
) {

893 
»t
 = 
NET_RX_SUCCESS
;

894 
out
;

897 
skb
 = 
Ãw_skb
;

898 
uniÿ¡_·ck‘
 = (
b©adv_uniÿ¡_·ck‘
 *)
skb
->
d©a
;

902 
uniÿ¡_·ck‘
->
h—d”
.
‰l
--;

905 
	`b©adv_šc_couÁ”
(
b©_´iv
, 
BATADV_CNT_FORWARD
);

906 
	`b©adv_add_couÁ”
(
b©_´iv
, 
BATADV_CNT_FORWARD_BYTES
,

907 
skb
->
Ën
 + 
ETH_HLEN
);

910 
	`b©adv_£nd_skb_·ck‘
(
skb
, 
Ãigh_node
->
if_šcomšg
,‚eigh_node->
addr
);

911 
»t
 = 
NET_RX_SUCCESS
;

913 
out
:

914 ià(
Ãigh_node
)

915 
	`b©adv_Ãigh_node_ä“_»f
(
Ãigh_node
);

916 ià(
Üig_node
)

917 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

918  
»t
;

919 
	}
}

921 
	$b©adv_check_uniÿ¡_‰vn
(
b©adv_´iv
 *
b©_´iv
,

922 
sk_buff
 *
skb
) {

923 
ušt8_t
 
cu¼_‰vn
;

924 
b©adv_Üig_node
 *
Üig_node
;

925 
‘hhdr
 *ethhdr;

926 
b©adv_h¬d_içû
 *
´im¬y_if
;

927 
b©adv_uniÿ¡_·ck‘
 *
uniÿ¡_·ck‘
;

928 
boŞ
 
‰_poss_chªge
;

929 
is_Şd_‰vn
;

932 ià(
	`skb_cow
(
skb
, (
b©adv_uniÿ¡_·ck‘
)) < 0)

935 
uniÿ¡_·ck‘
 = (
b©adv_uniÿ¡_·ck‘
 *)
skb
->
d©a
;

937 ià(
	`b©adv_is_my_mac
(
uniÿ¡_·ck‘
->
de¡
)) {

938 
‰_poss_chªge
 = 
b©_´iv
->
‰
.
poss_chªge
;

939 
cu¼_‰vn
 = (
ušt8_t
)
	`©omic_»ad
(&
b©_´iv
->
‰
.
vn
);

941 
Üig_node
 = 
	`b©adv_Üig_hash_fšd
(
b©_´iv
,

942 
uniÿ¡_·ck‘
->
de¡
);

944 ià(!
Üig_node
)

947 
cu¼_‰vn
 = (
ušt8_t
)
	`©omic_»ad
(&
Üig_node
->
Ï¡_‰vn
);

948 
‰_poss_chªge
 = 
Üig_node
->tt_poss_change;

949 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

953 
is_Şd_‰vn
 = 
	`b©adv_£q_befÜe
(
uniÿ¡_·ck‘
->
‰vn
, 
cu¼_‰vn
);

954 ià(
is_Şd_‰vn
 || 
‰_poss_chªge
) {

956 ià(
	`pskb_may_puÎ
(
skb
, (
b©adv_uniÿ¡_·ck‘
) +

957 
ETH_HLEN
) < 0)

960 
‘hhdr
 = (‘hhd¸*)(
skb
->
d©a
 + (*
uniÿ¡_·ck‘
));

965 ià(
	`b©adv_‰_glob®_ş›Á_is_rßmšg
(
b©_´iv
,

966 
‘hhdr
->
h_de¡
))

969 
Üig_node
 = 
	`b©adv_Œª¡abË_£¬ch
(
b©_´iv
, 
NULL
,

970 
‘hhdr
->
h_de¡
);

972 ià(!
Üig_node
) {

973 ià(!
	`b©adv_is_my_ş›Á
(
b©_´iv
, 
‘hhdr
->
h_de¡
))

975 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

976 ià(!
´im¬y_if
)

978 
	`memıy
(
uniÿ¡_·ck‘
->
de¡
,

979 
´im¬y_if
->
Ãt_dev
->
dev_addr
, 
ETH_ALEN
);

980 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

982 
	`memıy
(
uniÿ¡_·ck‘
->
de¡
, 
Üig_node
->
Üig
,

983 
ETH_ALEN
);

984 
cu¼_‰vn
 = (
ušt8_t
)
	`©omic_»ad
(&
Üig_node
->
Ï¡_‰vn
);

985 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

988 
	`b©adv_dbg
(
BATADV_DBG_ROUTES
, 
b©_´iv
,

990 
uniÿ¡_·ck‘
->
‰vn
, 
cu¼_‰vn
, 
‘hhdr
->
h_de¡
,

991 
uniÿ¡_·ck‘
->
de¡
);

993 
uniÿ¡_·ck‘
->
‰vn
 = 
cu¼_‰vn
;

996 
	}
}

998 
	$b©adv_»cv_uniÿ¡_·ck‘
(
sk_buff
 *
skb
,

999 
b©adv_h¬d_içû
 *
»cv_if
)

1001 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
»cv_if
->
soá_içû
);

1002 
b©adv_uniÿ¡_·ck‘
 *
uniÿ¡_·ck‘
;

1003 
hdr_size
 = (*
uniÿ¡_·ck‘
);

1005 ià(
	`b©adv_check_uniÿ¡_·ck‘
(
skb
, 
hdr_size
) < 0)

1006  
NET_RX_DROP
;

1008 ià(!
	`b©adv_check_uniÿ¡_‰vn
(
b©_´iv
, 
skb
))

1009  
NET_RX_DROP
;

1011 
uniÿ¡_·ck‘
 = (
b©adv_uniÿ¡_·ck‘
 *)
skb
->
d©a
;

1014 ià(
	`b©adv_is_my_mac
(
uniÿ¡_·ck‘
->
de¡
)) {

1015 
	`b©adv_š‹rçû_rx
(
»cv_if
->
soá_içû
, 
skb
,„ecv_if, 
hdr_size
,

1016 
NULL
);

1018  
NET_RX_SUCCESS
;

1021  
	`b©adv_rou‹_uniÿ¡_·ck‘
(
skb
, 
»cv_if
);

1022 
	}
}

1024 
	$b©adv_»cv_uÿ¡_äag_·ck‘
(
sk_buff
 *
skb
,

1025 
b©adv_h¬d_içû
 *
»cv_if
)

1027 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
»cv_if
->
soá_içû
);

1028 
b©adv_uniÿ¡_äag_·ck‘
 *
uniÿ¡_·ck‘
;

1029 
hdr_size
 = (*
uniÿ¡_·ck‘
);

1030 
sk_buff
 *
Ãw_skb
 = 
NULL
;

1031 
»t
;

1033 ià(
	`b©adv_check_uniÿ¡_·ck‘
(
skb
, 
hdr_size
) < 0)

1034  
NET_RX_DROP
;

1036 ià(!
	`b©adv_check_uniÿ¡_‰vn
(
b©_´iv
, 
skb
))

1037  
NET_RX_DROP
;

1039 
uniÿ¡_·ck‘
 = (
b©adv_uniÿ¡_äag_·ck‘
 *)
skb
->
d©a
;

1042 ià(
	`b©adv_is_my_mac
(
uniÿ¡_·ck‘
->
de¡
)) {

1044 
»t
 = 
	`b©adv_äag_»as£mbË_skb
(
skb
, 
b©_´iv
, &
Ãw_skb
);

1046 ià(
»t
 =ğ
NET_RX_DROP
)

1047  
NET_RX_DROP
;

1050 ià(!
Ãw_skb
)

1051  
NET_RX_SUCCESS
;

1053 
	`b©adv_š‹rçû_rx
(
»cv_if
->
soá_içû
, 
Ãw_skb
,„ecv_if,

1054 (
b©adv_uniÿ¡_·ck‘
), 
NULL
);

1055  
NET_RX_SUCCESS
;

1058  
	`b©adv_rou‹_uniÿ¡_·ck‘
(
skb
, 
»cv_if
);

1059 
	}
}

1062 
	$b©adv_»cv_bÿ¡_·ck‘
(
sk_buff
 *
skb
,

1063 
b©adv_h¬d_içû
 *
»cv_if
)

1065 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
»cv_if
->
soá_içû
);

1066 
b©adv_Üig_node
 *
Üig_node
 = 
NULL
;

1067 
b©adv_bÿ¡_·ck‘
 *
bÿ¡_·ck‘
;

1068 
‘hhdr
 *ethhdr;

1069 
hdr_size
 = (*
bÿ¡_·ck‘
);

1070 
»t
 = 
NET_RX_DROP
;

1071 
št32_t
 
£q_diff
;

1074 ià(
	`uÆik–y
(!
	`pskb_may_puÎ
(
skb
, 
hdr_size
)))

1075 
out
;

1077 
‘hhdr
 = (‘hhd¸*)
	`skb_mac_h—d”
(
skb
);

1080 ià(!
	`is_brßdÿ¡_‘h”_addr
(
‘hhdr
->
h_de¡
))

1081 
out
;

1084 ià(
	`is_brßdÿ¡_‘h”_addr
(
‘hhdr
->
h_sourû
))

1085 
out
;

1088 ià(
	`b©adv_is_my_mac
(
‘hhdr
->
h_sourû
))

1089 
out
;

1091 
bÿ¡_·ck‘
 = (
b©adv_bÿ¡_·ck‘
 *)
skb
->
d©a
;

1094 ià(
	`b©adv_is_my_mac
(
bÿ¡_·ck‘
->
Üig
))

1095 
out
;

1097 ià(
bÿ¡_·ck‘
->
h—d”
.
‰l
 < 2)

1098 
out
;

1100 
Üig_node
 = 
	`b©adv_Üig_hash_fšd
(
b©_´iv
, 
bÿ¡_·ck‘
->
Üig
);

1102 ià(!
Üig_node
)

1103 
out
;

1105 
	`¥š_lock_bh
(&
Üig_node
->
bÿ¡_£qno_lock
);

1108 ià(
	`b©adv_‹¡_b™
(
Üig_node
->
bÿ¡_b™s
, orig_node->
Ï¡_bÿ¡_£qno
,

1109 
	`Áohl
(
bÿ¡_·ck‘
->
£qno
)))

1110 
¥š_uÆock
;

1112 
£q_diff
 = 
	`Áohl
(
bÿ¡_·ck‘
->
£qno
è- 
Üig_node
->
Ï¡_bÿ¡_£qno
;

1115 ià(
	`b©adv_wšdow_´Ùeùed
(
b©_´iv
, 
£q_diff
,

1116 &
Üig_node
->
bÿ¡_£qno_»£t
))

1117 
¥š_uÆock
;

1122 ià(
	`b©adv_b™_g‘_·ck‘
(
b©_´iv
, 
Üig_node
->
bÿ¡_b™s
, 
£q_diff
, 1))

1123 
Üig_node
->
Ï¡_bÿ¡_£qno
 = 
	`Áohl
(
bÿ¡_·ck‘
->
£qno
);

1125 
	`¥š_uÆock_bh
(&
Üig_node
->
bÿ¡_£qno_lock
);

1128 ià(
	`skb_lš—rize
(
skb
) < 0)

1129 
out
;

1131 
bÿ¡_·ck‘
 = (
b©adv_bÿ¡_·ck‘
 *)
skb
->
d©a
;

1134 ià(
	`b©adv_bÏ_check_bÿ¡_du¶i¡
(
b©_´iv
, 
bÿ¡_·ck‘
, 
skb
->
Ën
))

1135 
out
;

1138 
	`b©adv_add_bÿ¡_·ck‘_to_li¡
(
b©_´iv
, 
skb
, 1);

1143 ià(
	`b©adv_bÏ_is_backbÚe_gw
(
skb
, 
Üig_node
, 
hdr_size
))

1144 
out
;

1147 
	`b©adv_š‹rçû_rx
(
»cv_if
->
soá_içû
, 
skb
,„ecv_if, 
hdr_size
,

1148 
Üig_node
);

1149 
»t
 = 
NET_RX_SUCCESS
;

1150 
out
;

1152 
¥š_uÆock
:

1153 
	`¥š_uÆock_bh
(&
Üig_node
->
bÿ¡_£qno_lock
);

1154 
out
:

1155 ià(
Üig_node
)

1156 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

1157  
»t
;

1158 
	}
}

1160 
	$b©adv_»cv_vis_·ck‘
(
sk_buff
 *
skb
,

1161 
b©adv_h¬d_içû
 *
»cv_if
)

1163 
b©adv_vis_·ck‘
 *
vis_·ck‘
;

1164 
‘hhdr
 *ethhdr;

1165 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
»cv_if
->
soá_içû
);

1166 
hdr_size
 = (*
vis_·ck‘
);

1169 ià(
	`skb_lš—rize
(
skb
) < 0)

1170  
NET_RX_DROP
;

1172 ià(
	`uÆik–y
(!
	`pskb_may_puÎ
(
skb
, 
hdr_size
)))

1173  
NET_RX_DROP
;

1175 
vis_·ck‘
 = (
b©adv_vis_·ck‘
 *)
skb
->
d©a
;

1176 
‘hhdr
 = (‘hhd¸*)
	`skb_mac_h—d”
(
skb
);

1179 ià(!
	`b©adv_is_my_mac
(
‘hhdr
->
h_de¡
))

1180  
NET_RX_DROP
;

1183 ià(
	`b©adv_is_my_mac
(
vis_·ck‘
->
vis_Üig
))

1184  
NET_RX_DROP
;

1186 ià(
	`b©adv_is_my_mac
(
vis_·ck‘
->
£nd”_Üig
))

1187  
NET_RX_DROP
;

1189 
vis_·ck‘
->
vis_ty³
) {

1190 
BATADV_VIS_TYPE_SERVER_SYNC
:

1191 
	`b©adv_»ûive_£rv”_sync_·ck‘
(
b©_´iv
, 
vis_·ck‘
,

1192 
	`skb_h—dËn
(
skb
));

1195 
BATADV_VIS_TYPE_CLIENT_UPDATE
:

1196 
	`b©adv_»ûive_ş›Á_upd©e_·ck‘
(
b©_´iv
, 
vis_·ck‘
,

1197 
	`skb_h—dËn
(
skb
));

1207  
NET_RX_DROP
;

1208 
	}
}

	@routing.h

20 #iâdeà
_NET_BATMAN_ADV_ROUTING_H_


21 
	#_NET_BATMAN_ADV_ROUTING_H_


	)

23 
b©adv_¦ide_own_bÿ¡_wšdow
(
b©adv_h¬d_içû
 *
h¬d_içû
);

24 
boŞ
 
b©adv_check_mªagem’t_·ck‘
(
sk_buff
 *
skb
,

25 
b©adv_h¬d_içû
 *
h¬d_içû
,

26 
h—d”_Ën
);

27 
b©adv_upd©e_rou‹
(
b©adv_´iv
 *
b©_´iv
,

28 
b©adv_Üig_node
 *
Üig_node
,

29 
b©adv_Ãigh_node
 *
Ãigh_node
);

30 
b©adv_»cv_icmp_·ck‘
(
sk_buff
 *
skb
,

31 
b©adv_h¬d_içû
 *
»cv_if
);

32 
b©adv_»cv_uniÿ¡_·ck‘
(
sk_buff
 *
skb
,

33 
b©adv_h¬d_içû
 *
»cv_if
);

34 
b©adv_»cv_uÿ¡_äag_·ck‘
(
sk_buff
 *
skb
,

35 
b©adv_h¬d_içû
 *
»cv_if
);

36 
b©adv_»cv_bÿ¡_·ck‘
(
sk_buff
 *
skb
,

37 
b©adv_h¬d_içû
 *
»cv_if
);

38 
b©adv_»cv_vis_·ck‘
(
sk_buff
 *
skb
,

39 
b©adv_h¬d_içû
 *
»cv_if
);

40 
b©adv_»cv_‰_qu”y
(
sk_buff
 *
skb
,

41 
b©adv_h¬d_içû
 *
»cv_if
);

42 
b©adv_»cv_rßm_adv
(
sk_buff
 *
skb
,

43 
b©adv_h¬d_içû
 *
»cv_if
);

44 
b©adv_Ãigh_node
 *

45 
b©adv_fšd_rou‹r
(
b©adv_´iv
 *
b©_´iv
,

46 
b©adv_Üig_node
 *
Üig_node
,

47 cÚ¡ 
b©adv_h¬d_içû
 *
»cv_if
);

48 
b©adv_bÚdšg_ÿndid©e_d–
(
b©adv_Üig_node
 *
Üig_node
,

49 
b©adv_Ãigh_node
 *
Ãigh_node
);

50 
b©adv_bÚdšg_ÿndid©e_add
(
b©adv_Üig_node
 *
Üig_node
,

51 
b©adv_Ãigh_node
 *
Ãigh_node
);

52 
b©adv_bÚdšg_§ve_´im¬y
(cÚ¡ 
b©adv_Üig_node
 *
Üig_node
,

53 
b©adv_Üig_node
 *
Üig_Ãigh_node
,

54 cÚ¡ 
b©adv_ogm_·ck‘


55 *
b©mª_ogm_·ck‘
);

56 
b©adv_wšdow_´Ùeùed
(
b©adv_´iv
 *
b©_´iv
, 
št32_t
 
£q_num_diff
,

57 *
Ï¡_»£t
);

	@send.c

20 
	~"maš.h
"

21 
	~"£nd.h
"

22 
	~"routšg.h
"

23 
	~"Œª¦©iÚ-bË.h
"

24 
	~"soá-š‹rçû.h
"

25 
	~"h¬d-š‹rçû.h
"

26 
	~"vis.h
"

27 
	~"g©eway_commÚ.h
"

28 
	~"Üigš©Ü.h
"

30 
b©adv_£nd_out¡ªdšg_bÿ¡_·ck‘
(
wÜk_¡ruù
 *
wÜk
);

35 
	$b©adv_£nd_skb_·ck‘
(
sk_buff
 *
skb
,

36 
b©adv_h¬d_içû
 *
h¬d_içû
,

37 cÚ¡ 
ušt8_t
 *
d¡_addr
)

39 
‘hhdr
 *ethhdr;

41 ià(
h¬d_içû
->
if_¡©us
 !ğ
BATADV_IF_ACTIVE
)

42 
£nd_skb_”r
;

44 ià(
	`uÆik–y
(!
h¬d_içû
->
Ãt_dev
))

45 
£nd_skb_”r
;

47 ià(!(
h¬d_içû
->
Ãt_dev
->
æags
 & 
IFF_UP
)) {

48 
	`´_w¬n
("Interface %s is‚ot up - can't send…acket viahat interface!\n",

49 
h¬d_içû
->
Ãt_dev
->
Çme
);

50 
£nd_skb_”r
;

54 ià(
	`b©adv_skb_h—d_push
(
skb
, 
ETH_HLEN
) < 0)

55 
£nd_skb_”r
;

57 
	`skb_»£t_mac_h—d”
(
skb
);

59 
‘hhdr
 = (‘hhd¸*)
	`skb_mac_h—d”
(
skb
);

60 
	`memıy
(
‘hhdr
->
h_sourû
, 
h¬d_içû
->
Ãt_dev
->
dev_addr
, 
ETH_ALEN
);

61 
	`memıy
(
‘hhdr
->
h_de¡
, 
d¡_addr
, 
ETH_ALEN
);

62 
‘hhdr
->
h_´Ùo
 = 
	`__cÚ¡ªt_htÚs
(
BATADV_ETH_P_BATMAN
);

64 
	`skb_£t_ÃtwÜk_h—d”
(
skb
, 
ETH_HLEN
);

65 
skb
->
´iÜ™y
 = 
TC_PRIO_CONTROL
;

66 
skb
->
´ÙocŞ
 = 
	`__cÚ¡ªt_htÚs
(
BATADV_ETH_P_BATMAN
);

68 
skb
->
dev
 = 
h¬d_içû
->
Ãt_dev
;

74  
	`dev_queue_xm™
(
skb
);

75 
£nd_skb_”r
:

76 
	`kä“_skb
(
skb
);

77  
NET_XMIT_DROP
;

78 
	}
}

80 
	$b©adv_scheduË_b©_ogm
(
b©adv_h¬d_içû
 *
h¬d_içû
)

82 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
h¬d_içû
->
soá_içû
);

84 ià((
h¬d_içû
->
if_¡©us
 =ğ
BATADV_IF_NOT_IN_USE
) ||

85 (
h¬d_içû
->
if_¡©us
 =ğ
BATADV_IF_TO_BE_REMOVED
))

94 ià(
h¬d_içû
->
if_¡©us
 =ğ
BATADV_IF_TO_BE_ACTIVATED
)

95 
h¬d_içû
->
if_¡©us
 = 
BATADV_IF_ACTIVE
;

97 
b©_´iv
->
b©_®go_İs
->
	`b©_ogm_scheduË
(
h¬d_içû
);

98 
	}
}

100 
	$b©adv_fÜw_·ck‘_ä“
(
b©adv_fÜw_·ck‘
 *
fÜw_·ck‘
)

102 ià(
fÜw_·ck‘
->
skb
)

103 
	`kä“_skb
(
fÜw_·ck‘
->
skb
);

104 ià(
fÜw_·ck‘
->
if_šcomšg
)

105 
	`b©adv_h¬dif_ä“_»f
(
fÜw_·ck‘
->
if_šcomšg
);

106 
	`kä“
(
fÜw_·ck‘
);

107 
	}
}

110 
	$_b©adv_add_bÿ¡_·ck‘_to_li¡
(
b©adv_´iv
 *
b©_´iv
,

111 
b©adv_fÜw_·ck‘
 *
fÜw_·ck‘
,

112 
£nd_time
)

114 
	`INIT_HLIST_NODE
(&
fÜw_·ck‘
->
li¡
);

117 
	`¥š_lock_bh
(&
b©_´iv
->
fÜw_bÿ¡_li¡_lock
);

118 
	`hli¡_add_h—d
(&
fÜw_·ck‘
->
li¡
, &
b©_´iv
->
fÜw_bÿ¡_li¡
);

119 
	`¥š_uÆock_bh
(&
b©_´iv
->
fÜw_bÿ¡_li¡_lock
);

122 
	`INIT_DELAYED_WORK
(&
fÜw_·ck‘
->
d–ayed_wÜk
,

123 
b©adv_£nd_out¡ªdšg_bÿ¡_·ck‘
);

124 
	`queue_d–ayed_wÜk
(
b©adv_ev’t_wÜkqueue
, &
fÜw_·ck‘
->
d–ayed_wÜk
,

125 
£nd_time
);

126 
	}
}

137 
	$b©adv_add_bÿ¡_·ck‘_to_li¡
(
b©adv_´iv
 *
b©_´iv
,

138 cÚ¡ 
sk_buff
 *
skb
,

139 
d–ay
)

141 
b©adv_h¬d_içû
 *
´im¬y_if
 = 
NULL
;

142 
b©adv_fÜw_·ck‘
 *
fÜw_·ck‘
;

143 
b©adv_bÿ¡_·ck‘
 *
bÿ¡_·ck‘
;

144 
sk_buff
 *
Ãwskb
;

146 ià(!
	`b©adv_©omic_dec_nÙ_z”o
(&
b©_´iv
->
bÿ¡_queue_Ëá
)) {

147 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

149 
out
;

152 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

153 ià(!
´im¬y_if
)

154 
out_ªd_šc
;

156 
fÜw_·ck‘
 = 
	`km®loc
((*fÜw_·ck‘), 
GFP_ATOMIC
);

158 ià(!
fÜw_·ck‘
)

159 
out_ªd_šc
;

161 
Ãwskb
 = 
	`skb_cİy
(
skb
, 
GFP_ATOMIC
);

162 ià(!
Ãwskb
)

163 
·ck‘_ä“
;

166 
bÿ¡_·ck‘
 = (
b©adv_bÿ¡_·ck‘
 *)
Ãwskb
->
d©a
;

167 
bÿ¡_·ck‘
->
h—d”
.
‰l
--;

169 
	`skb_»£t_mac_h—d”
(
Ãwskb
);

171 
fÜw_·ck‘
->
skb
 = 
Ãwskb
;

172 
fÜw_·ck‘
->
if_šcomšg
 = 
´im¬y_if
;

175 
fÜw_·ck‘
->
num_·ck‘s
 = 0;

177 
	`_b©adv_add_bÿ¡_·ck‘_to_li¡
(
b©_´iv
, 
fÜw_·ck‘
, 
d–ay
);

178  
NETDEV_TX_OK
;

180 
·ck‘_ä“
:

181 
	`kä“
(
fÜw_·ck‘
);

182 
out_ªd_šc
:

183 
	`©omic_šc
(&
b©_´iv
->
bÿ¡_queue_Ëá
);

184 
out
:

185 ià(
´im¬y_if
)

186 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

187  
NETDEV_TX_BUSY
;

188 
	}
}

190 
	$b©adv_£nd_out¡ªdšg_bÿ¡_·ck‘
(
wÜk_¡ruù
 *
wÜk
)

192 
b©adv_h¬d_içû
 *
h¬d_içû
;

193 
d–ayed_wÜk
 *delayed_work;

194 
b©adv_fÜw_·ck‘
 *
fÜw_·ck‘
;

195 
sk_buff
 *
skb1
;

196 
Ãt_deviû
 *
soá_içû
;

197 
b©adv_´iv
 *
b©_´iv
;

199 
d–ayed_wÜk
 = 
	`cÚš”_of
(
wÜk
, delayed_work, work);

200 
fÜw_·ck‘
 = 
	`cÚš”_of
(
d–ayed_wÜk
, 
b©adv_fÜw_·ck‘
,

201 
d–ayed_wÜk
);

202 
soá_içû
 = 
fÜw_·ck‘
->
if_šcomšg
->soft_iface;

203 
b©_´iv
 = 
	`Ãtdev_´iv
(
soá_içû
);

205 
	`¥š_lock_bh
(&
b©_´iv
->
fÜw_bÿ¡_li¡_lock
);

206 
	`hli¡_d–
(&
fÜw_·ck‘
->
li¡
);

207 
	`¥š_uÆock_bh
(&
b©_´iv
->
fÜw_bÿ¡_li¡_lock
);

209 ià(
	`©omic_»ad
(&
b©_´iv
->
mesh_¡©e
è=ğ
BATADV_MESH_DEACTIVATING
)

210 
out
;

213 
	`rcu_»ad_lock
();

214 
	`li¡_fÜ_—ch_’Œy_rcu
(
h¬d_içû
, &
b©adv_h¬dif_li¡
, 
li¡
) {

215 ià(
h¬d_içû
->
soá_içû
 != soft_iface)

219 
skb1
 = 
	`skb_şÚe
(
fÜw_·ck‘
->
skb
, 
GFP_ATOMIC
);

220 ià(
skb1
)

221 
	`b©adv_£nd_skb_·ck‘
(
skb1
, 
h¬d_içû
,

222 
b©adv_brßdÿ¡_addr
);

224 
	`rcu_»ad_uÆock
();

226 
fÜw_·ck‘
->
num_·ck‘s
++;

229 ià(
fÜw_·ck‘
->
num_·ck‘s
 < 3) {

230 
	`_b©adv_add_bÿ¡_·ck‘_to_li¡
(
b©_´iv
, 
fÜw_·ck‘
,

231 
	`m£cs_to_jiff›s
(5));

235 
out
:

236 
	`b©adv_fÜw_·ck‘_ä“
(
fÜw_·ck‘
);

237 
	`©omic_šc
(&
b©_´iv
->
bÿ¡_queue_Ëá
);

238 
	}
}

240 
	$b©adv_£nd_out¡ªdšg_b©_ogm_·ck‘
(
wÜk_¡ruù
 *
wÜk
)

242 
d–ayed_wÜk
 *delayed_work;

243 
b©adv_fÜw_·ck‘
 *
fÜw_·ck‘
;

244 
b©adv_´iv
 *
b©_´iv
;

246 
d–ayed_wÜk
 = 
	`cÚš”_of
(
wÜk
, delayed_work, work);

247 
fÜw_·ck‘
 = 
	`cÚš”_of
(
d–ayed_wÜk
, 
b©adv_fÜw_·ck‘
,

248 
d–ayed_wÜk
);

249 
b©_´iv
 = 
	`Ãtdev_´iv
(
fÜw_·ck‘
->
if_šcomšg
->
soá_içû
);

250 
	`¥š_lock_bh
(&
b©_´iv
->
fÜw_b©_li¡_lock
);

251 
	`hli¡_d–
(&
fÜw_·ck‘
->
li¡
);

252 
	`¥š_uÆock_bh
(&
b©_´iv
->
fÜw_b©_li¡_lock
);

254 ià(
	`©omic_»ad
(&
b©_´iv
->
mesh_¡©e
è=ğ
BATADV_MESH_DEACTIVATING
)

255 
out
;

257 
b©_´iv
->
b©_®go_İs
->
	`b©_ogm_em™
(
fÜw_·ck‘
);

263 ià(
fÜw_·ck‘
->
own
)

264 
	`b©adv_scheduË_b©_ogm
(
fÜw_·ck‘
->
if_šcomšg
);

266 
out
:

268 ià(!
fÜw_·ck‘
->
own
)

269 
	`©omic_šc
(&
b©_´iv
->
b©mª_queue_Ëá
);

271 
	`b©adv_fÜw_·ck‘_ä“
(
fÜw_·ck‘
);

272 
	}
}

275 
	$b©adv_purge_out¡ªdšg_·ck‘s
(
b©adv_´iv
 *
b©_´iv
,

276 cÚ¡ 
b©adv_h¬d_içû
 *
h¬d_içû
)

278 
b©adv_fÜw_·ck‘
 *
fÜw_·ck‘
;

279 
hli¡_node
 *
tmp_node
, *
§ã_tmp_node
;

280 
boŞ
 
³ndšg
;

282 ià(
h¬d_içû
)

283 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

285 
h¬d_içû
->
Ãt_dev
->
Çme
);

287 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

291 
	`¥š_lock_bh
(&
b©_´iv
->
fÜw_bÿ¡_li¡_lock
);

292 
	`hli¡_fÜ_—ch_’Œy_§ã
(
fÜw_·ck‘
, 
tmp_node
, 
§ã_tmp_node
,

293 &
b©_´iv
->
fÜw_bÿ¡_li¡
, 
li¡
) {

298 ià((
h¬d_içû
) &&

299 (
fÜw_·ck‘
->
if_šcomšg
 !ğ
h¬d_içû
))

302 
	`¥š_uÆock_bh
(&
b©_´iv
->
fÜw_bÿ¡_li¡_lock
);

307 
³ndšg
 = 
	`ÿnûl_d–ayed_wÜk_sync
(&
fÜw_·ck‘
->
d–ayed_wÜk
);

308 
	`¥š_lock_bh
(&
b©_´iv
->
fÜw_bÿ¡_li¡_lock
);

310 ià(
³ndšg
) {

311 
	`hli¡_d–
(&
fÜw_·ck‘
->
li¡
);

312 
	`b©adv_fÜw_·ck‘_ä“
(
fÜw_·ck‘
);

315 
	`¥š_uÆock_bh
(&
b©_´iv
->
fÜw_bÿ¡_li¡_lock
);

318 
	`¥š_lock_bh
(&
b©_´iv
->
fÜw_b©_li¡_lock
);

319 
	`hli¡_fÜ_—ch_’Œy_§ã
(
fÜw_·ck‘
, 
tmp_node
, 
§ã_tmp_node
,

320 &
b©_´iv
->
fÜw_b©_li¡
, 
li¡
) {

325 ià((
h¬d_içû
) &&

326 (
fÜw_·ck‘
->
if_šcomšg
 !ğ
h¬d_içû
))

329 
	`¥š_uÆock_bh
(&
b©_´iv
->
fÜw_b©_li¡_lock
);

334 
³ndšg
 = 
	`ÿnûl_d–ayed_wÜk_sync
(&
fÜw_·ck‘
->
d–ayed_wÜk
);

335 
	`¥š_lock_bh
(&
b©_´iv
->
fÜw_b©_li¡_lock
);

337 ià(
³ndšg
) {

338 
	`hli¡_d–
(&
fÜw_·ck‘
->
li¡
);

339 
	`b©adv_fÜw_·ck‘_ä“
(
fÜw_·ck‘
);

342 
	`¥š_uÆock_bh
(&
b©_´iv
->
fÜw_b©_li¡_lock
);

343 
	}
}

	@send.h

20 #iâdeà
_NET_BATMAN_ADV_SEND_H_


21 
	#_NET_BATMAN_ADV_SEND_H_


	)

23 
b©adv_£nd_skb_·ck‘
(
sk_buff
 *
skb
,

24 
b©adv_h¬d_içû
 *
h¬d_içû
,

25 cÚ¡ 
ušt8_t
 *
d¡_addr
);

26 
b©adv_scheduË_b©_ogm
(
b©adv_h¬d_içû
 *
h¬d_içû
);

27 
b©adv_add_bÿ¡_·ck‘_to_li¡
(
b©adv_´iv
 *
b©_´iv
,

28 cÚ¡ 
sk_buff
 *
skb
,

29 
d–ay
);

30 
b©adv_£nd_out¡ªdšg_b©_ogm_·ck‘
(
wÜk_¡ruù
 *
wÜk
);

32 
b©adv_purge_out¡ªdšg_·ck‘s
(
b©adv_´iv
 *
b©_´iv
,

33 cÚ¡ 
b©adv_h¬d_içû
 *
h¬d_içû
);

	@soft-interface.c

20 
	~"maš.h
"

21 
	~"soá-š‹rçû.h
"

22 
	~"h¬d-š‹rçû.h
"

23 
	~"routšg.h
"

24 
	~"£nd.h
"

25 
	~"debugfs.h
"

26 
	~"Œª¦©iÚ-bË.h
"

27 
	~"hash.h
"

28 
	~"g©eway_commÚ.h
"

29 
	~"g©eway_ş›Á.h
"

30 
	~"sysfs.h
"

31 
	~"Üigš©Ü.h
"

32 
	~<lšux/¦ab.h
>

33 
	~<lšux/‘htoŞ.h
>

34 
	~<lšux/‘h”deviû.h
>

35 
	~<lšux/if_vÏn.h
>

36 
	~"uniÿ¡.h
"

37 
	~"bridge_loİ_avoidªû.h
"

40 
b©adv_g‘_£‰šgs
(
Ãt_deviû
 *
dev
, 
‘htoŞ_cmd
 *
cmd
);

41 
b©adv_g‘_drvšfo
(
Ãt_deviû
 *
dev
,

42 
‘htoŞ_drvšfo
 *
šfo
);

43 
u32
 
b©adv_g‘_msgËv–
(
Ãt_deviû
 *
dev
);

44 
b©adv_£t_msgËv–
(
Ãt_deviû
 *
dev
, 
u32
 
v®ue
);

45 
u32
 
b©adv_g‘_lšk
(
Ãt_deviû
 *
dev
);

46 
b©adv_g‘_¡ršgs
(
Ãt_deviû
 *
dev
, 
u32
 
¡ršg£t
, 
u8
 *
d©a
);

47 
b©adv_g‘_‘htoŞ_¡©s
(
Ãt_deviû
 *
dev
,

48 
‘htoŞ_¡©s
 *
¡©s
, 
u64
 *
d©a
);

49 
b©adv_g‘_s£t_couÁ
(
Ãt_deviû
 *
dev
, 
¡ršg£t
);

51 cÚ¡ 
‘htoŞ_İs
 
	gb©adv_‘htoŞ_İs
 = {

52 .
g‘_£‰šgs
 = 
b©adv_g‘_£‰šgs
,

53 .
	gg‘_drvšfo
 = 
b©adv_g‘_drvšfo
,

54 .
	gg‘_msgËv–
 = 
b©adv_g‘_msgËv–
,

55 .
	g£t_msgËv–
 = 
b©adv_£t_msgËv–
,

56 .
	gg‘_lšk
 = 
b©adv_g‘_lšk
,

57 .
	gg‘_¡ršgs
 = 
b©adv_g‘_¡ršgs
,

58 .
	gg‘_‘htoŞ_¡©s
 = 
b©adv_g‘_‘htoŞ_¡©s
,

59 .
	gg‘_s£t_couÁ
 = 
b©adv_g‘_s£t_couÁ
,

62 
	$b©adv_skb_h—d_push
(
sk_buff
 *
skb
, 
Ën
)

64 
»suÉ
;

73 
»suÉ
 = 
	`skb_cow_h—d
(
skb
, 
Ën
);

74 ià(
»suÉ
 < 0)

75  
»suÉ
;

77 
	`skb_push
(
skb
, 
Ën
);

79 
	}
}

81 
	$b©adv_š‹rçû_İ’
(
Ãt_deviû
 *
dev
)

83 
	`Ãtif_¡¬t_queue
(
dev
);

85 
	}
}

87 
	$b©adv_š‹rçû_»Ëa£
(
Ãt_deviû
 *
dev
)

89 
	`Ãtif_¡İ_queue
(
dev
);

91 
	}
}

93 
Ãt_deviû_¡©s
 *
	$b©adv_š‹rçû_¡©s
(
Ãt_deviû
 *
dev
)

95 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
dev
);

96 
Ãt_deviû_¡©s
 *
¡©s
 = &
b©_´iv
->stats;

98 
¡©s
->
tx_·ck‘s
 = 
	`b©adv_sum_couÁ”
(
b©_´iv
, 
BATADV_CNT_TX
);

99 
¡©s
->
tx_by‹s
 = 
	`b©adv_sum_couÁ”
(
b©_´iv
, 
BATADV_CNT_TX_BYTES
);

100 
¡©s
->
tx_drİ³d
 = 
	`b©adv_sum_couÁ”
(
b©_´iv
, 
BATADV_CNT_TX_DROPPED
);

101 
¡©s
->
rx_·ck‘s
 = 
	`b©adv_sum_couÁ”
(
b©_´iv
, 
BATADV_CNT_RX
);

102 
¡©s
->
rx_by‹s
 = 
	`b©adv_sum_couÁ”
(
b©_´iv
, 
BATADV_CNT_RX_BYTES
);

103  
¡©s
;

104 
	}
}

106 
	$b©adv_š‹rçû_£t_mac_addr
(
Ãt_deviû
 *
dev
, *
p
)

108 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
dev
);

109 
sockaddr
 *
addr
 = 
p
;

110 
ušt8_t
 
Şd_addr
[
ETH_ALEN
];

112 ià(!
	`is_v®id_‘h”_addr
(
addr
->
§_d©a
))

113  -
EADDRNOTAVAIL
;

115 
	`memıy
(
Şd_addr
, 
dev
->
dev_addr
, 
ETH_ALEN
);

116 
	`memıy
(
dev
->
dev_addr
, 
addr
->
§_d©a
, 
ETH_ALEN
);

119 ià(
	`©omic_»ad
(&
b©_´iv
->
mesh_¡©e
è=ğ
BATADV_MESH_ACTIVE
) {

120 
	`b©adv_‰_loÿl_»move
(
b©_´iv
, 
Şd_addr
,

121 "maøadd»s chªged", 
çl£
);

122 
	`b©adv_‰_loÿl_add
(
dev
, 
addr
->
§_d©a
, 
BATADV_NULL_IFINDEX
);

125 
dev
->
addr_assign_ty³
 &ğ~
NET_ADDR_RANDOM
;

127 
	}
}

129 
	$b©adv_š‹rçû_chªge_mtu
(
Ãt_deviû
 *
dev
, 
Ãw_mtu
)

132 ià((
Ãw_mtu
 < 68è|| (Ãw_mtu > 
	`b©adv_h¬dif_mš_mtu
(
dev
)))

133  -
EINVAL
;

135 
dev
->
mtu
 = 
Ãw_mtu
;

138 
	}
}

140 
	$b©adv_š‹rçû_tx
(
sk_buff
 *
skb
,

141 
Ãt_deviû
 *
soá_içû
)

143 
‘hhdr
 *‘hhd¸ğ(‘hhd¸*)
skb
->
d©a
;

144 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
soá_içû
);

145 
b©adv_h¬d_içû
 *
´im¬y_if
 = 
NULL
;

146 
b©adv_bÿ¡_·ck‘
 *
bÿ¡_·ck‘
;

147 
vÏn_‘hhdr
 *
vhdr
;

148 
__be16
 
‘h”ty³
 = 
	`__cÚ¡ªt_htÚs
(
BATADV_ETH_P_BATMAN
);

149 cÚ¡ 
ušt8_t
 
¡p_addr
[
ETH_ALEN
] = {0x01, 0x80, 0xC2, 0x00, 0x00,

151 
h—d”_Ën
 = 0;

152 
d©a_Ën
 = 
skb
->
Ën
, 
»t
;

153 
vid
 
__maybe_unu£d
 = -1;

154 
boŞ
 
do_bÿ¡
 = 
çl£
;

155 
ušt32_t
 
£qno
;

157 ià(
	`©omic_»ad
(&
b©_´iv
->
mesh_¡©e
è!ğ
BATADV_MESH_ACTIVE
)

158 
drİ³d
;

160 
soá_içû
->
Œªs_¡¬t
 = 
jiff›s
;

162 
	`Áohs
(
‘hhdr
->
h_´Ùo
)) {

163 
ETH_P_8021Q
:

164 
vhdr
 = (
vÏn_‘hhdr
 *)
skb
->
d©a
;

165 
vid
 = 
	`Áohs
(
vhdr
->
h_vÏn_TCI
è& 
VLAN_VID_MASK
;

167 ià(
vhdr
->
h_vÏn_’ÿpsuÏ‹d_´Ùo
 !ğ
‘h”ty³
)

171 
BATADV_ETH_P_BATMAN
:

172 
drİ³d
;

175 ià(
	`b©adv_bÏ_tx
(
b©_´iv
, 
skb
, 
vid
))

176 
drİ³d
;

179 
	`b©adv_‰_loÿl_add
(
soá_içû
, 
‘hhdr
->
h_sourû
, 
skb
->
skb_iif
);

184 ià(
	`b©adv_com·»_‘h
(
‘hhdr
->
h_de¡
, 
¡p_addr
))

185 
drİ³d
;

187 ià(
	`is_muÉiÿ¡_‘h”_addr
(
‘hhdr
->
h_de¡
)) {

188 
do_bÿ¡
 = 
Œue
;

190 
	`©omic_»ad
(&
b©_´iv
->
gw_mode
)) {

191 
BATADV_GW_MODE_SERVER
:

195 
»t
 = 
	`b©adv_gw_is_dhı_rg‘
(
skb
, &
h—d”_Ën
);

196 ià(
»t
)

197 
drİ³d
;

199 
BATADV_GW_MODE_CLIENT
:

203 
»t
 = 
	`b©adv_gw_is_dhı_rg‘
(
skb
, &
h—d”_Ën
);

204 ià(
»t
)

205 
do_bÿ¡
 = 
çl£
;

207 
BATADV_GW_MODE_OFF
:

214 ià(
do_bÿ¡
) {

215 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

216 ià(!
´im¬y_if
)

217 
drİ³d
;

219 ià(
	`b©adv_skb_h—d_push
(
skb
, (*
bÿ¡_·ck‘
)) < 0)

220 
drİ³d
;

222 
bÿ¡_·ck‘
 = (
b©adv_bÿ¡_·ck‘
 *)
skb
->
d©a
;

223 
bÿ¡_·ck‘
->
h—d”
.
v”siÚ
 = 
BATADV_COMPAT_VERSION
;

224 
bÿ¡_·ck‘
->
h—d”
.
‰l
 = 
BATADV_TTL
;

227 
bÿ¡_·ck‘
->
h—d”
.
·ck‘_ty³
 = 
BATADV_BCAST
;

228 
bÿ¡_·ck‘
->
»£rved
 = 0;

233 
	`memıy
(
bÿ¡_·ck‘
->
Üig
,

234 
´im¬y_if
->
Ãt_dev
->
dev_addr
, 
ETH_ALEN
);

237 
£qno
 = 
	`©omic_šc_»tuº
(&
b©_´iv
->
bÿ¡_£qno
);

238 
bÿ¡_·ck‘
->
£qno
 = 
	`htÚl
(seqno);

240 
	`b©adv_add_bÿ¡_·ck‘_to_li¡
(
b©_´iv
, 
skb
, 1);

245 
	`kä“_skb
(
skb
);

249 ià(
	`©omic_»ad
(&
b©_´iv
->
gw_mode
è!ğ
BATADV_GW_MODE_OFF
) {

250 
»t
 = 
	`b©adv_gw_out_of_¿nge
(
b©_´iv
, 
skb
, 
‘hhdr
);

251 ià(
»t
)

252 
drİ³d
;

255 
»t
 = 
	`b©adv_uniÿ¡_£nd_skb
(
skb
, 
b©_´iv
);

256 ià(
»t
 != 0)

257 
drİ³d_ä“d
;

260 
	`b©adv_šc_couÁ”
(
b©_´iv
, 
BATADV_CNT_TX
);

261 
	`b©adv_add_couÁ”
(
b©_´iv
, 
BATADV_CNT_TX_BYTES
, 
d©a_Ën
);

262 
’d
;

264 
drİ³d
:

265 
	`kä“_skb
(
skb
);

266 
drİ³d_ä“d
:

267 
	`b©adv_šc_couÁ”
(
b©_´iv
, 
BATADV_CNT_TX_DROPPED
);

268 
’d
:

269 ià(
´im¬y_if
)

270 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

271  
NETDEV_TX_OK
;

272 
	}
}

274 
	$b©adv_š‹rçû_rx
(
Ãt_deviû
 *
soá_içû
,

275 
sk_buff
 *
skb
, 
b©adv_h¬d_içû
 *
»cv_if
,

276 
hdr_size
, 
b©adv_Üig_node
 *
Üig_node
)

278 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
soá_içû
);

279 
‘hhdr
 *ethhdr;

280 
vÏn_‘hhdr
 *
vhdr
;

281 
b©adv_h—d”
 *b©adv_h—d” = (b©adv_h—d” *)
skb
->
d©a
;

282 
vid
 
__maybe_unu£d
 = -1;

283 
__be16
 
‘h”ty³
 = 
	`__cÚ¡ªt_htÚs
(
BATADV_ETH_P_BATMAN
);

284 
boŞ
 
is_bÿ¡
;

286 
is_bÿ¡
 = (
b©adv_h—d”
->
·ck‘_ty³
 =ğ
BATADV_BCAST
);

289 ià(!
	`pskb_may_puÎ
(
skb
, 
hdr_size
))

290 
drİ³d
;

292 
	`skb_puÎ_rcsum
(
skb
, 
hdr_size
);

293 
	`skb_»£t_mac_h—d”
(
skb
);

295 
‘hhdr
 = (‘hhd¸*)
	`skb_mac_h—d”
(
skb
);

297 
	`Áohs
(
‘hhdr
->
h_´Ùo
)) {

298 
ETH_P_8021Q
:

299 
vhdr
 = (
vÏn_‘hhdr
 *)
skb
->
d©a
;

300 
vid
 = 
	`Áohs
(
vhdr
->
h_vÏn_TCI
è& 
VLAN_VID_MASK
;

302 ià(
vhdr
->
h_vÏn_’ÿpsuÏ‹d_´Ùo
 !ğ
‘h”ty³
)

306 
BATADV_ETH_P_BATMAN
:

307 
drİ³d
;

311 ià(
	`uÆik–y
(!
	`pskb_may_puÎ
(
skb
, 
ETH_HLEN
)))

312 
drİ³d
;

313 
skb
->
´ÙocŞ
 = 
	`‘h_ty³_Œªs
(skb, 
soá_içû
);

322 
	`b©adv_šc_couÁ”
(
b©_´iv
, 
BATADV_CNT_RX
);

323 
	`b©adv_add_couÁ”
(
b©_´iv
, 
BATADV_CNT_RX_BYTES
,

324 
skb
->
Ën
 + 
ETH_HLEN
);

326 
soá_içû
->
Ï¡_rx
 = 
jiff›s
;

328 ià(
Üig_node
)

329 
	`b©adv_‰_add_‹mpÜ¬y_glob®_’Œy
(
b©_´iv
, 
Üig_node
,

330 
‘hhdr
->
h_sourû
);

332 ià(
	`b©adv_is_­_isŞ©ed
(
b©_´iv
, 
‘hhdr
->
h_sourû
,ƒthhdr->
h_de¡
))

333 
drİ³d
;

338 ià(
	`b©adv_bÏ_rx
(
b©_´iv
, 
skb
, 
vid
, 
is_bÿ¡
))

339 
out
;

341 
	`Ãtif_rx
(
skb
);

342 
out
;

344 
drİ³d
:

345 
	`kä“_skb
(
skb
);

346 
out
:

348 
	}
}

350 cÚ¡ 
Ãt_deviû_İs
 
	gb©adv_Ãtdev_İs
 = {

351 .
ndo_İ’
 = 
b©adv_š‹rçû_İ’
,

352 .
	gndo_¡İ
 = 
b©adv_š‹rçû_»Ëa£
,

353 .
	gndo_g‘_¡©s
 = 
b©adv_š‹rçû_¡©s
,

354 .
	gndo_£t_mac_add»ss
 = 
b©adv_š‹rçû_£t_mac_addr
,

355 .
	gndo_chªge_mtu
 = 
b©adv_š‹rçû_chªge_mtu
,

356 .
	gndo_¡¬t_xm™
 = 
b©adv_š‹rçû_tx
,

357 .
	gndo_v®id©e_addr
 = 
‘h_v®id©e_addr


360 
	$b©adv_š‹rçû_£tup
(
Ãt_deviû
 *
dev
)

362 
b©adv_´iv
 *
´iv
 = 
	`Ãtdev_´iv
(
dev
);

364 
	`‘h”_£tup
(
dev
);

366 
dev
->
Ãtdev_İs
 = &
b©adv_Ãtdev_İs
;

367 
dev
->
de¡ruùÜ
 = 
ä“_Ãtdev
;

368 
dev
->
tx_queue_Ën
 = 0;

373 
dev
->
mtu
 = 
ETH_DATA_LEN
;

375 
dev
->
h¬d_h—d”_Ën
 = 
BATADV_HEADER_LEN
;

378 
	`‘h_hw_addr_¿ndom
(
dev
);

380 
	`SET_ETHTOOL_OPS
(
dev
, &
b©adv_‘htoŞ_İs
);

382 
	`mem£t
(
´iv
, 0, (*priv));

383 
	}
}

385 
Ãt_deviû
 *
	$b©adv_soáif_ü—‹
(cÚ¡ *
Çme
)

387 
Ãt_deviû
 *
soá_içû
;

388 
b©adv_´iv
 *
b©_´iv
;

389 
»t
;

390 
size_t
 
út_Ën
 = (
ušt64_t
è* 
BATADV_CNT_NUM
;

392 
soá_içû
 = 
	`®loc_Ãtdev
((*
b©_´iv
), 
Çme
,

393 
b©adv_š‹rçû_£tup
);

395 ià(!
soá_içû
)

396 
out
;

398 
b©_´iv
 = 
	`Ãtdev_´iv
(
soá_içû
);

403 
b©_´iv
->
b©_couÁ”s
 = 
	`__®loc_³rıu
(
út_Ën
, 
	`__®ignof__
(
ušt64_t
));

404 ià(!
b©_´iv
->
b©_couÁ”s
)

405 
ä“_soá_içû
;

407 
»t
 = 
	`»gi¡”_Ãtdeviû
(
soá_içû
);

408 ià(
»t
 < 0) {

409 
	`´_”r
("Unableo„egisterhe batman interface '%s': %i\n",

410 
Çme
, 
»t
);

411 
ä“_b©_couÁ”s
;

414 
	`©omic_£t
(&
b©_´iv
->
agg»g©ed_ogms
, 1);

415 
	`©omic_£t
(&
b©_´iv
->
bÚdšg
, 0);

416 
	`©omic_£t
(&
b©_´iv
->
bridge_loİ_avoidªû
, 0);

417 
	`©omic_£t
(&
b©_´iv
->
­_isŞ©iÚ
, 0);

418 
	`©omic_£t
(&
b©_´iv
->
vis_mode
, 
BATADV_VIS_TYPE_CLIENT_UPDATE
);

419 
	`©omic_£t
(&
b©_´iv
->
gw_mode
, 
BATADV_GW_MODE_OFF
);

420 
	`©omic_£t
(&
b©_´iv
->
gw_£l_şass
, 20);

421 
	`©omic_£t
(&
b©_´iv
->
gw_bªdwidth
, 41);

422 
	`©omic_£t
(&
b©_´iv
->
Üig_š‹rv®
, 1000);

423 
	`©omic_£t
(&
b©_´iv
->
hİ_³ÇÉy
, 30);

424 
	`©omic_£t
(&
b©_´iv
->
log_Ëv–
, 0);

425 
	`©omic_£t
(&
b©_´iv
->
äagm’tiÚ
, 1);

426 
	`©omic_£t
(&
b©_´iv
->
bÿ¡_queue_Ëá
, 
BATADV_BCAST_QUEUE_LEN
);

427 
	`©omic_£t
(&
b©_´iv
->
b©mª_queue_Ëá
, 
BATADV_BATMAN_QUEUE_LEN
);

429 
	`©omic_£t
(&
b©_´iv
->
mesh_¡©e
, 
BATADV_MESH_INACTIVE
);

430 
	`©omic_£t
(&
b©_´iv
->
bÿ¡_£qno
, 1);

431 
	`©omic_£t
(&
b©_´iv
->
‰
.
vn
, 0);

432 
	`©omic_£t
(&
b©_´iv
->
‰
.
loÿl_chªges
, 0);

433 
	`©omic_£t
(&
b©_´iv
->
‰
.
ogm_­³nd_út
, 0);

434 #ifdeà
CONFIG_BATMAN_ADV_BLA


435 
	`©omic_£t
(&
b©_´iv
->
bÏ
.
num_»que¡s
, 0);

437 
b©_´iv
->
‰
.
Ï¡_chªge£t
 = 
NULL
;

438 
b©_´iv
->
‰
.
Ï¡_chªge£t_Ën
 = 0;

439 
b©_´iv
->
‰
.
poss_chªge
 = 
çl£
;

441 
b©_´iv
->
´im¬y_if
 = 
NULL
;

442 
b©_´iv
->
num_içûs
 = 0;

444 
»t
 = 
	`b©adv_®go_£Ëù
(
b©_´iv
, 
b©adv_routšg_®go
);

445 ià(
»t
 < 0)

446 
uÄeg_soá_içû
;

448 
»t
 = 
	`b©adv_sysfs_add_meshif
(
soá_içû
);

449 ià(
»t
 < 0)

450 
uÄeg_soá_içû
;

452 
»t
 = 
	`b©adv_debugfs_add_meshif
(
soá_içû
);

453 ià(
»t
 < 0)

454 
uÄeg_sysfs
;

456 
»t
 = 
	`b©adv_mesh_š™
(
soá_içû
);

457 ià(
»t
 < 0)

458 
uÄeg_debugfs
;

460  
soá_içû
;

462 
uÄeg_debugfs
:

463 
	`b©adv_debugfs_d–_meshif
(
soá_içû
);

464 
uÄeg_sysfs
:

465 
	`b©adv_sysfs_d–_meshif
(
soá_içû
);

466 
uÄeg_soá_içû
:

467 
	`ä“_³rıu
(
b©_´iv
->
b©_couÁ”s
);

468 
	`uÄegi¡”_Ãtdeviû
(
soá_içû
);

469  
NULL
;

471 
ä“_b©_couÁ”s
:

472 
	`ä“_³rıu
(
b©_´iv
->
b©_couÁ”s
);

473 
ä“_soá_içû
:

474 
	`ä“_Ãtdev
(
soá_içû
);

475 
out
:

476  
NULL
;

477 
	}
}

479 
	$b©adv_soáif_de¡roy
(
Ãt_deviû
 *
soá_içû
)

481 
	`b©adv_debugfs_d–_meshif
(
soá_içû
);

482 
	`b©adv_sysfs_d–_meshif
(
soá_içû
);

483 
	`b©adv_mesh_ä“
(
soá_içû
);

484 
	`uÄegi¡”_Ãtdeviû
(
soá_içû
);

485 
	}
}

487 
	$b©adv_soáif_is_v®id
(cÚ¡ 
Ãt_deviû
 *
Ãt_dev
)

489 ià(
Ãt_dev
->
Ãtdev_İs
->
ndo_¡¬t_xm™
 =ğ
b©adv_š‹rçû_tx
)

493 
	}
}

496 
	$b©adv_g‘_£‰šgs
(
Ãt_deviû
 *
dev
, 
‘htoŞ_cmd
 *
cmd
)

498 
cmd
->
suµÜ‹d
 = 0;

499 
cmd
->
adv”tisšg
 = 0;

500 
	`‘htoŞ_cmd_¥“d_£t
(
cmd
, 
SPEED_10
);

501 
cmd
->
du¶ex
 = 
DUPLEX_FULL
;

502 
cmd
->
pÜt
 = 
PORT_TP
;

503 
cmd
->
phy_add»ss
 = 0;

504 
cmd
->
Œªsûiv”
 = 
XCVR_INTERNAL
;

505 
cmd
->
autÚeg
 = 
AUTONEG_DISABLE
;

506 
cmd
->
maxtxpkt
 = 0;

507 
cmd
->
maxrxpkt
 = 0;

510 
	}
}

512 
	$b©adv_g‘_drvšfo
(
Ãt_deviû
 *
dev
,

513 
‘htoŞ_drvšfo
 *
šfo
)

515 
	`¡rıy
(
šfo
->
driv”
, "B.A.T.M.A.N.‡dvanced");

516 
	`¡rıy
(
šfo
->
v”siÚ
, 
BATADV_SOURCE_VERSION
);

517 
	`¡rıy
(
šfo
->
fw_v”siÚ
, "N/A");

518 
	`¡rıy
(
šfo
->
bus_šfo
, "batman");

519 
	}
}

521 
u32
 
	$b©adv_g‘_msgËv–
(
Ãt_deviû
 *
dev
)

523  -
EOPNOTSUPP
;

524 
	}
}

526 
	$b©adv_£t_msgËv–
(
Ãt_deviû
 *
dev
, 
u32
 
v®ue
)

528 
	}
}

530 
u32
 
	$b©adv_g‘_lšk
(
Ãt_deviû
 *
dev
)

533 
	}
}

540 cÚ¡ 
	mÇme
[
ETH_GSTRING_LEN
];

541 } 
	gb©adv_couÁ”s_¡ršgs
[] = {

561 
	$b©adv_g‘_¡ršgs
(
Ãt_deviû
 *
dev
, 
ušt32_t
 
¡ršg£t
,

562 
ušt8_t
 *
d©a
)

564 ià(
¡ršg£t
 =ğ
ETH_SS_STATS
)

565 
	`memıy
(
d©a
, 
b©adv_couÁ”s_¡ršgs
,

566 (
b©adv_couÁ”s_¡ršgs
));

567 
	}
}

569 
	$b©adv_g‘_‘htoŞ_¡©s
(
Ãt_deviû
 *
dev
,

570 
‘htoŞ_¡©s
 *
¡©s
,

571 
ušt64_t
 *
d©a
)

573 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
dev
);

574 
i
;

576 
i
 = 0; i < 
BATADV_CNT_NUM
; i++)

577 
d©a
[
i
] = 
	`b©adv_sum_couÁ”
(
b©_´iv
, i);

578 
	}
}

580 
	$b©adv_g‘_s£t_couÁ
(
Ãt_deviû
 *
dev
, 
¡ršg£t
)

582 ià(
¡ršg£t
 =ğ
ETH_SS_STATS
)

583  
BATADV_CNT_NUM
;

585  -
EOPNOTSUPP
;

586 
	}
}

	@soft-interface.h

20 #iâdeà
_NET_BATMAN_ADV_SOFT_INTERFACE_H_


21 
	#_NET_BATMAN_ADV_SOFT_INTERFACE_H_


	)

23 
b©adv_skb_h—d_push
(
sk_buff
 *
skb
, 
Ën
);

24 
b©adv_š‹rçû_rx
(
Ãt_deviû
 *
soá_içû
,

25 
sk_buff
 *
skb
, 
b©adv_h¬d_içû
 *
»cv_if
,

26 
hdr_size
, 
b©adv_Üig_node
 *
Üig_node
);

27 
Ãt_deviû
 *
b©adv_soáif_ü—‹
(cÚ¡ *
Çme
);

28 
b©adv_soáif_de¡roy
(
Ãt_deviû
 *
soá_içû
);

29 
b©adv_soáif_is_v®id
(cÚ¡ 
Ãt_deviû
 *
Ãt_dev
);

	@sysfs.c

20 
	~"maš.h
"

21 
	~"sysfs.h
"

22 
	~"Œª¦©iÚ-bË.h
"

23 
	~"Üigš©Ü.h
"

24 
	~"h¬d-š‹rçû.h
"

25 
	~"g©eway_commÚ.h
"

26 
	~"g©eway_ş›Á.h
"

27 
	~"vis.h
"

29 
Ãt_deviû
 *
	$b©adv_kobj_to_Ãtdev
(
kobjeù
 *
obj
)

31 
deviû
 *
dev
 = 
	`cÚš”_of
(
obj
->
·»Á
, deviû, 
kobj
);

32  
	`to_Ãt_dev
(
dev
);

33 
	}
}

35 
b©adv_´iv
 *
	$b©adv_kobj_to_b©´iv
(
kobjeù
 *
obj
)

37 
Ãt_deviû
 *
Ãt_dev
 = 
	`b©adv_kobj_to_Ãtdev
(
obj
);

38  
	`Ãtdev_´iv
(
Ãt_dev
);

39 
	}
}

41 
	#BATADV_UEV_TYPE_VAR
 "BATTYPE="

	)

42 
	#BATADV_UEV_ACTION_VAR
 "BATACTION="

	)

43 
	#BATADV_UEV_DATA_VAR
 "BATDATA="

	)

45 *
	gb©adv_uev_aùiÚ_¡r
[] = {

51 *
	gb©adv_uev_ty³_¡r
[] = {

56 
	#BATADV_ATTR
(
_Çme
, 
_mode
, 
_show
, 
_¡Üe
) \

57 
b©adv_©Œibu‹
 
b©adv_©Œ_
##
_Çme
 = { \

58 .
©Œ
 = {.
Çme
 = 
	`__¡ršgify
(
_Çme
), \

59 .
mode
 = 
_mode
 }, \

60 .
show
 = 
_show
, \

61 .
¡Üe
 = 
_¡Üe
, \

62 };

	)

64 
	#BATADV_ATTR_SIF_STORE_BOOL
(
_Çme
, 
_po¡_func
) \

65 
ssize_t
 
b©adv_¡Üe_
##
	`_Çme
(
kobjeù
 *
kobj
, \

66 
©Œibu‹
 *
©Œ
, *
buff
, \

67 
size_t
 
couÁ
) \

69 
Ãt_deviû
 *
Ãt_dev
 = 
	`b©adv_kobj_to_Ãtdev
(
kobj
); \

70 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
Ãt_dev
); \

71  
	`__b©adv_¡Üe_boŞ_©Œ
(
buff
, 
couÁ
, 
_po¡_func
, 
©Œ
, \

72 &
b©_´iv
->
_Çme
, 
Ãt_dev
); \

73 }

	)

75 
	#BATADV_ATTR_SIF_SHOW_BOOL
(
_Çme
) \

76 
ssize_t
 
b©adv_show_
##
	`_Çme
(
kobjeù
 *
kobj
, \

77 
©Œibu‹
 *
©Œ
, *
buff
) \

79 
b©adv_´iv
 *
b©_´iv
 = 
	`b©adv_kobj_to_b©´iv
(
kobj
); \

80  
	`¥rštf
(
buff
, "%s\n", \

81 
	`©omic_»ad
(&
b©_´iv
->
_Çme
) == 0 ? \

84 

	)

88 
	#BATADV_ATTR_SIF_BOOL
(
_Çme
, 
_mode
, 
_po¡_func
) \

89 
	`BATADV_ATTR_SIF_STORE_BOOL
(
_Çme
, 
_po¡_func
) \

90 
	`BATADV_ATTR_SIF_SHOW_BOOL
(
_Çme
) \

91 
	`BATADV_ATTR
(
_Çme
, 
_mode
, 
b©adv_show_
##_name, \

92 
b©adv_¡Üe_
##
_Çme
)

	)

95 
	#BATADV_ATTR_SIF_STORE_UINT
(
_Çme
, 
_mš
, 
_max
, 
_po¡_func
) \

96 
ssize_t
 
b©adv_¡Üe_
##
	`_Çme
(
kobjeù
 *
kobj
, \

97 
©Œibu‹
 *
©Œ
, *
buff
, \

98 
size_t
 
couÁ
) \

100 
Ãt_deviû
 *
Ãt_dev
 = 
	`b©adv_kobj_to_Ãtdev
(
kobj
); \

101 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
Ãt_dev
); \

102  
	`__b©adv_¡Üe_ušt_©Œ
(
buff
, 
couÁ
, 
_mš
, 
_max
, \

103 
_po¡_func
, 
©Œ
, \

104 &
b©_´iv
->
_Çme
, 
Ãt_dev
); \

105 }

	)

107 
	#BATADV_ATTR_SIF_SHOW_UINT
(
_Çme
) \

108 
ssize_t
 
b©adv_show_
##
	`_Çme
(
kobjeù
 *
kobj
, \

109 
©Œibu‹
 *
©Œ
, *
buff
) \

111 
b©adv_´iv
 *
b©_´iv
 = 
	`b©adv_kobj_to_b©´iv
(
kobj
); \

112  
	`¥rštf
(
buff
, "%i\n", 
	`©omic_»ad
(&
b©_´iv
->
_Çme
)); \

114 

	)

118 
	#BATADV_ATTR_SIF_UINT
(
_Çme
, 
_mode
, 
_mš
, 
_max
, 
_po¡_func
) \

119 
	`BATADV_ATTR_SIF_STORE_UINT
(
_Çme
, 
_mš
, 
_max
, 
_po¡_func
)\

120 
	`BATADV_ATTR_SIF_SHOW_UINT
(
_Çme
) \

121 
	`BATADV_ATTR
(
_Çme
, 
_mode
, 
b©adv_show_
##_name, \

122 
b©adv_¡Üe_
##
_Çme
)

	)

125 
	#BATADV_ATTR_HIF_STORE_UINT
(
_Çme
, 
_mš
, 
_max
, 
_po¡_func
) \

126 
ssize_t
 
b©adv_¡Üe_
##
	`_Çme
(
kobjeù
 *
kobj
, \

127 
©Œibu‹
 *
©Œ
, *
buff
, \

128 
size_t
 
couÁ
) \

130 
Ãt_deviû
 *
Ãt_dev
 = 
	`b©adv_kobj_to_Ãtdev
(
kobj
); \

131 
b©adv_h¬d_içû
 *
h¬d_içû
; \

132 
ssize_t
 
Ëngth
; \

134 
h¬d_içû
 = 
	`b©adv_h¬dif_g‘_by_Ãtdev
(
Ãt_dev
); \

135 ià(!
h¬d_içû
) \

138 
Ëngth
 = 
	`__b©adv_¡Üe_ušt_©Œ
(
buff
, 
couÁ
, 
_mš
, 
_max
, \

139 
_po¡_func
, 
©Œ
, \

140 &
h¬d_içû
->
_Çme
, 
Ãt_dev
); \

142 
	`b©adv_h¬dif_ä“_»f
(
h¬d_içû
); \

143  
Ëngth
; \

144 }

	)

146 
	#BATADV_ATTR_HIF_SHOW_UINT
(
_Çme
) \

147 
ssize_t
 
b©adv_show_
##
	`_Çme
(
kobjeù
 *
kobj
, \

148 
©Œibu‹
 *
©Œ
, *
buff
) \

150 
Ãt_deviû
 *
Ãt_dev
 = 
	`b©adv_kobj_to_Ãtdev
(
kobj
); \

151 
b©adv_h¬d_içû
 *
h¬d_içû
; \

152 
ssize_t
 
Ëngth
; \

154 
h¬d_içû
 = 
	`b©adv_h¬dif_g‘_by_Ãtdev
(
Ãt_dev
); \

155 ià(!
h¬d_içû
) \

158 
Ëngth
 = 
	`¥rštf
(
buff
, "%i\n", 
	`©omic_»ad
(&
h¬d_içû
->
_Çme
));\

160 
	`b©adv_h¬dif_ä“_»f
(
h¬d_içû
); \

161  
Ëngth
; \

162 }

	)

167 
	#BATADV_ATTR_HIF_UINT
(
_Çme
, 
_mode
, 
_mš
, 
_max
, 
_po¡_func
) \

168 
	`BATADV_ATTR_HIF_STORE_UINT
(
_Çme
, 
_mš
, 
_max
, 
_po¡_func
)\

169 
	`BATADV_ATTR_HIF_SHOW_UINT
(
_Çme
) \

170 
	`BATADV_ATTR
(
_Çme
, 
_mode
, 
b©adv_show_
##_name, \

171 
b©adv_¡Üe_
##
_Çme
)

	)

174 
	$b©adv_¡Üe_boŞ_©Œ
(*
buff
, 
size_t
 
couÁ
,

175 
Ãt_deviû
 *
Ãt_dev
,

176 cÚ¡ *
©Œ_Çme
, 
©omic_t
 *
©Œ
)

178 
’abËd
 = -1;

180 ià(
buff
[
couÁ
 - 1] == '\n')

181 
buff
[
couÁ
 - 1] = '\0';

183 ià((
	`¡ºcmp
(
buff
, "1", 2) == 0) ||

184 (
	`¡ºcmp
(
buff
, "enable", 7) == 0) ||

185 (
	`¡ºcmp
(
buff
, "enabled", 8) == 0))

186 
’abËd
 = 1;

188 ià((
	`¡ºcmp
(
buff
, "0", 2) == 0) ||

189 (
	`¡ºcmp
(
buff
, "disable", 8) == 0) ||

190 (
	`¡ºcmp
(
buff
, "disabled", 9) == 0))

191 
’abËd
 = 0;

193 ià(
’abËd
 < 0) {

194 
	`b©adv_šfo
(
Ãt_dev
, "%s: Invalid…arameter„eceived: %s\n",

195 
©Œ_Çme
, 
buff
);

196  -
EINVAL
;

199 ià(
	`©omic_»ad
(
©Œ
è=ğ
’abËd
)

200  
couÁ
;

202 
	`b©adv_šfo
(
Ãt_dev
, "%s: Chªgšg from: % to: %s\n", 
©Œ_Çme
,

203 
	`©omic_»ad
(
©Œ
) == 1 ? "enabled" : "disabled",

204 
’abËd
 == 1 ? "enabled" : "disabled");

206 
	`©omic_£t
(
©Œ
, ()
’abËd
);

207  
couÁ
;

208 
	}
}

210 
šlše
 
ssize_t


211 
__b©adv_¡Üe_boŞ_©Œ
(*
buff
, 
size_t
 
couÁ
,

212 (*
po¡_func
)(
Ãt_deviû
 *),

213 
©Œibu‹
 *
©Œ
,

214 
©omic_t
 *
©Œ_¡Üe
, 
Ãt_deviû
 *
Ãt_dev
)

216 
»t
;

218 
»t
 = 
	`b©adv_¡Üe_boŞ_©Œ
(
buff
, 
couÁ
, 
Ãt_dev
, 
©Œ
->
Çme
,

219 
©Œ_¡Üe
);

220 ià(
po¡_func
 && 
»t
)

221 
	`po¡_func
(
Ãt_dev
);

223  
»t
;

224 
	}
}

226 
	$b©adv_¡Üe_ušt_©Œ
(cÚ¡ *
buff
, 
size_t
 
couÁ
,

227 
Ãt_deviû
 *
Ãt_dev
,

228 cÚ¡ *
©Œ_Çme
,

229 
mš
, 
max
,

230 
©omic_t
 *
©Œ
)

232 
ušt_v®
;

233 
»t
;

235 
»t
 = 
	`k¡¹oul
(
buff
, 10, &
ušt_v®
);

236 ià(
»t
) {

237 
	`b©adv_šfo
(
Ãt_dev
, "%s: Invalid…arameter„eceived: %s\n",

238 
©Œ_Çme
, 
buff
);

239  -
EINVAL
;

242 ià(
ušt_v®
 < 
mš
) {

243 
	`b©adv_šfo
(
Ãt_dev
, "%s: Value isoo small: %lu min: %u\n",

244 
©Œ_Çme
, 
ušt_v®
, 
mš
);

245  -
EINVAL
;

248 ià(
ušt_v®
 > 
max
) {

249 
	`b©adv_šfo
(
Ãt_dev
, "%s: Value isoo big: %lu max: %u\n",

250 
©Œ_Çme
, 
ušt_v®
, 
max
);

251  -
EINVAL
;

254 ià(
	`©omic_»ad
(
©Œ
è=ğ
ušt_v®
)

255  
couÁ
;

257 
	`b©adv_šfo
(
Ãt_dev
, "%s: Changing from: %io: %lu\n",

258 
©Œ_Çme
, 
	`©omic_»ad
(
©Œ
), 
ušt_v®
);

260 
	`©omic_£t
(
©Œ
, 
ušt_v®
);

261  
couÁ
;

262 
	}
}

264 
šlše
 
ssize_t


265 
__b©adv_¡Üe_ušt_©Œ
(cÚ¡ *
buff
, 
size_t
 
couÁ
,

266 
mš
, 
max
,

267 (*
po¡_func
)(
Ãt_deviû
 *),

268 cÚ¡ 
©Œibu‹
 *
©Œ
,

269 
©omic_t
 *
©Œ_¡Üe
, 
Ãt_deviû
 *
Ãt_dev
)

271 
»t
;

273 
»t
 = 
	`b©adv_¡Üe_ušt_©Œ
(
buff
, 
couÁ
, 
Ãt_dev
, 
©Œ
->
Çme
, 
mš
, 
max
,

274 
©Œ_¡Üe
);

275 ià(
po¡_func
 && 
»t
)

276 
	`po¡_func
(
Ãt_dev
);

278  
»t
;

279 
	}
}

281 
ssize_t
 
	$b©adv_show_vis_mode
(
kobjeù
 *
kobj
,

282 
©Œibu‹
 *
©Œ
, *
buff
)

284 
b©adv_´iv
 *
b©_´iv
 = 
	`b©adv_kobj_to_b©´iv
(
kobj
);

285 
vis_mode
 = 
	`©omic_»ad
(&
b©_´iv
->vis_mode);

286 cÚ¡ *
mode
;

288 ià(
vis_mode
 =ğ
BATADV_VIS_TYPE_CLIENT_UPDATE
)

289 
mode
 = "client";

291 
mode
 = "server";

293  
	`¥rštf
(
buff
, "%s\n", 
mode
);

294 
	}
}

296 
ssize_t
 
	$b©adv_¡Üe_vis_mode
(
kobjeù
 *
kobj
,

297 
©Œibu‹
 *
©Œ
, *
buff
,

298 
size_t
 
couÁ
)

300 
Ãt_deviû
 *
Ãt_dev
 = 
	`b©adv_kobj_to_Ãtdev
(
kobj
);

301 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
Ãt_dev
);

302 
v®
;

303 
»t
, 
vis_mode_tmp
 = -1;

304 cÚ¡ *
Şd_mode
, *
Ãw_mode
;

306 
»t
 = 
	`k¡¹oul
(
buff
, 10, &
v®
);

308 ià(((
couÁ
 =ğ2è&& (!
»t
) &&

309 (
v®
 =ğ
BATADV_VIS_TYPE_CLIENT_UPDATE
)) ||

310 (
	`¡ºcmp
(
buff
, "client", 6) == 0) ||

311 (
	`¡ºcmp
(
buff
, "off", 3) == 0))

312 
vis_mode_tmp
 = 
BATADV_VIS_TYPE_CLIENT_UPDATE
;

314 ià(((
couÁ
 =ğ2è&& (!
»t
) &&

315 (
v®
 =ğ
BATADV_VIS_TYPE_SERVER_SYNC
)) ||

316 (
	`¡ºcmp
(
buff
, "server", 6) == 0))

317 
vis_mode_tmp
 = 
BATADV_VIS_TYPE_SERVER_SYNC
;

319 ià(
vis_mode_tmp
 < 0) {

320 ià(
buff
[
couÁ
 - 1] == '\n')

321 
buff
[
couÁ
 - 1] = '\0';

323 
	`b©adv_šfo
(
Ãt_dev
,

325 
buff
);

326  -
EINVAL
;

329 ià(
	`©omic_»ad
(&
b©_´iv
->
vis_mode
è=ğ
vis_mode_tmp
)

330  
couÁ
;

332 ià(
	`©omic_»ad
(&
b©_´iv
->
vis_mode
è=ğ
BATADV_VIS_TYPE_CLIENT_UPDATE
)

333 
Şd_mode
 = "client";

335 
Şd_mode
 = "server";

337 ià(
vis_mode_tmp
 =ğ
BATADV_VIS_TYPE_CLIENT_UPDATE
)

338 
Ãw_mode
 = "client";

340 
Ãw_mode
 = "server";

342 
	`b©adv_šfo
(
Ãt_dev
, "Chªgšg vi modäom: % to: %s\n", 
Şd_mode
,

343 
Ãw_mode
);

345 
	`©omic_£t
(&
b©_´iv
->
vis_mode
, ()
vis_mode_tmp
);

346  
couÁ
;

347 
	}
}

349 
ssize_t
 
	$b©adv_show_b©_®go
(
kobjeù
 *
kobj
,

350 
©Œibu‹
 *
©Œ
, *
buff
)

352 
b©adv_´iv
 *
b©_´iv
 = 
	`b©adv_kobj_to_b©´iv
(
kobj
);

353  
	`¥rštf
(
buff
, "%s\n", 
b©_´iv
->
b©_®go_İs
->
Çme
);

354 
	}
}

356 
	$b©adv_po¡_gw_de£Ëù
(
Ãt_deviû
 *
Ãt_dev
)

358 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
Ãt_dev
);

359 
	`b©adv_gw_de£Ëù
(
b©_´iv
);

360 
	}
}

362 
ssize_t
 
	$b©adv_show_gw_mode
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
,

363 *
buff
)

365 
b©adv_´iv
 *
b©_´iv
 = 
	`b©adv_kobj_to_b©´iv
(
kobj
);

366 
by‹s_wr™‹n
;

368 
	`©omic_»ad
(&
b©_´iv
->
gw_mode
)) {

369 
BATADV_GW_MODE_CLIENT
:

370 
by‹s_wr™‹n
 = 
	`¥rštf
(
buff
, "%s\n",

371 
BATADV_GW_MODE_CLIENT_NAME
);

373 
BATADV_GW_MODE_SERVER
:

374 
by‹s_wr™‹n
 = 
	`¥rštf
(
buff
, "%s\n",

375 
BATADV_GW_MODE_SERVER_NAME
);

378 
by‹s_wr™‹n
 = 
	`¥rštf
(
buff
, "%s\n",

379 
BATADV_GW_MODE_OFF_NAME
);

383  
by‹s_wr™‹n
;

384 
	}
}

386 
ssize_t
 
	$b©adv_¡Üe_gw_mode
(
kobjeù
 *
kobj
,

387 
©Œibu‹
 *
©Œ
, *
buff
,

388 
size_t
 
couÁ
)

390 
Ãt_deviû
 *
Ãt_dev
 = 
	`b©adv_kobj_to_Ãtdev
(
kobj
);

391 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
Ãt_dev
);

392 *
cu¼_gw_mode_¡r
;

393 
gw_mode_tmp
 = -1;

395 ià(
buff
[
couÁ
 - 1] == '\n')

396 
buff
[
couÁ
 - 1] = '\0';

398 ià(
	`¡ºcmp
(
buff
, 
BATADV_GW_MODE_OFF_NAME
,

399 
	`¡¾’
(
BATADV_GW_MODE_OFF_NAME
)) == 0)

400 
gw_mode_tmp
 = 
BATADV_GW_MODE_OFF
;

402 ià(
	`¡ºcmp
(
buff
, 
BATADV_GW_MODE_CLIENT_NAME
,

403 
	`¡¾’
(
BATADV_GW_MODE_CLIENT_NAME
)) == 0)

404 
gw_mode_tmp
 = 
BATADV_GW_MODE_CLIENT
;

406 ià(
	`¡ºcmp
(
buff
, 
BATADV_GW_MODE_SERVER_NAME
,

407 
	`¡¾’
(
BATADV_GW_MODE_SERVER_NAME
)) == 0)

408 
gw_mode_tmp
 = 
BATADV_GW_MODE_SERVER
;

410 ià(
gw_mode_tmp
 < 0) {

411 
	`b©adv_šfo
(
Ãt_dev
,

413 
buff
);

414  -
EINVAL
;

417 ià(
	`©omic_»ad
(&
b©_´iv
->
gw_mode
è=ğ
gw_mode_tmp
)

418  
couÁ
;

420 
	`©omic_»ad
(&
b©_´iv
->
gw_mode
)) {

421 
BATADV_GW_MODE_CLIENT
:

422 
cu¼_gw_mode_¡r
 = 
BATADV_GW_MODE_CLIENT_NAME
;

424 
BATADV_GW_MODE_SERVER
:

425 
cu¼_gw_mode_¡r
 = 
BATADV_GW_MODE_SERVER_NAME
;

428 
cu¼_gw_mode_¡r
 = 
BATADV_GW_MODE_OFF_NAME
;

432 
	`b©adv_šfo
(
Ãt_dev
, "Changing gw mode from: %so: %s\n",

433 
cu¼_gw_mode_¡r
, 
buff
);

435 
	`b©adv_gw_de£Ëù
(
b©_´iv
);

436 
	`©omic_£t
(&
b©_´iv
->
gw_mode
, ()
gw_mode_tmp
);

437  
couÁ
;

438 
	}
}

440 
ssize_t
 
	$b©adv_show_gw_bwidth
(
kobjeù
 *
kobj
,

441 
©Œibu‹
 *
©Œ
, *
buff
)

443 
b©adv_´iv
 *
b©_´iv
 = 
	`b©adv_kobj_to_b©´iv
(
kobj
);

444 
down
, 
up
;

445 
gw_bªdwidth
 = 
	`©omic_»ad
(&
b©_´iv
->gw_bandwidth);

447 
	`b©adv_gw_bªdwidth_to_kb™
(
gw_bªdwidth
, &
down
, &
up
);

448  
	`¥rštf
(
buff
, "%i%s/%i%s\n",

449 (
down
 > 2048 ? down / 1024 : down),

450 (
down
 > 2048 ? "MBit" : "KBit"),

451 (
up
 > 2048 ? up / 1024 : up),

452 (
up
 > 2048 ? "MBit" : "KBit"));

453 
	}
}

455 
ssize_t
 
	$b©adv_¡Üe_gw_bwidth
(
kobjeù
 *
kobj
,

456 
©Œibu‹
 *
©Œ
, *
buff
,

457 
size_t
 
couÁ
)

459 
Ãt_deviû
 *
Ãt_dev
 = 
	`b©adv_kobj_to_Ãtdev
(
kobj
);

461 ià(
buff
[
couÁ
 - 1] == '\n')

462 
buff
[
couÁ
 - 1] = '\0';

464  
	`b©adv_gw_bªdwidth_£t
(
Ãt_dev
, 
buff
, 
couÁ
);

465 
	}
}

467 
BATADV_ATTR_SIF_BOOL
(
agg»g©ed_ogms
, 
S_IRUGO
 | 
S_IWUSR
, 
NULL
);

468 
BATADV_ATTR_SIF_BOOL
(
bÚdšg
, 
S_IRUGO
 | 
S_IWUSR
, 
NULL
);

469 #ifdeà
CONFIG_BATMAN_ADV_BLA


470 
BATADV_ATTR_SIF_BOOL
(
bridge_loİ_avoidªû
, 
S_IRUGO
 | 
S_IWUSR
, 
NULL
);

472 
BATADV_ATTR_SIF_BOOL
(
äagm’tiÚ
, 
S_IRUGO
 | 
S_IWUSR
, 
b©adv_upd©e_mš_mtu
);

473 
BATADV_ATTR_SIF_BOOL
(
­_isŞ©iÚ
, 
S_IRUGO
 | 
S_IWUSR
, 
NULL
);

474 
BATADV_ATTR
(
vis_mode
, 
S_IRUGO
 | 
S_IWUSR
, 
b©adv_show_vis_mode
,

475 
b©adv_¡Üe_vis_mode
);

476 
BATADV_ATTR
(
routšg_®go
, 
S_IRUGO
, 
b©adv_show_b©_®go
, 
NULL
);

477 
BATADV_ATTR
(
gw_mode
, 
S_IRUGO
 | 
S_IWUSR
, 
b©adv_show_gw_mode
,

478 
b©adv_¡Üe_gw_mode
);

479 
BATADV_ATTR_SIF_UINT
(
Üig_š‹rv®
, 
S_IRUGO
 | 
S_IWUSR
, 2 * 
BATADV_JITTER
,

480 
INT_MAX
, 
NULL
);

481 
BATADV_ATTR_SIF_UINT
(
hİ_³ÇÉy
, 
S_IRUGO
 | 
S_IWUSR
, 0, 
BATADV_TQ_MAX_VALUE
,

482 
NULL
);

483 
BATADV_ATTR_SIF_UINT
(
gw_£l_şass
, 
S_IRUGO
 | 
S_IWUSR
, 1, 
BATADV_TQ_MAX_VALUE
,

484 
b©adv_po¡_gw_de£Ëù
);

485 
BATADV_ATTR
(
gw_bªdwidth
, 
S_IRUGO
 | 
S_IWUSR
, 
b©adv_show_gw_bwidth
,

486 
b©adv_¡Üe_gw_bwidth
);

487 #ifdeà
CONFIG_BATMAN_ADV_DEBUG


488 
BATADV_ATTR_SIF_UINT
(
log_Ëv–
, 
S_IRUGO
 | 
S_IWUSR
, 0, 
BATADV_DBG_ALL
, 
NULL
);

491 
b©adv_©Œibu‹
 *
	gb©adv_mesh_©Œs
[] = {

492 &
b©adv_©Œ_agg»g©ed_ogms
,

493 &
b©adv_©Œ_bÚdšg
,

494 #ifdeà
CONFIG_BATMAN_ADV_BLA


495 &
b©adv_©Œ_bridge_loİ_avoidªû
,

497 &
b©adv_©Œ_äagm’tiÚ
,

498 &
b©adv_©Œ_­_isŞ©iÚ
,

499 &
b©adv_©Œ_vis_mode
,

500 &
b©adv_©Œ_routšg_®go
,

501 &
b©adv_©Œ_gw_mode
,

502 &
b©adv_©Œ_Üig_š‹rv®
,

503 &
b©adv_©Œ_hİ_³ÇÉy
,

504 &
b©adv_©Œ_gw_£l_şass
,

505 &
b©adv_©Œ_gw_bªdwidth
,

506 #ifdeà
CONFIG_BATMAN_ADV_DEBUG


507 &
b©adv_©Œ_log_Ëv–
,

509 
NULL
,

512 
	$b©adv_sysfs_add_meshif
(
Ãt_deviû
 *
dev
)

514 
kobjeù
 *
b©if_kobjeù
 = &
dev
->dev.
kobj
;

515 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
dev
);

516 
b©adv_©Œibu‹
 **
b©_©Œ
;

517 
”r
;

519 
b©_´iv
->
mesh_obj
 = 
	`kobjeù_ü—‹_ªd_add
(
BATADV_SYSFS_IF_MESH_SUBDIR
,

520 
b©if_kobjeù
);

521 ià(!
b©_´iv
->
mesh_obj
) {

522 
	`b©adv_”r
(
dev
, "Cª'ˆadd sysf dœeùÜy: %s/%s\n", dev->
Çme
,

523 
BATADV_SYSFS_IF_MESH_SUBDIR
);

524 
out
;

527 
b©_©Œ
 = 
b©adv_mesh_©Œs
; *bat_attr; ++bat_attr) {

528 
”r
 = 
	`sysfs_ü—‹_fe
(
b©_´iv
->
mesh_obj
,

529 &((*
b©_©Œ
)->
©Œ
));

530 ià(
”r
) {

531 
	`b©adv_”r
(
dev
, "Can't‡dd sysfs file: %s/%s/%s\n",

532 
dev
->
Çme
, 
BATADV_SYSFS_IF_MESH_SUBDIR
,

533 ((*
b©_©Œ
)->
©Œ
).
Çme
);

534 
»m_©Œ
;

540 
»m_©Œ
:

541 
b©_©Œ
 = 
b©adv_mesh_©Œs
; *bat_attr; ++bat_attr)

542 
	`sysfs_»move_fe
(
b©_´iv
->
mesh_obj
, &((*
b©_©Œ
)->
©Œ
));

544 
	`kobjeù_put
(
b©_´iv
->
mesh_obj
);

545 
b©_´iv
->
mesh_obj
 = 
NULL
;

546 
out
:

547  -
ENOMEM
;

548 
	}
}

550 
	$b©adv_sysfs_d–_meshif
(
Ãt_deviû
 *
dev
)

552 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
dev
);

553 
b©adv_©Œibu‹
 **
b©_©Œ
;

555 
b©_©Œ
 = 
b©adv_mesh_©Œs
; *bat_attr; ++bat_attr)

556 
	`sysfs_»move_fe
(
b©_´iv
->
mesh_obj
, &((*
b©_©Œ
)->
©Œ
));

558 
	`kobjeù_put
(
b©_´iv
->
mesh_obj
);

559 
b©_´iv
->
mesh_obj
 = 
NULL
;

560 
	}
}

562 
ssize_t
 
	$b©adv_show_mesh_içû
(
kobjeù
 *
kobj
,

563 
©Œibu‹
 *
©Œ
, *
buff
)

565 
Ãt_deviû
 *
Ãt_dev
 = 
	`b©adv_kobj_to_Ãtdev
(
kobj
);

566 
b©adv_h¬d_içû
 *
h¬d_içû
;

567 
ssize_t
 
Ëngth
;

568 cÚ¡ *
iâame
;

570 
h¬d_içû
 = 
	`b©adv_h¬dif_g‘_by_Ãtdev
(
Ãt_dev
);

571 ià(!
h¬d_içû
)

574 ià(
h¬d_içû
->
if_¡©us
 =ğ
BATADV_IF_NOT_IN_USE
)

575 
iâame
 = "none";

577 
iâame
 = 
h¬d_içû
->
soá_içû
->
Çme
;

579 
Ëngth
 = 
	`¥rštf
(
buff
, "%s\n", 
iâame
);

581 
	`b©adv_h¬dif_ä“_»f
(
h¬d_içû
);

583  
Ëngth
;

584 
	}
}

586 
ssize_t
 
	$b©adv_¡Üe_mesh_içû
(
kobjeù
 *
kobj
,

587 
©Œibu‹
 *
©Œ
, *
buff
,

588 
size_t
 
couÁ
)

590 
Ãt_deviû
 *
Ãt_dev
 = 
	`b©adv_kobj_to_Ãtdev
(
kobj
);

591 
b©adv_h¬d_içû
 *
h¬d_içû
;

592 
¡©us_tmp
 = -1;

593 
»t
 = 
couÁ
;

595 
h¬d_içû
 = 
	`b©adv_h¬dif_g‘_by_Ãtdev
(
Ãt_dev
);

596 ià(!
h¬d_içû
)

597  
couÁ
;

599 ià(
buff
[
couÁ
 - 1] == '\n')

600 
buff
[
couÁ
 - 1] = '\0';

602 ià(
	`¡¾’
(
buff
è>ğ
IFNAMSIZ
) {

603 
	`´_”r
("Invalid…arameter for 'mesh_iface' setting„eceived: interface‚ameoo†ong '%s'\n",

604 
buff
);

605 
	`b©adv_h¬dif_ä“_»f
(
h¬d_içû
);

606  -
EINVAL
;

609 ià(
	`¡ºcmp
(
buff
, "none", 4) == 0)

610 
¡©us_tmp
 = 
BATADV_IF_NOT_IN_USE
;

612 
¡©us_tmp
 = 
BATADV_IF_I_WANT_YOU
;

614 ià(
h¬d_içû
->
if_¡©us
 =ğ
¡©us_tmp
)

615 
out
;

617 ià((
h¬d_içû
->
soá_içû
) &&

618 (
	`¡ºcmp
(
h¬d_içû
->
soá_içû
->
Çme
, 
buff
, 
IFNAMSIZ
) == 0))

619 
out
;

621 ià(!
	`¹Æ_Œylock
()) {

622 
»t
 = -
ERESTARTSYS
;

623 
out
;

626 ià(
¡©us_tmp
 =ğ
BATADV_IF_NOT_IN_USE
) {

627 
	`b©adv_h¬dif_di§bË_š‹rçû
(
h¬d_içû
);

628 
uÆock
;

632 ià(
h¬d_içû
->
if_¡©us
 !ğ
BATADV_IF_NOT_IN_USE
)

633 
	`b©adv_h¬dif_di§bË_š‹rçû
(
h¬d_içû
);

635 
»t
 = 
	`b©adv_h¬dif_’abË_š‹rçû
(
h¬d_içû
, 
buff
);

637 
uÆock
:

638 
	`¹Æ_uÆock
();

639 
out
:

640 
	`b©adv_h¬dif_ä“_»f
(
h¬d_içû
);

641  
»t
;

642 
	}
}

644 
ssize_t
 
	$b©adv_show_içû_¡©us
(
kobjeù
 *
kobj
,

645 
©Œibu‹
 *
©Œ
, *
buff
)

647 
Ãt_deviû
 *
Ãt_dev
 = 
	`b©adv_kobj_to_Ãtdev
(
kobj
);

648 
b©adv_h¬d_içû
 *
h¬d_içû
;

649 
ssize_t
 
Ëngth
;

651 
h¬d_içû
 = 
	`b©adv_h¬dif_g‘_by_Ãtdev
(
Ãt_dev
);

652 ià(!
h¬d_içû
)

655 
h¬d_içû
->
if_¡©us
) {

656 
BATADV_IF_TO_BE_REMOVED
:

657 
Ëngth
 = 
	`¥rštf
(
buff
, "disabling\n");

659 
BATADV_IF_INACTIVE
:

660 
Ëngth
 = 
	`¥rštf
(
buff
, "inactive\n");

662 
BATADV_IF_ACTIVE
:

663 
Ëngth
 = 
	`¥rštf
(
buff
, "active\n");

665 
BATADV_IF_TO_BE_ACTIVATED
:

666 
Ëngth
 = 
	`¥rštf
(
buff
, "enabling\n");

668 
BATADV_IF_NOT_IN_USE
:

670 
Ëngth
 = 
	`¥rštf
(
buff
, "not in use\n");

674 
	`b©adv_h¬dif_ä“_»f
(
h¬d_içû
);

676  
Ëngth
;

677 
	}
}

679 
BATADV_ATTR
(
mesh_içû
, 
S_IRUGO
 | 
S_IWUSR
, 
b©adv_show_mesh_içû
,

680 
b©adv_¡Üe_mesh_içû
);

681 
BATADV_ATTR
(
içû_¡©us
, 
S_IRUGO
, 
b©adv_show_içû_¡©us
, 
NULL
);

683 
b©adv_©Œibu‹
 *
	gb©adv_b©mª_©Œs
[] = {

684 &
b©adv_©Œ_mesh_içû
,

685 &
b©adv_©Œ_içû_¡©us
,

686 
NULL
,

689 
	$b©adv_sysfs_add_h¬dif
(
kobjeù
 **
h¬dif_obj
, 
Ãt_deviû
 *
dev
)

691 
kobjeù
 *
h¬dif_kobjeù
 = &
dev
->dev.
kobj
;

692 
b©adv_©Œibu‹
 **
b©_©Œ
;

693 
”r
;

695 *
h¬dif_obj
 = 
	`kobjeù_ü—‹_ªd_add
(
BATADV_SYSFS_IF_BAT_SUBDIR
,

696 
h¬dif_kobjeù
);

698 ià(!*
h¬dif_obj
) {

699 
	`b©adv_”r
(
dev
, "Cª'ˆadd sysf dœeùÜy: %s/%s\n", dev->
Çme
,

700 
BATADV_SYSFS_IF_BAT_SUBDIR
);

701 
out
;

704 
b©_©Œ
 = 
b©adv_b©mª_©Œs
; *bat_attr; ++bat_attr) {

705 
”r
 = 
	`sysfs_ü—‹_fe
(*
h¬dif_obj
, &((*
b©_©Œ
)->
©Œ
));

706 ià(
”r
) {

707 
	`b©adv_”r
(
dev
, "Can't‡dd sysfs file: %s/%s/%s\n",

708 
dev
->
Çme
, 
BATADV_SYSFS_IF_BAT_SUBDIR
,

709 ((*
b©_©Œ
)->
©Œ
).
Çme
);

710 
»m_©Œ
;

716 
»m_©Œ
:

717 
b©_©Œ
 = 
b©adv_b©mª_©Œs
; *bat_attr; ++bat_attr)

718 
	`sysfs_»move_fe
(*
h¬dif_obj
, &((*
b©_©Œ
)->
©Œ
));

719 
out
:

720  -
ENOMEM
;

721 
	}
}

723 
	$b©adv_sysfs_d–_h¬dif
(
kobjeù
 **
h¬dif_obj
)

725 
	`kobjeù_put
(*
h¬dif_obj
);

726 *
h¬dif_obj
 = 
NULL
;

727 
	}
}

729 
	$b©adv_throw_uev’t
(
b©adv_´iv
 *
b©_´iv
, 
b©adv_uev_ty³
 
ty³
,

730 
b©adv_uev_aùiÚ
 
aùiÚ
, cÚ¡ *
d©a
)

732 
»t
 = -
ENOMEM
;

733 
b©adv_h¬d_içû
 *
´im¬y_if
 = 
NULL
;

734 
kobjeù
 *
b©_kobj
;

735 *
uev’t_’v
[4] = { 
NULL
, NULL, NULL, NULL };

737 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

738 ià(!
´im¬y_if
)

739 
out
;

741 
b©_kobj
 = &
´im¬y_if
->
soá_içû
->
dev
.
kobj
;

743 
uev’t_’v
[0] = 
	`km®loc
(
	`¡¾’
(
BATADV_UEV_TYPE_VAR
) +

744 
	`¡¾’
(
b©adv_uev_ty³_¡r
[
ty³
]) + 1,

745 
GFP_ATOMIC
);

746 ià(!
uev’t_’v
[0])

747 
out
;

749 
	`¥rštf
(
uev’t_’v
[0], "%s%s", 
BATADV_UEV_TYPE_VAR
,

750 
b©adv_uev_ty³_¡r
[
ty³
]);

752 
uev’t_’v
[1] = 
	`km®loc
(
	`¡¾’
(
BATADV_UEV_ACTION_VAR
) +

753 
	`¡¾’
(
b©adv_uev_aùiÚ_¡r
[
aùiÚ
]) + 1,

754 
GFP_ATOMIC
);

755 ià(!
uev’t_’v
[1])

756 
out
;

758 
	`¥rštf
(
uev’t_’v
[1], "%s%s", 
BATADV_UEV_ACTION_VAR
,

759 
b©adv_uev_aùiÚ_¡r
[
aùiÚ
]);

762 ià(
aùiÚ
 !ğ
BATADV_UEV_DEL
) {

763 
uev’t_’v
[2] = 
	`km®loc
(
	`¡¾’
(
BATADV_UEV_DATA_VAR
) +

764 
	`¡¾’
(
d©a
è+ 1, 
GFP_ATOMIC
);

765 ià(!
uev’t_’v
[2])

766 
out
;

768 
	`¥rštf
(
uev’t_’v
[2], "%s%s", 
BATADV_UEV_DATA_VAR
, 
d©a
);

771 
»t
 = 
	`kobjeù_uev’t_’v
(
b©_kobj
, 
KOBJ_CHANGE
, 
uev’t_’v
);

772 
out
:

773 
	`kä“
(
uev’t_’v
[0]);

774 
	`kä“
(
uev’t_’v
[1]);

775 
	`kä“
(
uev’t_’v
[2]);

777 ià(
´im¬y_if
)

778 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

780 ià(
»t
)

781 
	`b©adv_dbg
(
BATADV_DBG_BATMAN
, 
b©_´iv
,

783 
b©adv_uev_ty³_¡r
[
ty³
],

784 
b©adv_uev_aùiÚ_¡r
[
aùiÚ
],

785 (
aùiÚ
 =ğ
BATADV_UEV_DEL
 ? "NULL" : 
d©a
), 
»t
);

786  
»t
;

787 
	}
}

	@sysfs.h

20 #iâdeà
_NET_BATMAN_ADV_SYSFS_H_


21 
	#_NET_BATMAN_ADV_SYSFS_H_


	)

23 
	#BATADV_SYSFS_IF_MESH_SUBDIR
 "mesh"

	)

24 
	#BATADV_SYSFS_IF_BAT_SUBDIR
 "b©mª_adv"

	)

26 
	sb©adv_©Œibu‹
 {

27 
©Œibu‹
 
	m©Œ
;

28 
ssize_t
 (*
show
)(
kobjeù
 *
	mkobj
, 
©Œibu‹
 *
	m©Œ
,

29 *
	mbuf
);

30 
ssize_t
 (*
¡Üe
)(
kobjeù
 *
	mkobj
, 
©Œibu‹
 *
	m©Œ
,

31 *
	mbuf
, 
size_t
 
	mcouÁ
);

34 
b©adv_sysfs_add_meshif
(
Ãt_deviû
 *
dev
);

35 
b©adv_sysfs_d–_meshif
(
Ãt_deviû
 *
dev
);

36 
b©adv_sysfs_add_h¬dif
(
kobjeù
 **
h¬dif_obj
,

37 
Ãt_deviû
 *
dev
);

38 
b©adv_sysfs_d–_h¬dif
(
kobjeù
 **
h¬dif_obj
);

39 
b©adv_throw_uev’t
(
b©adv_´iv
 *
b©_´iv
, 
b©adv_uev_ty³
 
ty³
,

40 
b©adv_uev_aùiÚ
 
aùiÚ
, cÚ¡ *
d©a
);

	@translation-table.c

20 
	~"maš.h
"

21 
	~"Œª¦©iÚ-bË.h
"

22 
	~"soá-š‹rçû.h
"

23 
	~"h¬d-š‹rçû.h
"

24 
	~"£nd.h
"

25 
	~"hash.h
"

26 
	~"Üigš©Ü.h
"

27 
	~"routšg.h
"

28 
	~"bridge_loİ_avoidªû.h
"

30 
	~<lšux/üc16.h
>

32 
b©adv_£nd_rßm_adv
(
b©adv_´iv
 *
b©_´iv
, 
ušt8_t
 *
ş›Á
,

33 
b©adv_Üig_node
 *
Üig_node
);

34 
b©adv_‰_purge
(
wÜk_¡ruù
 *
wÜk
);

36 
b©adv_‰_glob®_d–_Üig_li¡
(
b©adv_‰_glob®_’Œy
 *
‰_glob®_’Œy
);

37 
b©adv_‰_glob®_d–
(
b©adv_´iv
 *
b©_´iv
,

38 
b©adv_Üig_node
 *
Üig_node
,

39 cÚ¡ *
addr
,

40 cÚ¡ *
mes§ge
, 
boŞ
 
rßmšg
);

43 
	$b©adv_com·»_‰
(cÚ¡ 
hli¡_node
 *
node
, cÚ¡ *
d©a2
)

45 cÚ¡ *
d©a1
 = 
	`cÚš”_of
(
node
, 
b©adv_‰_commÚ_’Œy
,

46 
hash_’Œy
);

48  (
	`memcmp
(
d©a1
, 
d©a2
, 
ETH_ALEN
) == 0 ? 1 : 0);

49 
	}
}

51 
	$b©adv_‰_¡¬t_tim”
(
b©adv_´iv
 *
b©_´iv
)

53 
	`INIT_DELAYED_WORK
(&
b©_´iv
->
‰
.
wÜk
, 
b©adv_‰_purge
);

54 
	`queue_d–ayed_wÜk
(
b©adv_ev’t_wÜkqueue
, &
b©_´iv
->
‰
.
wÜk
,

55 
	`m£cs_to_jiff›s
(5000));

56 
	}
}

58 
b©adv_‰_commÚ_’Œy
 *

59 
	$b©adv_‰_hash_fšd
(
b©adv_hashbË
 *
hash
, cÚ¡ *
d©a
)

61 
hli¡_h—d
 *
h—d
;

62 
hli¡_node
 *
node
;

63 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ_’Œy
;

64 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ_’Œy_tmp
 = 
NULL
;

65 
ušt32_t
 
šdex
;

67 ià(!
hash
)

68  
NULL
;

70 
šdex
 = 
	`b©adv_choo£_Üig
(
d©a
, 
hash
->
size
);

71 
h—d
 = &
hash
->
bË
[
šdex
];

73 
	`rcu_»ad_lock
();

74 
	`hli¡_fÜ_—ch_’Œy_rcu
(
‰_commÚ_’Œy
, 
node
, 
h—d
, 
hash_’Œy
) {

75 ià(!
	`b©adv_com·»_‘h
(
‰_commÚ_’Œy
, 
d©a
))

78 ià(!
	`©omic_šc_nÙ_z”o
(&
‰_commÚ_’Œy
->
»fcouÁ
))

81 
‰_commÚ_’Œy_tmp
 = 
‰_commÚ_’Œy
;

84 
	`rcu_»ad_uÆock
();

86  
‰_commÚ_’Œy_tmp
;

87 
	}
}

89 
b©adv_‰_loÿl_’Œy
 *

90 
	$b©adv_‰_loÿl_hash_fšd
(
b©adv_´iv
 *
b©_´iv
, cÚ¡ *
d©a
)

92 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ_’Œy
;

93 
b©adv_‰_loÿl_’Œy
 *
‰_loÿl_’Œy
 = 
NULL
;

95 
‰_commÚ_’Œy
 = 
	`b©adv_‰_hash_fšd
(
b©_´iv
->
‰
.
loÿl_hash
, 
d©a
);

96 ià(
‰_commÚ_’Œy
)

97 
‰_loÿl_’Œy
 = 
	`cÚš”_of
(
‰_commÚ_’Œy
,

98 
b©adv_‰_loÿl_’Œy
,

99 
commÚ
);

100  
‰_loÿl_’Œy
;

101 
	}
}

103 
b©adv_‰_glob®_’Œy
 *

104 
	$b©adv_‰_glob®_hash_fšd
(
b©adv_´iv
 *
b©_´iv
, cÚ¡ *
d©a
)

106 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ_’Œy
;

107 
b©adv_‰_glob®_’Œy
 *
‰_glob®_’Œy
 = 
NULL
;

109 
‰_commÚ_’Œy
 = 
	`b©adv_‰_hash_fšd
(
b©_´iv
->
‰
.
glob®_hash
, 
d©a
);

110 ià(
‰_commÚ_’Œy
)

111 
‰_glob®_’Œy
 = 
	`cÚš”_of
(
‰_commÚ_’Œy
,

112 
b©adv_‰_glob®_’Œy
,

113 
commÚ
);

114  
‰_glob®_’Œy
;

116 
	}
}

119 
	$b©adv_‰_loÿl_’Œy_ä“_»f
(
b©adv_‰_loÿl_’Œy
 *
‰_loÿl_’Œy
)

121 ià(
	`©omic_dec_ªd_‹¡
(&
‰_loÿl_’Œy
->
commÚ
.
»fcouÁ
))

122 
	`kä“_rcu
(
‰_loÿl_’Œy
, 
commÚ
.
rcu
);

123 
	}
}

125 
	$b©adv_‰_glob®_’Œy_ä“_rcu
(
rcu_h—d
 *
rcu
)

127 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ_’Œy
;

128 
b©adv_‰_glob®_’Œy
 *
‰_glob®_’Œy
;

130 
‰_commÚ_’Œy
 = 
	`cÚš”_of
(
rcu
, 
b©adv_‰_commÚ_’Œy
,„cu);

131 
‰_glob®_’Œy
 = 
	`cÚš”_of
(
‰_commÚ_’Œy
,

132 
b©adv_‰_glob®_’Œy
, 
commÚ
);

134 
	`kä“
(
‰_glob®_’Œy
);

135 
	}
}

138 
	$b©adv_‰_glob®_’Œy_ä“_»f
(
b©adv_‰_glob®_’Œy
 *
‰_glob®_’Œy
)

140 ià(
	`©omic_dec_ªd_‹¡
(&
‰_glob®_’Œy
->
commÚ
.
»fcouÁ
)) {

141 
	`b©adv_‰_glob®_d–_Üig_li¡
(
‰_glob®_’Œy
);

142 
	`ÿÎ_rcu
(&
‰_glob®_’Œy
->
commÚ
.
rcu
,

143 
b©adv_‰_glob®_’Œy_ä“_rcu
);

145 
	}
}

147 
	$b©adv_‰_Üig_li¡_’Œy_ä“_rcu
(
rcu_h—d
 *
rcu
)

149 
b©adv_‰_Üig_li¡_’Œy
 *
Üig_’Œy
;

151 
Üig_’Œy
 = 
	`cÚš”_of
(
rcu
, 
b©adv_‰_Üig_li¡_’Œy
,„cu);

152 
	`b©adv_Üig_node_ä“_»f
(
Üig_’Œy
->
Üig_node
);

153 
	`kä“
(
Üig_’Œy
);

154 
	}
}

157 
	$b©adv_‰_Üig_li¡_’Œy_ä“_»f
(
b©adv_‰_Üig_li¡_’Œy
 *
Üig_’Œy
)

159 ià(!
	`©omic_dec_ªd_‹¡
(&
Üig_’Œy
->
»fcouÁ
))

162 
	`©omic_dec
(&
Üig_’Œy
->
Üig_node
->
‰_size
);

163 
	`ÿÎ_rcu
(&
Üig_’Œy
->
rcu
, 
b©adv_‰_Üig_li¡_’Œy_ä“_rcu
);

164 
	}
}

166 
	$b©adv_‰_loÿl_ev’t
(
b©adv_´iv
 *
b©_´iv
,

167 cÚ¡ 
ušt8_t
 *
addr
, ušt8_ˆ
æags
)

169 
b©adv_‰_chªge_node
 *
‰_chªge_node
, *
’Œy
, *
§ã
;

170 
boŞ
 
ev’t_»moved
 = 
çl£
;

171 
boŞ
 
d–_İ_»que¡ed
, 
d–_İ_’Œy
;

173 
‰_chªge_node
 = 
	`km®loc
((*‰_chªge_node), 
GFP_ATOMIC
);

175 ià(!
‰_chªge_node
)

178 
‰_chªge_node
->
chªge
.
æags
 = flags;

179 
	`memıy
(
‰_chªge_node
->
chªge
.
addr
,‡ddr, 
ETH_ALEN
);

181 
d–_İ_»que¡ed
 = 
æags
 & 
BATADV_TT_CLIENT_DEL
;

184 
	`¥š_lock_bh
(&
b©_´iv
->
‰
.
chªges_li¡_lock
);

185 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
§ã
, &
b©_´iv
->
‰
.
chªges_li¡
,

186 
li¡
) {

187 ià(!
	`b©adv_com·»_‘h
(
’Œy
->
chªge
.
addr
,‡ddr))

197 
d–_İ_’Œy
 = 
’Œy
->
chªge
.
æags
 & 
BATADV_TT_CLIENT_DEL
;

198 ià(!
d–_İ_»que¡ed
 && 
d–_İ_’Œy
)

199 
d–
;

200 ià(
d–_İ_»que¡ed
 && !
d–_İ_’Œy
)

201 
d–
;

203 
d–
:

204 
	`li¡_d–
(&
’Œy
->
li¡
);

205 
	`kä“
(
’Œy
);

206 
	`kä“
(
‰_chªge_node
);

207 
ev’t_»moved
 = 
Œue
;

208 
uÆock
;

212 
	`li¡_add_
(&
‰_chªge_node
->
li¡
, &
b©_´iv
->
‰
.
chªges_li¡
);

214 
uÆock
:

215 
	`¥š_uÆock_bh
(&
b©_´iv
->
‰
.
chªges_li¡_lock
);

217 ià(
ev’t_»moved
)

218 
	`©omic_dec
(&
b©_´iv
->
‰
.
loÿl_chªges
);

220 
	`©omic_šc
(&
b©_´iv
->
‰
.
loÿl_chªges
);

221 
	}
}

223 
	$b©adv_‰_Ën
(
chªges_num
)

225  
chªges_num
 * (
b©adv_‰_chªge
);

226 
	}
}

228 
	$b©adv_‰_loÿl_š™
(
b©adv_´iv
 *
b©_´iv
)

230 ià(
b©_´iv
->
‰
.
loÿl_hash
)

233 
b©_´iv
->
‰
.
loÿl_hash
 = 
	`b©adv_hash_Ãw
(1024);

235 ià(!
b©_´iv
->
‰
.
loÿl_hash
)

236  -
ENOMEM
;

239 
	}
}

241 
	$b©adv_‰_loÿl_add
(
Ãt_deviû
 *
soá_içû
, cÚ¡ 
ušt8_t
 *
addr
,

242 
ifšdex
)

244 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
soá_içû
);

245 
b©adv_‰_loÿl_’Œy
 *
‰_loÿl_’Œy
 = 
NULL
;

246 
b©adv_‰_glob®_’Œy
 *
‰_glob®_’Œy
 = 
NULL
;

247 
hli¡_h—d
 *
h—d
;

248 
hli¡_node
 *
node
;

249 
b©adv_‰_Üig_li¡_’Œy
 *
Üig_’Œy
;

250 
hash_added
;

252 
‰_loÿl_’Œy
 = 
	`b©adv_‰_loÿl_hash_fšd
(
b©_´iv
, 
addr
);

254 ià(
‰_loÿl_’Œy
) {

255 
‰_loÿl_’Œy
->
Ï¡_£’
 = 
jiff›s
;

257 
‰_loÿl_’Œy
->
commÚ
.
æags
 &ğ~
BATADV_TT_CLIENT_PENDING
;

258 
out
;

261 
‰_loÿl_’Œy
 = 
	`km®loc
((*‰_loÿl_’Œy), 
GFP_ATOMIC
);

262 ià(!
‰_loÿl_’Œy
)

263 
out
;

265 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

266 "C»©šg‚ew†oÿÈ‰ƒÁry: %pM (‰vn: %d)\n", 
addr
,

267 (
ušt8_t
)
	`©omic_»ad
(&
b©_´iv
->
‰
.
vn
));

269 
	`memıy
(
‰_loÿl_’Œy
->
commÚ
.
addr
,‡ddr, 
ETH_ALEN
);

270 
‰_loÿl_’Œy
->
commÚ
.
æags
 = 
BATADV_NO_FLAGS
;

271 ià(
	`b©adv_is_wifi_içû
(
ifšdex
))

272 
‰_loÿl_’Œy
->
commÚ
.
æags
 |ğ
BATADV_TT_CLIENT_WIFI
;

273 
	`©omic_£t
(&
‰_loÿl_’Œy
->
commÚ
.
»fcouÁ
, 2);

274 
‰_loÿl_’Œy
->
Ï¡_£’
 = 
jiff›s
;

275 
‰_loÿl_’Œy
->
commÚ
.
added_©
 =t_loÿl_’Œy->
Ï¡_£’
;

278 ià(
	`b©adv_com·»_‘h
(
addr
, 
soá_içû
->
dev_addr
))

279 
‰_loÿl_’Œy
->
commÚ
.
æags
 |ğ
BATADV_TT_CLIENT_NOPURGE
;

285 
‰_loÿl_’Œy
->
commÚ
.
æags
 |ğ
BATADV_TT_CLIENT_NEW
;

287 
hash_added
 = 
	`b©adv_hash_add
(
b©_´iv
->
‰
.
loÿl_hash
, 
b©adv_com·»_‰
,

288 
b©adv_choo£_Üig
,

289 &
‰_loÿl_’Œy
->
commÚ
,

290 &
‰_loÿl_’Œy
->
commÚ
.
hash_’Œy
);

292 ià(
	`uÆik–y
(
hash_added
 != 0)) {

294 
	`b©adv_‰_loÿl_’Œy_ä“_»f
(
‰_loÿl_’Œy
);

295 
out
;

298 
	`b©adv_‰_loÿl_ev’t
(
b©_´iv
, 
addr
, 
‰_loÿl_’Œy
->
commÚ
.
æags
);

301 
‰_glob®_’Œy
 = 
	`b©adv_‰_glob®_hash_fšd
(
b©_´iv
, 
addr
);

304 ià(
‰_glob®_’Œy
) {

306 
h—d
 = &
‰_glob®_’Œy
->
Üig_li¡
;

307 
	`rcu_»ad_lock
();

308 
	`hli¡_fÜ_—ch_’Œy_rcu
(
Üig_’Œy
, 
node
, 
h—d
, 
li¡
) {

309 
Üig_’Œy
->
Üig_node
->
‰_poss_chªge
 = 
Œue
;

311 
	`b©adv_£nd_rßm_adv
(
b©_´iv
,

312 
‰_glob®_’Œy
->
commÚ
.
addr
,

313 
Üig_’Œy
->
Üig_node
);

315 
	`rcu_»ad_uÆock
();

319 
‰_glob®_’Œy
->
commÚ
.
æags
 |ğ
BATADV_TT_CLIENT_ROAM
;

320 
‰_glob®_’Œy
->
rßm_©
 = 
jiff›s
;

322 
out
:

323 ià(
‰_loÿl_’Œy
)

324 
	`b©adv_‰_loÿl_’Œy_ä“_»f
(
‰_loÿl_’Œy
);

325 ià(
‰_glob®_’Œy
)

326 
	`b©adv_‰_glob®_’Œy_ä“_»f
(
‰_glob®_’Œy
);

327 
	}
}

329 
	$b©adv_‰_»®loc_·ck‘_buff
(**
·ck‘_buff
,

330 *
·ck‘_buff_Ën
,

331 
mš_·ck‘_Ën
,

332 
Ãw_·ck‘_Ën
)

334 *
Ãw_buff
;

336 
Ãw_buff
 = 
	`km®loc
(
Ãw_·ck‘_Ën
, 
GFP_ATOMIC
);

339 ià(
Ãw_buff
) {

340 
	`memıy
(
Ãw_buff
, *
·ck‘_buff
, 
mš_·ck‘_Ën
);

341 
	`kä“
(*
·ck‘_buff
);

342 *
·ck‘_buff
 = 
Ãw_buff
;

343 *
·ck‘_buff_Ën
 = 
Ãw_·ck‘_Ën
;

345 
	}
}

347 
	$b©adv_‰_´•¬e_·ck‘_buff
(
b©adv_´iv
 *
b©_´iv
,

348 **
·ck‘_buff
,

349 *
·ck‘_buff_Ën
,

350 
mš_·ck‘_Ën
)

352 
b©adv_h¬d_içû
 *
´im¬y_if
;

353 
»q_Ën
;

355 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

357 
»q_Ën
 = 
mš_·ck‘_Ën
;

358 
»q_Ën
 +ğ
	`b©adv_‰_Ën
(
	`©omic_»ad
(&
b©_´iv
->
‰
.
loÿl_chªges
));

363 ià((!
´im¬y_if
è|| (
»q_Ën
 >…rim¬y_if->
soá_içû
->
mtu
))

364 
»q_Ën
 = 
mš_·ck‘_Ën
;

366 
	`b©adv_‰_»®loc_·ck‘_buff
(
·ck‘_buff
, 
·ck‘_buff_Ën
,

367 
mš_·ck‘_Ën
, 
»q_Ën
);

369 ià(
´im¬y_if
)

370 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

371 
	}
}

373 
	$b©adv_‰_chªges_fl_buff
(
b©adv_´iv
 *
b©_´iv
,

374 **
·ck‘_buff
,

375 *
·ck‘_buff_Ën
,

376 
mš_·ck‘_Ën
)

378 
b©adv_‰_chªge_node
 *
’Œy
, *
§ã
;

379 
couÁ
 = 0, 
tÙ_chªges
 = 0, 
Ãw_Ën
;

380 *
‰_buff
;

382 
	`b©adv_‰_´•¬e_·ck‘_buff
(
b©_´iv
, 
·ck‘_buff
,

383 
·ck‘_buff_Ën
, 
mš_·ck‘_Ën
);

385 
Ãw_Ën
 = *
·ck‘_buff_Ën
 - 
mš_·ck‘_Ën
;

386 
‰_buff
 = *
·ck‘_buff
 + 
mš_·ck‘_Ën
;

388 ià(
Ãw_Ën
 > 0)

389 
tÙ_chªges
 = 
Ãw_Ën
 / 
	`b©adv_‰_Ën
(1);

391 
	`¥š_lock_bh
(&
b©_´iv
->
‰
.
chªges_li¡_lock
);

392 
	`©omic_£t
(&
b©_´iv
->
‰
.
loÿl_chªges
, 0);

394 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
§ã
, &
b©_´iv
->
‰
.
chªges_li¡
,

395 
li¡
) {

396 ià(
couÁ
 < 
tÙ_chªges
) {

397 
	`memıy
(
‰_buff
 + 
	`b©adv_‰_Ën
(
couÁ
),

398 &
’Œy
->
chªge
, (
b©adv_‰_chªge
));

399 
couÁ
++;

401 
	`li¡_d–
(&
’Œy
->
li¡
);

402 
	`kä“
(
’Œy
);

404 
	`¥š_uÆock_bh
(&
b©_´iv
->
‰
.
chªges_li¡_lock
);

407 
	`¥š_lock_bh
(&
b©_´iv
->
‰
.
Ï¡_chªge£t_lock
);

408 
	`kä“
(
b©_´iv
->
‰
.
Ï¡_chªge£t
);

409 
b©_´iv
->
‰
.
Ï¡_chªge£t_Ën
 = 0;

410 
b©_´iv
->
‰
.
Ï¡_chªge£t
 = 
NULL
;

412 ià(
Ãw_Ën
 > 0) {

416 
b©_´iv
->
‰
.
Ï¡_chªge£t
 = 
	`km®loc
(
Ãw_Ën
, 
GFP_ATOMIC
);

417 ià(
b©_´iv
->
‰
.
Ï¡_chªge£t
) {

418 
	`memıy
(
b©_´iv
->
‰
.
Ï¡_chªge£t
, 
‰_buff
, 
Ãw_Ën
);

419 
b©_´iv
->
‰
.
Ï¡_chªge£t_Ën
 = 
Ãw_Ën
;

422 
	`¥š_uÆock_bh
(&
b©_´iv
->
‰
.
Ï¡_chªge£t_lock
);

424  
couÁ
;

425 
	}
}

427 
	$b©adv_‰_loÿl_£q_´št_‹xt
(
£q_fe
 *
£q
, *
off£t
)

429 
Ãt_deviû
 *
Ãt_dev
 = (Ãt_deviû *)
£q
->
´iv©e
;

430 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
Ãt_dev
);

431 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
‰
.
loÿl_hash
;

432 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ_’Œy
;

433 
b©adv_h¬d_içû
 *
´im¬y_if
;

434 
hli¡_node
 *
node
;

435 
hli¡_h—d
 *
h—d
;

436 
ušt32_t
 
i
;

437 
»t
 = 0;

439 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

440 ià(!
´im¬y_if
) {

441 
»t
 = 
	`£q_´štf
(
£q
,

443 
Ãt_dev
->
Çme
);

444 
out
;

447 ià(
´im¬y_if
->
if_¡©us
 !ğ
BATADV_IF_ACTIVE
) {

448 
»t
 = 
	`£q_´štf
(
£q
,

450 
Ãt_dev
->
Çme
);

451 
out
;

454 
	`£q_´štf
(
£q
,

456 
Ãt_dev
->
Çme
, (
ušt8_t
)
	`©omic_»ad
(&
b©_´iv
->
‰
.
vn
));

458 
i
 = 0; i < 
hash
->
size
; i++) {

459 
h—d
 = &
hash
->
bË
[
i
];

461 
	`rcu_»ad_lock
();

462 
	`hli¡_fÜ_—ch_’Œy_rcu
(
‰_commÚ_’Œy
, 
node
,

463 
h—d
, 
hash_’Œy
) {

464 
	`£q_´štf
(
£q
, " * %pM [%c%c%c%c%c]\n",

465 
‰_commÚ_’Œy
->
addr
,

466 (
‰_commÚ_’Œy
->
æags
 &

467 
BATADV_TT_CLIENT_ROAM
 ? 'R' : '.'),

468 (
‰_commÚ_’Œy
->
æags
 &

469 
BATADV_TT_CLIENT_NOPURGE
 ? 'P' : '.'),

470 (
‰_commÚ_’Œy
->
æags
 &

471 
BATADV_TT_CLIENT_NEW
 ? 'N' : '.'),

472 (
‰_commÚ_’Œy
->
æags
 &

473 
BATADV_TT_CLIENT_PENDING
 ? 'X' : '.'),

474 (
‰_commÚ_’Œy
->
æags
 &

475 
BATADV_TT_CLIENT_WIFI
 ? 'W' : '.'));

477 
	`rcu_»ad_uÆock
();

479 
out
:

480 ià(
´im¬y_if
)

481 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

482  
»t
;

483 
	}
}

486 
	$b©adv_‰_loÿl_£t_³ndšg
(
b©adv_´iv
 *
b©_´iv
,

487 
b©adv_‰_loÿl_’Œy
 *
‰_loÿl_’Œy
,

488 
ušt16_t
 
æags
, cÚ¡ *
mes§ge
)

490 
	`b©adv_‰_loÿl_ev’t
(
b©_´iv
, 
‰_loÿl_’Œy
->
commÚ
.
addr
,

491 
‰_loÿl_’Œy
->
commÚ
.
æags
 | flags);

497 
‰_loÿl_’Œy
->
commÚ
.
æags
 |ğ
BATADV_TT_CLIENT_PENDING
;

499 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

501 
‰_loÿl_’Œy
->
commÚ
.
addr
, 
mes§ge
);

502 
	}
}

504 
	$b©adv_‰_loÿl_»move
(
b©adv_´iv
 *
b©_´iv
, cÚ¡ 
ušt8_t
 *
addr
,

505 cÚ¡ *
mes§ge
, 
boŞ
 
rßmšg
)

507 
b©adv_‰_loÿl_’Œy
 *
‰_loÿl_’Œy
 = 
NULL
;

508 
ušt16_t
 
æags
;

510 
‰_loÿl_’Œy
 = 
	`b©adv_‰_loÿl_hash_fšd
(
b©_´iv
, 
addr
);

511 ià(!
‰_loÿl_’Œy
)

512 
out
;

514 
æags
 = 
BATADV_TT_CLIENT_DEL
;

515 ià(
rßmšg
)

516 
æags
 |ğ
BATADV_TT_CLIENT_ROAM
;

518 
	`b©adv_‰_loÿl_£t_³ndšg
(
b©_´iv
, 
‰_loÿl_’Œy
, 
æags
, 
mes§ge
);

519 
out
:

520 ià(
‰_loÿl_’Œy
)

521 
	`b©adv_‰_loÿl_’Œy_ä“_»f
(
‰_loÿl_’Œy
);

522 
	}
}

524 
	$b©adv_‰_loÿl_purge_li¡
(
b©adv_´iv
 *
b©_´iv
,

525 
hli¡_h—d
 *
h—d
)

527 
b©adv_‰_loÿl_’Œy
 *
‰_loÿl_’Œy
;

528 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ_’Œy
;

529 
hli¡_node
 *
node
, *
node_tmp
;

531 
	`hli¡_fÜ_—ch_’Œy_§ã
(
‰_commÚ_’Œy
, 
node
, 
node_tmp
, 
h—d
,

532 
hash_’Œy
) {

533 
‰_loÿl_’Œy
 = 
	`cÚš”_of
(
‰_commÚ_’Œy
,

534 
b©adv_‰_loÿl_’Œy
,

535 
commÚ
);

536 ià(
‰_loÿl_’Œy
->
commÚ
.
æags
 & 
BATADV_TT_CLIENT_NOPURGE
)

540 ià(
‰_loÿl_’Œy
->
commÚ
.
æags
 & 
BATADV_TT_CLIENT_PENDING
)

543 ià(!
	`b©adv_has_timed_out
(
‰_loÿl_’Œy
->
Ï¡_£’
,

544 
BATADV_TT_LOCAL_TIMEOUT
))

547 
	`b©adv_‰_loÿl_£t_³ndšg
(
b©_´iv
, 
‰_loÿl_’Œy
,

548 
BATADV_TT_CLIENT_DEL
, "timed out");

550 
	}
}

552 
	$b©adv_‰_loÿl_purge
(
b©adv_´iv
 *
b©_´iv
)

554 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
‰
.
loÿl_hash
;

555 
hli¡_h—d
 *
h—d
;

556 
¥šlock_t
 *
li¡_lock
;

557 
ušt32_t
 
i
;

559 
i
 = 0; i < 
hash
->
size
; i++) {

560 
h—d
 = &
hash
->
bË
[
i
];

561 
li¡_lock
 = &
hash
->
li¡_locks
[
i
];

563 
	`¥š_lock_bh
(
li¡_lock
);

564 
	`b©adv_‰_loÿl_purge_li¡
(
b©_´iv
, 
h—d
);

565 
	`¥š_uÆock_bh
(
li¡_lock
);

568 
	}
}

570 
	$b©adv_‰_loÿl_bË_ä“
(
b©adv_´iv
 *
b©_´iv
)

572 
b©adv_hashbË
 *
hash
;

573 
¥šlock_t
 *
li¡_lock
;

574 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ_’Œy
;

575 
b©adv_‰_loÿl_’Œy
 *
‰_loÿl
;

576 
hli¡_node
 *
node
, *
node_tmp
;

577 
hli¡_h—d
 *
h—d
;

578 
ušt32_t
 
i
;

580 ià(!
b©_´iv
->
‰
.
loÿl_hash
)

583 
hash
 = 
b©_´iv
->
‰
.
loÿl_hash
;

585 
i
 = 0; i < 
hash
->
size
; i++) {

586 
h—d
 = &
hash
->
bË
[
i
];

587 
li¡_lock
 = &
hash
->
li¡_locks
[
i
];

589 
	`¥š_lock_bh
(
li¡_lock
);

590 
	`hli¡_fÜ_—ch_’Œy_§ã
(
‰_commÚ_’Œy
, 
node
, 
node_tmp
,

591 
h—d
, 
hash_’Œy
) {

592 
	`hli¡_d–_rcu
(
node
);

593 
‰_loÿl
 = 
	`cÚš”_of
(
‰_commÚ_’Œy
,

594 
b©adv_‰_loÿl_’Œy
,

595 
commÚ
);

596 
	`b©adv_‰_loÿl_’Œy_ä“_»f
(
‰_loÿl
);

598 
	`¥š_uÆock_bh
(
li¡_lock
);

601 
	`b©adv_hash_de¡roy
(
hash
);

603 
b©_´iv
->
‰
.
loÿl_hash
 = 
NULL
;

604 
	}
}

606 
	$b©adv_‰_glob®_š™
(
b©adv_´iv
 *
b©_´iv
)

608 ià(
b©_´iv
->
‰
.
glob®_hash
)

611 
b©_´iv
->
‰
.
glob®_hash
 = 
	`b©adv_hash_Ãw
(1024);

613 ià(!
b©_´iv
->
‰
.
glob®_hash
)

614  -
ENOMEM
;

617 
	}
}

619 
	$b©adv_‰_chªges_li¡_ä“
(
b©adv_´iv
 *
b©_´iv
)

621 
b©adv_‰_chªge_node
 *
’Œy
, *
§ã
;

623 
	`¥š_lock_bh
(&
b©_´iv
->
‰
.
chªges_li¡_lock
);

625 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
§ã
, &
b©_´iv
->
‰
.
chªges_li¡
,

626 
li¡
) {

627 
	`li¡_d–
(&
’Œy
->
li¡
);

628 
	`kä“
(
’Œy
);

631 
	`©omic_£t
(&
b©_´iv
->
‰
.
loÿl_chªges
, 0);

632 
	`¥š_uÆock_bh
(&
b©_´iv
->
‰
.
chªges_li¡_lock
);

633 
	}
}

640 
b©adv_‰_Üig_li¡_’Œy
 *

641 
	$b©adv_‰_glob®_Üig_’Œy_fšd
(cÚ¡ 
b©adv_‰_glob®_’Œy
 *
’Œy
,

642 cÚ¡ 
b©adv_Üig_node
 *
Üig_node
)

644 
b©adv_‰_Üig_li¡_’Œy
 *
tmp_Üig_’Œy
, *
Üig_’Œy
 = 
NULL
;

645 cÚ¡ 
hli¡_h—d
 *
h—d
;

646 
hli¡_node
 *
node
;

648 
	`rcu_»ad_lock
();

649 
h—d
 = &
’Œy
->
Üig_li¡
;

650 
	`hli¡_fÜ_—ch_’Œy_rcu
(
tmp_Üig_’Œy
, 
node
, 
h—d
, 
li¡
) {

651 ià(
tmp_Üig_’Œy
->
Üig_node
 != orig_node)

653 ià(!
	`©omic_šc_nÙ_z”o
(&
tmp_Üig_’Œy
->
»fcouÁ
))

656 
Üig_’Œy
 = 
tmp_Üig_’Œy
;

659 
	`rcu_»ad_uÆock
();

661  
Üig_’Œy
;

662 
	}
}

667 
boŞ


668 
	$b©adv_‰_glob®_’Œy_has_Üig
(cÚ¡ 
b©adv_‰_glob®_’Œy
 *
’Œy
,

669 cÚ¡ 
b©adv_Üig_node
 *
Üig_node
)

671 
b©adv_‰_Üig_li¡_’Œy
 *
Üig_’Œy
;

672 
boŞ
 
found
 = 
çl£
;

674 
Üig_’Œy
 = 
	`b©adv_‰_glob®_Üig_’Œy_fšd
(
’Œy
, 
Üig_node
);

675 ià(
Üig_’Œy
) {

676 
found
 = 
Œue
;

677 
	`b©adv_‰_Üig_li¡_’Œy_ä“_»f
(
Üig_’Œy
);

680  
found
;

681 
	}
}

684 
	$b©adv_‰_glob®_Üig_’Œy_add
(
b©adv_‰_glob®_’Œy
 *
‰_glob®
,

685 
b©adv_Üig_node
 *
Üig_node
, 
‰vn
)

687 
b©adv_‰_Üig_li¡_’Œy
 *
Üig_’Œy
;

689 
Üig_’Œy
 = 
	`b©adv_‰_glob®_Üig_’Œy_fšd
(
‰_glob®
, 
Üig_node
);

690 ià(
Üig_’Œy
) {

694 
Üig_’Œy
->
‰vn
 =tvn;

695 
out
;

698 
Üig_’Œy
 = 
	`kz®loc
((*Üig_’Œy), 
GFP_ATOMIC
);

699 ià(!
Üig_’Œy
)

700 
out
;

702 
	`INIT_HLIST_NODE
(&
Üig_’Œy
->
li¡
);

703 
	`©omic_šc
(&
Üig_node
->
»fcouÁ
);

704 
	`©omic_šc
(&
Üig_node
->
‰_size
);

705 
Üig_’Œy
->
Üig_node
 = orig_node;

706 
Üig_’Œy
->
‰vn
 =tvn;

707 
	`©omic_£t
(&
Üig_’Œy
->
»fcouÁ
, 2);

709 
	`¥š_lock_bh
(&
‰_glob®
->
li¡_lock
);

710 
	`hli¡_add_h—d_rcu
(&
Üig_’Œy
->
li¡
,

711 &
‰_glob®
->
Üig_li¡
);

712 
	`¥š_uÆock_bh
(&
‰_glob®
->
li¡_lock
);

713 
out
:

714 ià(
Üig_’Œy
)

715 
	`b©adv_‰_Üig_li¡_’Œy_ä“_»f
(
Üig_’Œy
);

716 
	}
}

719 
	$b©adv_‰_glob®_add
(
b©adv_´iv
 *
b©_´iv
,

720 
b©adv_Üig_node
 *
Üig_node
,

721 cÚ¡ *
‰_addr
, 
ušt8_t
 
æags
,

722 
ušt8_t
 
‰vn
)

724 
b©adv_‰_glob®_’Œy
 *
‰_glob®_’Œy
 = 
NULL
;

725 
»t
 = 0;

726 
hash_added
;

727 
b©adv_‰_commÚ_’Œy
 *
commÚ
;

729 
‰_glob®_’Œy
 = 
	`b©adv_‰_glob®_hash_fšd
(
b©_´iv
, 
‰_addr
);

731 ià(!
‰_glob®_’Œy
) {

732 
‰_glob®_’Œy
 = 
	`kz®loc
((*‰_glob®_’Œy), 
GFP_ATOMIC
);

733 ià(!
‰_glob®_’Œy
)

734 
out
;

736 
commÚ
 = &
‰_glob®_’Œy
->common;

737 
	`memıy
(
commÚ
->
addr
, 
‰_addr
, 
ETH_ALEN
);

739 
commÚ
->
æags
 = flags;

740 
‰_glob®_’Œy
->
rßm_©
 = 0;

741 
	`©omic_£t
(&
commÚ
->
»fcouÁ
, 2);

742 
commÚ
->
added_©
 = 
jiff›s
;

744 
	`INIT_HLIST_HEAD
(&
‰_glob®_’Œy
->
Üig_li¡
);

745 
	`¥š_lock_š™
(&
‰_glob®_’Œy
->
li¡_lock
);

747 
hash_added
 = 
	`b©adv_hash_add
(
b©_´iv
->
‰
.
glob®_hash
,

748 
b©adv_com·»_‰
,

749 
b©adv_choo£_Üig
, 
commÚ
,

750 &
commÚ
->
hash_’Œy
);

752 ià(
	`uÆik–y
(
hash_added
 != 0)) {

754 
	`b©adv_‰_glob®_’Œy_ä“_»f
(
‰_glob®_’Œy
);

755 
out_»move
;

764 ià(
æags
 & 
BATADV_TT_CLIENT_TEMP
)

765 
out
;

770 
‰_glob®_’Œy
->
commÚ
.
æags
 &ğ~
BATADV_TT_CLIENT_TEMP
;

779 ià(
‰_glob®_’Œy
->
commÚ
.
æags
 & 
BATADV_TT_CLIENT_ROAM
) {

780 
	`b©adv_‰_glob®_d–_Üig_li¡
(
‰_glob®_’Œy
);

781 
‰_glob®_’Œy
->
commÚ
.
æags
 &ğ~
BATADV_TT_CLIENT_ROAM
;

782 
‰_glob®_’Œy
->
rßm_©
 = 0;

786 
	`b©adv_‰_glob®_Üig_’Œy_add
(
‰_glob®_’Œy
, 
Üig_node
, 
‰vn
);

788 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

790 
‰_glob®_’Œy
->
commÚ
.
addr
, 
Üig_node
->
Üig
);

792 
out_»move
:

794 
	`b©adv_‰_loÿl_»move
(
b©_´iv
, 
‰_glob®_’Œy
->
commÚ
.
addr
,

796 
æags
 & 
BATADV_TT_CLIENT_ROAM
);

797 
»t
 = 1;

798 
out
:

799 ià(
‰_glob®_’Œy
)

800 
	`b©adv_‰_glob®_’Œy_ä“_»f
(
‰_glob®_’Œy
);

801  
»t
;

802 
	}
}

808 
	$b©adv_‰_glob®_´št_’Œy
(
b©adv_‰_glob®_’Œy
 *
‰_glob®_’Œy
,

809 
£q_fe
 *
£q
)

811 
hli¡_h—d
 *
h—d
;

812 
hli¡_node
 *
node
;

813 
b©adv_‰_Üig_li¡_’Œy
 *
Üig_’Œy
;

814 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ_’Œy
;

815 
ušt16_t
 
æags
;

816 
ušt8_t
 
Ï¡_‰vn
;

818 
‰_commÚ_’Œy
 = &
‰_glob®_’Œy
->
commÚ
;

820 
h—d
 = &
‰_glob®_’Œy
->
Üig_li¡
;

822 
	`hli¡_fÜ_—ch_’Œy_rcu
(
Üig_’Œy
, 
node
, 
h—d
, 
li¡
) {

823 
æags
 = 
‰_commÚ_’Œy
->flags;

824 
Ï¡_‰vn
 = 
	`©omic_»ad
(&
Üig_’Œy
->
Üig_node
->last_ttvn);

825 
	`£q_´štf
(
£q
, " * %pM (%3u) via %pM (%3u) [%c%c%c]\n",

826 
‰_glob®_’Œy
->
commÚ
.
addr
, 
Üig_’Œy
->
‰vn
,

827 
Üig_’Œy
->
Üig_node
->
Üig
, 
Ï¡_‰vn
,

828 (
æags
 & 
BATADV_TT_CLIENT_ROAM
 ? 'R' : '.'),

829 (
æags
 & 
BATADV_TT_CLIENT_WIFI
 ? 'W' : '.'),

830 (
æags
 & 
BATADV_TT_CLIENT_TEMP
 ? 'T' : '.'));

832 
	}
}

834 
	$b©adv_‰_glob®_£q_´št_‹xt
(
£q_fe
 *
£q
, *
off£t
)

836 
Ãt_deviû
 *
Ãt_dev
 = (Ãt_deviû *)
£q
->
´iv©e
;

837 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
Ãt_dev
);

838 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
‰
.
glob®_hash
;

839 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ_’Œy
;

840 
b©adv_‰_glob®_’Œy
 *
‰_glob®
;

841 
b©adv_h¬d_içû
 *
´im¬y_if
;

842 
hli¡_node
 *
node
;

843 
hli¡_h—d
 *
h—d
;

844 
ušt32_t
 
i
;

845 
»t
 = 0;

847 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

848 ià(!
´im¬y_if
) {

849 
»t
 = 
	`£q_´štf
(
£q
,

851 
Ãt_dev
->
Çme
);

852 
out
;

855 ià(
´im¬y_if
->
if_¡©us
 !ğ
BATADV_IF_ACTIVE
) {

856 
»t
 = 
	`£q_´štf
(
£q
,

858 
Ãt_dev
->
Çme
);

859 
out
;

862 
	`£q_´štf
(
£q
,

864 
Ãt_dev
->
Çme
);

865 
	`£q_´štf
(
£q
, " %-13s %s %-15s %s %s\n",

868 
i
 = 0; i < 
hash
->
size
; i++) {

869 
h—d
 = &
hash
->
bË
[
i
];

871 
	`rcu_»ad_lock
();

872 
	`hli¡_fÜ_—ch_’Œy_rcu
(
‰_commÚ_’Œy
, 
node
,

873 
h—d
, 
hash_’Œy
) {

874 
‰_glob®
 = 
	`cÚš”_of
(
‰_commÚ_’Œy
,

875 
b©adv_‰_glob®_’Œy
,

876 
commÚ
);

877 
	`b©adv_‰_glob®_´št_’Œy
(
‰_glob®
, 
£q
);

879 
	`rcu_»ad_uÆock
();

881 
out
:

882 ià(
´im¬y_if
)

883 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

884  
»t
;

885 
	}
}

889 
	$b©adv_‰_glob®_d–_Üig_li¡
(
b©adv_‰_glob®_’Œy
 *
‰_glob®_’Œy
)

891 
hli¡_h—d
 *
h—d
;

892 
hli¡_node
 *
node
, *
§ã
;

893 
b©adv_‰_Üig_li¡_’Œy
 *
Üig_’Œy
;

895 
	`¥š_lock_bh
(&
‰_glob®_’Œy
->
li¡_lock
);

896 
h—d
 = &
‰_glob®_’Œy
->
Üig_li¡
;

897 
	`hli¡_fÜ_—ch_’Œy_§ã
(
Üig_’Œy
, 
node
, 
§ã
, 
h—d
, 
li¡
) {

898 
	`hli¡_d–_rcu
(
node
);

899 
	`b©adv_‰_Üig_li¡_’Œy_ä“_»f
(
Üig_’Œy
);

901 
	`¥š_uÆock_bh
(&
‰_glob®_’Œy
->
li¡_lock
);

903 
	}
}

906 
	$b©adv_‰_glob®_d–_Üig_’Œy
(
b©adv_´iv
 *
b©_´iv
,

907 
b©adv_‰_glob®_’Œy
 *
‰_glob®_’Œy
,

908 
b©adv_Üig_node
 *
Üig_node
,

909 cÚ¡ *
mes§ge
)

911 
hli¡_h—d
 *
h—d
;

912 
hli¡_node
 *
node
, *
§ã
;

913 
b©adv_‰_Üig_li¡_’Œy
 *
Üig_’Œy
;

915 
	`¥š_lock_bh
(&
‰_glob®_’Œy
->
li¡_lock
);

916 
h—d
 = &
‰_glob®_’Œy
->
Üig_li¡
;

917 
	`hli¡_fÜ_—ch_’Œy_§ã
(
Üig_’Œy
, 
node
, 
§ã
, 
h—d
, 
li¡
) {

918 ià(
Üig_’Œy
->
Üig_node
 == orig_node) {

919 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

921 
Üig_node
->
Üig
,

922 
‰_glob®_’Œy
->
commÚ
.
addr
, 
mes§ge
);

923 
	`hli¡_d–_rcu
(
node
);

924 
	`b©adv_‰_Üig_li¡_’Œy_ä“_»f
(
Üig_’Œy
);

927 
	`¥š_uÆock_bh
(&
‰_glob®_’Œy
->
li¡_lock
);

928 
	}
}

931 
	$b©adv_‰_glob®_d–_¡ruù
(
b©adv_´iv
 *
b©_´iv
,

932 
b©adv_‰_glob®_’Œy
 *
‰_glob®_’Œy
,

933 cÚ¡ *
mes§ge
)

935 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

937 
‰_glob®_’Œy
->
commÚ
.
addr
, 
mes§ge
);

939 
	`b©adv_hash_»move
(
b©_´iv
->
‰
.
glob®_hash
, 
b©adv_com·»_‰
,

940 
b©adv_choo£_Üig
, 
‰_glob®_’Œy
->
commÚ
.
addr
);

941 
	`b©adv_‰_glob®_’Œy_ä“_»f
(
‰_glob®_’Œy
);

943 
	}
}

950 
	$b©adv_‰_glob®_d–_rßmšg
(
b©adv_´iv
 *
b©_´iv
,

951 
b©adv_‰_glob®_’Œy
 *
‰_glob®_’Œy
,

952 
b©adv_Üig_node
 *
Üig_node
,

953 cÚ¡ *
mes§ge
)

955 
boŞ
 
Ï¡_’Œy
 = 
Œue
;

956 
hli¡_h—d
 *
h—d
;

957 
hli¡_node
 *
node
;

958 
b©adv_‰_Üig_li¡_’Œy
 *
Üig_’Œy
;

964 
	`rcu_»ad_lock
();

965 
h—d
 = &
‰_glob®_’Œy
->
Üig_li¡
;

966 
	`hli¡_fÜ_—ch_’Œy_rcu
(
Üig_’Œy
, 
node
, 
h—d
, 
li¡
) {

967 ià(
Üig_’Œy
->
Üig_node
 != orig_node) {

968 
Ï¡_’Œy
 = 
çl£
;

972 
	`rcu_»ad_uÆock
();

974 ià(
Ï¡_’Œy
) {

976 
‰_glob®_’Œy
->
commÚ
.
æags
 |ğ
BATADV_TT_CLIENT_ROAM
;

977 
‰_glob®_’Œy
->
rßm_©
 = 
jiff›s
;

982 
	`b©adv_‰_glob®_d–_Üig_’Œy
(
b©_´iv
, 
‰_glob®_’Œy
,

983 
Üig_node
, 
mes§ge
);

984 
	}
}

988 
	$b©adv_‰_glob®_d–
(
b©adv_´iv
 *
b©_´iv
,

989 
b©adv_Üig_node
 *
Üig_node
,

990 cÚ¡ *
addr
,

991 cÚ¡ *
mes§ge
, 
boŞ
 
rßmšg
)

993 
b©adv_‰_glob®_’Œy
 *
‰_glob®_’Œy
 = 
NULL
;

994 
b©adv_‰_loÿl_’Œy
 *
loÿl_’Œy
 = 
NULL
;

996 
‰_glob®_’Œy
 = 
	`b©adv_‰_glob®_hash_fšd
(
b©_´iv
, 
addr
);

997 ià(!
‰_glob®_’Œy
)

998 
out
;

1000 ià(!
rßmšg
) {

1001 
	`b©adv_‰_glob®_d–_Üig_’Œy
(
b©_´iv
, 
‰_glob®_’Œy
,

1002 
Üig_node
, 
mes§ge
);

1004 ià(
	`hli¡_em±y
(&
‰_glob®_’Œy
->
Üig_li¡
))

1005 
	`b©adv_‰_glob®_d–_¡ruù
(
b©_´iv
, 
‰_glob®_’Œy
,

1006 
mes§ge
);

1008 
out
;

1024 
loÿl_’Œy
 = 
	`b©adv_‰_loÿl_hash_fšd
(
b©_´iv
,

1025 
‰_glob®_’Œy
->
commÚ
.
addr
);

1026 ià(
loÿl_’Œy
) {

1028 
	`b©adv_‰_glob®_d–_Üig_li¡
(
‰_glob®_’Œy
);

1029 
	`b©adv_‰_glob®_d–_¡ruù
(
b©_´iv
, 
‰_glob®_’Œy
, 
mes§ge
);

1032 
	`b©adv_‰_glob®_d–_rßmšg
(
b©_´iv
, 
‰_glob®_’Œy
,

1033 
Üig_node
, 
mes§ge
);

1036 
out
:

1037 ià(
‰_glob®_’Œy
)

1038 
	`b©adv_‰_glob®_’Œy_ä“_»f
(
‰_glob®_’Œy
);

1039 ià(
loÿl_’Œy
)

1040 
	`b©adv_‰_loÿl_’Œy_ä“_»f
(
loÿl_’Œy
);

1041 
	}
}

1043 
	$b©adv_‰_glob®_d–_Üig
(
b©adv_´iv
 *
b©_´iv
,

1044 
b©adv_Üig_node
 *
Üig_node
,

1045 cÚ¡ *
mes§ge
)

1047 
b©adv_‰_glob®_’Œy
 *
‰_glob®
;

1048 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ_’Œy
;

1049 
ušt32_t
 
i
;

1050 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
‰
.
glob®_hash
;

1051 
hli¡_node
 *
node
, *
§ã
;

1052 
hli¡_h—d
 *
h—d
;

1053 
¥šlock_t
 *
li¡_lock
;

1055 ià(!
hash
)

1058 
i
 = 0; i < 
hash
->
size
; i++) {

1059 
h—d
 = &
hash
->
bË
[
i
];

1060 
li¡_lock
 = &
hash
->
li¡_locks
[
i
];

1062 
	`¥š_lock_bh
(
li¡_lock
);

1063 
	`hli¡_fÜ_—ch_’Œy_§ã
(
‰_commÚ_’Œy
, 
node
, 
§ã
,

1064 
h—d
, 
hash_’Œy
) {

1065 
‰_glob®
 = 
	`cÚš”_of
(
‰_commÚ_’Œy
,

1066 
b©adv_‰_glob®_’Œy
,

1067 
commÚ
);

1069 
	`b©adv_‰_glob®_d–_Üig_’Œy
(
b©_´iv
, 
‰_glob®
,

1070 
Üig_node
, 
mes§ge
);

1072 ià(
	`hli¡_em±y
(&
‰_glob®
->
Üig_li¡
)) {

1073 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

1075 
‰_glob®
->
commÚ
.
addr
, 
mes§ge
);

1076 
	`hli¡_d–_rcu
(
node
);

1077 
	`b©adv_‰_glob®_’Œy_ä“_»f
(
‰_glob®
);

1080 
	`¥š_uÆock_bh
(
li¡_lock
);

1082 
Üig_node
->
‰_š™Ÿli£d
 = 
çl£
;

1083 
	}
}

1085 
boŞ
 
	$b©adv_‰_glob®_to_purge
(
b©adv_‰_glob®_’Œy
 *
‰_glob®
,

1086 **
msg
)

1088 
boŞ
 
purge
 = 
çl£
;

1089 
rßm_timeout
 = 
BATADV_TT_CLIENT_ROAM_TIMEOUT
;

1090 
‹mp_timeout
 = 
BATADV_TT_CLIENT_TEMP_TIMEOUT
;

1092 ià((
‰_glob®
->
commÚ
.
æags
 & 
BATADV_TT_CLIENT_ROAM
) &&

1093 
	`b©adv_has_timed_out
(
‰_glob®
->
rßm_©
, 
rßm_timeout
)) {

1094 
purge
 = 
Œue
;

1095 *
msg
 = "Roamingimeout\n";

1098 ià((
‰_glob®
->
commÚ
.
æags
 & 
BATADV_TT_CLIENT_TEMP
) &&

1099 
	`b©adv_has_timed_out
(
‰_glob®
->
commÚ
.
added_©
, 
‹mp_timeout
)) {

1100 
purge
 = 
Œue
;

1101 *
msg
 = "Temporary clientimeout\n";

1104  
purge
;

1105 
	}
}

1107 
	$b©adv_‰_glob®_purge
(
b©adv_´iv
 *
b©_´iv
)

1109 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
‰
.
glob®_hash
;

1110 
hli¡_h—d
 *
h—d
;

1111 
hli¡_node
 *
node
, *
node_tmp
;

1112 
¥šlock_t
 *
li¡_lock
;

1113 
ušt32_t
 
i
;

1114 *
msg
 = 
NULL
;

1115 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ
;

1116 
b©adv_‰_glob®_’Œy
 *
‰_glob®
;

1118 
i
 = 0; i < 
hash
->
size
; i++) {

1119 
h—d
 = &
hash
->
bË
[
i
];

1120 
li¡_lock
 = &
hash
->
li¡_locks
[
i
];

1122 
	`¥š_lock_bh
(
li¡_lock
);

1123 
	`hli¡_fÜ_—ch_’Œy_§ã
(
‰_commÚ
, 
node
, 
node_tmp
, 
h—d
,

1124 
hash_’Œy
) {

1125 
‰_glob®
 = 
	`cÚš”_of
(
‰_commÚ
,

1126 
b©adv_‰_glob®_’Œy
,

1127 
commÚ
);

1129 ià(!
	`b©adv_‰_glob®_to_purge
(
‰_glob®
, &
msg
))

1132 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

1134 
‰_glob®
->
commÚ
.
addr
, 
msg
);

1136 
	`hli¡_d–_rcu
(
node
);

1138 
	`b©adv_‰_glob®_’Œy_ä“_»f
(
‰_glob®
);

1140 
	`¥š_uÆock_bh
(
li¡_lock
);

1142 
	}
}

1144 
	$b©adv_‰_glob®_bË_ä“
(
b©adv_´iv
 *
b©_´iv
)

1146 
b©adv_hashbË
 *
hash
;

1147 
¥šlock_t
 *
li¡_lock
;

1148 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ_’Œy
;

1149 
b©adv_‰_glob®_’Œy
 *
‰_glob®
;

1150 
hli¡_node
 *
node
, *
node_tmp
;

1151 
hli¡_h—d
 *
h—d
;

1152 
ušt32_t
 
i
;

1154 ià(!
b©_´iv
->
‰
.
glob®_hash
)

1157 
hash
 = 
b©_´iv
->
‰
.
glob®_hash
;

1159 
i
 = 0; i < 
hash
->
size
; i++) {

1160 
h—d
 = &
hash
->
bË
[
i
];

1161 
li¡_lock
 = &
hash
->
li¡_locks
[
i
];

1163 
	`¥š_lock_bh
(
li¡_lock
);

1164 
	`hli¡_fÜ_—ch_’Œy_§ã
(
‰_commÚ_’Œy
, 
node
, 
node_tmp
,

1165 
h—d
, 
hash_’Œy
) {

1166 
	`hli¡_d–_rcu
(
node
);

1167 
‰_glob®
 = 
	`cÚš”_of
(
‰_commÚ_’Œy
,

1168 
b©adv_‰_glob®_’Œy
,

1169 
commÚ
);

1170 
	`b©adv_‰_glob®_’Œy_ä“_»f
(
‰_glob®
);

1172 
	`¥š_uÆock_bh
(
li¡_lock
);

1175 
	`b©adv_hash_de¡roy
(
hash
);

1177 
b©_´iv
->
‰
.
glob®_hash
 = 
NULL
;

1178 
	}
}

1180 
boŞ


1181 
	$_b©adv_is_­_isŞ©ed
(
b©adv_‰_loÿl_’Œy
 *
‰_loÿl_’Œy
,

1182 
b©adv_‰_glob®_’Œy
 *
‰_glob®_’Œy
)

1184 
boŞ
 
»t
 = 
çl£
;

1186 ià(
‰_loÿl_’Œy
->
commÚ
.
æags
 & 
BATADV_TT_CLIENT_WIFI
 &&

1187 
‰_glob®_’Œy
->
commÚ
.
æags
 & 
BATADV_TT_CLIENT_WIFI
)

1188 
»t
 = 
Œue
;

1190  
»t
;

1191 
	}
}

1193 
b©adv_Üig_node
 *
	$b©adv_Œª¡abË_£¬ch
(
b©adv_´iv
 *
b©_´iv
,

1194 cÚ¡ 
ušt8_t
 *
¤c
,

1195 cÚ¡ 
ušt8_t
 *
addr
)

1197 
b©adv_‰_loÿl_’Œy
 *
‰_loÿl_’Œy
 = 
NULL
;

1198 
b©adv_‰_glob®_’Œy
 *
‰_glob®_’Œy
 = 
NULL
;

1199 
b©adv_Üig_node
 *
Üig_node
 = 
NULL
;

1200 
b©adv_Ãigh_node
 *
rou‹r
 = 
NULL
;

1201 
hli¡_h—d
 *
h—d
;

1202 
hli¡_node
 *
node
;

1203 
b©adv_‰_Üig_li¡_’Œy
 *
Üig_’Œy
;

1204 
be¡_tq
;

1206 ià(
¤c
 && 
	`©omic_»ad
(&
b©_´iv
->
­_isŞ©iÚ
)) {

1207 
‰_loÿl_’Œy
 = 
	`b©adv_‰_loÿl_hash_fšd
(
b©_´iv
, 
¤c
);

1208 ià(!
‰_loÿl_’Œy
)

1209 
out
;

1212 
‰_glob®_’Œy
 = 
	`b©adv_‰_glob®_hash_fšd
(
b©_´iv
, 
addr
);

1213 ià(!
‰_glob®_’Œy
)

1214 
out
;

1219 ià(
‰_loÿl_’Œy
 &&

1220 
	`_b©adv_is_­_isŞ©ed
(
‰_loÿl_’Œy
, 
‰_glob®_’Œy
))

1221 
out
;

1223 
be¡_tq
 = 0;

1225 
	`rcu_»ad_lock
();

1226 
h—d
 = &
‰_glob®_’Œy
->
Üig_li¡
;

1227 
	`hli¡_fÜ_—ch_’Œy_rcu
(
Üig_’Œy
, 
node
, 
h—d
, 
li¡
) {

1228 
rou‹r
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_’Œy
->
Üig_node
);

1229 ià(!
rou‹r
)

1232 ià(
rou‹r
->
tq_avg
 > 
be¡_tq
) {

1233 
Üig_node
 = 
Üig_’Œy
->orig_node;

1234 
be¡_tq
 = 
rou‹r
->
tq_avg
;

1236 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r
);

1239 ià(
Üig_node
 && !
	`©omic_šc_nÙ_z”o
(&Üig_node->
»fcouÁ
))

1240 
Üig_node
 = 
NULL
;

1241 
	`rcu_»ad_uÆock
();

1242 
out
:

1243 ià(
‰_glob®_’Œy
)

1244 
	`b©adv_‰_glob®_’Œy_ä“_»f
(
‰_glob®_’Œy
);

1245 ià(
‰_loÿl_’Œy
)

1246 
	`b©adv_‰_loÿl_’Œy_ä“_»f
(
‰_loÿl_’Œy
);

1248  
Üig_node
;

1249 
	}
}

1252 
ušt16_t
 
	$b©adv_‰_glob®_üc
(
b©adv_´iv
 *
b©_´iv
,

1253 
b©adv_Üig_node
 *
Üig_node
)

1255 
ušt16_t
 
tÙ®
 = 0, 
tÙ®_Úe
;

1256 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
‰
.
glob®_hash
;

1257 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ
;

1258 
b©adv_‰_glob®_’Œy
 *
‰_glob®
;

1259 
hli¡_node
 *
node
;

1260 
hli¡_h—d
 *
h—d
;

1261 
ušt32_t
 
i
;

1262 
j
;

1264 
i
 = 0; i < 
hash
->
size
; i++) {

1265 
h—d
 = &
hash
->
bË
[
i
];

1267 
	`rcu_»ad_lock
();

1268 
	`hli¡_fÜ_—ch_’Œy_rcu
(
‰_commÚ
, 
node
, 
h—d
, 
hash_’Œy
) {

1269 
‰_glob®
 = 
	`cÚš”_of
(
‰_commÚ
,

1270 
b©adv_‰_glob®_’Œy
,

1271 
commÚ
);

1277 ià(
‰_commÚ
->
æags
 & 
BATADV_TT_CLIENT_ROAM
)

1283 ià(
‰_commÚ
->
æags
 & 
BATADV_TT_CLIENT_TEMP
)

1289 ià(!
	`b©adv_‰_glob®_’Œy_has_Üig
(
‰_glob®
,

1290 
Üig_node
))

1293 
tÙ®_Úe
 = 0;

1294 
j
 = 0; j < 
ETH_ALEN
; j++)

1295 
tÙ®_Úe
 = 
	`üc16_by‹
(total_one,

1296 
‰_commÚ
->
addr
[
j
]);

1297 
tÙ®
 ^ğ
tÙ®_Úe
;

1299 
	`rcu_»ad_uÆock
();

1302  
tÙ®
;

1303 
	}
}

1306 
ušt16_t
 
	$b©adv_‰_loÿl_üc
(
b©adv_´iv
 *
b©_´iv
)

1308 
ušt16_t
 
tÙ®
 = 0, 
tÙ®_Úe
;

1309 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
‰
.
loÿl_hash
;

1310 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ
;

1311 
hli¡_node
 *
node
;

1312 
hli¡_h—d
 *
h—d
;

1313 
ušt32_t
 
i
;

1314 
j
;

1316 
i
 = 0; i < 
hash
->
size
; i++) {

1317 
h—d
 = &
hash
->
bË
[
i
];

1319 
	`rcu_»ad_lock
();

1320 
	`hli¡_fÜ_—ch_’Œy_rcu
(
‰_commÚ
, 
node
, 
h—d
, 
hash_’Œy
) {

1324 ià(
‰_commÚ
->
æags
 & 
BATADV_TT_CLIENT_NEW
)

1326 
tÙ®_Úe
 = 0;

1327 
j
 = 0; j < 
ETH_ALEN
; j++)

1328 
tÙ®_Úe
 = 
	`üc16_by‹
(total_one,

1329 
‰_commÚ
->
addr
[
j
]);

1330 
tÙ®
 ^ğ
tÙ®_Úe
;

1332 
	`rcu_»ad_uÆock
();

1335  
tÙ®
;

1336 
	}
}

1338 
	$b©adv_‰_»q_li¡_ä“
(
b©adv_´iv
 *
b©_´iv
)

1340 
b©adv_‰_»q_node
 *
node
, *
§ã
;

1342 
	`¥š_lock_bh
(&
b©_´iv
->
‰
.
»q_li¡_lock
);

1344 
	`li¡_fÜ_—ch_’Œy_§ã
(
node
, 
§ã
, &
b©_´iv
->
‰
.
»q_li¡
, 
li¡
) {

1345 
	`li¡_d–
(&
node
->
li¡
);

1346 
	`kä“
(
node
);

1349 
	`¥š_uÆock_bh
(&
b©_´iv
->
‰
.
»q_li¡_lock
);

1350 
	}
}

1352 
	$b©adv_‰_§ve_Üig_bufãr
(
b©adv_´iv
 *
b©_´iv
,

1353 
b©adv_Üig_node
 *
Üig_node
,

1354 cÚ¡ *
‰_buff
,

1355 
ušt8_t
 
‰_num_chªges
)

1357 
ušt16_t
 
‰_buff_Ën
 = 
	`b©adv_‰_Ën
(
‰_num_chªges
);

1362 
	`¥š_lock_bh
(&
Üig_node
->
‰_buff_lock
);

1363 ià(
‰_buff_Ën
 > 0) {

1364 
	`kä“
(
Üig_node
->
‰_buff
);

1365 
Üig_node
->
‰_buff_Ën
 = 0;

1366 
Üig_node
->
‰_buff
 = 
	`km®loc
(
‰_buff_Ën
, 
GFP_ATOMIC
);

1367 ià(
Üig_node
->
‰_buff
) {

1368 
	`memıy
(
Üig_node
->
‰_buff
,t_buff, 
‰_buff_Ën
);

1369 
Üig_node
->
‰_buff_Ën
 =t_buff_len;

1372 
	`¥š_uÆock_bh
(&
Üig_node
->
‰_buff_lock
);

1373 
	}
}

1375 
	$b©adv_‰_»q_purge
(
b©adv_´iv
 *
b©_´iv
)

1377 
b©adv_‰_»q_node
 *
node
, *
§ã
;

1379 
	`¥š_lock_bh
(&
b©_´iv
->
‰
.
»q_li¡_lock
);

1380 
	`li¡_fÜ_—ch_’Œy_§ã
(
node
, 
§ã
, &
b©_´iv
->
‰
.
»q_li¡
, 
li¡
) {

1381 ià(
	`b©adv_has_timed_out
(
node
->
issued_©
,

1382 
BATADV_TT_REQUEST_TIMEOUT
)) {

1383 
	`li¡_d–
(&
node
->
li¡
);

1384 
	`kä“
(
node
);

1387 
	`¥š_uÆock_bh
(&
b©_´iv
->
‰
.
»q_li¡_lock
);

1388 
	}
}

1393 
b©adv_‰_»q_node
 *

1394 
	$b©adv_Ãw_‰_»q_node
(
b©adv_´iv
 *
b©_´iv
,

1395 
b©adv_Üig_node
 *
Üig_node
)

1397 
b©adv_‰_»q_node
 *
‰_»q_node_tmp
, *
‰_»q_node
 = 
NULL
;

1399 
	`¥š_lock_bh
(&
b©_´iv
->
‰
.
»q_li¡_lock
);

1400 
	`li¡_fÜ_—ch_’Œy
(
‰_»q_node_tmp
, &
b©_´iv
->
‰
.
»q_li¡
, 
li¡
) {

1401 ià(
	`b©adv_com·»_‘h
(
‰_»q_node_tmp
, 
Üig_node
) &&

1402 !
	`b©adv_has_timed_out
(
‰_»q_node_tmp
->
issued_©
,

1403 
BATADV_TT_REQUEST_TIMEOUT
))

1404 
uÆock
;

1407 
‰_»q_node
 = 
	`km®loc
((*‰_»q_node), 
GFP_ATOMIC
);

1408 ià(!
‰_»q_node
)

1409 
uÆock
;

1411 
	`memıy
(
‰_»q_node
->
addr
, 
Üig_node
->
Üig
, 
ETH_ALEN
);

1412 
‰_»q_node
->
issued_©
 = 
jiff›s
;

1414 
	`li¡_add
(&
‰_»q_node
->
li¡
, &
b©_´iv
->
‰
.
»q_li¡
);

1415 
uÆock
:

1416 
	`¥š_uÆock_bh
(&
b©_´iv
->
‰
.
»q_li¡_lock
);

1417  
‰_»q_node
;

1418 
	}
}

1421 
	$b©adv_‰_loÿl_v®id_’Œy
(cÚ¡ *
’Œy_±r
,

1422 cÚ¡ *
d©a_±r
)

1424 cÚ¡ 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ_’Œy
 = 
’Œy_±r
;

1426 ià(
‰_commÚ_’Œy
->
æags
 & 
BATADV_TT_CLIENT_NEW
)

1429 
	}
}

1431 
	$b©adv_‰_glob®_v®id
(cÚ¡ *
’Œy_±r
,

1432 cÚ¡ *
d©a_±r
)

1434 cÚ¡ 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ_’Œy
 = 
’Œy_±r
;

1435 cÚ¡ 
b©adv_‰_glob®_’Œy
 *
‰_glob®_’Œy
;

1436 cÚ¡ 
b©adv_Üig_node
 *
Üig_node
 = 
d©a_±r
;

1438 ià(
‰_commÚ_’Œy
->
æags
 & 
BATADV_TT_CLIENT_ROAM
 ||

1439 
‰_commÚ_’Œy
->
æags
 & 
BATADV_TT_CLIENT_TEMP
)

1442 
‰_glob®_’Œy
 = 
	`cÚš”_of
(
‰_commÚ_’Œy
,

1443 
b©adv_‰_glob®_’Œy
,

1444 
commÚ
);

1446  
	`b©adv_‰_glob®_’Œy_has_Üig
(
‰_glob®_’Œy
, 
Üig_node
);

1447 
	}
}

1449 
sk_buff
 *

1450 
b©adv_‰_»¥Ú£_fl_bË
(
ušt16_t
 
‰_Ën
, 
ušt8_t
 
‰vn
,

1451 
b©adv_hashbË
 *
hash
,

1452 
b©adv_h¬d_içû
 *
´im¬y_if
,

1453 (*
v®id_cb
)(const *, const *),

1454 *
cb_d©a
)

1456 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ_’Œy
;

1457 
b©adv_‰_qu”y_·ck‘
 *
‰_»¥Ú£
;

1458 
b©adv_‰_chªge
 *
‰_chªge
;

1459 
hli¡_node
 *
node
;

1460 
hli¡_h—d
 *
h—d
;

1461 
sk_buff
 *
skb
 = 
NULL
;

1462 
ušt16_t
 
‰_tÙ
, 
‰_couÁ
;

1463 
ssize_t
 
‰_qu”y_size
 = (
b©adv_‰_qu”y_·ck‘
);

1464 
ušt32_t
 
i
;

1465 
size_t
 
Ën
;

1467 ià(
‰_qu”y_size
 + 
‰_Ën
 > 
´im¬y_if
->
soá_içû
->
mtu
) {

1468 
‰_Ën
 = 
´im¬y_if
->
soá_içû
->
mtu
 - 
‰_qu”y_size
;

1469 
‰_Ën
 -ğ‰_ËÀ% (
b©adv_‰_chªge
);

1471 
‰_tÙ
 = 
‰_Ën
 / (
b©adv_‰_chªge
);

1473 
Ën
 = 
‰_qu”y_size
 + 
‰_Ën
;

1474 
skb
 = 
	`dev_®loc_skb
(
Ën
 + 
ETH_HLEN
);

1475 ià(!
skb
)

1476 
out
;

1478 
	`skb_»£rve
(
skb
, 
ETH_HLEN
);

1479 
‰_»¥Ú£
 = (
b©adv_‰_qu”y_·ck‘
 *)
	`skb_put
(
skb
, 
Ën
);

1480 
‰_»¥Ú£
->
‰vn
 =tvn;

1482 
‰_chªge
 = (
b©adv_‰_chªge
 *)(
skb
->
d©a
 + 
‰_qu”y_size
);

1483 
‰_couÁ
 = 0;

1485 
	`rcu_»ad_lock
();

1486 
i
 = 0; i < 
hash
->
size
; i++) {

1487 
h—d
 = &
hash
->
bË
[
i
];

1489 
	`hli¡_fÜ_—ch_’Œy_rcu
(
‰_commÚ_’Œy
, 
node
,

1490 
h—d
, 
hash_’Œy
) {

1491 ià(
‰_couÁ
 =ğ
‰_tÙ
)

1494 ià((
v®id_cb
è&& (!
	`v®id_cb
(
‰_commÚ_’Œy
, 
cb_d©a
)))

1497 
	`memıy
(
‰_chªge
->
addr
, 
‰_commÚ_’Œy
->addr,

1498 
ETH_ALEN
);

1499 
‰_chªge
->
æags
 = 
BATADV_NO_FLAGS
;

1501 
‰_couÁ
++;

1502 
‰_chªge
++;

1505 
	`rcu_»ad_uÆock
();

1510 
‰_»¥Ú£
->
‰_d©a
 = 
	`htÚs
(
‰_couÁ
);

1512 
out
:

1513  
skb
;

1514 
	}
}

1516 
	$b©adv_£nd_‰_»que¡
(
b©adv_´iv
 *
b©_´iv
,

1517 
b©adv_Üig_node
 *
d¡_Üig_node
,

1518 
ušt8_t
 
‰vn
, 
ušt16_t
 
‰_üc
,

1519 
boŞ
 
fuÎ_bË
)

1521 
sk_buff
 *
skb
 = 
NULL
;

1522 
b©adv_‰_qu”y_·ck‘
 *
‰_»que¡
;

1523 
b©adv_Ãigh_node
 *
Ãigh_node
 = 
NULL
;

1524 
b©adv_h¬d_içû
 *
´im¬y_if
;

1525 
b©adv_‰_»q_node
 *
‰_»q_node
 = 
NULL
;

1526 
»t
 = 1;

1527 
size_t
 
‰_»q_Ën
;

1529 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

1530 ià(!
´im¬y_if
)

1531 
out
;

1536 
‰_»q_node
 = 
	`b©adv_Ãw_‰_»q_node
(
b©_´iv
, 
d¡_Üig_node
);

1537 ià(!
‰_»q_node
)

1538 
out
;

1540 
skb
 = 
	`dev_®loc_skb
((*
‰_»que¡
è+ 
ETH_HLEN
);

1541 ià(!
skb
)

1542 
out
;

1544 
	`skb_»£rve
(
skb
, 
ETH_HLEN
);

1546 
‰_»q_Ën
 = (*
‰_»que¡
);

1547 
‰_»que¡
 = (
b©adv_‰_qu”y_·ck‘
 *)
	`skb_put
(
skb
, 
‰_»q_Ën
);

1549 
‰_»que¡
->
h—d”
.
·ck‘_ty³
 = 
BATADV_TT_QUERY
;

1550 
‰_»que¡
->
h—d”
.
v”siÚ
 = 
BATADV_COMPAT_VERSION
;

1551 
	`memıy
(
‰_»que¡
->
¤c
, 
´im¬y_if
->
Ãt_dev
->
dev_addr
, 
ETH_ALEN
);

1552 
	`memıy
(
‰_»que¡
->
d¡
, 
d¡_Üig_node
->
Üig
, 
ETH_ALEN
);

1553 
‰_»que¡
->
h—d”
.
‰l
 = 
BATADV_TTL
;

1554 
‰_»que¡
->
‰vn
 =tvn;

1555 
‰_»que¡
->
‰_d©a
 = 
	`htÚs
(
‰_üc
);

1556 
‰_»que¡
->
æags
 = 
BATADV_TT_REQUEST
;

1558 ià(
fuÎ_bË
)

1559 
‰_»que¡
->
æags
 |ğ
BATADV_TT_FULL_TABLE
;

1561 
Ãigh_node
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
d¡_Üig_node
);

1562 ià(!
Ãigh_node
)

1563 
out
;

1565 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

1567 
d¡_Üig_node
->
Üig
, 
Ãigh_node
->
addr
,

1568 (
fuÎ_bË
 ? 'F' : '.'));

1570 
	`b©adv_šc_couÁ”
(
b©_´iv
, 
BATADV_CNT_TT_REQUEST_TX
);

1572 
	`b©adv_£nd_skb_·ck‘
(
skb
, 
Ãigh_node
->
if_šcomšg
,‚eigh_node->
addr
);

1573 
»t
 = 0;

1575 
out
:

1576 ià(
Ãigh_node
)

1577 
	`b©adv_Ãigh_node_ä“_»f
(
Ãigh_node
);

1578 ià(
´im¬y_if
)

1579 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

1580 ià(
»t
)

1581 
	`kä“_skb
(
skb
);

1582 ià(
»t
 && 
‰_»q_node
) {

1583 
	`¥š_lock_bh
(&
b©_´iv
->
‰
.
»q_li¡_lock
);

1584 
	`li¡_d–
(&
‰_»q_node
->
li¡
);

1585 
	`¥š_uÆock_bh
(&
b©_´iv
->
‰
.
»q_li¡_lock
);

1586 
	`kä“
(
‰_»q_node
);

1588  
»t
;

1589 
	}
}

1591 
boŞ


1592 
	$b©adv_£nd_Ùh”_‰_»¥Ú£
(
b©adv_´iv
 *
b©_´iv
,

1593 
b©adv_‰_qu”y_·ck‘
 *
‰_»que¡
)

1595 
b©adv_Üig_node
 *
»q_d¡_Üig_node
 = 
NULL
;

1596 
b©adv_Üig_node
 *
»s_d¡_Üig_node
 = 
NULL
;

1597 
b©adv_Ãigh_node
 *
Ãigh_node
 = 
NULL
;

1598 
b©adv_h¬d_içû
 *
´im¬y_if
 = 
NULL
;

1599 
ušt8_t
 
Üig_‰vn
, 
»q_‰vn
, 
‰vn
;

1600 
»t
 = 
çl£
;

1601 *
‰_buff
;

1602 
boŞ
 
fuÎ_bË
;

1603 
ušt16_t
 
‰_Ën
, 
‰_tÙ
;

1604 
sk_buff
 *
skb
 = 
NULL
;

1605 
b©adv_‰_qu”y_·ck‘
 *
‰_»¥Ú£
;

1606 
ušt8_t
 *
·ck‘_pos
;

1607 
size_t
 
Ën
;

1609 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

1611 
‰_»que¡
->
¤c
,t_»que¡->
‰vn
,t_»que¡->
d¡
,

1612 (
‰_»que¡
->
æags
 & 
BATADV_TT_FULL_TABLE
 ? 'F' : '.'));

1615 
»q_d¡_Üig_node
 = 
	`b©adv_Üig_hash_fšd
(
b©_´iv
, 
‰_»que¡
->
d¡
);

1616 ià(!
»q_d¡_Üig_node
)

1617 
out
;

1619 
»s_d¡_Üig_node
 = 
	`b©adv_Üig_hash_fšd
(
b©_´iv
, 
‰_»que¡
->
¤c
);

1620 ià(!
»s_d¡_Üig_node
)

1621 
out
;

1623 
Ãigh_node
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
»s_d¡_Üig_node
);

1624 ià(!
Ãigh_node
)

1625 
out
;

1627 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

1628 ià(!
´im¬y_if
)

1629 
out
;

1631 
Üig_‰vn
 = (
ušt8_t
)
	`©omic_»ad
(&
»q_d¡_Üig_node
->
Ï¡_‰vn
);

1632 
»q_‰vn
 = 
‰_»que¡
->
‰vn
;

1635 ià(
Üig_‰vn
 !ğ
»q_‰vn
 ||

1636 
‰_»que¡
->
‰_d©a
 !ğ
	`htÚs
(
»q_d¡_Üig_node
->
‰_üc
))

1637 
out
;

1640 ià(
‰_»que¡
->
æags
 & 
BATADV_TT_FULL_TABLE
 ||

1641 !
»q_d¡_Üig_node
->
‰_buff
)

1642 
fuÎ_bË
 = 
Œue
;

1644 
fuÎ_bË
 = 
çl£
;

1649 ià(!
fuÎ_bË
) {

1650 
	`¥š_lock_bh
(&
»q_d¡_Üig_node
->
‰_buff_lock
);

1651 
‰_Ën
 = 
»q_d¡_Üig_node
->
‰_buff_Ën
;

1652 
‰_tÙ
 = 
‰_Ën
 / (
b©adv_‰_chªge
);

1654 
Ën
 = (*
‰_»¥Ú£
è+ 
‰_Ën
;

1655 
skb
 = 
	`dev_®loc_skb
(
Ën
 + 
ETH_HLEN
);

1656 ià(!
skb
)

1657 
uÆock
;

1659 
	`skb_»£rve
(
skb
, 
ETH_HLEN
);

1660 
·ck‘_pos
 = 
	`skb_put
(
skb
, 
Ën
);

1661 
‰_»¥Ú£
 = (
b©adv_‰_qu”y_·ck‘
 *)
·ck‘_pos
;

1662 
‰_»¥Ú£
->
‰vn
 = 
»q_‰vn
;

1663 
‰_»¥Ú£
->
‰_d©a
 = 
	`htÚs
(
‰_tÙ
);

1665 
‰_buff
 = 
skb
->
d©a
 + (*
‰_»¥Ú£
);

1667 
	`memıy
(
‰_buff
, 
»q_d¡_Üig_node
->tt_buff,

1668 
»q_d¡_Üig_node
->
‰_buff_Ën
);

1670 
	`¥š_uÆock_bh
(&
»q_d¡_Üig_node
->
‰_buff_lock
);

1672 
‰_Ën
 = (
ušt16_t
)
	`©omic_»ad
(&
»q_d¡_Üig_node
->
‰_size
);

1673 
‰_Ën
 *ğ(
b©adv_‰_chªge
);

1674 
‰vn
 = (
ušt8_t
)
	`©omic_»ad
(&
»q_d¡_Üig_node
->
Ï¡_‰vn
);

1676 
skb
 = 
	`b©adv_‰_»¥Ú£_fl_bË
(
‰_Ën
, 
‰vn
,

1677 
b©_´iv
->
‰
.
glob®_hash
,

1678 
´im¬y_if
,

1679 
b©adv_‰_glob®_v®id
,

1680 
»q_d¡_Üig_node
);

1681 ià(!
skb
)

1682 
out
;

1684 
‰_»¥Ú£
 = (
b©adv_‰_qu”y_·ck‘
 *)
skb
->
d©a
;

1687 
‰_»¥Ú£
->
h—d”
.
·ck‘_ty³
 = 
BATADV_TT_QUERY
;

1688 
‰_»¥Ú£
->
h—d”
.
v”siÚ
 = 
BATADV_COMPAT_VERSION
;

1689 
‰_»¥Ú£
->
h—d”
.
‰l
 = 
BATADV_TTL
;

1690 
	`memıy
(
‰_»¥Ú£
->
¤c
, 
»q_d¡_Üig_node
->
Üig
, 
ETH_ALEN
);

1691 
	`memıy
(
‰_»¥Ú£
->
d¡
, 
‰_»que¡
->
¤c
, 
ETH_ALEN
);

1692 
‰_»¥Ú£
->
æags
 = 
BATADV_TT_RESPONSE
;

1694 ià(
fuÎ_bË
)

1695 
‰_»¥Ú£
->
æags
 |ğ
BATADV_TT_FULL_TABLE
;

1697 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

1699 
»s_d¡_Üig_node
->
Üig
, 
Ãigh_node
->
addr
,

1700 
»q_d¡_Üig_node
->
Üig
, 
»q_‰vn
);

1702 
	`b©adv_šc_couÁ”
(
b©_´iv
, 
BATADV_CNT_TT_RESPONSE_TX
);

1704 
	`b©adv_£nd_skb_·ck‘
(
skb
, 
Ãigh_node
->
if_šcomšg
,‚eigh_node->
addr
);

1705 
»t
 = 
Œue
;

1706 
out
;

1708 
uÆock
:

1709 
	`¥š_uÆock_bh
(&
»q_d¡_Üig_node
->
‰_buff_lock
);

1711 
out
:

1712 ià(
»s_d¡_Üig_node
)

1713 
	`b©adv_Üig_node_ä“_»f
(
»s_d¡_Üig_node
);

1714 ià(
»q_d¡_Üig_node
)

1715 
	`b©adv_Üig_node_ä“_»f
(
»q_d¡_Üig_node
);

1716 ià(
Ãigh_node
)

1717 
	`b©adv_Ãigh_node_ä“_»f
(
Ãigh_node
);

1718 ià(
´im¬y_if
)

1719 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

1720 ià(!
»t
)

1721 
	`kä“_skb
(
skb
);

1722  
»t
;

1724 
	}
}

1726 
boŞ


1727 
	$b©adv_£nd_my_‰_»¥Ú£
(
b©adv_´iv
 *
b©_´iv
,

1728 
b©adv_‰_qu”y_·ck‘
 *
‰_»que¡
)

1730 
b©adv_Üig_node
 *
Üig_node
 = 
NULL
;

1731 
b©adv_Ãigh_node
 *
Ãigh_node
 = 
NULL
;

1732 
b©adv_h¬d_içû
 *
´im¬y_if
 = 
NULL
;

1733 
ušt8_t
 
my_‰vn
, 
»q_‰vn
, 
‰vn
;

1734 
»t
 = 
çl£
;

1735 *
‰_buff
;

1736 
boŞ
 
fuÎ_bË
;

1737 
ušt16_t
 
‰_Ën
, 
‰_tÙ
;

1738 
sk_buff
 *
skb
 = 
NULL
;

1739 
b©adv_‰_qu”y_·ck‘
 *
‰_»¥Ú£
;

1740 
ušt8_t
 *
·ck‘_pos
;

1741 
size_t
 
Ën
;

1743 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

1745 
‰_»que¡
->
¤c
,t_»que¡->
‰vn
,

1746 (
‰_»que¡
->
æags
 & 
BATADV_TT_FULL_TABLE
 ? 'F' : '.'));

1749 
my_‰vn
 = (
ušt8_t
)
	`©omic_»ad
(&
b©_´iv
->
‰
.
vn
);

1750 
»q_‰vn
 = 
‰_»que¡
->
‰vn
;

1752 
Üig_node
 = 
	`b©adv_Üig_hash_fšd
(
b©_´iv
, 
‰_»que¡
->
¤c
);

1753 ià(!
Üig_node
)

1754 
out
;

1756 
Ãigh_node
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_node
);

1757 ià(!
Ãigh_node
)

1758 
out
;

1760 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

1761 ià(!
´im¬y_if
)

1762 
out
;

1767 ià(
‰_»que¡
->
æags
 & 
BATADV_TT_FULL_TABLE
 || 
my_‰vn
 !ğ
»q_‰vn
 ||

1768 !
b©_´iv
->
‰
.
Ï¡_chªge£t
)

1769 
fuÎ_bË
 = 
Œue
;

1771 
fuÎ_bË
 = 
çl£
;

1776 ià(!
fuÎ_bË
) {

1777 
	`¥š_lock_bh
(&
b©_´iv
->
‰
.
Ï¡_chªge£t_lock
);

1778 
‰_Ën
 = 
b©_´iv
->
‰
.
Ï¡_chªge£t_Ën
;

1779 
‰_tÙ
 = 
‰_Ën
 / (
b©adv_‰_chªge
);

1781 
Ën
 = (*
‰_»¥Ú£
è+ 
‰_Ën
;

1782 
skb
 = 
	`dev_®loc_skb
(
Ën
 + 
ETH_HLEN
);

1783 ià(!
skb
)

1784 
uÆock
;

1786 
	`skb_»£rve
(
skb
, 
ETH_HLEN
);

1787 
·ck‘_pos
 = 
	`skb_put
(
skb
, 
Ën
);

1788 
‰_»¥Ú£
 = (
b©adv_‰_qu”y_·ck‘
 *)
·ck‘_pos
;

1789 
‰_»¥Ú£
->
‰vn
 = 
»q_‰vn
;

1790 
‰_»¥Ú£
->
‰_d©a
 = 
	`htÚs
(
‰_tÙ
);

1792 
‰_buff
 = 
skb
->
d©a
 + (*
‰_»¥Ú£
);

1793 
	`memıy
(
‰_buff
, 
b©_´iv
->
‰
.
Ï¡_chªge£t
,

1794 
b©_´iv
->
‰
.
Ï¡_chªge£t_Ën
);

1795 
	`¥š_uÆock_bh
(&
b©_´iv
->
‰
.
Ï¡_chªge£t_lock
);

1797 
‰_Ën
 = (
ušt16_t
)
	`©omic_»ad
(&
b©_´iv
->
‰
.
loÿl_’Œy_num
);

1798 
‰_Ën
 *ğ(
b©adv_‰_chªge
);

1799 
‰vn
 = (
ušt8_t
)
	`©omic_»ad
(&
b©_´iv
->
‰
.
vn
);

1801 
skb
 = 
	`b©adv_‰_»¥Ú£_fl_bË
(
‰_Ën
, 
‰vn
,

1802 
b©_´iv
->
‰
.
loÿl_hash
,

1803 
´im¬y_if
,

1804 
b©adv_‰_loÿl_v®id_’Œy
,

1805 
NULL
);

1806 ià(!
skb
)

1807 
out
;

1809 
‰_»¥Ú£
 = (
b©adv_‰_qu”y_·ck‘
 *)
skb
->
d©a
;

1812 
‰_»¥Ú£
->
h—d”
.
·ck‘_ty³
 = 
BATADV_TT_QUERY
;

1813 
‰_»¥Ú£
->
h—d”
.
v”siÚ
 = 
BATADV_COMPAT_VERSION
;

1814 
‰_»¥Ú£
->
h—d”
.
‰l
 = 
BATADV_TTL
;

1815 
	`memıy
(
‰_»¥Ú£
->
¤c
, 
´im¬y_if
->
Ãt_dev
->
dev_addr
, 
ETH_ALEN
);

1816 
	`memıy
(
‰_»¥Ú£
->
d¡
, 
‰_»que¡
->
¤c
, 
ETH_ALEN
);

1817 
‰_»¥Ú£
->
æags
 = 
BATADV_TT_RESPONSE
;

1819 ià(
fuÎ_bË
)

1820 
‰_»¥Ú£
->
æags
 |ğ
BATADV_TT_FULL_TABLE
;

1822 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

1824 
Üig_node
->
Üig
, 
Ãigh_node
->
addr
,

1825 (
‰_»¥Ú£
->
æags
 & 
BATADV_TT_FULL_TABLE
 ? 'F' : '.'));

1827 
	`b©adv_šc_couÁ”
(
b©_´iv
, 
BATADV_CNT_TT_RESPONSE_TX
);

1829 
	`b©adv_£nd_skb_·ck‘
(
skb
, 
Ãigh_node
->
if_šcomšg
,‚eigh_node->
addr
);

1830 
»t
 = 
Œue
;

1831 
out
;

1833 
uÆock
:

1834 
	`¥š_uÆock_bh
(&
b©_´iv
->
‰
.
Ï¡_chªge£t_lock
);

1835 
out
:

1836 ià(
Üig_node
)

1837 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

1838 ià(
Ãigh_node
)

1839 
	`b©adv_Ãigh_node_ä“_»f
(
Ãigh_node
);

1840 ià(
´im¬y_if
)

1841 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

1842 ià(!
»t
)

1843 
	`kä“_skb
(
skb
);

1845  
Œue
;

1846 
	}
}

1848 
boŞ
 
	$b©adv_£nd_‰_»¥Ú£
(
b©adv_´iv
 *
b©_´iv
,

1849 
b©adv_‰_qu”y_·ck‘
 *
‰_»que¡
)

1851 ià(
	`b©adv_is_my_mac
(
‰_»que¡
->
d¡
)) {

1853 ià(
	`b©adv_bÏ_is_backbÚe_gw_Üig
(
b©_´iv
, 
‰_»que¡
->
¤c
))

1854  
Œue
;

1856  
	`b©adv_£nd_my_‰_»¥Ú£
(
b©_´iv
, 
‰_»que¡
);

1858  
	`b©adv_£nd_Ùh”_‰_»¥Ú£
(
b©_´iv
, 
‰_»que¡
);

1860 
	}
}

1862 
	$_b©adv_‰_upd©e_chªges
(
b©adv_´iv
 *
b©_´iv
,

1863 
b©adv_Üig_node
 *
Üig_node
,

1864 
b©adv_‰_chªge
 *
‰_chªge
,

1865 
ušt16_t
 
‰_num_chªges
, 
ušt8_t
 
‰vn
)

1867 
i
;

1868 
rßms
;

1870 
i
 = 0; i < 
‰_num_chªges
; i++) {

1871 ià((
‰_chªge
 + 
i
)->
æags
 & 
BATADV_TT_CLIENT_DEL
) {

1872 
rßms
 = (
‰_chªge
 + 
i
)->
æags
 & 
BATADV_TT_CLIENT_ROAM
;

1873 
	`b©adv_‰_glob®_d–
(
b©_´iv
, 
Üig_node
,

1874 (
‰_chªge
 + 
i
)->
addr
,

1876 
rßms
);

1878 ià(!
	`b©adv_‰_glob®_add
(
b©_´iv
, 
Üig_node
,

1879 (
‰_chªge
 + 
i
)->
addr
,

1880 (
‰_chªge
 + 
i
)->
æags
, 
‰vn
))

1890 
Üig_node
->
‰_š™Ÿli£d
 = 
Œue
;

1891 
	}
}

1893 
	$b©adv_‰_fl_gbË
(
b©adv_´iv
 *
b©_´iv
,

1894 
b©adv_‰_qu”y_·ck‘
 *
‰_»¥Ú£
)

1896 
b©adv_Üig_node
 *
Üig_node
 = 
NULL
;

1898 
Üig_node
 = 
	`b©adv_Üig_hash_fšd
(
b©_´iv
, 
‰_»¥Ú£
->
¤c
);

1899 ià(!
Üig_node
)

1900 
out
;

1903 
	`b©adv_‰_glob®_d–_Üig
(
b©_´iv
, 
Üig_node
, "Received fullable");

1905 
	`_b©adv_‰_upd©e_chªges
(
b©_´iv
, 
Üig_node
,

1906 (
b©adv_‰_chªge
 *)(
‰_»¥Ú£
 + 1),

1907 
	`Áohs
(
‰_»¥Ú£
->
‰_d©a
),

1908 
‰_»¥Ú£
->
‰vn
);

1910 
	`¥š_lock_bh
(&
Üig_node
->
‰_buff_lock
);

1911 
	`kä“
(
Üig_node
->
‰_buff
);

1912 
Üig_node
->
‰_buff_Ën
 = 0;

1913 
Üig_node
->
‰_buff
 = 
NULL
;

1914 
	`¥š_uÆock_bh
(&
Üig_node
->
‰_buff_lock
);

1916 
	`©omic_£t
(&
Üig_node
->
Ï¡_‰vn
, 
‰_»¥Ú£
->
‰vn
);

1918 
out
:

1919 ià(
Üig_node
)

1920 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

1921 
	}
}

1923 
	$b©adv_‰_upd©e_chªges
(
b©adv_´iv
 *
b©_´iv
,

1924 
b©adv_Üig_node
 *
Üig_node
,

1925 
ušt16_t
 
‰_num_chªges
, 
ušt8_t
 
‰vn
,

1926 
b©adv_‰_chªge
 *
‰_chªge
)

1928 
	`_b©adv_‰_upd©e_chªges
(
b©_´iv
, 
Üig_node
, 
‰_chªge
,

1929 
‰_num_chªges
, 
‰vn
);

1931 
	`b©adv_‰_§ve_Üig_bufãr
(
b©_´iv
, 
Üig_node
,

1932 (*)
‰_chªge
, 
‰_num_chªges
);

1933 
	`©omic_£t
(&
Üig_node
->
Ï¡_‰vn
, 
‰vn
);

1934 
	}
}

1936 
boŞ
 
	$b©adv_is_my_ş›Á
(
b©adv_´iv
 *
b©_´iv
, cÚ¡ 
ušt8_t
 *
addr
)

1938 
b©adv_‰_loÿl_’Œy
 *
‰_loÿl_’Œy
 = 
NULL
;

1939 
boŞ
 
»t
 = 
çl£
;

1941 
‰_loÿl_’Œy
 = 
	`b©adv_‰_loÿl_hash_fšd
(
b©_´iv
, 
addr
);

1942 ià(!
‰_loÿl_’Œy
)

1943 
out
;

1947 ià(
‰_loÿl_’Œy
->
commÚ
.
æags
 & 
BATADV_TT_CLIENT_PENDING
)

1948 
out
;

1949 
»t
 = 
Œue
;

1950 
out
:

1951 ià(
‰_loÿl_’Œy
)

1952 
	`b©adv_‰_loÿl_’Œy_ä“_»f
(
‰_loÿl_’Œy
);

1953  
»t
;

1954 
	}
}

1956 
	$b©adv_hªdË_‰_»¥Ú£
(
b©adv_´iv
 *
b©_´iv
,

1957 
b©adv_‰_qu”y_·ck‘
 *
‰_»¥Ú£
)

1959 
b©adv_‰_»q_node
 *
node
, *
§ã
;

1960 
b©adv_Üig_node
 *
Üig_node
 = 
NULL
;

1961 
b©adv_‰_chªge
 *
‰_chªge
;

1963 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

1965 
‰_»¥Ú£
->
¤c
,t_»¥Ú£->
‰vn
,

1966 
	`Áohs
(
‰_»¥Ú£
->
‰_d©a
),

1967 (
‰_»¥Ú£
->
æags
 & 
BATADV_TT_FULL_TABLE
 ? 'F' : '.'));

1970 ià(
	`b©adv_bÏ_is_backbÚe_gw_Üig
(
b©_´iv
, 
‰_»¥Ú£
->
¤c
))

1971 
out
;

1973 
Üig_node
 = 
	`b©adv_Üig_hash_fšd
(
b©_´iv
, 
‰_»¥Ú£
->
¤c
);

1974 ià(!
Üig_node
)

1975 
out
;

1977 ià(
‰_»¥Ú£
->
æags
 & 
BATADV_TT_FULL_TABLE
) {

1978 
	`b©adv_‰_fl_gbË
(
b©_´iv
, 
‰_»¥Ú£
);

1980 
‰_chªge
 = (
b©adv_‰_chªge
 *)(
‰_»¥Ú£
 + 1);

1981 
	`b©adv_‰_upd©e_chªges
(
b©_´iv
, 
Üig_node
,

1982 
	`Áohs
(
‰_»¥Ú£
->
‰_d©a
),

1983 
‰_»¥Ú£
->
‰vn
, 
‰_chªge
);

1987 
	`¥š_lock_bh
(&
b©_´iv
->
‰
.
»q_li¡_lock
);

1988 
	`li¡_fÜ_—ch_’Œy_§ã
(
node
, 
§ã
, &
b©_´iv
->
‰
.
»q_li¡
, 
li¡
) {

1989 ià(!
	`b©adv_com·»_‘h
(
node
->
addr
, 
‰_»¥Ú£
->
¤c
))

1991 
	`li¡_d–
(&
node
->
li¡
);

1992 
	`kä“
(
node
);

1994 
	`¥š_uÆock_bh
(&
b©_´iv
->
‰
.
»q_li¡_lock
);

1997 
Üig_node
->
‰_üc
 = 
	`b©adv_‰_glob®_üc
(
b©_´iv
, orig_node);

2001 
Üig_node
->
‰_poss_chªge
 = 
çl£
;

2002 
out
:

2003 ià(
Üig_node
)

2004 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

2005 
	}
}

2007 
	$b©adv_‰_š™
(
b©adv_´iv
 *
b©_´iv
)

2009 
»t
;

2011 
»t
 = 
	`b©adv_‰_loÿl_š™
(
b©_´iv
);

2012 ià(
»t
 < 0)

2013  
»t
;

2015 
»t
 = 
	`b©adv_‰_glob®_š™
(
b©_´iv
);

2016 ià(
»t
 < 0)

2017  
»t
;

2019 
	`b©adv_‰_¡¬t_tim”
(
b©_´iv
);

2022 
	}
}

2024 
	$b©adv_‰_rßm_li¡_ä“
(
b©adv_´iv
 *
b©_´iv
)

2026 
b©adv_‰_rßm_node
 *
node
, *
§ã
;

2028 
	`¥š_lock_bh
(&
b©_´iv
->
‰
.
rßm_li¡_lock
);

2030 
	`li¡_fÜ_—ch_’Œy_§ã
(
node
, 
§ã
, &
b©_´iv
->
‰
.
rßm_li¡
, 
li¡
) {

2031 
	`li¡_d–
(&
node
->
li¡
);

2032 
	`kä“
(
node
);

2035 
	`¥š_uÆock_bh
(&
b©_´iv
->
‰
.
rßm_li¡_lock
);

2036 
	}
}

2038 
	$b©adv_‰_rßm_purge
(
b©adv_´iv
 *
b©_´iv
)

2040 
b©adv_‰_rßm_node
 *
node
, *
§ã
;

2042 
	`¥š_lock_bh
(&
b©_´iv
->
‰
.
rßm_li¡_lock
);

2043 
	`li¡_fÜ_—ch_’Œy_§ã
(
node
, 
§ã
, &
b©_´iv
->
‰
.
rßm_li¡
, 
li¡
) {

2044 ià(!
	`b©adv_has_timed_out
(
node
->
fœ¡_time
,

2045 
BATADV_ROAMING_MAX_TIME
))

2048 
	`li¡_d–
(&
node
->
li¡
);

2049 
	`kä“
(
node
);

2051 
	`¥š_uÆock_bh
(&
b©_´iv
->
‰
.
rßm_li¡_lock
);

2052 
	}
}

2060 
boŞ
 
	$b©adv_‰_check_rßm_couÁ
(
b©adv_´iv
 *
b©_´iv
,

2061 
ušt8_t
 *
ş›Á
)

2063 
b©adv_‰_rßm_node
 *
‰_rßm_node
;

2064 
boŞ
 
»t
 = 
çl£
;

2066 
	`¥š_lock_bh
(&
b©_´iv
->
‰
.
rßm_li¡_lock
);

2070 
	`li¡_fÜ_—ch_’Œy
(
‰_rßm_node
, &
b©_´iv
->
‰
.
rßm_li¡
, 
li¡
) {

2071 ià(!
	`b©adv_com·»_‘h
(
‰_rßm_node
->
addr
, 
ş›Á
))

2074 ià(
	`b©adv_has_timed_out
(
‰_rßm_node
->
fœ¡_time
,

2075 
BATADV_ROAMING_MAX_TIME
))

2078 ià(!
	`b©adv_©omic_dec_nÙ_z”o
(&
‰_rßm_node
->
couÁ”
))

2080 
uÆock
;

2081 
»t
 = 
Œue
;

2085 ià(!
»t
) {

2086 
‰_rßm_node
 = 
	`km®loc
((*‰_rßm_node), 
GFP_ATOMIC
);

2087 ià(!
‰_rßm_node
)

2088 
uÆock
;

2090 
‰_rßm_node
->
fœ¡_time
 = 
jiff›s
;

2091 
	`©omic_£t
(&
‰_rßm_node
->
couÁ”
,

2092 
BATADV_ROAMING_MAX_COUNT
 - 1);

2093 
	`memıy
(
‰_rßm_node
->
addr
, 
ş›Á
, 
ETH_ALEN
);

2095 
	`li¡_add
(&
‰_rßm_node
->
li¡
, &
b©_´iv
->
‰
.
rßm_li¡
);

2096 
»t
 = 
Œue
;

2099 
uÆock
:

2100 
	`¥š_uÆock_bh
(&
b©_´iv
->
‰
.
rßm_li¡_lock
);

2101  
»t
;

2102 
	}
}

2104 
	$b©adv_£nd_rßm_adv
(
b©adv_´iv
 *
b©_´iv
, 
ušt8_t
 *
ş›Á
,

2105 
b©adv_Üig_node
 *
Üig_node
)

2107 
b©adv_Ãigh_node
 *
Ãigh_node
 = 
NULL
;

2108 
sk_buff
 *
skb
 = 
NULL
;

2109 
b©adv_rßm_adv_·ck‘
 *
rßm_adv_·ck‘
;

2110 
»t
 = 1;

2111 
b©adv_h¬d_içû
 *
´im¬y_if
;

2112 
size_t
 
Ën
 = (*
rßm_adv_·ck‘
);

2117 ià(!
	`b©adv_‰_check_rßm_couÁ
(
b©_´iv
, 
ş›Á
))

2118 
out
;

2120 
skb
 = 
	`dev_®loc_skb
((*
rßm_adv_·ck‘
è+ 
ETH_HLEN
);

2121 ià(!
skb
)

2122 
out
;

2124 
	`skb_»£rve
(
skb
, 
ETH_HLEN
);

2126 
rßm_adv_·ck‘
 = (
b©adv_rßm_adv_·ck‘
 *)
	`skb_put
(
skb
, 
Ën
);

2128 
rßm_adv_·ck‘
->
h—d”
.
·ck‘_ty³
 = 
BATADV_ROAM_ADV
;

2129 
rßm_adv_·ck‘
->
h—d”
.
v”siÚ
 = 
BATADV_COMPAT_VERSION
;

2130 
rßm_adv_·ck‘
->
h—d”
.
‰l
 = 
BATADV_TTL
;

2131 
rßm_adv_·ck‘
->
»£rved
 = 0;

2132 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

2133 ià(!
´im¬y_if
)

2134 
out
;

2135 
	`memıy
(
rßm_adv_·ck‘
->
¤c
, 
´im¬y_if
->
Ãt_dev
->
dev_addr
, 
ETH_ALEN
);

2136 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

2137 
	`memıy
(
rßm_adv_·ck‘
->
d¡
, 
Üig_node
->
Üig
, 
ETH_ALEN
);

2138 
	`memıy
(
rßm_adv_·ck‘
->
ş›Á
, cl›Á, 
ETH_ALEN
);

2140 
Ãigh_node
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_node
);

2141 ià(!
Ãigh_node
)

2142 
out
;

2144 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

2146 
Üig_node
->
Üig
, 
ş›Á
, 
Ãigh_node
->
addr
);

2148 
	`b©adv_šc_couÁ”
(
b©_´iv
, 
BATADV_CNT_TT_ROAM_ADV_TX
);

2150 
	`b©adv_£nd_skb_·ck‘
(
skb
, 
Ãigh_node
->
if_šcomšg
,‚eigh_node->
addr
);

2151 
»t
 = 0;

2153 
out
:

2154 ià(
Ãigh_node
)

2155 
	`b©adv_Ãigh_node_ä“_»f
(
Ãigh_node
);

2156 ià(
»t
)

2157 
	`kä“_skb
(
skb
);

2159 
	}
}

2161 
	$b©adv_‰_purge
(
wÜk_¡ruù
 *
wÜk
)

2163 
d–ayed_wÜk
 *delayed_work;

2164 
b©adv_´iv_‰
 *
´iv_‰
;

2165 
b©adv_´iv
 *
b©_´iv
;

2167 
d–ayed_wÜk
 = 
	`cÚš”_of
(
wÜk
, delayed_work, work);

2168 
´iv_‰
 = 
	`cÚš”_of
(
d–ayed_wÜk
, 
b©adv_´iv_‰
, 
wÜk
);

2169 
b©_´iv
 = 
	`cÚš”_of
(
´iv_‰
, 
b©adv_´iv
, 
‰
);

2171 
	`b©adv_‰_loÿl_purge
(
b©_´iv
);

2172 
	`b©adv_‰_glob®_purge
(
b©_´iv
);

2173 
	`b©adv_‰_»q_purge
(
b©_´iv
);

2174 
	`b©adv_‰_rßm_purge
(
b©_´iv
);

2176 
	`b©adv_‰_¡¬t_tim”
(
b©_´iv
);

2177 
	}
}

2179 
	$b©adv_‰_ä“
(
b©adv_´iv
 *
b©_´iv
)

2181 
	`ÿnûl_d–ayed_wÜk_sync
(&
b©_´iv
->
‰
.
wÜk
);

2183 
	`b©adv_‰_loÿl_bË_ä“
(
b©_´iv
);

2184 
	`b©adv_‰_glob®_bË_ä“
(
b©_´iv
);

2185 
	`b©adv_‰_»q_li¡_ä“
(
b©_´iv
);

2186 
	`b©adv_‰_chªges_li¡_ä“
(
b©_´iv
);

2187 
	`b©adv_‰_rßm_li¡_ä“
(
b©_´iv
);

2189 
	`kä“
(
b©_´iv
->
‰
.
Ï¡_chªge£t
);

2190 
	}
}

2195 
ušt16_t
 
	$b©adv_‰_£t_æags
(
b©adv_hashbË
 *
hash
,

2196 
ušt16_t
 
æags
, 
boŞ
 
’abË
)

2198 
ušt32_t
 
i
;

2199 
ušt16_t
 
chªged_num
 = 0;

2200 
hli¡_h—d
 *
h—d
;

2201 
hli¡_node
 *
node
;

2202 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ_’Œy
;

2204 ià(!
hash
)

2205 
out
;

2207 
i
 = 0; i < 
hash
->
size
; i++) {

2208 
h—d
 = &
hash
->
bË
[
i
];

2210 
	`rcu_»ad_lock
();

2211 
	`hli¡_fÜ_—ch_’Œy_rcu
(
‰_commÚ_’Œy
, 
node
,

2212 
h—d
, 
hash_’Œy
) {

2213 ià(
’abË
) {

2214 ià((
‰_commÚ_’Œy
->
æags
 & flags) == flags)

2216 
‰_commÚ_’Œy
->
æags
 |= flags;

2218 ià(!(
‰_commÚ_’Œy
->
æags
 & flags))

2220 
‰_commÚ_’Œy
->
æags
 &= ~flags;

2222 
chªged_num
++;

2224 
	`rcu_»ad_uÆock
();

2226 
out
:

2227  
chªged_num
;

2228 
	}
}

2231 
	$b©adv_‰_loÿl_purge_³ndšg_ş›Ás
(
b©adv_´iv
 *
b©_´iv
)

2233 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
‰
.
loÿl_hash
;

2234 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ
;

2235 
b©adv_‰_loÿl_’Œy
 *
‰_loÿl
;

2236 
hli¡_node
 *
node
, *
node_tmp
;

2237 
hli¡_h—d
 *
h—d
;

2238 
¥šlock_t
 *
li¡_lock
;

2239 
ušt32_t
 
i
;

2241 ià(!
hash
)

2244 
i
 = 0; i < 
hash
->
size
; i++) {

2245 
h—d
 = &
hash
->
bË
[
i
];

2246 
li¡_lock
 = &
hash
->
li¡_locks
[
i
];

2248 
	`¥š_lock_bh
(
li¡_lock
);

2249 
	`hli¡_fÜ_—ch_’Œy_§ã
(
‰_commÚ
, 
node
, 
node_tmp
, 
h—d
,

2250 
hash_’Œy
) {

2251 ià(!(
‰_commÚ
->
æags
 & 
BATADV_TT_CLIENT_PENDING
))

2254 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

2256 
‰_commÚ
->
addr
);

2258 
	`©omic_dec
(&
b©_´iv
->
‰
.
loÿl_’Œy_num
);

2259 
	`hli¡_d–_rcu
(
node
);

2260 
‰_loÿl
 = 
	`cÚš”_of
(
‰_commÚ
,

2261 
b©adv_‰_loÿl_’Œy
,

2262 
commÚ
);

2263 
	`b©adv_‰_loÿl_’Œy_ä“_»f
(
‰_loÿl
);

2265 
	`¥š_uÆock_bh
(
li¡_lock
);

2268 
	}
}

2270 
	$b©adv_‰_comm™_chªges
(
b©adv_´iv
 *
b©_´iv
,

2271 **
·ck‘_buff
,

2272 *
·ck‘_buff_Ën
, 
·ck‘_mš_Ën
)

2274 
ušt16_t
 
chªged_num
 = 0;

2276 ià(
	`©omic_»ad
(&
b©_´iv
->
‰
.
loÿl_chªges
) < 1)

2277  -
ENOENT
;

2279 
chªged_num
 = 
	`b©adv_‰_£t_æags
(
b©_´iv
->
‰
.
loÿl_hash
,

2280 
BATADV_TT_CLIENT_NEW
, 
çl£
);

2283 
	`©omic_add
(
chªged_num
, &
b©_´iv
->
‰
.
loÿl_’Œy_num
);

2284 
	`b©adv_‰_loÿl_purge_³ndšg_ş›Ás
(
b©_´iv
);

2285 
b©_´iv
->
‰
.
loÿl_üc
 = 
	`b©adv_‰_loÿl_üc
(bat_priv);

2288 
	`©omic_šc
(&
b©_´iv
->
‰
.
vn
);

2289 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

2291 (
ušt8_t
)
	`©omic_»ad
(&
b©_´iv
->
‰
.
vn
));

2292 
b©_´iv
->
‰
.
poss_chªge
 = 
çl£
;

2295 
	`©omic_£t
(&
b©_´iv
->
‰
.
ogm_­³nd_út
, 
BATADV_TT_OGM_APPEND_MAX
);

2297  
	`b©adv_‰_chªges_fl_buff
(
b©_´iv
, 
·ck‘_buff
,

2298 
·ck‘_buff_Ën
, 
·ck‘_mš_Ën
);

2299 
	}
}

2302 
	$b©adv_‰_­³nd_diff
(
b©adv_´iv
 *
b©_´iv
,

2303 **
·ck‘_buff
, *
·ck‘_buff_Ën
,

2304 
·ck‘_mš_Ën
)

2306 
‰_num_chªges
;

2309 
‰_num_chªges
 = 
	`b©adv_‰_comm™_chªges
(
b©_´iv
, 
·ck‘_buff
,

2310 
·ck‘_buff_Ën
,

2311 
·ck‘_mš_Ën
);

2314 ià((
‰_num_chªges
 < 0) &&

2315 (!
	`b©adv_©omic_dec_nÙ_z”o
(&
b©_´iv
->
‰
.
ogm_­³nd_út
))) {

2316 
	`b©adv_‰_»®loc_·ck‘_buff
(
·ck‘_buff
, 
·ck‘_buff_Ën
,

2317 
·ck‘_mš_Ën
,…acket_min_len);

2318 
‰_num_chªges
 = 0;

2321  
‰_num_chªges
;

2322 
	}
}

2324 
boŞ
 
	$b©adv_is_­_isŞ©ed
(
b©adv_´iv
 *
b©_´iv
, 
ušt8_t
 *
¤c
,

2325 
ušt8_t
 *
d¡
)

2327 
b©adv_‰_loÿl_’Œy
 *
‰_loÿl_’Œy
 = 
NULL
;

2328 
b©adv_‰_glob®_’Œy
 *
‰_glob®_’Œy
 = 
NULL
;

2329 
boŞ
 
»t
 = 
çl£
;

2331 ià(!
	`©omic_»ad
(&
b©_´iv
->
­_isŞ©iÚ
))

2332 
out
;

2334 
‰_loÿl_’Œy
 = 
	`b©adv_‰_loÿl_hash_fšd
(
b©_´iv
, 
d¡
);

2335 ià(!
‰_loÿl_’Œy
)

2336 
out
;

2338 
‰_glob®_’Œy
 = 
	`b©adv_‰_glob®_hash_fšd
(
b©_´iv
, 
¤c
);

2339 ià(!
‰_glob®_’Œy
)

2340 
out
;

2342 ià(!
	`_b©adv_is_­_isŞ©ed
(
‰_loÿl_’Œy
, 
‰_glob®_’Œy
))

2343 
out
;

2345 
»t
 = 
Œue
;

2347 
out
:

2348 ià(
‰_glob®_’Œy
)

2349 
	`b©adv_‰_glob®_’Œy_ä“_»f
(
‰_glob®_’Œy
);

2350 ià(
‰_loÿl_’Œy
)

2351 
	`b©adv_‰_loÿl_’Œy_ä“_»f
(
‰_loÿl_’Œy
);

2352  
»t
;

2353 
	}
}

2355 
	$b©adv_‰_upd©e_Üig
(
b©adv_´iv
 *
b©_´iv
,

2356 
b©adv_Üig_node
 *
Üig_node
,

2357 cÚ¡ *
‰_buff
, 
ušt8_t
 
‰_num_chªges
,

2358 
ušt8_t
 
‰vn
, 
ušt16_t
 
‰_üc
)

2360 
ušt8_t
 
Üig_‰vn
 = (ušt8_t)
	`©omic_»ad
(&
Üig_node
->
Ï¡_‰vn
);

2361 
boŞ
 
fuÎ_bË
 = 
Œue
;

2362 
b©adv_‰_chªge
 *
‰_chªge
;

2365 ià(
	`b©adv_bÏ_is_backbÚe_gw_Üig
(
b©_´iv
, 
Üig_node
->
Üig
))

2371 ià((!
Üig_node
->
‰_š™Ÿli£d
 && 
‰vn
 == 1) ||

2372 
‰vn
 - 
Üig_‰vn
 == 1) {

2378 ià(!
‰_num_chªges
) {

2379 
fuÎ_bË
 = 
çl£
;

2380 
»que¡_bË
;

2383 
‰_chªge
 = (
b©adv_‰_chªge
 *)
‰_buff
;

2384 
	`b©adv_‰_upd©e_chªges
(
b©_´iv
, 
Üig_node
, 
‰_num_chªges
,

2385 
‰vn
, 
‰_chªge
);

2391 
Üig_node
->
‰_üc
 = 
	`b©adv_‰_glob®_üc
(
b©_´iv
, orig_node);

2402 ià(
Üig_node
->
‰_üc
 !=t_crc)

2403 
»que¡_bË
;

2408 
Üig_node
->
‰_poss_chªge
 = 
çl£
;

2413 ià(!
Üig_node
->
‰_š™Ÿli£d
 || 
‰vn
 !ğ
Üig_‰vn
 ||

2414 
Üig_node
->
‰_üc
 !=t_crc) {

2415 
»que¡_bË
:

2416 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

2418 
Üig_node
->
Üig
, 
‰vn
, 
Üig_‰vn
, 
‰_üc
,

2419 
Üig_node
->
‰_üc
, 
‰_num_chªges
);

2420 
	`b©adv_£nd_‰_»que¡
(
b©_´iv
, 
Üig_node
, 
‰vn
,

2421 
‰_üc
, 
fuÎ_bË
);

2425 
	}
}

2431 
boŞ
 
	$b©adv_‰_glob®_ş›Á_is_rßmšg
(
b©adv_´iv
 *
b©_´iv
,

2432 
ušt8_t
 *
addr
)

2434 
b©adv_‰_glob®_’Œy
 *
‰_glob®_’Œy
;

2435 
boŞ
 
»t
 = 
çl£
;

2437 
‰_glob®_’Œy
 = 
	`b©adv_‰_glob®_hash_fšd
(
b©_´iv
, 
addr
);

2438 ià(!
‰_glob®_’Œy
)

2439 
out
;

2441 
»t
 = 
‰_glob®_’Œy
->
commÚ
.
æags
 & 
BATADV_TT_CLIENT_ROAM
;

2442 
	`b©adv_‰_glob®_’Œy_ä“_»f
(
‰_glob®_’Œy
);

2443 
out
:

2444  
»t
;

2445 
	}
}

2447 
boŞ
 
	$b©adv_‰_add_‹mpÜ¬y_glob®_’Œy
(
b©adv_´iv
 *
b©_´iv
,

2448 
b©adv_Üig_node
 *
Üig_node
,

2449 cÚ¡ *
addr
)

2451 
boŞ
 
»t
 = 
çl£
;

2453 ià(!
	`b©adv_‰_glob®_add
(
b©_´iv
, 
Üig_node
, 
addr
,

2454 
BATADV_TT_CLIENT_TEMP
,

2455 
	`©omic_»ad
(&
Üig_node
->
Ï¡_‰vn
)))

2456 
out
;

2458 
	`b©adv_dbg
(
BATADV_DBG_TT
, 
b©_´iv
,

2460 
addr
, 
Üig_node
->
Üig
);

2461 
»t
 = 
Œue
;

2462 
out
:

2463  
»t
;

2464 
	}
}

	@translation-table.h

20 #iâdeà
_NET_BATMAN_ADV_TRANSLATION_TABLE_H_


21 
	#_NET_BATMAN_ADV_TRANSLATION_TABLE_H_


	)

23 
b©adv_‰_Ën
(
chªges_num
);

24 
b©adv_‰_š™
(
b©adv_´iv
 *
b©_´iv
);

25 
b©adv_‰_loÿl_add
(
Ãt_deviû
 *
soá_içû
, cÚ¡ 
ušt8_t
 *
addr
,

26 
ifšdex
);

27 
b©adv_‰_loÿl_»move
(
b©adv_´iv
 *
b©_´iv
,

28 cÚ¡ 
ušt8_t
 *
addr
, cÚ¡ *
mes§ge
,

29 
boŞ
 
rßmšg
);

30 
b©adv_‰_loÿl_£q_´št_‹xt
(
£q_fe
 *
£q
, *
off£t
);

31 
b©adv_‰_glob®_add_Üig
(
b©adv_´iv
 *
b©_´iv
,

32 
b©adv_Üig_node
 *
Üig_node
,

33 cÚ¡ *
‰_buff
, 
‰_buff_Ën
);

34 
b©adv_‰_glob®_add
(
b©adv_´iv
 *
b©_´iv
,

35 
b©adv_Üig_node
 *
Üig_node
,

36 cÚ¡ *
addr
, 
ušt8_t
 
æags
,

37 
ušt8_t
 
‰vn
);

38 
b©adv_‰_glob®_£q_´št_‹xt
(
£q_fe
 *
£q
, *
off£t
);

39 
b©adv_‰_glob®_d–_Üig
(
b©adv_´iv
 *
b©_´iv
,

40 
b©adv_Üig_node
 *
Üig_node
,

41 cÚ¡ *
mes§ge
);

42 
b©adv_Üig_node
 *
b©adv_Œª¡abË_£¬ch
(
b©adv_´iv
 *
b©_´iv
,

43 cÚ¡ 
ušt8_t
 *
¤c
,

44 cÚ¡ 
ušt8_t
 *
addr
);

45 
b©adv_‰_ä“
(
b©adv_´iv
 *
b©_´iv
);

46 
boŞ
 
b©adv_£nd_‰_»¥Ú£
(
b©adv_´iv
 *
b©_´iv
,

47 
b©adv_‰_qu”y_·ck‘
 *
‰_»que¡
);

48 
boŞ
 
b©adv_is_my_ş›Á
(
b©adv_´iv
 *
b©_´iv
, cÚ¡ 
ušt8_t
 *
addr
);

49 
b©adv_hªdË_‰_»¥Ú£
(
b©adv_´iv
 *
b©_´iv
,

50 
b©adv_‰_qu”y_·ck‘
 *
‰_»¥Ú£
);

51 
boŞ
 
b©adv_is_­_isŞ©ed
(
b©adv_´iv
 *
b©_´iv
, 
ušt8_t
 *
¤c
,

52 
ušt8_t
 *
d¡
);

53 
b©adv_‰_upd©e_Üig
(
b©adv_´iv
 *
b©_´iv
,

54 
b©adv_Üig_node
 *
Üig_node
,

55 cÚ¡ *
‰_buff
, 
ušt8_t
 
‰_num_chªges
,

56 
ušt8_t
 
‰vn
, 
ušt16_t
 
‰_üc
);

57 
b©adv_‰_­³nd_diff
(
b©adv_´iv
 *
b©_´iv
,

58 **
·ck‘_buff
, *
·ck‘_buff_Ën
,

59 
·ck‘_mš_Ën
);

60 
boŞ
 
b©adv_‰_glob®_ş›Á_is_rßmšg
(
b©adv_´iv
 *
b©_´iv
,

61 
ušt8_t
 *
addr
);

62 
boŞ
 
b©adv_‰_add_‹mpÜ¬y_glob®_’Œy
(
b©adv_´iv
 *
b©_´iv
,

63 
b©adv_Üig_node
 *
Üig_node
,

64 cÚ¡ *
addr
);

	@types.h

20 #iâdeà
_NET_BATMAN_ADV_TYPES_H_


21 
	#_NET_BATMAN_ADV_TYPES_H_


	)

23 
	~"·ck‘.h
"

24 
	~"b™¬¿y.h
"

25 
	~<lšux/k”Ãl.h
>

27 
	#BATADV_HEADER_LEN
 \

28 (
ETH_HLEN
 + 
	`max
((
b©adv_uniÿ¡_·ck‘
), \

29 (
b©adv_bÿ¡_·ck‘
)))

	)

31 
	sb©adv_h¬d_içû
 {

32 
li¡_h—d
 
	mli¡
;

33 
št16_t
 
	mif_num
;

34 
	mif_¡©us
;

35 
Ãt_deviû
 *
	mÃt_dev
;

36 
©omic_t
 
	m£qno
;

37 
©omic_t
 
	mäag_£qno
;

38 *
	m·ck‘_buff
;

39 
	m·ck‘_Ën
;

40 
kobjeù
 *
	mh¬dif_obj
;

41 
©omic_t
 
	m»fcouÁ
;

42 
·ck‘_ty³
 
	mb©mª_adv_±y³
;

43 
Ãt_deviû
 *
	msoá_içû
;

44 
rcu_h—d
 
	mrcu
;

62 
	sb©adv_Üig_node
 {

63 
ušt8_t
 
	mÜig
[
ETH_ALEN
];

64 
ušt8_t
 
	m´im¬y_addr
[
ETH_ALEN
];

65 
b©adv_Ãigh_node
 
__rcu
 *
	mrou‹r
;

66 *
	mbÿ¡_own
;

67 
ušt8_t
 *
	mbÿ¡_own_sum
;

68 
	mÏ¡_£’
;

69 
	mbÿ¡_£qno_»£t
;

70 
	mb©mª_£qno_»£t
;

71 
ušt8_t
 
	mgw_æags
;

72 
ušt8_t
 
	mæags
;

73 
©omic_t
 
	mÏ¡_‰vn
;

74 
ušt16_t
 
	m‰_üc
;

75 *
	m‰_buff
;

76 
št16_t
 
	m‰_buff_Ën
;

77 
¥šlock_t
 
	m‰_buff_lock
;

78 
©omic_t
 
	m‰_size
;

79 
boŞ
 
	m‰_š™Ÿli£d
;

86 
boŞ
 
	m‰_poss_chªge
;

87 
ušt32_t
 
	mÏ¡_»®_£qno
;

88 
ušt8_t
 
	mÏ¡_‰l
;

89 
DECLARE_BITMAP
(
bÿ¡_b™s
, 
BATADV_TQ_LOCAL_WINDOW_SIZE
);

90 
ušt32_t
 
	mÏ¡_bÿ¡_£qno
;

91 
hli¡_h—d
 
	mÃigh_li¡
;

92 
li¡_h—d
 
	mäag_li¡
;

93 
¥šlock_t
 
	mÃigh_li¡_lock
;

94 
©omic_t
 
	m»fcouÁ
;

95 
rcu_h—d
 
	mrcu
;

96 
hli¡_node
 
	mhash_’Œy
;

97 
b©adv_´iv
 *
	mb©_´iv
;

98 
	mÏ¡_äag_·ck‘
;

102 
¥šlock_t
 
	mogm_út_lock
;

104 
¥šlock_t
 
	mbÿ¡_£qno_lock
;

105 
¥šlock_t
 
	m‰_li¡_lock
;

106 
©omic_t
 
	mbÚd_ÿndid©es
;

107 
li¡_h—d
 
	mbÚd_li¡
;

110 
	sb©adv_gw_node
 {

111 
hli¡_node
 
	mli¡
;

112 
b©adv_Üig_node
 *
	mÜig_node
;

113 
	md–‘ed
;

114 
©omic_t
 
	m»fcouÁ
;

115 
rcu_h—d
 
	mrcu
;

121 
	sb©adv_Ãigh_node
 {

122 
hli¡_node
 
	mli¡
;

123 
ušt8_t
 
	maddr
[
ETH_ALEN
];

124 
ušt8_t
 
	m»®_·ck‘_couÁ
;

125 
ušt8_t
 
	mtq_»cv
[
BATADV_TQ_GLOBAL_WINDOW_SIZE
];

126 
ušt8_t
 
	mtq_šdex
;

127 
ušt8_t
 
	mtq_avg
;

128 
ušt8_t
 
	mÏ¡_‰l
;

129 
li¡_h—d
 
	mbÚdšg_li¡
;

130 
	mÏ¡_£’
;

131 
DECLARE_BITMAP
(
»®_b™s
, 
BATADV_TQ_LOCAL_WINDOW_SIZE
);

132 
©omic_t
 
	m»fcouÁ
;

133 
rcu_h—d
 
	mrcu
;

134 
b©adv_Üig_node
 *
	mÜig_node
;

135 
b©adv_h¬d_içû
 *
	mif_šcomšg
;

136 
¥šlock_t
 
	mlq_upd©e_lock
;

139 #ifdeà
CONFIG_BATMAN_ADV_BLA


140 
	sb©adv_bÿ¡_du¶i¡_’Œy
 {

141 
ušt8_t
 
	mÜig
[
ETH_ALEN
];

142 
ušt16_t
 
	müc
;

143 
	m’Œytime
;

147 
	eb©adv_couÁ”s
 {

148 
	mBATADV_CNT_TX
,

149 
	mBATADV_CNT_TX_BYTES
,

150 
	mBATADV_CNT_TX_DROPPED
,

151 
	mBATADV_CNT_RX
,

152 
	mBATADV_CNT_RX_BYTES
,

153 
	mBATADV_CNT_FORWARD
,

154 
	mBATADV_CNT_FORWARD_BYTES
,

155 
	mBATADV_CNT_MGMT_TX
,

156 
	mBATADV_CNT_MGMT_TX_BYTES
,

157 
	mBATADV_CNT_MGMT_RX
,

158 
	mBATADV_CNT_MGMT_RX_BYTES
,

159 
	mBATADV_CNT_TT_REQUEST_TX
,

160 
	mBATADV_CNT_TT_REQUEST_RX
,

161 
	mBATADV_CNT_TT_RESPONSE_TX
,

162 
	mBATADV_CNT_TT_RESPONSE_RX
,

163 
	mBATADV_CNT_TT_ROAM_ADV_TX
,

164 
	mBATADV_CNT_TT_ROAM_ADV_RX
,

165 
	mBATADV_CNT_NUM
,

180 
	sb©adv_´iv_‰
 {

181 
©omic_t
 
	mvn
;

182 
©omic_t
 
	mogm_­³nd_út
;

183 
©omic_t
 
	mloÿl_chªges
;

184 
boŞ
 
	mposs_chªge
;

185 
li¡_h—d
 
	mchªges_li¡
;

186 
b©adv_hashbË
 *
	mloÿl_hash
;

187 
b©adv_hashbË
 *
	mglob®_hash
;

188 
li¡_h—d
 
	m»q_li¡
;

189 
li¡_h—d
 
	mrßm_li¡
;

190 
¥šlock_t
 
	mchªges_li¡_lock
;

191 
¥šlock_t
 
	m»q_li¡_lock
;

192 
¥šlock_t
 
	mrßm_li¡_lock
;

193 
©omic_t
 
	mloÿl_’Œy_num
;

194 
ušt16_t
 
	mloÿl_üc
;

195 *
	mÏ¡_chªge£t
;

196 
št16_t
 
	mÏ¡_chªge£t_Ën
;

197 
¥šlock_t
 
	mÏ¡_chªge£t_lock
;

198 
d–ayed_wÜk
 
	mwÜk
;

201 #ifdeà
CONFIG_BATMAN_ADV_BLA


202 
	sb©adv_´iv_bÏ
 {

203 
©omic_t
 
	mnum_»que¡s
;

204 
b©adv_hashbË
 *
	mşaim_hash
;

205 
b©adv_hashbË
 *
	mbackbÚe_hash
;

206 
b©adv_bÿ¡_du¶i¡_’Œy
 
	mbÿ¡_du¶i¡
[
BATADV_DUPLIST_SIZE
];

207 
	mbÿ¡_du¶i¡_cu¼
;

209 
¥šlock_t
 
	mbÿ¡_du¶i¡_lock
;

210 
b©adv_bÏ_şaim_d¡
 
	mşaim_de¡
;

211 
d–ayed_wÜk
 
	mwÜk
;

215 
	sb©adv_´iv_gw
 {

216 
hli¡_h—d
 
	mli¡
;

217 
¥šlock_t
 
	mli¡_lock
;

218 
b©adv_gw_node
 
__rcu
 *
	mcu¼_gw
;

219 
©omic_t
 
	m»£Ëù
;

222 
	sb©adv_´iv_vis
 {

223 
li¡_h—d
 
	m£nd_li¡
;

224 
b©adv_hashbË
 *
	mhash
;

225 
¥šlock_t
 
	mhash_lock
;

226 
¥šlock_t
 
	mli¡_lock
;

227 
d–ayed_wÜk
 
	mwÜk
;

228 
b©adv_vis_šfo
 *
	mmy_šfo
;

231 
	sb©adv_´iv
 {

232 
©omic_t
 
	mmesh_¡©e
;

233 
Ãt_deviû_¡©s
 
	m¡©s
;

234 
ušt64_t
 
__³rıu
 *
	mb©_couÁ”s
;

235 
©omic_t
 
	magg»g©ed_ogms
;

236 
©omic_t
 
	mbÚdšg
;

237 
©omic_t
 
	mäagm’tiÚ
;

238 
©omic_t
 
	m­_isŞ©iÚ
;

239 
©omic_t
 
	mbridge_loİ_avoidªû
;

240 
©omic_t
 
	mvis_mode
;

241 
©omic_t
 
	mgw_mode
;

242 
©omic_t
 
	mgw_£l_şass
;

243 
©omic_t
 
	mgw_bªdwidth
;

244 
©omic_t
 
	mÜig_š‹rv®
;

245 
©omic_t
 
	mhİ_³ÇÉy
;

246 
©omic_t
 
	mlog_Ëv–
;

247 
©omic_t
 
	mbÿ¡_£qno
;

248 
©omic_t
 
	mbÿ¡_queue_Ëá
;

249 
©omic_t
 
	mb©mª_queue_Ëá
;

250 
	mnum_içûs
;

251 
b©adv_debug_log
 *
	mdebug_log
;

252 
kobjeù
 *
	mmesh_obj
;

253 
d’Œy
 *
	mdebug_dœ
;

254 
hli¡_h—d
 
	mfÜw_b©_li¡
;

255 
hli¡_h—d
 
	mfÜw_bÿ¡_li¡
;

256 
b©adv_hashbË
 *
	mÜig_hash
;

257 
¥šlock_t
 
	mfÜw_b©_li¡_lock
;

258 
¥šlock_t
 
	mfÜw_bÿ¡_li¡_lock
;

259 
d–ayed_wÜk
 
	mÜig_wÜk
;

260 
b©adv_h¬d_içû
 
__rcu
 *
	m´im¬y_if
;

261 
b©adv_®go_İs
 *
	mb©_®go_İs
;

262 #ifdeà
CONFIG_BATMAN_ADV_BLA


263 
b©adv_´iv_bÏ
 
	mbÏ
;

265 
b©adv_´iv_gw
 
	mgw
;

266 
b©adv_´iv_‰
 
	m‰
;

267 
b©adv_´iv_vis
 
	mvis
;

270 
	sb©adv_sock‘_ş›Á
 {

271 
li¡_h—d
 
	mqueue_li¡
;

272 
	mqueue_Ën
;

273 
	mšdex
;

274 
¥šlock_t
 
	mlock
;

275 
wa™_queue_h—d_t
 
	mqueue_wa™
;

276 
b©adv_´iv
 *
	mb©_´iv
;

279 
	sb©adv_sock‘_·ck‘
 {

280 
li¡_h—d
 
	mli¡
;

281 
size_t
 
	micmp_Ën
;

282 
b©adv_icmp_·ck‘_¼
 
	micmp_·ck‘
;

285 
	sb©adv_‰_commÚ_’Œy
 {

286 
ušt8_t
 
	maddr
[
ETH_ALEN
];

287 
hli¡_node
 
	mhash_’Œy
;

288 
ušt16_t
 
	mæags
;

289 
	madded_©
;

290 
©omic_t
 
	m»fcouÁ
;

291 
rcu_h—d
 
	mrcu
;

294 
	sb©adv_‰_loÿl_’Œy
 {

295 
b©adv_‰_commÚ_’Œy
 
	mcommÚ
;

296 
	mÏ¡_£’
;

299 
	sb©adv_‰_glob®_’Œy
 {

300 
b©adv_‰_commÚ_’Œy
 
	mcommÚ
;

301 
hli¡_h—d
 
	mÜig_li¡
;

302 
¥šlock_t
 
	mli¡_lock
;

303 
	mrßm_©
;

306 
	sb©adv_‰_Üig_li¡_’Œy
 {

307 
b©adv_Üig_node
 *
	mÜig_node
;

308 
ušt8_t
 
	m‰vn
;

309 
©omic_t
 
	m»fcouÁ
;

310 
rcu_h—d
 
	mrcu
;

311 
hli¡_node
 
	mli¡
;

314 #ifdeà
CONFIG_BATMAN_ADV_BLA


315 
	sb©adv_backbÚe_gw
 {

316 
ušt8_t
 
	mÜig
[
ETH_ALEN
];

317 
	mvid
;

318 
hli¡_node
 
	mhash_’Œy
;

319 
b©adv_´iv
 *
	mb©_´iv
;

320 
	mÏ¡time
;

321 
©omic_t
 
	m»que¡_£Á
;

322 
©omic_t
 
	m»fcouÁ
;

323 
rcu_h—d
 
	mrcu
;

324 
ušt16_t
 
	müc
;

327 
	sb©adv_şaim
 {

328 
ušt8_t
 
	maddr
[
ETH_ALEN
];

329 
	mvid
;

330 
b©adv_backbÚe_gw
 *
	mbackbÚe_gw
;

331 
	mÏ¡time
;

332 
rcu_h—d
 
	mrcu
;

333 
©omic_t
 
	m»fcouÁ
;

334 
hli¡_node
 
	mhash_’Œy
;

338 
	sb©adv_‰_chªge_node
 {

339 
li¡_h—d
 
	mli¡
;

340 
b©adv_‰_chªge
 
	mchªge
;

343 
	sb©adv_‰_»q_node
 {

344 
ušt8_t
 
	maddr
[
ETH_ALEN
];

345 
	missued_©
;

346 
li¡_h—d
 
	mli¡
;

349 
	sb©adv_‰_rßm_node
 {

350 
ušt8_t
 
	maddr
[
ETH_ALEN
];

351 
©omic_t
 
	mcouÁ”
;

352 
	mfœ¡_time
;

353 
li¡_h—d
 
	mli¡
;

359 
	sb©adv_fÜw_·ck‘
 {

360 
hli¡_node
 
	mli¡
;

361 
	m£nd_time
;

362 
ušt8_t
 
	mown
;

363 
sk_buff
 *
	mskb
;

364 
ušt16_t
 
	m·ck‘_Ën
;

365 
ušt32_t
 
	mdœeù_lšk_æags
;

366 
ušt8_t
 
	mnum_·ck‘s
;

367 
d–ayed_wÜk
 
	md–ayed_wÜk
;

368 
b©adv_h¬d_içû
 *
	mif_šcomšg
;

375 
	sb©adv_if_li¡_’Œy
 {

376 
ušt8_t
 
	maddr
[
ETH_ALEN
];

377 
boŞ
 
	m´im¬y
;

378 
hli¡_node
 
	mli¡
;

381 
	sb©adv_debug_log
 {

382 
	mlog_buff
[
BATADV_LOG_BUF_LEN
];

383 
	mlog_¡¬t
;

384 
	mlog_’d
;

385 
¥šlock_t
 
	mlock
;

386 
wa™_queue_h—d_t
 
	mqueue_wa™
;

389 
	sb©adv_äag_·ck‘_li¡_’Œy
 {

390 
li¡_h—d
 
	mli¡
;

391 
ušt16_t
 
	m£qno
;

392 
sk_buff
 *
	mskb
;

395 
	sb©adv_vis_šfo
 {

396 
	mfœ¡_£’
;

400 
li¡_h—d
 
	m»cv_li¡
;

401 
li¡_h—d
 
	m£nd_li¡
;

402 
k»f
 
	m»fcouÁ
;

403 
hli¡_node
 
	mhash_’Œy
;

404 
b©adv_´iv
 *
	mb©_´iv
;

406 
sk_buff
 *
	mskb_·ck‘
;

408 } 
	g__·cked
;

410 
	sb©adv_vis_šfo_’Œy
 {

411 
ušt8_t
 
	m¤c
[
ETH_ALEN
];

412 
ušt8_t
 
	mde¡
[
ETH_ALEN
];

413 
ušt8_t
 
	mqu®™y
;

414 } 
	g__·cked
;

416 
	sb©adv_»cvli¡_node
 {

417 
li¡_h—d
 
	mli¡
;

418 
ušt8_t
 
	mmac
[
ETH_ALEN
];

421 
	sb©adv_®go_İs
 {

422 
hli¡_node
 
	mli¡
;

423 *
	mÇme
;

425 (*
	mb©_içû_’abË
)(
b©adv_h¬d_içû
 *
	mh¬d_içû
);

427 (*
	mb©_içû_di§bË
)(
b©adv_h¬d_içû
 *
	mh¬d_içû
);

431 (*
	mb©_içû_upd©e_mac
)(
b©adv_h¬d_içû
 *
	mh¬d_içû
);

433 (*
	mb©_´im¬y_içû_£t
)(
b©adv_h¬d_içû
 *
	mh¬d_içû
);

435 (*
	mb©_ogm_scheduË
)(
b©adv_h¬d_içû
 *
	mh¬d_içû
);

437 (*
	mb©_ogm_em™
)(
b©adv_fÜw_·ck‘
 *
	mfÜw_·ck‘
);

	@unicast.c

20 
	~"maš.h
"

21 
	~"uniÿ¡.h
"

22 
	~"£nd.h
"

23 
	~"soá-š‹rçû.h
"

24 
	~"g©eway_ş›Á.h
"

25 
	~"Üigš©Ü.h
"

26 
	~"hash.h
"

27 
	~"Œª¦©iÚ-bË.h
"

28 
	~"routšg.h
"

29 
	~"h¬d-š‹rçû.h
"

32 
sk_buff
 *

33 
	$b©adv_äag_m”ge_·ck‘
(
li¡_h—d
 *
h—d
,

34 
b©adv_äag_·ck‘_li¡_’Œy
 *
tå
,

35 
sk_buff
 *
skb
)

37 
b©adv_uniÿ¡_äag_·ck‘
 *
up
;

38 
sk_buff
 *
tmp_skb
;

39 
b©adv_uniÿ¡_·ck‘
 *
uniÿ¡_·ck‘
;

40 
hdr_Ën
 = (*
uniÿ¡_·ck‘
);

41 
uni_diff
 = (*
up
è- 
hdr_Ën
;

42 
ušt8_t
 *
·ck‘_pos
;

44 
up
 = (
b©adv_uniÿ¡_äag_·ck‘
 *)
skb
->
d©a
;

46 ià(
up
->
æags
 & 
BATADV_UNI_FRAG_HEAD
) {

47 
tmp_skb
 = 
tå
->
skb
;

49 
tmp_skb
 = 
skb
;

50 
skb
 = 
tå
->skb;

53 ià(
	`skb_lš—rize
(
skb
è< 0 || skb_lš—rize(
tmp_skb
) < 0)

54 
”r
;

56 
	`skb_puÎ
(
tmp_skb
, (*
up
));

57 ià(
	`pskb_ex·nd_h—d
(
skb
, 0, 
tmp_skb
->
Ën
, 
GFP_ATOMIC
) < 0)

58 
”r
;

61 
tå
->
skb
 = 
NULL
;

62 
tå
->
£qno
 = 0;

63 
	`li¡_move_
(&
tå
->
li¡
, 
h—d
);

65 
	`memıy
(
	`skb_put
(
skb
, 
tmp_skb
->
Ën
),mp_skb->
d©a
,mp_skb->len);

66 
	`kä“_skb
(
tmp_skb
);

68 
	`memmove
(
skb
->
d©a
 + 
uni_diff
, skb->d©a, 
hdr_Ën
);

69 
·ck‘_pos
 = 
	`skb_puÎ
(
skb
, 
uni_diff
);

70 
uniÿ¡_·ck‘
 = (
b©adv_uniÿ¡_·ck‘
 *)
·ck‘_pos
;

71 
uniÿ¡_·ck‘
->
h—d”
.
·ck‘_ty³
 = 
BATADV_UNICAST
;

73  
skb
;

75 
”r
:

77 
	`kä“_skb
(
tå
->
skb
);

78  
NULL
;

79 
	}
}

81 
	$b©adv_äag_ü—‹_’Œy
(
li¡_h—d
 *
h—d
,

82 
sk_buff
 *
skb
)

84 
b©adv_äag_·ck‘_li¡_’Œy
 *
tå
;

85 
b©adv_uniÿ¡_äag_·ck‘
 *
up
;

87 
up
 = (
b©adv_uniÿ¡_äag_·ck‘
 *)
skb
->
d©a
;

90 
tå
 = 
	`li¡_’Œy
((
h—d
)->
´ev
, 
	`ty³of
(*tå), 
li¡
);

91 
	`kä“_skb
(
tå
->
skb
);

93 
tå
->
£qno
 = 
	`Áohs
(
up
->seqno);

94 
tå
->
skb
 = skb;

95 
	`li¡_move
(&
tå
->
li¡
, 
h—d
);

97 
	}
}

99 
	$b©adv_äag_ü—‹_bufãr
(
li¡_h—d
 *
h—d
)

101 
i
;

102 
b©adv_äag_·ck‘_li¡_’Œy
 *
tå
;

104 
i
 = 0; i < 
BATADV_FRAG_BUFFER_SIZE
; i++) {

105 
tå
 = 
	`km®loc
((*tå), 
GFP_ATOMIC
);

106 ià(!
tå
) {

107 
	`b©adv_äag_li¡_ä“
(
h—d
);

108  -
ENOMEM
;

110 
tå
->
skb
 = 
NULL
;

111 
tå
->
£qno
 = 0;

112 
	`INIT_LIST_HEAD
(&
tå
->
li¡
);

113 
	`li¡_add
(&
tå
->
li¡
, 
h—d
);

117 
	}
}

119 
b©adv_äag_·ck‘_li¡_’Œy
 *

120 
	$b©adv_äag_£¬ch_·ck‘
(
li¡_h—d
 *
h—d
,

121 cÚ¡ 
b©adv_uniÿ¡_äag_·ck‘
 *
up
)

123 
b©adv_äag_·ck‘_li¡_’Œy
 *
tå
;

124 
b©adv_uniÿ¡_äag_·ck‘
 *
tmp_up
 = 
NULL
;

125 
is_h—d_tmp
, 
is_h—d
;

126 
ušt16_t
 
£¬ch_£qno
;

128 ià(
up
->
æags
 & 
BATADV_UNI_FRAG_HEAD
)

129 
£¬ch_£qno
 = 
	`Áohs
(
up
->
£qno
)+1;

131 
£¬ch_£qno
 = 
	`Áohs
(
up
->
£qno
)-1;

133 
is_h—d
 = !!(
up
->
æags
 & 
BATADV_UNI_FRAG_HEAD
);

135 
	`li¡_fÜ_—ch_’Œy
(
tå
, 
h—d
, 
li¡
) {

137 ià(!
tå
->
skb
)

140 ià(
tå
->
£qno
 =ğ
	`Áohs
(
up
->seqno))

141 
mov_
;

143 
tmp_up
 = (
b©adv_uniÿ¡_äag_·ck‘
 *)
tå
->
skb
->
d©a
;

145 ià(
tå
->
£qno
 =ğ
£¬ch_£qno
) {

146 
is_h—d_tmp
 = !!(
tmp_up
->
æags
 & 
BATADV_UNI_FRAG_HEAD
);

147 ià(
is_h—d_tmp
 !ğ
is_h—d
)

148  
tå
;

150 
mov_
;

153  
NULL
;

155 
mov_
:

156 
	`li¡_move_
(&
tå
->
li¡
, 
h—d
);

157  
NULL
;

158 
	}
}

160 
	$b©adv_äag_li¡_ä“
(
li¡_h—d
 *
h—d
)

162 
b©adv_äag_·ck‘_li¡_’Œy
 *
pf
, *
tmp_pf
;

164 ià(!
	`li¡_em±y
(
h—d
)) {

166 
	`li¡_fÜ_—ch_’Œy_§ã
(
pf
, 
tmp_pf
, 
h—d
, 
li¡
) {

167 
	`kä“_skb
(
pf
->
skb
);

168 
	`li¡_d–
(&
pf
->
li¡
);

169 
	`kä“
(
pf
);

173 
	}
}

181 
	$b©adv_äag_»as£mbË_skb
(
sk_buff
 *
skb
,

182 
b©adv_´iv
 *
b©_´iv
,

183 
sk_buff
 **
Ãw_skb
)

185 
b©adv_Üig_node
 *
Üig_node
;

186 
b©adv_äag_·ck‘_li¡_’Œy
 *
tmp_äag_’Œy
;

187 
»t
 = 
NET_RX_DROP
;

188 
b©adv_uniÿ¡_äag_·ck‘
 *
uniÿ¡_·ck‘
;

190 
uniÿ¡_·ck‘
 = (
b©adv_uniÿ¡_äag_·ck‘
 *)
skb
->
d©a
;

191 *
Ãw_skb
 = 
NULL
;

193 
Üig_node
 = 
	`b©adv_Üig_hash_fšd
(
b©_´iv
, 
uniÿ¡_·ck‘
->
Üig
);

194 ià(!
Üig_node
)

195 
out
;

197 
Üig_node
->
Ï¡_äag_·ck‘
 = 
jiff›s
;

199 ià(
	`li¡_em±y
(&
Üig_node
->
äag_li¡
) &&

200 
	`b©adv_äag_ü—‹_bufãr
(&
Üig_node
->
äag_li¡
)) {

201 
	`´_debug
("couldn't create frag buffer\n");

202 
out
;

205 
tmp_äag_’Œy
 = 
	`b©adv_äag_£¬ch_·ck‘
(&
Üig_node
->
äag_li¡
,

206 
uniÿ¡_·ck‘
);

208 ià(!
tmp_äag_’Œy
) {

209 
	`b©adv_äag_ü—‹_’Œy
(&
Üig_node
->
äag_li¡
, 
skb
);

210 
»t
 = 
NET_RX_SUCCESS
;

211 
out
;

214 *
Ãw_skb
 = 
	`b©adv_äag_m”ge_·ck‘
(&
Üig_node
->
äag_li¡
,

215 
tmp_äag_’Œy
, 
skb
);

217 ià(*
Ãw_skb
)

218 
»t
 = 
NET_RX_SUCCESS
;

220 
out
:

221 ià(
Üig_node
)

222 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

223  
»t
;

224 
	}
}

226 
	$b©adv_äag_£nd_skb
(
sk_buff
 *
skb
, 
b©adv_´iv
 *
b©_´iv
,

227 
b©adv_h¬d_içû
 *
h¬d_içû
,

228 cÚ¡ 
ušt8_t
 
d¡addr
[])

230 
b©adv_uniÿ¡_·ck‘
 
tmp_uc
, *
uniÿ¡_·ck‘
;

231 
b©adv_h¬d_içû
 *
´im¬y_if
;

232 
sk_buff
 *
äag_skb
;

233 
b©adv_uniÿ¡_äag_·ck‘
 *
äag1
, *
äag2
;

234 
uc_hdr_Ën
 = (*
uniÿ¡_·ck‘
);

235 
ucf_hdr_Ën
 = (*
äag1
);

236 
d©a_Ën
 = 
skb
->
Ën
 - 
uc_hdr_Ën
;

237 
Ïrge_
 = 0, 
»t
 = 
NET_RX_DROP
;

238 
ušt16_t
 
£qno
;

240 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

241 ià(!
´im¬y_if
)

242 
drİ³d
;

244 
äag_skb
 = 
	`dev_®loc_skb
(
d©a_Ën
 - (d©a_ËÀ/ 2è+ 
ucf_hdr_Ën
);

245 ià(!
äag_skb
)

246 
drİ³d
;

247 
	`skb_»£rve
(
äag_skb
, 
ucf_hdr_Ën
);

249 
uniÿ¡_·ck‘
 = (
b©adv_uniÿ¡_·ck‘
 *)
skb
->
d©a
;

250 
	`memıy
(&
tmp_uc
, 
uniÿ¡_·ck‘
, 
uc_hdr_Ën
);

251 
	`skb_¥l™
(
skb
, 
äag_skb
, 
d©a_Ën
 / 2 + 
uc_hdr_Ën
);

253 ià(
	`b©adv_skb_h—d_push
(
skb
, 
ucf_hdr_Ën
 - 
uc_hdr_Ën
) < 0 ||

254 
	`b©adv_skb_h—d_push
(
äag_skb
, 
ucf_hdr_Ën
) < 0)

255 
drİ_äag
;

257 
äag1
 = (
b©adv_uniÿ¡_äag_·ck‘
 *)
skb
->
d©a
;

258 
äag2
 = (
b©adv_uniÿ¡_äag_·ck‘
 *)
äag_skb
->
d©a
;

260 
	`memıy
(
äag1
, &
tmp_uc
, (tmp_uc));

262 
äag1
->
h—d”
.
‰l
--;

263 
äag1
->
h—d”
.
v”siÚ
 = 
BATADV_COMPAT_VERSION
;

264 
äag1
->
h—d”
.
·ck‘_ty³
 = 
BATADV_UNICAST_FRAG
;

266 
	`memıy
(
äag1
->
Üig
, 
´im¬y_if
->
Ãt_dev
->
dev_addr
, 
ETH_ALEN
);

267 
	`memıy
(
äag2
, 
äag1
, (*frag2));

269 ià(
d©a_Ën
 & 1)

270 
Ïrge_
 = 
BATADV_UNI_FRAG_LARGETAIL
;

272 
äag1
->
æags
 = 
BATADV_UNI_FRAG_HEAD
 | 
Ïrge_
;

273 
äag2
->
æags
 = 
Ïrge_
;

275 
£qno
 = 
	`©omic_add_»tuº
(2, &
h¬d_içû
->
äag_£qno
);

276 
äag1
->
£qno
 = 
	`htÚs
(seqno - 1);

277 
äag2
->
£qno
 = 
	`htÚs
(seqno);

279 
	`b©adv_£nd_skb_·ck‘
(
skb
, 
h¬d_içû
, 
d¡addr
);

280 
	`b©adv_£nd_skb_·ck‘
(
äag_skb
, 
h¬d_içû
, 
d¡addr
);

281 
»t
 = 
NET_RX_SUCCESS
;

282 
out
;

284 
drİ_äag
:

285 
	`kä“_skb
(
äag_skb
);

286 
drİ³d
:

287 
	`kä“_skb
(
skb
);

288 
out
:

289 ià(
´im¬y_if
)

290 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

291  
»t
;

292 
	}
}

294 
	$b©adv_uniÿ¡_£nd_skb
(
sk_buff
 *
skb
, 
b©adv_´iv
 *
b©_´iv
)

296 
‘hhdr
 *‘hhd¸ğ(‘hhd¸*)
skb
->
d©a
;

297 
b©adv_uniÿ¡_·ck‘
 *
uniÿ¡_·ck‘
;

298 
b©adv_Üig_node
 *
Üig_node
;

299 
b©adv_Ãigh_node
 *
Ãigh_node
;

300 
d©a_Ën
 = 
skb
->
Ën
;

301 
»t
 = 1;

302 
dev_mtu
;

305 ià(
	`is_muÉiÿ¡_‘h”_addr
(
‘hhdr
->
h_de¡
)) {

306 
Üig_node
 = 
	`b©adv_gw_g‘_£Ëùed_Üig
(
b©_´iv
);

307 ià(
Üig_node
)

308 
fšd_rou‹r
;

314 
Üig_node
 = 
	`b©adv_Œª¡abË_£¬ch
(
b©_´iv
, 
‘hhdr
->
h_sourû
,

315 
‘hhdr
->
h_de¡
);

317 
fšd_rou‹r
:

322 
Ãigh_node
 = 
	`b©adv_fšd_rou‹r
(
b©_´iv
, 
Üig_node
, 
NULL
);

324 ià(!
Ãigh_node
)

325 
out
;

327 ià(
	`b©adv_skb_h—d_push
(
skb
, (*
uniÿ¡_·ck‘
)) < 0)

328 
out
;

330 
uniÿ¡_·ck‘
 = (
b©adv_uniÿ¡_·ck‘
 *)
skb
->
d©a
;

332 
uniÿ¡_·ck‘
->
h—d”
.
v”siÚ
 = 
BATADV_COMPAT_VERSION
;

334 
uniÿ¡_·ck‘
->
h—d”
.
·ck‘_ty³
 = 
BATADV_UNICAST
;

336 
uniÿ¡_·ck‘
->
h—d”
.
‰l
 = 
BATADV_TTL
;

338 
	`memıy
(
uniÿ¡_·ck‘
->
de¡
, 
Üig_node
->
Üig
, 
ETH_ALEN
);

340 
uniÿ¡_·ck‘
->
‰vn
 = (
ušt8_t
)
	`©omic_»ad
(&
Üig_node
->
Ï¡_‰vn
);

347 ià(
	`b©adv_‰_glob®_ş›Á_is_rßmšg
(
b©_´iv
, 
‘hhdr
->
h_de¡
))

348 
uniÿ¡_·ck‘
->
‰vn
 = unicast_packet->ttvn - 1;

350 
dev_mtu
 = 
Ãigh_node
->
if_šcomšg
->
Ãt_dev
->
mtu
;

351 ià(
	`©omic_»ad
(&
b©_´iv
->
äagm’tiÚ
) &&

352 
d©a_Ën
 + (*
uniÿ¡_·ck‘
è> 
dev_mtu
) {

354 
uniÿ¡_·ck‘
->
h—d”
.
‰l
++;

355 
»t
 = 
	`b©adv_äag_£nd_skb
(
skb
, 
b©_´iv
,

356 
Ãigh_node
->
if_šcomšg
,

357 
Ãigh_node
->
addr
);

358 
out
;

361 
	`b©adv_£nd_skb_·ck‘
(
skb
, 
Ãigh_node
->
if_šcomšg
,‚eigh_node->
addr
);

362 
»t
 = 0;

363 
out
;

365 
out
:

366 ià(
Ãigh_node
)

367 
	`b©adv_Ãigh_node_ä“_»f
(
Ãigh_node
);

368 ià(
Üig_node
)

369 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

370 ià(
»t
 == 1)

371 
	`kä“_skb
(
skb
);

372  
»t
;

373 
	}
}

	@unicast.h

20 #iâdeà
_NET_BATMAN_ADV_UNICAST_H_


21 
	#_NET_BATMAN_ADV_UNICAST_H_


	)

23 
	~"·ck‘.h
"

25 
	#BATADV_FRAG_TIMEOUT
 10000

	)

26 
	#BATADV_FRAG_BUFFER_SIZE
 6

	)

28 
b©adv_äag_»as£mbË_skb
(
sk_buff
 *
skb
,

29 
b©adv_´iv
 *
b©_´iv
,

30 
sk_buff
 **
Ãw_skb
);

31 
b©adv_äag_li¡_ä“
(
li¡_h—d
 *
h—d
);

32 
b©adv_uniÿ¡_£nd_skb
(
sk_buff
 *
skb
, 
b©adv_´iv
 *
b©_´iv
);

33 
b©adv_äag_£nd_skb
(
sk_buff
 *
skb
, 
b©adv_´iv
 *
b©_´iv
,

34 
b©adv_h¬d_içû
 *
h¬d_içû
,

35 cÚ¡ 
ušt8_t
 
d¡addr
[]);

37 
šlše
 
	$b©adv_äag_ÿn_»as£mbË
(cÚ¡ 
sk_buff
 *
skb
, 
mtu
)

39 cÚ¡ 
b©adv_uniÿ¡_äag_·ck‘
 *
uniÿ¡_·ck‘
;

40 
uÃv’_cÜ»ùiÚ
 = 0;

41 
m”ged_size
;

43 
uniÿ¡_·ck‘
 = (
b©adv_uniÿ¡_äag_·ck‘
 *)
skb
->
d©a
;

45 ià(
uniÿ¡_·ck‘
->
æags
 & 
BATADV_UNI_FRAG_LARGETAIL
) {

46 ià(
uniÿ¡_·ck‘
->
æags
 & 
BATADV_UNI_FRAG_HEAD
)

47 
uÃv’_cÜ»ùiÚ
 = 1;

49 
uÃv’_cÜ»ùiÚ
 = -1;

52 
m”ged_size
 = (
skb
->
Ën
 - (*
uniÿ¡_·ck‘
)) * 2;

53 
m”ged_size
 +ğ(
b©adv_uniÿ¡_·ck‘
è+ 
uÃv’_cÜ»ùiÚ
;

55  
m”ged_size
 <ğ
mtu
;

56 
	}
}

	@vis.c

20 
	~"maš.h
"

21 
	~"£nd.h
"

22 
	~"Œª¦©iÚ-bË.h
"

23 
	~"vis.h
"

24 
	~"soá-š‹rçû.h
"

25 
	~"h¬d-š‹rçû.h
"

26 
	~"hash.h
"

27 
	~"Üigš©Ü.h
"

29 
	#BATADV_MAX_VIS_PACKET_SIZE
 1000

	)

31 
b©adv_¡¬t_vis_tim”
(
b©adv_´iv
 *
b©_´iv
);

34 
	$b©adv_ä“_šfo
(
k»f
 *
»f
)

36 
b©adv_vis_šfo
 *
šfo
;

37 
b©adv_´iv
 *
b©_´iv
;

38 
b©adv_»cvli¡_node
 *
’Œy
, *
tmp
;

40 
šfo
 = 
	`cÚš”_of
(
»f
, 
b©adv_vis_šfo
, 
»fcouÁ
);

41 
b©_´iv
 = 
šfo
->bat_priv;

43 
	`li¡_d–_š™
(&
šfo
->
£nd_li¡
);

44 
	`¥š_lock_bh
(&
b©_´iv
->
vis
.
li¡_lock
);

45 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
tmp
, &
šfo
->
»cv_li¡
, 
li¡
) {

46 
	`li¡_d–
(&
’Œy
->
li¡
);

47 
	`kä“
(
’Œy
);

50 
	`¥š_uÆock_bh
(&
b©_´iv
->
vis
.
li¡_lock
);

51 
	`kä“_skb
(
šfo
->
skb_·ck‘
);

52 
	`kä“
(
šfo
);

53 
	}
}

56 
	$b©adv_vis_šfo_cmp
(cÚ¡ 
hli¡_node
 *
node
, cÚ¡ *
d©a2
)

58 cÚ¡ 
b©adv_vis_šfo
 *
d1
, *
d2
;

59 cÚ¡ 
b©adv_vis_·ck‘
 *
p1
, *
p2
;

61 
d1
 = 
	`cÚš”_of
(
node
, 
b©adv_vis_šfo
, 
hash_’Œy
);

62 
d2
 = 
d©a2
;

63 
p1
 = (
b©adv_vis_·ck‘
 *)
d1
->
skb_·ck‘
->
d©a
;

64 
p2
 = (
b©adv_vis_·ck‘
 *)
d2
->
skb_·ck‘
->
d©a
;

65  
	`b©adv_com·»_‘h
(
p1
->
vis_Üig
, 
p2
->vis_orig);

66 
	}
}

71 
ušt32_t
 
	$b©adv_vis_šfo_choo£
(cÚ¡ *
d©a
, 
ušt32_t
 
size
)

73 cÚ¡ 
b©adv_vis_šfo
 *
vis_šfo
 = 
d©a
;

74 cÚ¡ 
b©adv_vis_·ck‘
 *
·ck‘
;

75 cÚ¡ *
key
;

76 
ušt32_t
 
hash
 = 0;

77 
size_t
 
i
;

79 
·ck‘
 = (
b©adv_vis_·ck‘
 *)
vis_šfo
->
skb_·ck‘
->
d©a
;

80 
key
 = 
·ck‘
->
vis_Üig
;

81 
i
 = 0; i < 
ETH_ALEN
; i++) {

82 
hash
 +ğ
key
[
i
];

83 
hash
 += (hash << 10);

84 
hash
 ^= (hash >> 6);

87 
hash
 += (hash << 3);

88 
hash
 ^= (hash >> 11);

89 
hash
 += (hash << 15);

91  
hash
 % 
size
;

92 
	}
}

94 
b©adv_vis_šfo
 *

95 
	$b©adv_vis_hash_fšd
(
b©adv_´iv
 *
b©_´iv
, cÚ¡ *
d©a
)

97 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
vis
.hash;

98 
hli¡_h—d
 *
h—d
;

99 
hli¡_node
 *
node
;

100 
b©adv_vis_šfo
 *
vis_šfo
, *
vis_šfo_tmp
 = 
NULL
;

101 
ušt32_t
 
šdex
;

103 ià(!
hash
)

104  
NULL
;

106 
šdex
 = 
	`b©adv_vis_šfo_choo£
(
d©a
, 
hash
->
size
);

107 
h—d
 = &
hash
->
bË
[
šdex
];

109 
	`rcu_»ad_lock
();

110 
	`hli¡_fÜ_—ch_’Œy_rcu
(
vis_šfo
, 
node
, 
h—d
, 
hash_’Œy
) {

111 ià(!
	`b©adv_vis_šfo_cmp
(
node
, 
d©a
))

114 
vis_šfo_tmp
 = 
vis_šfo
;

117 
	`rcu_»ad_uÆock
();

119  
vis_šfo_tmp
;

120 
	}
}

125 
	$b©adv_vis_d©a_š£¹_š‹rçû
(cÚ¡ 
ušt8_t
 *
š‹rçû
,

126 
hli¡_h—d
 *
if_li¡
,

127 
boŞ
 
´im¬y
)

129 
b©adv_if_li¡_’Œy
 *
’Œy
;

130 
hli¡_node
 *
pos
;

132 
	`hli¡_fÜ_—ch_’Œy
(
’Œy
, 
pos
, 
if_li¡
, 
li¡
) {

133 ià(
	`b©adv_com·»_‘h
(
’Œy
->
addr
, 
š‹rçû
))

138 
’Œy
 = 
	`km®loc
((*’Œy), 
GFP_ATOMIC
);

139 ià(!
’Œy
)

141 
	`memıy
(
’Œy
->
addr
, 
š‹rçû
, 
ETH_ALEN
);

142 
’Œy
->
´im¬y
 =…rimary;

143 
	`hli¡_add_h—d
(&
’Œy
->
li¡
, 
if_li¡
);

144 
	}
}

146 
	$b©adv_vis_d©a_»ad_´im_£c
(
£q_fe
 *
£q
,

147 cÚ¡ 
hli¡_h—d
 *
if_li¡
)

149 
b©adv_if_li¡_’Œy
 *
’Œy
;

150 
hli¡_node
 *
pos
;

152 
	`hli¡_fÜ_—ch_’Œy
(
’Œy
, 
pos
, 
if_li¡
, 
li¡
) {

153 ià(
’Œy
->
´im¬y
)

154 
	`£q_´štf
(
£q
, "PRIMARY, ");

156 
	`£q_´štf
(
£q
, "SEC %pM, ", 
’Œy
->
addr
);

158 
	}
}

161 
ssize_t


162 
	$b©adv_vis_d©a_»ad_’Œy
(
£q_fe
 *
£q
,

163 cÚ¡ 
b©adv_vis_šfo_’Œy
 *
’Œy
,

164 cÚ¡ 
ušt8_t
 *
¤c
, 
boŞ
 
´im¬y
)

166 ià(
´im¬y
 && 
’Œy
->
qu®™y
 == 0)

167  
	`£q_´štf
(
£q
, "TT %pM, ", 
’Œy
->
de¡
);

168 ià(
	`b©adv_com·»_‘h
(
’Œy
->
¤c
, src))

169  
	`£q_´štf
(
£q
, "TQ %pM %d, ", 
’Œy
->
de¡
,

170 
’Œy
->
qu®™y
);

173 
	}
}

176 
	$b©adv_vis_d©a_š£¹_š‹rçûs
(
hli¡_h—d
 *
li¡
,

177 
b©adv_vis_·ck‘
 *
·ck‘
,

178 
b©adv_vis_šfo_’Œy
 *
’Œ›s
)

180 
i
;

182 
i
 = 0; i < 
·ck‘
->
’Œ›s
; i++) {

183 ià(
’Œ›s
[
i
].
qu®™y
 == 0)

186 ià(
	`b©adv_com·»_‘h
(
’Œ›s
[
i
].
¤c
, 
·ck‘
->
vis_Üig
))

189 
	`b©adv_vis_d©a_š£¹_š‹rçû
(
’Œ›s
[
i
].
¤c
, 
li¡
, 
çl£
);

191 
	}
}

193 
	$b©adv_vis_d©a_»ad_’Œ›s
(
£q_fe
 *
£q
,

194 
hli¡_h—d
 *
li¡
,

195 
b©adv_vis_·ck‘
 *
·ck‘
,

196 
b©adv_vis_šfo_’Œy
 *
’Œ›s
)

198 
i
;

199 
b©adv_if_li¡_’Œy
 *
’Œy
;

200 
hli¡_node
 *
pos
;

202 
	`hli¡_fÜ_—ch_’Œy
(
’Œy
, 
pos
, 
li¡
,†ist) {

203 
	`£q_´štf
(
£q
, "%pM,", 
’Œy
->
addr
);

205 
i
 = 0; i < 
·ck‘
->
’Œ›s
; i++)

206 
	`b©adv_vis_d©a_»ad_’Œy
(
£q
, &
’Œ›s
[
i
],

207 
’Œy
->
addr
,ƒÁry->
´im¬y
);

210 ià(
	`b©adv_com·»_‘h
(
’Œy
->
addr
, 
·ck‘
->
vis_Üig
))

211 
	`b©adv_vis_d©a_»ad_´im_£c
(
£q
, 
li¡
);

213 
	`£q_´štf
(
£q
, "\n");

215 
	}
}

217 
	$b©adv_vis_£q_´št_‹xt_buck‘
(
£q_fe
 *
£q
,

218 cÚ¡ 
hli¡_h—d
 *
h—d
)

220 
hli¡_node
 *
node
;

221 
b©adv_vis_šfo
 *
šfo
;

222 
b©adv_vis_·ck‘
 *
·ck‘
;

223 
ušt8_t
 *
’Œ›s_pos
;

224 
b©adv_vis_šfo_’Œy
 *
’Œ›s
;

225 
b©adv_if_li¡_’Œy
 *
’Œy
;

226 
hli¡_node
 *
pos
, *
n
;

228 
	`HLIST_HEAD
(
vis_if_li¡
);

230 
	`hli¡_fÜ_—ch_’Œy_rcu
(
šfo
, 
node
, 
h—d
, 
hash_’Œy
) {

231 
·ck‘
 = (
b©adv_vis_·ck‘
 *)
šfo
->
skb_·ck‘
->
d©a
;

232 
’Œ›s_pos
 = (
ušt8_t
 *)
·ck‘
 + (*packet);

233 
’Œ›s
 = (
b©adv_vis_šfo_’Œy
 *)
’Œ›s_pos
;

235 
	`b©adv_vis_d©a_š£¹_š‹rçû
(
·ck‘
->
vis_Üig
, &
vis_if_li¡
,

236 
Œue
);

237 
	`b©adv_vis_d©a_š£¹_š‹rçûs
(&
vis_if_li¡
, 
·ck‘
,

238 
’Œ›s
);

239 
	`b©adv_vis_d©a_»ad_’Œ›s
(
£q
, &
vis_if_li¡
, 
·ck‘
,

240 
’Œ›s
);

242 
	`hli¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
pos
, 
n
, &
vis_if_li¡
, 
li¡
) {

243 
	`hli¡_d–
(&
’Œy
->
li¡
);

244 
	`kä“
(
’Œy
);

247 
	}
}

249 
	$b©adv_vis_£q_´št_‹xt
(
£q_fe
 *
£q
, *
off£t
)

251 
b©adv_h¬d_içû
 *
´im¬y_if
;

252 
hli¡_h—d
 *
h—d
;

253 
Ãt_deviû
 *
Ãt_dev
 = (Ãt_deviû *)
£q
->
´iv©e
;

254 
b©adv_´iv
 *
b©_´iv
 = 
	`Ãtdev_´iv
(
Ãt_dev
);

255 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
vis
.hash;

256 
ušt32_t
 
i
;

257 
»t
 = 0;

258 
vis_£rv”
 = 
	`©omic_»ad
(&
b©_´iv
->
vis_mode
);

260 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

261 ià(!
´im¬y_if
)

262 
out
;

264 ià(
vis_£rv”
 =ğ
BATADV_VIS_TYPE_CLIENT_UPDATE
)

265 
out
;

267 
	`¥š_lock_bh
(&
b©_´iv
->
vis
.
hash_lock
);

268 
i
 = 0; i < 
hash
->
size
; i++) {

269 
h—d
 = &
hash
->
bË
[
i
];

270 
	`b©adv_vis_£q_´št_‹xt_buck‘
(
£q
, 
h—d
);

272 
	`¥š_uÆock_bh
(&
b©_´iv
->
vis
.
hash_lock
);

274 
out
:

275 ià(
´im¬y_if
)

276 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

277  
»t
;

278 
	}
}

283 
	$b©adv_£nd_li¡_add
(
b©adv_´iv
 *
b©_´iv
,

284 
b©adv_vis_šfo
 *
šfo
)

286 ià(
	`li¡_em±y
(&
šfo
->
£nd_li¡
)) {

287 
	`k»f_g‘
(&
šfo
->
»fcouÁ
);

288 
	`li¡_add_
(&
šfo
->
£nd_li¡
, &
b©_´iv
->
vis
.send_list);

290 
	}
}

295 
	$b©adv_£nd_li¡_d–
(
b©adv_vis_šfo
 *
šfo
)

297 ià(!
	`li¡_em±y
(&
šfo
->
£nd_li¡
)) {

298 
	`li¡_d–_š™
(&
šfo
->
£nd_li¡
);

299 
	`k»f_put
(&
šfo
->
»fcouÁ
, 
b©adv_ä“_šfo
);

301 
	}
}

304 
	$b©adv_»cv_li¡_add
(
b©adv_´iv
 *
b©_´iv
,

305 
li¡_h—d
 *
»cv_li¡
, cÚ¡ *
mac
)

307 
b©adv_»cvli¡_node
 *
’Œy
;

309 
’Œy
 = 
	`km®loc
((*’Œy), 
GFP_ATOMIC
);

310 ià(!
’Œy
)

313 
	`memıy
(
’Œy
->
mac
, mac, 
ETH_ALEN
);

314 
	`¥š_lock_bh
(&
b©_´iv
->
vis
.
li¡_lock
);

315 
	`li¡_add_
(&
’Œy
->
li¡
, 
»cv_li¡
);

316 
	`¥š_uÆock_bh
(&
b©_´iv
->
vis
.
li¡_lock
);

317 
	}
}

320 
	$b©adv_»cv_li¡_is_š
(
b©adv_´iv
 *
b©_´iv
,

321 cÚ¡ 
li¡_h—d
 *
»cv_li¡
,

322 cÚ¡ *
mac
)

324 cÚ¡ 
b©adv_»cvli¡_node
 *
’Œy
;

326 
	`¥š_lock_bh
(&
b©_´iv
->
vis
.
li¡_lock
);

327 
	`li¡_fÜ_—ch_’Œy
(
’Œy
, 
»cv_li¡
, 
li¡
) {

328 ià(
	`b©adv_com·»_‘h
(
’Œy
->
mac
, mac)) {

329 
	`¥š_uÆock_bh
(&
b©_´iv
->
vis
.
li¡_lock
);

333 
	`¥š_uÆock_bh
(&
b©_´iv
->
vis
.
li¡_lock
);

335 
	}
}

341 
b©adv_vis_šfo
 *

342 
	$b©adv_add_·ck‘
(
b©adv_´iv
 *
b©_´iv
,

343 
b©adv_vis_·ck‘
 *
vis_·ck‘
, 
vis_šfo_Ën
,

344 *
is_Ãw
, 
make_brßdÿ¡
)

346 
b©adv_vis_šfo
 *
šfo
, *
Şd_šfo
;

347 
b©adv_vis_·ck‘
 *
£¬ch_·ck‘
, *
Şd_·ck‘
;

348 
b©adv_vis_šfo
 
£¬ch_–em
;

349 
b©adv_vis_·ck‘
 *
·ck‘
;

350 
sk_buff
 *
tmp_skb
;

351 
hash_added
;

352 
size_t
 
Ën
;

353 
size_t
 
max_’Œ›s
;

355 *
is_Ãw
 = 0;

357 ià(!
b©_´iv
->
vis
.
hash
)

358  
NULL
;

361 
£¬ch_–em
.
skb_·ck‘
 = 
	`dev_®loc_skb
((*
£¬ch_·ck‘
));

362 ià(!
£¬ch_–em
.
skb_·ck‘
)

363  
NULL
;

364 
Ën
 = (*
£¬ch_·ck‘
);

365 
tmp_skb
 = 
£¬ch_–em
.
skb_·ck‘
;

366 
£¬ch_·ck‘
 = (
b©adv_vis_·ck‘
 *)
	`skb_put
(
tmp_skb
, 
Ën
);

368 
	`memıy
(
£¬ch_·ck‘
->
vis_Üig
, 
vis_·ck‘
->vis_Üig, 
ETH_ALEN
);

369 
Şd_šfo
 = 
	`b©adv_vis_hash_fšd
(
b©_´iv
, &
£¬ch_–em
);

370 
	`kä“_skb
(
£¬ch_–em
.
skb_·ck‘
);

372 ià(
Şd_šfo
) {

373 
tmp_skb
 = 
Şd_šfo
->
skb_·ck‘
;

374 
Şd_·ck‘
 = (
b©adv_vis_·ck‘
 *)
tmp_skb
->
d©a
;

375 ià(!
	`b©adv_£q_aá”
(
	`Áohl
(
vis_·ck‘
->
£qno
),

376 
	`Áohl
(
Şd_·ck‘
->
£qno
))) {

377 ià(
Şd_·ck‘
->
£qno
 =ğ
vis_·ck‘
->seqno) {

378 
	`b©adv_»cv_li¡_add
(
b©_´iv
,

379 &
Şd_šfo
->
»cv_li¡
,

380 
vis_·ck‘
->
£nd”_Üig
);

381  
Şd_šfo
;

384  
NULL
;

388 
	`b©adv_hash_»move
(
b©_´iv
->
vis
.
hash
, 
b©adv_vis_šfo_cmp
,

389 
b©adv_vis_šfo_choo£
, 
Şd_šfo
);

390 
	`b©adv_£nd_li¡_d–
(
Şd_šfo
);

391 
	`k»f_put
(&
Şd_šfo
->
»fcouÁ
, 
b©adv_ä“_šfo
);

394 
šfo
 = 
	`km®loc
((*šfo), 
GFP_ATOMIC
);

395 ià(!
šfo
)

396  
NULL
;

398 
Ën
 = (*
·ck‘
è+ 
vis_šfo_Ën
;

399 
šfo
->
skb_·ck‘
 = 
	`dev_®loc_skb
(
Ën
 + 
ETH_HLEN
);

400 ià(!
šfo
->
skb_·ck‘
) {

401 
	`kä“
(
šfo
);

402  
NULL
;

404 
	`skb_»£rve
(
šfo
->
skb_·ck‘
, 
ETH_HLEN
);

405 
·ck‘
 = (
b©adv_vis_·ck‘
 *)
	`skb_put
(
šfo
->
skb_·ck‘
, 
Ën
);

407 
	`k»f_š™
(&
šfo
->
»fcouÁ
);

408 
	`INIT_LIST_HEAD
(&
šfo
->
£nd_li¡
);

409 
	`INIT_LIST_HEAD
(&
šfo
->
»cv_li¡
);

410 
šfo
->
fœ¡_£’
 = 
jiff›s
;

411 
šfo
->
b©_´iv
 = bat_priv;

412 
	`memıy
(
·ck‘
, 
vis_·ck‘
, 
Ën
);

415 *
is_Ãw
 = 1;

418 ià(
make_brßdÿ¡
)

419 
	`memıy
(
·ck‘
->
rg‘_Üig
, 
b©adv_brßdÿ¡_addr
, 
ETH_ALEN
);

422 
max_’Œ›s
 = 
vis_šfo_Ën
 / (
b©adv_vis_šfo_’Œy
);

423 ià(
·ck‘
->
’Œ›s
 > 
max_’Œ›s
)

424 
·ck‘
->
’Œ›s
 = 
max_’Œ›s
;

426 
	`b©adv_»cv_li¡_add
(
b©_´iv
, &
šfo
->
»cv_li¡
, 
·ck‘
->
£nd”_Üig
);

429 
hash_added
 = 
	`b©adv_hash_add
(
b©_´iv
->
vis
.
hash
, 
b©adv_vis_šfo_cmp
,

430 
b©adv_vis_šfo_choo£
, 
šfo
,

431 &
šfo
->
hash_’Œy
);

432 ià(
hash_added
 != 0) {

434 
	`k»f_put
(&
šfo
->
»fcouÁ
, 
b©adv_ä“_šfo
);

435 
šfo
 = 
NULL
;

438  
šfo
;

439 
	}
}

442 
	$b©adv_»ûive_£rv”_sync_·ck‘
(
b©adv_´iv
 *
b©_´iv
,

443 
b©adv_vis_·ck‘
 *
vis_·ck‘
,

444 
vis_šfo_Ën
)

446 
b©adv_vis_šfo
 *
šfo
;

447 
is_Ãw
, 
make_brßdÿ¡
;

448 
vis_£rv”
 = 
	`©omic_»ad
(&
b©_´iv
->
vis_mode
);

450 
make_brßdÿ¡
 = (
vis_£rv”
 =ğ
BATADV_VIS_TYPE_SERVER_SYNC
);

452 
	`¥š_lock_bh
(&
b©_´iv
->
vis
.
hash_lock
);

453 
šfo
 = 
	`b©adv_add_·ck‘
(
b©_´iv
, 
vis_·ck‘
, 
vis_šfo_Ën
,

454 &
is_Ãw
, 
make_brßdÿ¡
);

455 ià(!
šfo
)

456 
’d
;

461 ià(
vis_£rv”
 =ğ
BATADV_VIS_TYPE_SERVER_SYNC
 && 
is_Ãw
)

462 
	`b©adv_£nd_li¡_add
(
b©_´iv
, 
šfo
);

463 
’d
:

464 
	`¥š_uÆock_bh
(&
b©_´iv
->
vis
.
hash_lock
);

465 
	}
}

468 
	$b©adv_»ûive_ş›Á_upd©e_·ck‘
(
b©adv_´iv
 *
b©_´iv
,

469 
b©adv_vis_·ck‘
 *
vis_·ck‘
,

470 
vis_šfo_Ën
)

472 
b©adv_vis_šfo
 *
šfo
;

473 
b©adv_vis_·ck‘
 *
·ck‘
;

474 
is_Ãw
;

475 
vis_£rv”
 = 
	`©omic_»ad
(&
b©_´iv
->
vis_mode
);

476 
¬e_rg‘
 = 0;

479 ià(
	`is_brßdÿ¡_‘h”_addr
(
vis_·ck‘
->
rg‘_Üig
))

483 ià(
vis_£rv”
 =ğ
BATADV_VIS_TYPE_SERVER_SYNC
 &&

484 
	`b©adv_is_my_mac
(
vis_·ck‘
->
rg‘_Üig
))

485 
¬e_rg‘
 = 1;

487 
	`¥š_lock_bh
(&
b©_´iv
->
vis
.
hash_lock
);

488 
šfo
 = 
	`b©adv_add_·ck‘
(
b©_´iv
, 
vis_·ck‘
, 
vis_šfo_Ën
,

489 &
is_Ãw
, 
¬e_rg‘
);

491 ià(!
šfo
)

492 
’d
;

495 
·ck‘
 = (
b©adv_vis_·ck‘
 *)
šfo
->
skb_·ck‘
->
d©a
;

498 ià(
¬e_rg‘
 && 
is_Ãw
) {

499 
·ck‘
->
vis_ty³
 = 
BATADV_VIS_TYPE_SERVER_SYNC
;

500 
	`b©adv_£nd_li¡_add
(
b©_´iv
, 
šfo
);

503 } ià(!
	`b©adv_is_my_mac
(
·ck‘
->
rg‘_Üig
)) {

504 
	`b©adv_£nd_li¡_add
(
b©_´iv
, 
šfo
);

507 
’d
:

508 
	`¥š_uÆock_bh
(&
b©_´iv
->
vis
.
hash_lock
);

509 
	}
}

516 
	$b©adv_fšd_be¡_vis_£rv”
(
b©adv_´iv
 *
b©_´iv
,

517 
b©adv_vis_šfo
 *
šfo
)

519 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
Üig_hash
;

520 
b©adv_Ãigh_node
 *
rou‹r
;

521 
hli¡_node
 *
node
;

522 
hli¡_h—d
 *
h—d
;

523 
b©adv_Üig_node
 *
Üig_node
;

524 
b©adv_vis_·ck‘
 *
·ck‘
;

525 
be¡_tq
 = -1;

526 
ušt32_t
 
i
;

528 
·ck‘
 = (
b©adv_vis_·ck‘
 *)
šfo
->
skb_·ck‘
->
d©a
;

530 
i
 = 0; i < 
hash
->
size
; i++) {

531 
h—d
 = &
hash
->
bË
[
i
];

533 
	`rcu_»ad_lock
();

534 
	`hli¡_fÜ_—ch_’Œy_rcu
(
Üig_node
, 
node
, 
h—d
, 
hash_’Œy
) {

535 
rou‹r
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_node
);

536 ià(!
rou‹r
)

539 ià((
Üig_node
->
æags
 & 
BATADV_VIS_SERVER
) &&

540 (
rou‹r
->
tq_avg
 > 
be¡_tq
)) {

541 
be¡_tq
 = 
rou‹r
->
tq_avg
;

542 
	`memıy
(
·ck‘
->
rg‘_Üig
, 
Üig_node
->
Üig
,

543 
ETH_ALEN
);

545 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r
);

547 
	`rcu_»ad_uÆock
();

550  
be¡_tq
;

551 
	}
}

554 
boŞ
 
	$b©adv_vis_·ck‘_fuÎ
(cÚ¡ 
b©adv_vis_šfo
 *
šfo
)

556 cÚ¡ 
b©adv_vis_·ck‘
 *
·ck‘
;

557 
size_t
 
num
;

559 
·ck‘
 = (
b©adv_vis_·ck‘
 *)
šfo
->
skb_·ck‘
->
d©a
;

560 
num
 = 
BATADV_MAX_VIS_PACKET_SIZE
 / (
b©adv_vis_šfo_’Œy
);

562 ià(
num
 < 
·ck‘
->
’Œ›s
 + 1)

563  
Œue
;

564  
çl£
;

565 
	}
}

570 
	$b©adv_g’”©e_vis_·ck‘
(
b©adv_´iv
 *
b©_´iv
)

572 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
Üig_hash
;

573 
hli¡_node
 *
node
;

574 
hli¡_h—d
 *
h—d
;

575 
b©adv_Üig_node
 *
Üig_node
;

576 
b©adv_Ãigh_node
 *
rou‹r
;

577 
b©adv_vis_šfo
 *
šfo
 = 
b©_´iv
->
vis
.
my_šfo
;

578 
b©adv_vis_·ck‘
 *
·ck‘
;

579 
b©adv_vis_šfo_’Œy
 *
’Œy
;

580 
b©adv_‰_commÚ_’Œy
 *
‰_commÚ_’Œy
;

581 
ušt8_t
 *
·ck‘_pos
;

582 
be¡_tq
 = -1;

583 
ušt32_t
 
i
;

585 
šfo
->
fœ¡_£’
 = 
jiff›s
;

586 
·ck‘
 = (
b©adv_vis_·ck‘
 *)
šfo
->
skb_·ck‘
->
d©a
;

587 
·ck‘
->
vis_ty³
 = 
	`©omic_»ad
(&
b©_´iv
->
vis_mode
);

589 
	`memıy
(
·ck‘
->
rg‘_Üig
, 
b©adv_brßdÿ¡_addr
, 
ETH_ALEN
);

590 
·ck‘
->
h—d”
.
‰l
 = 
BATADV_TTL
;

591 
·ck‘
->
£qno
 = 
	`htÚl
(
	`Áohl
(packet->seqno) + 1);

592 
·ck‘
->
’Œ›s
 = 0;

593 
·ck‘
->
»£rved
 = 0;

594 
	`skb_Œim
(
šfo
->
skb_·ck‘
, (*
·ck‘
));

596 ià(
·ck‘
->
vis_ty³
 =ğ
BATADV_VIS_TYPE_CLIENT_UPDATE
) {

597 
be¡_tq
 = 
	`b©adv_fšd_be¡_vis_£rv”
(
b©_´iv
, 
šfo
);

599 ià(
be¡_tq
 < 0)

600  
be¡_tq
;

603 
i
 = 0; i < 
hash
->
size
; i++) {

604 
h—d
 = &
hash
->
bË
[
i
];

606 
	`rcu_»ad_lock
();

607 
	`hli¡_fÜ_—ch_’Œy_rcu
(
Üig_node
, 
node
, 
h—d
, 
hash_’Œy
) {

608 
rou‹r
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_node
);

609 ià(!
rou‹r
)

612 ià(!
	`b©adv_com·»_‘h
(
rou‹r
->
addr
, 
Üig_node
->
Üig
))

613 
Ãxt
;

615 ià(
rou‹r
->
if_šcomšg
->
if_¡©us
 !ğ
BATADV_IF_ACTIVE
)

616 
Ãxt
;

618 ià(
rou‹r
->
tq_avg
 < 1)

619 
Ãxt
;

622 
·ck‘_pos
 = 
	`skb_put
(
šfo
->
skb_·ck‘
, (*
’Œy
));

623 
’Œy
 = (
b©adv_vis_šfo_’Œy
 *)
·ck‘_pos
;

624 
	`memıy
(
’Œy
->
¤c
,

625 
rou‹r
->
if_šcomšg
->
Ãt_dev
->
dev_addr
,

626 
ETH_ALEN
);

627 
	`memıy
(
’Œy
->
de¡
, 
Üig_node
->
Üig
, 
ETH_ALEN
);

628 
’Œy
->
qu®™y
 = 
rou‹r
->
tq_avg
;

629 
·ck‘
->
’Œ›s
++;

631 
Ãxt
:

632 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r
);

634 ià(
	`b©adv_vis_·ck‘_fuÎ
(
šfo
))

635 
uÆock
;

637 
	`rcu_»ad_uÆock
();

640 
hash
 = 
b©_´iv
->
‰
.
loÿl_hash
;

642 
i
 = 0; i < 
hash
->
size
; i++) {

643 
h—d
 = &
hash
->
bË
[
i
];

645 
	`rcu_»ad_lock
();

646 
	`hli¡_fÜ_—ch_’Œy_rcu
(
‰_commÚ_’Œy
, 
node
, 
h—d
,

647 
hash_’Œy
) {

648 
·ck‘_pos
 = 
	`skb_put
(
šfo
->
skb_·ck‘
, (*
’Œy
));

649 
’Œy
 = (
b©adv_vis_šfo_’Œy
 *)
·ck‘_pos
;

650 
	`mem£t
(
’Œy
->
¤c
, 0, 
ETH_ALEN
);

651 
	`memıy
(
’Œy
->
de¡
, 
‰_commÚ_’Œy
->
addr
, 
ETH_ALEN
);

652 
’Œy
->
qu®™y
 = 0;

653 
·ck‘
->
’Œ›s
++;

655 ià(
	`b©adv_vis_·ck‘_fuÎ
(
šfo
))

656 
uÆock
;

658 
	`rcu_»ad_uÆock
();

663 
uÆock
:

664 
	`rcu_»ad_uÆock
();

666 
	}
}

671 
	$b©adv_purge_vis_·ck‘s
(
b©adv_´iv
 *
b©_´iv
)

673 
ušt32_t
 
i
;

674 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
vis
.hash;

675 
hli¡_node
 *
node
, *
node_tmp
;

676 
hli¡_h—d
 *
h—d
;

677 
b©adv_vis_šfo
 *
šfo
;

679 
i
 = 0; i < 
hash
->
size
; i++) {

680 
h—d
 = &
hash
->
bË
[
i
];

682 
	`hli¡_fÜ_—ch_’Œy_§ã
(
šfo
, 
node
, 
node_tmp
,

683 
h—d
, 
hash_’Œy
) {

685 ià(
šfo
 =ğ
b©_´iv
->
vis
.
my_šfo
)

688 ià(
	`b©adv_has_timed_out
(
šfo
->
fœ¡_£’
,

689 
BATADV_VIS_TIMEOUT
)) {

690 
	`hli¡_d–
(
node
);

691 
	`b©adv_£nd_li¡_d–
(
šfo
);

692 
	`k»f_put
(&
šfo
->
»fcouÁ
, 
b©adv_ä“_šfo
);

696 
	}
}

698 
	$b©adv_brßdÿ¡_vis_·ck‘
(
b©adv_´iv
 *
b©_´iv
,

699 
b©adv_vis_šfo
 *
šfo
)

701 
b©adv_Ãigh_node
 *
rou‹r
;

702 
b©adv_hashbË
 *
hash
 = 
b©_´iv
->
Üig_hash
;

703 
hli¡_node
 *
node
;

704 
hli¡_h—d
 *
h—d
;

705 
b©adv_Üig_node
 *
Üig_node
;

706 
b©adv_vis_·ck‘
 *
·ck‘
;

707 
sk_buff
 *
skb
;

708 
b©adv_h¬d_içû
 *
h¬d_içû
;

709 
ušt8_t
 
d¡addr
[
ETH_ALEN
];

710 
ušt32_t
 
i
;

713 
·ck‘
 = (
b©adv_vis_·ck‘
 *)
šfo
->
skb_·ck‘
->
d©a
;

716 
i
 = 0; i < 
hash
->
size
; i++) {

717 
h—d
 = &
hash
->
bË
[
i
];

719 
	`rcu_»ad_lock
();

720 
	`hli¡_fÜ_—ch_’Œy_rcu
(
Üig_node
, 
node
, 
h—d
, 
hash_’Œy
) {

722 ià(!(
Üig_node
->
æags
 & 
BATADV_VIS_SERVER
))

725 
rou‹r
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_node
);

726 ià(!
rou‹r
)

732 ià(
	`b©adv_»cv_li¡_is_š
(
b©_´iv
, &
šfo
->
»cv_li¡
,

733 
Üig_node
->
Üig
)) {

734 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r
);

738 
	`memıy
(
·ck‘
->
rg‘_Üig
, 
Üig_node
->
Üig
, 
ETH_ALEN
);

739 
h¬d_içû
 = 
rou‹r
->
if_šcomšg
;

740 
	`memıy
(
d¡addr
, 
rou‹r
->
addr
, 
ETH_ALEN
);

742 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r
);

744 
skb
 = 
	`skb_şÚe
(
šfo
->
skb_·ck‘
, 
GFP_ATOMIC
);

745 ià(
skb
)

746 
	`b©adv_£nd_skb_·ck‘
(
skb
, 
h¬d_içû
,

747 
d¡addr
);

750 
	`rcu_»ad_uÆock
();

752 
	}
}

754 
	$b©adv_uniÿ¡_vis_·ck‘
(
b©adv_´iv
 *
b©_´iv
,

755 
b©adv_vis_šfo
 *
šfo
)

757 
b©adv_Üig_node
 *
Üig_node
;

758 
b©adv_Ãigh_node
 *
rou‹r
 = 
NULL
;

759 
sk_buff
 *
skb
;

760 
b©adv_vis_·ck‘
 *
·ck‘
;

762 
·ck‘
 = (
b©adv_vis_·ck‘
 *)
šfo
->
skb_·ck‘
->
d©a
;

764 
Üig_node
 = 
	`b©adv_Üig_hash_fšd
(
b©_´iv
, 
·ck‘
->
rg‘_Üig
);

765 ià(!
Üig_node
)

766 
out
;

768 
rou‹r
 = 
	`b©adv_Üig_node_g‘_rou‹r
(
Üig_node
);

769 ià(!
rou‹r
)

770 
out
;

772 
skb
 = 
	`skb_şÚe
(
šfo
->
skb_·ck‘
, 
GFP_ATOMIC
);

773 ià(
skb
)

774 
	`b©adv_£nd_skb_·ck‘
(
skb
, 
rou‹r
->
if_šcomšg
,„ou‹r->
addr
);

776 
out
:

777 ià(
rou‹r
)

778 
	`b©adv_Ãigh_node_ä“_»f
(
rou‹r
);

779 ià(
Üig_node
)

780 
	`b©adv_Üig_node_ä“_»f
(
Üig_node
);

781 
	}
}

784 
	$b©adv_£nd_vis_·ck‘
(
b©adv_´iv
 *
b©_´iv
,

785 
b©adv_vis_šfo
 *
šfo
)

787 
b©adv_h¬d_içû
 *
´im¬y_if
;

788 
b©adv_vis_·ck‘
 *
·ck‘
;

790 
´im¬y_if
 = 
	`b©adv_´im¬y_if_g‘_£Ëùed
(
b©_´iv
);

791 ià(!
´im¬y_if
)

792 
out
;

794 
·ck‘
 = (
b©adv_vis_·ck‘
 *)
šfo
->
skb_·ck‘
->
d©a
;

795 ià(
·ck‘
->
h—d”
.
‰l
 < 2) {

796 
	`´_debug
("Error - can't send vis…acket:tlƒxceeded\n");

797 
out
;

800 
	`memıy
(
·ck‘
->
£nd”_Üig
, 
´im¬y_if
->
Ãt_dev
->
dev_addr
, 
ETH_ALEN
);

801 
·ck‘
->
h—d”
.
‰l
--;

803 ià(
	`is_brßdÿ¡_‘h”_addr
(
·ck‘
->
rg‘_Üig
))

804 
	`b©adv_brßdÿ¡_vis_·ck‘
(
b©_´iv
, 
šfo
);

806 
	`b©adv_uniÿ¡_vis_·ck‘
(
b©_´iv
, 
šfo
);

807 
·ck‘
->
h—d”
.
‰l
++;

809 
out
:

810 ià(
´im¬y_if
)

811 
	`b©adv_h¬dif_ä“_»f
(
´im¬y_if
);

812 
	}
}

815 
	$b©adv_£nd_vis_·ck‘s
(
wÜk_¡ruù
 *
wÜk
)

817 
d–ayed_wÜk
 *delayed_work;

818 
b©adv_´iv
 *
b©_´iv
;

819 
b©adv_´iv_vis
 *
´iv_vis
;

820 
b©adv_vis_šfo
 *
šfo
;

822 
d–ayed_wÜk
 = 
	`cÚš”_of
(
wÜk
, delayed_work, work);

823 
´iv_vis
 = 
	`cÚš”_of
(
d–ayed_wÜk
, 
b©adv_´iv_vis
, 
wÜk
);

824 
b©_´iv
 = 
	`cÚš”_of
(
´iv_vis
, 
b©adv_´iv
, 
vis
);

825 
	`¥š_lock_bh
(&
b©_´iv
->
vis
.
hash_lock
);

826 
	`b©adv_purge_vis_·ck‘s
(
b©_´iv
);

828 ià(
	`b©adv_g’”©e_vis_·ck‘
(
b©_´iv
) == 0) {

830 
	`b©adv_£nd_li¡_add
(
b©_´iv
, b©_´iv->
vis
.
my_šfo
);

833 !
	`li¡_em±y
(&
b©_´iv
->
vis
.
£nd_li¡
)) {

834 
šfo
 = 
	`li¡_fœ¡_’Œy
(&
b©_´iv
->
vis
.
£nd_li¡
,

835 
	`ty³of
(*
šfo
), 
£nd_li¡
);

837 
	`k»f_g‘
(&
šfo
->
»fcouÁ
);

838 
	`¥š_uÆock_bh
(&
b©_´iv
->
vis
.
hash_lock
);

840 
	`b©adv_£nd_vis_·ck‘
(
b©_´iv
, 
šfo
);

842 
	`¥š_lock_bh
(&
b©_´iv
->
vis
.
hash_lock
);

843 
	`b©adv_£nd_li¡_d–
(
šfo
);

844 
	`k»f_put
(&
šfo
->
»fcouÁ
, 
b©adv_ä“_šfo
);

846 
	`¥š_uÆock_bh
(&
b©_´iv
->
vis
.
hash_lock
);

847 
	`b©adv_¡¬t_vis_tim”
(
b©_´iv
);

848 
	}
}

853 
	$b©adv_vis_š™
(
b©adv_´iv
 *
b©_´iv
)

855 
b©adv_vis_·ck‘
 *
·ck‘
;

856 
hash_added
;

857 
Ën
;

858 
fœ¡_£’
;

859 
sk_buff
 *
tmp_skb
;

861 ià(
b©_´iv
->
vis
.
hash
)

864 
	`¥š_lock_bh
(&
b©_´iv
->
vis
.
hash_lock
);

866 
b©_´iv
->
vis
.
hash
 = 
	`b©adv_hash_Ãw
(256);

867 ià(!
b©_´iv
->
vis
.
hash
) {

868 
	`´_”r
("Can't initialize vis_hash\n");

869 
”r
;

872 
b©_´iv
->
vis
.
my_šfo
 = 
	`km®loc
(
BATADV_MAX_VIS_PACKET_SIZE
, 
GFP_ATOMIC
);

873 ià(!
b©_´iv
->
vis
.
my_šfo
)

874 
”r
;

876 
Ën
 = (*
·ck‘
è+ 
BATADV_MAX_VIS_PACKET_SIZE
 + 
ETH_HLEN
;

877 
b©_´iv
->
vis
.
my_šfo
->
skb_·ck‘
 = 
	`dev_®loc_skb
(
Ën
);

878 ià(!
b©_´iv
->
vis
.
my_šfo
->
skb_·ck‘
)

879 
ä“_šfo
;

881 
	`skb_»£rve
(
b©_´iv
->
vis
.
my_šfo
->
skb_·ck‘
, 
ETH_HLEN
);

882 
tmp_skb
 = 
b©_´iv
->
vis
.
my_šfo
->
skb_·ck‘
;

883 
·ck‘
 = (
b©adv_vis_·ck‘
 *)
	`skb_put
(
tmp_skb
, (*packet));

886 
fœ¡_£’
 = 
jiff›s
 - 
	`m£cs_to_jiff›s
(
BATADV_VIS_INTERVAL
);

887 
b©_´iv
->
vis
.
my_šfo
->
fœ¡_£’
 = first_seen;

888 
	`INIT_LIST_HEAD
(&
b©_´iv
->
vis
.
my_šfo
->
»cv_li¡
);

889 
	`INIT_LIST_HEAD
(&
b©_´iv
->
vis
.
my_šfo
->
£nd_li¡
);

890 
	`k»f_š™
(&
b©_´iv
->
vis
.
my_šfo
->
»fcouÁ
);

891 
b©_´iv
->
vis
.
my_šfo
->bat_priv = bat_priv;

892 
·ck‘
->
h—d”
.
v”siÚ
 = 
BATADV_COMPAT_VERSION
;

893 
·ck‘
->
h—d”
.
·ck‘_ty³
 = 
BATADV_VIS
;

894 
·ck‘
->
h—d”
.
‰l
 = 
BATADV_TTL
;

895 
·ck‘
->
£qno
 = 0;

896 
·ck‘
->
»£rved
 = 0;

897 
·ck‘
->
’Œ›s
 = 0;

899 
	`INIT_LIST_HEAD
(&
b©_´iv
->
vis
.
£nd_li¡
);

901 
hash_added
 = 
	`b©adv_hash_add
(
b©_´iv
->
vis
.
hash
, 
b©adv_vis_šfo_cmp
,

902 
b©adv_vis_šfo_choo£
,

903 
b©_´iv
->
vis
.
my_šfo
,

904 &
b©_´iv
->
vis
.
my_šfo
->
hash_’Œy
);

905 ià(
hash_added
 != 0) {

906 
	`´_”r
("Can't‡dd own vis…acket into hash\n");

908 
	`k»f_put
(&
b©_´iv
->
vis
.
my_šfo
->
»fcouÁ
, 
b©adv_ä“_šfo
);

909 
”r
;

912 
	`¥š_uÆock_bh
(&
b©_´iv
->
vis
.
hash_lock
);

913 
	`b©adv_¡¬t_vis_tim”
(
b©_´iv
);

916 
ä“_šfo
:

917 
	`kä“
(
b©_´iv
->
vis
.
my_šfo
);

918 
b©_´iv
->
vis
.
my_šfo
 = 
NULL
;

919 
”r
:

920 
	`¥š_uÆock_bh
(&
b©_´iv
->
vis
.
hash_lock
);

921 
	`b©adv_vis_qu™
(
b©_´iv
);

922  -
ENOMEM
;

923 
	}
}

926 
	$b©adv_ä“_šfo_»f
(
hli¡_node
 *
node
, *
¬g
)

928 
b©adv_vis_šfo
 *
šfo
;

930 
šfo
 = 
	`cÚš”_of
(
node
, 
b©adv_vis_šfo
, 
hash_’Œy
);

931 
	`b©adv_£nd_li¡_d–
(
šfo
);

932 
	`k»f_put
(&
šfo
->
»fcouÁ
, 
b©adv_ä“_šfo
);

933 
	}
}

936 
	$b©adv_vis_qu™
(
b©adv_´iv
 *
b©_´iv
)

938 ià(!
b©_´iv
->
vis
.
hash
)

941 
	`ÿnûl_d–ayed_wÜk_sync
(&
b©_´iv
->
vis
.
wÜk
);

943 
	`¥š_lock_bh
(&
b©_´iv
->
vis
.
hash_lock
);

945 
	`b©adv_hash_d–‘e
(
b©_´iv
->
vis
.
hash
, 
b©adv_ä“_šfo_»f
, 
NULL
);

946 
b©_´iv
->
vis
.
hash
 = 
NULL
;

947 
b©_´iv
->
vis
.
my_šfo
 = 
NULL
;

948 
	`¥š_uÆock_bh
(&
b©_´iv
->
vis
.
hash_lock
);

949 
	}
}

952 
	$b©adv_¡¬t_vis_tim”
(
b©adv_´iv
 *
b©_´iv
)

954 
	`INIT_DELAYED_WORK
(&
b©_´iv
->
vis
.
wÜk
, 
b©adv_£nd_vis_·ck‘s
);

955 
	`queue_d–ayed_wÜk
(
b©adv_ev’t_wÜkqueue
, &
b©_´iv
->
vis
.
wÜk
,

956 
	`m£cs_to_jiff›s
(
BATADV_VIS_INTERVAL
));

957 
	}
}

	@vis.h

20 #iâdeà
_NET_BATMAN_ADV_VIS_H_


21 
	#_NET_BATMAN_ADV_VIS_H_


	)

24 
	#BATADV_VIS_TIMEOUT
 200000

	)

26 
b©adv_vis_£q_´št_‹xt
(
£q_fe
 *
£q
, *
off£t
);

27 
b©adv_»ûive_£rv”_sync_·ck‘
(
b©adv_´iv
 *
b©_´iv
,

28 
b©adv_vis_·ck‘
 *
vis_·ck‘
,

29 
vis_šfo_Ën
);

30 
b©adv_»ûive_ş›Á_upd©e_·ck‘
(
b©adv_´iv
 *
b©_´iv
,

31 
b©adv_vis_·ck‘
 *
vis_·ck‘
,

32 
vis_šfo_Ën
);

33 
b©adv_vis_š™
(
b©adv_´iv
 *
b©_´iv
);

34 
b©adv_vis_qu™
(
b©adv_´iv
 *
b©_´iv
);

	@/usr/include/linux/ethtool.h

13 #iâdeà
_LINUX_ETHTOOL_H


14 
	#_LINUX_ETHTOOL_H


	)

16 
	~<lšux/ty³s.h
>

17 
	~<lšux/if_‘h”.h
>

20 
	s‘htoŞ_cmd
 {

21 
__u32
 
	mcmd
;

22 
__u32
 
	msuµÜ‹d
;

23 
__u32
 
	madv”tisšg
;

24 
__u16
 
	m¥“d
;

28 
__u8
 
	mdu¶ex
;

29 
__u8
 
	mpÜt
;

30 
__u8
 
	mphy_add»ss
;

31 
__u8
 
	mŒªsûiv”
;

32 
__u8
 
	mautÚeg
;

33 
__u8
 
	mmdio_suµÜt
;

34 
__u32
 
	mmaxtxpkt
;

35 
__u32
 
	mmaxrxpkt
;

36 
__u16
 
	m¥“d_hi
;

40 
__u8
 
	m‘h__mdix
;

41 
__u8
 
	m»£rved2
;

42 
__u32
 
	mÍ_adv”tisšg
;

43 
__u32
 
	m»£rved
[2];

46 
__šlše__
 
	$‘htoŞ_cmd_¥“d_£t
(
‘htoŞ_cmd
 *
•
,

47 
__u32
 
¥“d
)

50 
•
->
¥“d
 = (
__u16
)speed;

51 
•
->
¥“d_hi
 = (
__u16
)(
¥“d
 >> 16);

52 
	}
}

54 
__šlše__
 
__u32
 
	$‘htoŞ_cmd_¥“d
(cÚ¡ 
‘htoŞ_cmd
 *
•
)

56  (
•
->
¥“d_hi
 << 16è|ƒp->
¥“d
;

57 
	}
}

59 
	#ETHTOOL_FWVERS_LEN
 32

	)

60 
	#ETHTOOL_BUSINFO_LEN
 32

	)

62 
	s‘htoŞ_drvšfo
 {

63 
__u32
 
	mcmd
;

64 
	mdriv”
[32];

65 
	mv”siÚ
[32];

66 
	mfw_v”siÚ
[
ETHTOOL_FWVERS_LEN
];

67 
	mbus_šfo
[
ETHTOOL_BUSINFO_LEN
];

69 
	m»£rved1
[32];

70 
	m»£rved2
[12];

78 
__u32
 
	mn_´iv_æags
;

79 
__u32
 
	mn_¡©s
;

80 
__u32
 
	m‹¡šfo_Ën
;

81 
__u32
 
	m“dump_Ën
;

82 
__u32
 
	m»gdump_Ën
;

85 
	#SOPASS_MAX
 6

	)

87 
	s‘htoŞ_wŞšfo
 {

88 
__u32
 
	mcmd
;

89 
__u32
 
	msuµÜ‹d
;

90 
__u32
 
	mwŞİts
;

91 
__u8
 
	msİass
[
SOPASS_MAX
];

95 
	s‘htoŞ_v®ue
 {

96 
__u32
 
	mcmd
;

97 
__u32
 
	md©a
;

101 
	s‘htoŞ_»gs
 {

102 
__u32
 
	mcmd
;

103 
__u32
 
	mv”siÚ
;

104 
__u32
 
	mËn
;

105 
__u8
 
	md©a
[0];

109 
	s‘htoŞ_“´om
 {

110 
__u32
 
	mcmd
;

111 
__u32
 
	mmagic
;

112 
__u32
 
	moff£t
;

113 
__u32
 
	mËn
;

114 
__u8
 
	md©a
[0];

189 
	s‘htoŞ_cßËsû
 {

190 
__u32
 
	mcmd
;

191 
__u32
 
	mrx_cßËsû_u£cs
;

192 
__u32
 
	mrx_max_cßËsûd_äames
;

193 
__u32
 
	mrx_cßËsû_u£cs_œq
;

194 
__u32
 
	mrx_max_cßËsûd_äames_œq
;

195 
__u32
 
	mtx_cßËsû_u£cs
;

196 
__u32
 
	mtx_max_cßËsûd_äames
;

197 
__u32
 
	mtx_cßËsû_u£cs_œq
;

198 
__u32
 
	mtx_max_cßËsûd_äames_œq
;

199 
__u32
 
	m¡©s_block_cßËsû_u£cs
;

200 
__u32
 
	mu£_ad­tive_rx_cßËsû
;

201 
__u32
 
	mu£_ad­tive_tx_cßËsû
;

202 
__u32
 
	mpkt_¿‹_low
;

203 
__u32
 
	mrx_cßËsû_u£cs_low
;

204 
__u32
 
	mrx_max_cßËsûd_äames_low
;

205 
__u32
 
	mtx_cßËsû_u£cs_low
;

206 
__u32
 
	mtx_max_cßËsûd_äames_low
;

207 
__u32
 
	mpkt_¿‹_high
;

208 
__u32
 
	mrx_cßËsû_u£cs_high
;

209 
__u32
 
	mrx_max_cßËsûd_äames_high
;

210 
__u32
 
	mtx_cßËsû_u£cs_high
;

211 
__u32
 
	mtx_max_cßËsûd_äames_high
;

212 
__u32
 
	m¿‹_§m¶e_š‹rv®
;

216 
	s‘htoŞ_ršg·¿m
 {

217 
__u32
 
	mcmd
;

223 
__u32
 
	mrx_max_³ndšg
;

224 
__u32
 
	mrx_mši_max_³ndšg
;

225 
__u32
 
	mrx_jumbo_max_³ndšg
;

226 
__u32
 
	mtx_max_³ndšg
;

231 
__u32
 
	mrx_³ndšg
;

232 
__u32
 
	mrx_mši_³ndšg
;

233 
__u32
 
	mrx_jumbo_³ndšg
;

234 
__u32
 
	mtx_³ndšg
;

253 
	s‘htoŞ_chªÃls
 {

254 
__u32
 
	mcmd
;

255 
__u32
 
	mmax_rx
;

256 
__u32
 
	mmax_tx
;

257 
__u32
 
	mmax_Ùh”
;

258 
__u32
 
	mmax_combšed
;

259 
__u32
 
	mrx_couÁ
;

260 
__u32
 
	mtx_couÁ
;

261 
__u32
 
	mÙh”_couÁ
;

262 
__u32
 
	mcombšed_couÁ
;

266 
	s‘htoŞ_·u£·¿m
 {

267 
__u32
 
	mcmd
;

279 
__u32
 
	mautÚeg
;

280 
__u32
 
	mrx_·u£
;

281 
__u32
 
	mtx_·u£
;

284 
	#ETH_GSTRING_LEN
 32

	)

285 
	e‘htoŞ_¡ršg£t
 {

286 
	mETH_SS_TEST
 = 0,

287 
	mETH_SS_STATS
,

288 
	mETH_SS_PRIV_FLAGS
,

289 
	mETH_SS_NTUPLE_FILTERS
,

290 
	mETH_SS_FEATURES
,

294 
	s‘htoŞ_g¡ršgs
 {

295 
__u32
 
	mcmd
;

296 
__u32
 
	m¡ršg_£t
;

297 
__u32
 
	mËn
;

298 
__u8
 
	md©a
[0];

301 
	s‘htoŞ_s£t_šfo
 {

302 
__u32
 
	mcmd
;

303 
__u32
 
	m»£rved
;

304 
__u64
 
	ms£t_mask
;

306 
__u32
 
	md©a
[0];

322 
	e‘htoŞ_‹¡_æags
 {

323 
	mETH_TEST_FL_OFFLINE
 = (1 << 0),

324 
	mETH_TEST_FL_FAILED
 = (1 << 1),

325 
	mETH_TEST_FL_EXTERNAL_LB
 = (1 << 2),

326 
	mETH_TEST_FL_EXTERNAL_LB_DONE
 = (1 << 3),

330 
	s‘htoŞ_‹¡
 {

331 
__u32
 
	mcmd
;

332 
__u32
 
	mæags
;

333 
__u32
 
	m»£rved
;

334 
__u32
 
	mËn
;

335 
__u64
 
	md©a
[0];

339 
	s‘htoŞ_¡©s
 {

340 
__u32
 
	mcmd
;

341 
__u32
 
	mn_¡©s
;

342 
__u64
 
	md©a
[0];

345 
	s‘htoŞ_³rm_addr
 {

346 
__u32
 
	mcmd
;

347 
__u32
 
	msize
;

348 
__u8
 
	md©a
[0];

360 
	e‘htoŞ_æags
 {

361 
	mETH_FLAG_TXVLAN
 = (1 << 7),

362 
	mETH_FLAG_RXVLAN
 = (1 << 8),

363 
	mETH_FLAG_LRO
 = (1 << 15),

364 
	mETH_FLAG_NTUPLE
 = (1 << 27),

365 
	mETH_FLAG_RXHASH
 = (1 << 28),

384 
	s‘htoŞ_tı4_¥ec
 {

385 
__be32
 
	m4¤c
;

386 
__be32
 
	m4d¡
;

387 
__be16
 
	mp¤c
;

388 
__be16
 
	mpd¡
;

389 
__u8
 
	mtos
;

401 
	s‘htoŞ_ah_e¥4_¥ec
 {

402 
__be32
 
	m4¤c
;

403 
__be32
 
	m4d¡
;

404 
__be32
 
	m¥i
;

405 
__u8
 
	mtos
;

408 
	#ETH_RX_NFC_IP4
 1

	)

419 
	s‘htoŞ_u¤4_¥ec
 {

420 
__be32
 
	m4¤c
;

421 
__be32
 
	m4d¡
;

422 
__be32
 
	ml4_4_by‹s
;

423 
__u8
 
	mtos
;

424 
__u8
 
	m_v”
;

425 
__u8
 
	m´Ùo
;

428 
	u‘htoŞ_æow_uniÚ
 {

429 
‘htoŞ_tı4_¥ec
 
	mtı_4_¥ec
;

430 
‘htoŞ_tı4_¥ec
 
	mudp_4_¥ec
;

431 
‘htoŞ_tı4_¥ec
 
	msùp_4_¥ec
;

432 
‘htoŞ_ah_e¥4_¥ec
 
	mah_4_¥ec
;

433 
‘htoŞ_ah_e¥4_¥ec
 
	me¥_4_¥ec
;

434 
‘htoŞ_u¤4_¥ec
 
	mu¤_4_¥ec
;

435 
‘hhdr
 
	m‘h”_¥ec
;

436 
__u8
 
	mhd©a
[60];

439 
	s‘htoŞ_æow_ext
 {

440 
__be16
 
	mvÏn_‘y³
;

441 
__be16
 
	mvÏn_tci
;

442 
__be32
 
	md©a
[2];

460 
	s‘htoŞ_rx_æow_¥ec
 {

461 
__u32
 
	mæow_ty³
;

462 
‘htoŞ_æow_uniÚ
 
	mh_u
;

463 
‘htoŞ_æow_ext
 
	mh_ext
;

464 
‘htoŞ_æow_uniÚ
 
	mm_u
;

465 
‘htoŞ_æow_ext
 
	mm_ext
;

466 
__u64
 
	mršg_cook›
;

467 
__u32
 
	mloÿtiÚ
;

506 
	s‘htoŞ_rxnfc
 {

507 
__u32
 
	mcmd
;

508 
__u32
 
	mæow_ty³
;

509 
__u64
 
	md©a
;

510 
‘htoŞ_rx_æow_¥ec
 
	mfs
;

511 
__u32
 
	mruË_út
;

512 
__u32
 
	mruË_locs
[0];

523 
	s‘htoŞ_rxfh_šdœ
 {

524 
__u32
 
	mcmd
;

525 
__u32
 
	msize
;

526 
__u32
 
	mršg_šdex
[0];

545 
	s‘htoŞ_rx_Áu¶e_æow_¥ec
 {

546 
__u32
 
	mæow_ty³
;

548 
‘htoŞ_tı4_¥ec
 
	mtı_4_¥ec
;

549 
‘htoŞ_tı4_¥ec
 
	mudp_4_¥ec
;

550 
‘htoŞ_tı4_¥ec
 
	msùp_4_¥ec
;

551 
‘htoŞ_ah_e¥4_¥ec
 
	mah_4_¥ec
;

552 
‘htoŞ_ah_e¥4_¥ec
 
	me¥_4_¥ec
;

553 
‘htoŞ_u¤4_¥ec
 
	mu¤_4_¥ec
;

554 
‘hhdr
 
	m‘h”_¥ec
;

555 
__u8
 
	mhd©a
[72];

556 } 
	mh_u
, 
	mm_u
;

558 
__u16
 
	mvÏn_g
;

559 
__u16
 
	mvÏn_g_mask
;

560 
__u64
 
	md©a
;

561 
__u64
 
	md©a_mask
;

563 
__s32
 
	maùiÚ
;

564 
	#ETHTOOL_RXNTUPLE_ACTION_DROP
 (-1è

	)

565 
	#ETHTOOL_RXNTUPLE_ACTION_CLEAR
 (-2è

	)

573 
	s‘htoŞ_rx_Áu¶e
 {

574 
__u32
 
	mcmd
;

575 
‘htoŞ_rx_Áu¶e_æow_¥ec
 
	mfs
;

578 
	#ETHTOOL_FLASH_MAX_FILENAME
 128

	)

579 
	e‘htoŞ_æash_İ_ty³
 {

580 
	mETHTOOL_FLASH_ALL_REGIONS
 = 0,

584 
	s‘htoŞ_æash
 {

585 
__u32
 
	mcmd
;

586 
__u32
 
	m»giÚ
;

587 
	md©a
[
ETHTOOL_FLASH_MAX_FILENAME
];

602 
	s‘htoŞ_dump
 {

603 
__u32
 
	mcmd
;

604 
__u32
 
	mv”siÚ
;

605 
__u32
 
	mæag
;

606 
__u32
 
	mËn
;

607 
__u8
 
	md©a
[0];

619 
	s‘htoŞ_g‘_ã©u»s_block
 {

620 
__u32
 
	mavaabË
;

621 
__u32
 
	m»que¡ed
;

622 
__u32
 
	maùive
;

623 
__u32
 
	mÃv”_chªged
;

633 
	s‘htoŞ_gã©u»s
 {

634 
__u32
 
	mcmd
;

635 
__u32
 
	msize
;

636 
‘htoŞ_g‘_ã©u»s_block
 
	mã©u»s
[0];

644 
	s‘htoŞ_£t_ã©u»s_block
 {

645 
__u32
 
	mv®id
;

646 
__u32
 
	m»que¡ed
;

655 
	s‘htoŞ_sã©u»s
 {

656 
__u32
 
	mcmd
;

657 
__u32
 
	msize
;

658 
‘htoŞ_£t_ã©u»s_block
 
	mã©u»s
[0];

686 
	e‘htoŞ_sã©u»s_»tv®_b™s
 {

687 
	mETHTOOL_F_UNSUPPORTED__BIT
,

688 
	mETHTOOL_F_WISH__BIT
,

689 
	mETHTOOL_F_COMPAT__BIT
,

692 
	#ETHTOOL_F_UNSUPPORTED
 (1 << 
ETHTOOL_F_UNSUPPORTED__BIT
)

	)

693 
	#ETHTOOL_F_WISH
 (1 << 
ETHTOOL_F_WISH__BIT
)

	)

694 
	#ETHTOOL_F_COMPAT
 (1 << 
ETHTOOL_F_COMPAT__BIT
)

	)

698 
	#ETHTOOL_GSET
 0x00000001

	)

699 
	#ETHTOOL_SSET
 0x00000002

	)

700 
	#ETHTOOL_GDRVINFO
 0x00000003

	)

701 
	#ETHTOOL_GREGS
 0x00000004

	)

702 
	#ETHTOOL_GWOL
 0x00000005

	)

703 
	#ETHTOOL_SWOL
 0x00000006

	)

704 
	#ETHTOOL_GMSGLVL
 0x00000007

	)

705 
	#ETHTOOL_SMSGLVL
 0x00000008

	)

706 
	#ETHTOOL_NWAY_RST
 0x00000009

	)

709 
	#ETHTOOL_GLINK
 0x0000000a

	)

710 
	#ETHTOOL_GEEPROM
 0x0000000b

	)

711 
	#ETHTOOL_SEEPROM
 0x0000000ø

	)

712 
	#ETHTOOL_GCOALESCE
 0x0000000

	)

713 
	#ETHTOOL_SCOALESCE
 0x0000000à

	)

714 
	#ETHTOOL_GRINGPARAM
 0x00000010

	)

715 
	#ETHTOOL_SRINGPARAM
 0x00000011

	)

716 
	#ETHTOOL_GPAUSEPARAM
 0x00000012

	)

717 
	#ETHTOOL_SPAUSEPARAM
 0x00000013

	)

718 
	#ETHTOOL_GRXCSUM
 0x00000014

	)

719 
	#ETHTOOL_SRXCSUM
 0x00000015

	)

720 
	#ETHTOOL_GTXCSUM
 0x00000016

	)

721 
	#ETHTOOL_STXCSUM
 0x00000017

	)

722 
	#ETHTOOL_GSG
 0x00000018

	)

724 
	#ETHTOOL_SSG
 0x00000019

	)

726 
	#ETHTOOL_TEST
 0x0000001¨

	)

727 
	#ETHTOOL_GSTRINGS
 0x0000001b

	)

728 
	#ETHTOOL_PHYS_ID
 0x0000001ø

	)

729 
	#ETHTOOL_GSTATS
 0x0000001d

	)

730 
	#ETHTOOL_GTSO
 0x0000001

	)

731 
	#ETHTOOL_STSO
 0x0000001à

	)

732 
	#ETHTOOL_GPERMADDR
 0x00000020

	)

733 
	#ETHTOOL_GUFO
 0x00000021

	)

734 
	#ETHTOOL_SUFO
 0x00000022

	)

735 
	#ETHTOOL_GGSO
 0x00000023

	)

736 
	#ETHTOOL_SGSO
 0x00000024

	)

737 
	#ETHTOOL_GFLAGS
 0x00000025

	)

738 
	#ETHTOOL_SFLAGS
 0x00000026

	)

739 
	#ETHTOOL_GPFLAGS
 0x00000027

	)

740 
	#ETHTOOL_SPFLAGS
 0x00000028

	)

742 
	#ETHTOOL_GRXFH
 0x00000029

	)

743 
	#ETHTOOL_SRXFH
 0x0000002¨

	)

744 
	#ETHTOOL_GGRO
 0x0000002b

	)

745 
	#ETHTOOL_SGRO
 0x0000002ø

	)

746 
	#ETHTOOL_GRXRINGS
 0x0000002d

	)

747 
	#ETHTOOL_GRXCLSRLCNT
 0x0000002

	)

748 
	#ETHTOOL_GRXCLSRULE
 0x0000002à

	)

749 
	#ETHTOOL_GRXCLSRLALL
 0x00000030

	)

750 
	#ETHTOOL_SRXCLSRLDEL
 0x00000031

	)

751 
	#ETHTOOL_SRXCLSRLINS
 0x00000032

	)

752 
	#ETHTOOL_FLASHDEV
 0x00000033

	)

753 
	#ETHTOOL_RESET
 0x00000034

	)

754 
	#ETHTOOL_SRXNTUPLE
 0x00000035

	)

755 
	#ETHTOOL_GRXNTUPLE
 0x00000036

	)

756 
	#ETHTOOL_GSSET_INFO
 0x00000037

	)

757 
	#ETHTOOL_GRXFHINDIR
 0x00000038

	)

758 
	#ETHTOOL_SRXFHINDIR
 0x00000039

	)

760 
	#ETHTOOL_GFEATURES
 0x0000003¨

	)

761 
	#ETHTOOL_SFEATURES
 0x0000003b

	)

762 
	#ETHTOOL_GCHANNELS
 0x0000003ø

	)

763 
	#ETHTOOL_SCHANNELS
 0x0000003d

	)

764 
	#ETHTOOL_SET_DUMP
 0x0000003

	)

765 
	#ETHTOOL_GET_DUMP_FLAG
 0x0000003à

	)

766 
	#ETHTOOL_GET_DUMP_DATA
 0x00000040

	)

769 
	#SPARC_ETH_GSET
 
ETHTOOL_GSET


	)

770 
	#SPARC_ETH_SSET
 
ETHTOOL_SSET


	)

773 
	#SUPPORTED_10ba£T_H®f
 (1 << 0)

	)

774 
	#SUPPORTED_10ba£T_FuÎ
 (1 << 1)

	)

775 
	#SUPPORTED_100ba£T_H®f
 (1 << 2)

	)

776 
	#SUPPORTED_100ba£T_FuÎ
 (1 << 3)

	)

777 
	#SUPPORTED_1000ba£T_H®f
 (1 << 4)

	)

778 
	#SUPPORTED_1000ba£T_FuÎ
 (1 << 5)

	)

779 
	#SUPPORTED_AutÚeg
 (1 << 6)

	)

780 
	#SUPPORTED_TP
 (1 << 7)

	)

781 
	#SUPPORTED_AUI
 (1 << 8)

	)

782 
	#SUPPORTED_MII
 (1 << 9)

	)

783 
	#SUPPORTED_FIBRE
 (1 << 10)

	)

784 
	#SUPPORTED_BNC
 (1 << 11)

	)

785 
	#SUPPORTED_10000ba£T_FuÎ
 (1 << 12)

	)

786 
	#SUPPORTED_Pau£
 (1 << 13)

	)

787 
	#SUPPORTED_Asym_Pau£
 (1 << 14)

	)

788 
	#SUPPORTED_2500ba£X_FuÎ
 (1 << 15)

	)

789 
	#SUPPORTED_Back¶ªe
 (1 << 16)

	)

790 
	#SUPPORTED_1000ba£KX_FuÎ
 (1 << 17)

	)

791 
	#SUPPORTED_10000ba£KX4_FuÎ
 (1 << 18)

	)

792 
	#SUPPORTED_10000ba£KR_FuÎ
 (1 << 19)

	)

793 
	#SUPPORTED_10000ba£R_FEC
 (1 << 20)

	)

794 
	#SUPPORTED_20000ba£MLD2_FuÎ
 (1 << 21)

	)

795 
	#SUPPORTED_20000ba£KR2_FuÎ
 (1 << 22)

	)

798 
	#ADVERTISED_10ba£T_H®f
 (1 << 0)

	)

799 
	#ADVERTISED_10ba£T_FuÎ
 (1 << 1)

	)

800 
	#ADVERTISED_100ba£T_H®f
 (1 << 2)

	)

801 
	#ADVERTISED_100ba£T_FuÎ
 (1 << 3)

	)

802 
	#ADVERTISED_1000ba£T_H®f
 (1 << 4)

	)

803 
	#ADVERTISED_1000ba£T_FuÎ
 (1 << 5)

	)

804 
	#ADVERTISED_AutÚeg
 (1 << 6)

	)

805 
	#ADVERTISED_TP
 (1 << 7)

	)

806 
	#ADVERTISED_AUI
 (1 << 8)

	)

807 
	#ADVERTISED_MII
 (1 << 9)

	)

808 
	#ADVERTISED_FIBRE
 (1 << 10)

	)

809 
	#ADVERTISED_BNC
 (1 << 11)

	)

810 
	#ADVERTISED_10000ba£T_FuÎ
 (1 << 12)

	)

811 
	#ADVERTISED_Pau£
 (1 << 13)

	)

812 
	#ADVERTISED_Asym_Pau£
 (1 << 14)

	)

813 
	#ADVERTISED_2500ba£X_FuÎ
 (1 << 15)

	)

814 
	#ADVERTISED_Back¶ªe
 (1 << 16)

	)

815 
	#ADVERTISED_1000ba£KX_FuÎ
 (1 << 17)

	)

816 
	#ADVERTISED_10000ba£KX4_FuÎ
 (1 << 18)

	)

817 
	#ADVERTISED_10000ba£KR_FuÎ
 (1 << 19)

	)

818 
	#ADVERTISED_10000ba£R_FEC
 (1 << 20)

	)

819 
	#ADVERTISED_20000ba£MLD2_FuÎ
 (1 << 21)

	)

820 
	#ADVERTISED_20000ba£KR2_FuÎ
 (1 << 22)

	)

829 
	#SPEED_10
 10

	)

830 
	#SPEED_100
 100

	)

831 
	#SPEED_1000
 1000

	)

832 
	#SPEED_2500
 2500

	)

833 
	#SPEED_10000
 10000

	)

834 
	#SPEED_UNKNOWN
 -1

	)

837 
	#DUPLEX_HALF
 0x00

	)

838 
	#DUPLEX_FULL
 0x01

	)

839 
	#DUPLEX_UNKNOWN
 0xff

	)

842 
	#PORT_TP
 0x00

	)

843 
	#PORT_AUI
 0x01

	)

844 
	#PORT_MII
 0x02

	)

845 
	#PORT_FIBRE
 0x03

	)

846 
	#PORT_BNC
 0x04

	)

847 
	#PORT_DA
 0x05

	)

848 
	#PORT_NONE
 0xef

	)

849 
	#PORT_OTHER
 0xff

	)

852 
	#XCVR_INTERNAL
 0x00

	)

853 
	#XCVR_EXTERNAL
 0x01

	)

854 
	#XCVR_DUMMY1
 0x02

	)

855 
	#XCVR_DUMMY2
 0x03

	)

856 
	#XCVR_DUMMY3
 0x04

	)

861 
	#AUTONEG_DISABLE
 0x00

	)

862 
	#AUTONEG_ENABLE
 0x01

	)

865 
	#ETH_TP_MDI_INVALID
 0x00

	)

866 
	#ETH_TP_MDI
 0x01

	)

867 
	#ETH_TP_MDI_X
 0x02

	)

870 
	#WAKE_PHY
 (1 << 0)

	)

871 
	#WAKE_UCAST
 (1 << 1)

	)

872 
	#WAKE_MCAST
 (1 << 2)

	)

873 
	#WAKE_BCAST
 (1 << 3)

	)

874 
	#WAKE_ARP
 (1 << 4)

	)

875 
	#WAKE_MAGIC
 (1 << 5)

	)

876 
	#WAKE_MAGICSECURE
 (1 << 6è

	)

879 
	#TCP_V4_FLOW
 0x01

	)

880 
	#UDP_V4_FLOW
 0x02

	)

881 
	#SCTP_V4_FLOW
 0x03

	)

882 
	#AH_ESP_V4_FLOW
 0x04

	)

883 
	#TCP_V6_FLOW
 0x05

	)

884 
	#UDP_V6_FLOW
 0x06

	)

885 
	#SCTP_V6_FLOW
 0x07

	)

886 
	#AH_ESP_V6_FLOW
 0x08

	)

887 
	#AH_V4_FLOW
 0x09

	)

888 
	#ESP_V4_FLOW
 0x0¨

	)

889 
	#AH_V6_FLOW
 0x0b

	)

890 
	#ESP_V6_FLOW
 0x0ø

	)

891 
	#IP_USER_FLOW
 0x0d

	)

892 
	#IPV4_FLOW
 0x10

	)

893 
	#IPV6_FLOW
 0x11

	)

894 
	#ETHER_FLOW
 0x12

	)

896 
	#FLOW_EXT
 0x80000000

	)

899 
	#RXH_L2DA
 (1 << 1)

	)

900 
	#RXH_VLAN
 (1 << 2)

	)

901 
	#RXH_L3_PROTO
 (1 << 3)

	)

902 
	#RXH_IP_SRC
 (1 << 4)

	)

903 
	#RXH_IP_DST
 (1 << 5)

	)

904 
	#RXH_L4_B_0_1
 (1 << 6è

	)

905 
	#RXH_L4_B_2_3
 (1 << 7è

	)

906 
	#RXH_DISCARD
 (1 << 31)

	)

908 
	#RX_CLS_FLOW_DISC
 0xffffffffffffffffULL

	)

917 
	e‘htoŞ_»£t_æags
 {

923 
	mETH_RESET_MGMT
 = 1 << 0,

924 
	mETH_RESET_IRQ
 = 1 << 1,

925 
	mETH_RESET_DMA
 = 1 << 2,

926 
	mETH_RESET_FILTER
 = 1 << 3,

927 
	mETH_RESET_OFFLOAD
 = 1 << 4,

928 
	mETH_RESET_MAC
 = 1 << 5,

929 
	mETH_RESET_PHY
 = 1 << 6,

930 
	mETH_RESET_RAM
 = 1 << 7,

933 
	mETH_RESET_DEDICATED
 = 0x0000ffff,

935 
	mETH_RESET_ALL
 = 0xffffffff,

938 
	#ETH_RESET_SHARED_SHIFT
 16

	)

	@/usr/include/linux/if_arp.h

23 #iâdeà
_LINUX_IF_ARP_H


24 
	#_LINUX_IF_ARP_H


	)

26 
	~<lšux/Ãtdeviû.h
>

29 
	#ARPHRD_NETROM
 0

	)

30 
	#ARPHRD_ETHER
 1

	)

31 
	#ARPHRD_EETHER
 2

	)

32 
	#ARPHRD_AX25
 3

	)

33 
	#ARPHRD_PRONET
 4

	)

34 
	#ARPHRD_CHAOS
 5

	)

35 
	#ARPHRD_IEEE802
 6

	)

36 
	#ARPHRD_ARCNET
 7

	)

37 
	#ARPHRD_APPLETLK
 8

	)

38 
	#ARPHRD_DLCI
 15

	)

39 
	#ARPHRD_ATM
 19

	)

40 
	#ARPHRD_METRICOM
 23

	)

41 
	#ARPHRD_IEEE1394
 24

	)

42 
	#ARPHRD_EUI64
 27

	)

43 
	#ARPHRD_INFINIBAND
 32

	)

46 
	#ARPHRD_SLIP
 256

	)

47 
	#ARPHRD_CSLIP
 257

	)

48 
	#ARPHRD_SLIP6
 258

	)

49 
	#ARPHRD_CSLIP6
 259

	)

50 
	#ARPHRD_RSRVD
 260

	)

51 
	#ARPHRD_ADAPT
 264

	)

52 
	#ARPHRD_ROSE
 270

	)

53 
	#ARPHRD_X25
 271

	)

54 
	#ARPHRD_HWX25
 272

	)

55 
	#ARPHRD_CAN
 280

	)

56 
	#ARPHRD_PPP
 512

	)

57 
	#ARPHRD_CISCO
 513

	)

58 
	#ARPHRD_HDLC
 
ARPHRD_CISCO


	)

59 
	#ARPHRD_LAPB
 516

	)

60 
	#ARPHRD_DDCMP
 517

	)

61 
	#ARPHRD_RAWHDLC
 518

	)

63 
	#ARPHRD_TUNNEL
 768

	)

64 
	#ARPHRD_TUNNEL6
 769

	)

65 
	#ARPHRD_FRAD
 770

	)

66 
	#ARPHRD_SKIP
 771

	)

67 
	#ARPHRD_LOOPBACK
 772

	)

68 
	#ARPHRD_LOCALTLK
 773

	)

69 
	#ARPHRD_FDDI
 774

	)

70 
	#ARPHRD_BIF
 775

	)

71 
	#ARPHRD_SIT
 776

	)

72 
	#ARPHRD_IPDDP
 777

	)

73 
	#ARPHRD_IPGRE
 778

	)

74 
	#ARPHRD_PIMREG
 779

	)

75 
	#ARPHRD_HIPPI
 780

	)

76 
	#ARPHRD_ASH
 781

	)

77 
	#ARPHRD_ECONET
 782

	)

78 
	#ARPHRD_IRDA
 783

	)

80 
	#ARPHRD_FCPP
 784

	)

81 
	#ARPHRD_FCAL
 785

	)

82 
	#ARPHRD_FCPL
 786

	)

83 
	#ARPHRD_FCFABRIC
 787

	)

85 
	#ARPHRD_IEEE802_TR
 800

	)

86 
	#ARPHRD_IEEE80211
 801

	)

87 
	#ARPHRD_IEEE80211_PRISM
 802

	)

88 
	#ARPHRD_IEEE80211_RADIOTAP
 803

	)

89 
	#ARPHRD_IEEE802154
 804

	)

91 
	#ARPHRD_PHONET
 820

	)

92 
	#ARPHRD_PHONET_PIPE
 821

	)

93 
	#ARPHRD_CAIF
 822

	)

95 
	#ARPHRD_VOID
 0xFFFF

	)

96 
	#ARPHRD_NONE
 0xFFFE

	)

99 
	#ARPOP_REQUEST
 1

	)

100 
	#ARPOP_REPLY
 2

	)

101 
	#ARPOP_RREQUEST
 3

	)

102 
	#ARPOP_RREPLY
 4

	)

103 
	#ARPOP_InREQUEST
 8

	)

104 
	#ARPOP_InREPLY
 9

	)

105 
	#ARPOP_NAK
 10

	)

109 
	s¬´eq
 {

110 
sockaddr
 
	m¬p_·
;

111 
sockaddr
 
	m¬p_ha
;

112 
	m¬p_æags
;

113 
sockaddr
 
	m¬p_Ãtmask
;

114 
	m¬p_dev
[16];

117 
	s¬´eq_Şd
 {

118 
sockaddr
 
	m¬p_·
;

119 
sockaddr
 
	m¬p_ha
;

120 
	m¬p_æags
;

121 
sockaddr
 
	m¬p_Ãtmask
;

125 
	#ATF_COM
 0x02

	)

126 
	#ATF_PERM
 0x04

	)

127 
	#ATF_PUBL
 0x08

	)

128 
	#ATF_USETRAILERS
 0x10

	)

129 
	#ATF_NETMASK
 0x20

	)

131 
	#ATF_DONTPUB
 0x40

	)

137 
	s¬phdr
 {

138 
__be16
 
	m¬_hrd
;

139 
__be16
 
	m¬_´o
;

140 
	m¬_hÊ
;

141 
	m¬_¶n
;

142 
__be16
 
	m¬_İ
;

148 
	m¬_sha
[
ETH_ALEN
];

149 
	m¬_s
[4];

150 
	m¬_tha
[
ETH_ALEN
];

151 
	m¬_t
[4];

	@/usr/include/linux/if_ether.h

21 #iâdeà
_LINUX_IF_ETHER_H


22 
	#_LINUX_IF_ETHER_H


	)

24 
	~<lšux/ty³s.h
>

31 
	#ETH_ALEN
 6

	)

32 
	#ETH_HLEN
 14

	)

33 
	#ETH_ZLEN
 60

	)

34 
	#ETH_DATA_LEN
 1500

	)

35 
	#ETH_FRAME_LEN
 1514

	)

36 
	#ETH_FCS_LEN
 4

	)

42 
	#ETH_P_LOOP
 0x0060

	)

43 
	#ETH_P_PUP
 0x0200

	)

44 
	#ETH_P_PUPAT
 0x0201

	)

45 
	#ETH_P_IP
 0x0800

	)

46 
	#ETH_P_X25
 0x0805

	)

47 
	#ETH_P_ARP
 0x0806

	)

48 
	#ETH_P_BPQ
 0x08FF

	)

49 
	#ETH_P_IEEEPUP
 0x0a00

	)

50 
	#ETH_P_IEEEPUPAT
 0x0a01

	)

51 
	#ETH_P_DEC
 0x6000

	)

52 
	#ETH_P_DNA_DL
 0x6001

	)

53 
	#ETH_P_DNA_RC
 0x6002

	)

54 
	#ETH_P_DNA_RT
 0x6003

	)

55 
	#ETH_P_LAT
 0x6004

	)

56 
	#ETH_P_DIAG
 0x6005

	)

57 
	#ETH_P_CUST
 0x6006

	)

58 
	#ETH_P_SCA
 0x6007

	)

59 
	#ETH_P_TEB
 0x6558

	)

60 
	#ETH_P_RARP
 0x8035

	)

61 
	#ETH_P_ATALK
 0x809B

	)

62 
	#ETH_P_AARP
 0x80F3

	)

63 
	#ETH_P_8021Q
 0x8100

	)

64 
	#ETH_P_IPX
 0x8137

	)

65 
	#ETH_P_IPV6
 0x86DD

	)

66 
	#ETH_P_PAUSE
 0x8808

	)

67 
	#ETH_P_SLOW
 0x8809

	)

68 
	#ETH_P_WCCP
 0x883E

	)

70 
	#ETH_P_PPP_DISC
 0x8863

	)

71 
	#ETH_P_PPP_SES
 0x8864

	)

72 
	#ETH_P_MPLS_UC
 0x8847

	)

73 
	#ETH_P_MPLS_MC
 0x8848

	)

74 
	#ETH_P_ATMMPOA
 0x884ø

	)

75 
	#ETH_P_LINK_CTL
 0x886ø

	)

76 
	#ETH_P_ATMFATE
 0x8884

	)

79 
	#ETH_P_PAE
 0x888E

	)

80 
	#ETH_P_AOE
 0x88A2

	)

81 
	#ETH_P_8021AD
 0x88A8

	)

82 
	#ETH_P_TIPC
 0x88CA

	)

83 
	#ETH_P_8021AH
 0x88E7

	)

84 
	#ETH_P_1588
 0x88F7

	)

85 
	#ETH_P_FCOE
 0x8906

	)

86 
	#ETH_P_TDLS
 0x890D

	)

87 
	#ETH_P_FIP
 0x8914

	)

88 
	#ETH_P_QINQ1
 0x9100

	)

89 
	#ETH_P_QINQ2
 0x9200

	)

90 
	#ETH_P_QINQ3
 0x9300

	)

91 
	#ETH_P_EDSA
 0xDADA

	)

92 
	#ETH_P_AF_IUCV
 0xFBFB

	)

98 
	#ETH_P_802_3
 0x0001

	)

99 
	#ETH_P_AX25
 0x0002

	)

100 
	#ETH_P_ALL
 0x0003

	)

101 
	#ETH_P_802_2
 0x0004

	)

102 
	#ETH_P_SNAP
 0x0005

	)

103 
	#ETH_P_DDCMP
 0x0006

	)

104 
	#ETH_P_WAN_PPP
 0x0007

	)

105 
	#ETH_P_PPP_MP
 0x0008

	)

106 
	#ETH_P_LOCALTALK
 0x0009

	)

107 
	#ETH_P_CAN
 0x000C

	)

108 
	#ETH_P_PPPTALK
 0x0010

	)

109 
	#ETH_P_TR_802_2
 0x0011

	)

110 
	#ETH_P_MOBITEX
 0x0015

	)

111 
	#ETH_P_CONTROL
 0x0016

	)

112 
	#ETH_P_IRDA
 0x0017

	)

113 
	#ETH_P_ECONET
 0x0018

	)

114 
	#ETH_P_HDLC
 0x0019

	)

115 
	#ETH_P_ARCNET
 0x001A

	)

116 
	#ETH_P_DSA
 0x001B

	)

117 
	#ETH_P_TRAILER
 0x001C

	)

118 
	#ETH_P_PHONET
 0x00F5

	)

119 
	#ETH_P_IEEE802154
 0x00F6

	)

120 
	#ETH_P_CAIF
 0x00F7

	)

126 
	s‘hhdr
 {

127 
	mh_de¡
[
ETH_ALEN
];

128 
	mh_sourû
[
ETH_ALEN
];

129 
__be16
 
	mh_´Ùo
;

130 } 
__©Œibu‹__
((
·cked
));

	@/usr/include/linux/if_vlan.h

13 #iâdeà
_LINUX_IF_VLAN_H_


14 
	#_LINUX_IF_VLAN_H_


	)

20 
	evÏn_ioùl_cmds
 {

21 
	mADD_VLAN_CMD
,

22 
	mDEL_VLAN_CMD
,

23 
	mSET_VLAN_INGRESS_PRIORITY_CMD
,

24 
	mSET_VLAN_EGRESS_PRIORITY_CMD
,

25 
	mGET_VLAN_INGRESS_PRIORITY_CMD
,

26 
	mGET_VLAN_EGRESS_PRIORITY_CMD
,

27 
	mSET_VLAN_NAME_TYPE_CMD
,

28 
	mSET_VLAN_FLAG_CMD
,

29 
	mGET_VLAN_REALDEV_NAME_CMD
,

30 
	mGET_VLAN_VID_CMD


33 
	evÏn_æags
 {

34 
	mVLAN_FLAG_REORDER_HDR
 = 0x1,

35 
	mVLAN_FLAG_GVRP
 = 0x2,

36 
	mVLAN_FLAG_LOOSE_BINDING
 = 0x4,

39 
	evÏn_Çme_ty³s
 {

40 
	mVLAN_NAME_TYPE_PLUS_VID
,

41 
	mVLAN_NAME_TYPE_RAW_PLUS_VID
,

42 
	mVLAN_NAME_TYPE_PLUS_VID_NO_PAD
,

43 
	mVLAN_NAME_TYPE_RAW_PLUS_VID_NO_PAD
,

44 
	mVLAN_NAME_TYPE_HIGHEST


47 
	svÏn_ioùl_¬gs
 {

48 
	mcmd
;

49 
	mdeviû1
[24];

52 
	mdeviû2
[24];

53 
	mVID
;

54 
	mskb_´iÜ™y
;

55 
	mÇme_ty³
;

56 
	mbšd_ty³
;

57 
	mæag
;

58 } 
	mu
;

60 
	mvÏn_qos
;

	@/usr/include/linux/in.h

18 #iâdeà
_LINUX_IN_H


19 
	#_LINUX_IN_H


	)

21 
	~<lšux/ty³s.h
>

22 
	~<lšux/sock‘.h
>

26 
	mIPPROTO_IP
 = 0,

27 
	mIPPROTO_ICMP
 = 1,

28 
	mIPPROTO_IGMP
 = 2,

29 
	mIPPROTO_IPIP
 = 4,

30 
	mIPPROTO_TCP
 = 6,

31 
	mIPPROTO_EGP
 = 8,

32 
	mIPPROTO_PUP
 = 12,

33 
	mIPPROTO_UDP
 = 17,

34 
	mIPPROTO_IDP
 = 22,

35 
	mIPPROTO_DCCP
 = 33,

36 
	mIPPROTO_RSVP
 = 46,

37 
	mIPPROTO_GRE
 = 47,

39 
	mIPPROTO_IPV6
 = 41,

41 
	mIPPROTO_ESP
 = 50,

42 
	mIPPROTO_AH
 = 51,

43 
	mIPPROTO_BEETPH
 = 94,

44 
	mIPPROTO_PIM
 = 103,

46 
	mIPPROTO_COMP
 = 108,

47 
	mIPPROTO_SCTP
 = 132,

48 
	mIPPROTO_UDPLITE
 = 136,

50 
	mIPPROTO_RAW
 = 255,

51 
	mIPPROTO_MAX


56 
	sš_addr
 {

57 
__be32
 
	ms_addr
;

60 
	#IP_TOS
 1

	)

61 
	#IP_TTL
 2

	)

62 
	#IP_HDRINCL
 3

	)

63 
	#IP_OPTIONS
 4

	)

64 
	#IP_ROUTER_ALERT
 5

	)

65 
	#IP_RECVOPTS
 6

	)

66 
	#IP_RETOPTS
 7

	)

67 
	#IP_PKTINFO
 8

	)

68 
	#IP_PKTOPTIONS
 9

	)

69 
	#IP_MTU_DISCOVER
 10

	)

70 
	#IP_RECVERR
 11

	)

71 
	#IP_RECVTTL
 12

	)

72 
	#IP_RECVTOS
 13

	)

73 
	#IP_MTU
 14

	)

74 
	#IP_FREEBIND
 15

	)

75 
	#IP_IPSEC_POLICY
 16

	)

76 
	#IP_XFRM_POLICY
 17

	)

77 
	#IP_PASSSEC
 18

	)

78 
	#IP_TRANSPARENT
 19

	)

81 
	#IP_RECVRETOPTS
 
IP_RETOPTS


	)

84 
	#IP_ORIGDSTADDR
 20

	)

85 
	#IP_RECVORIGDSTADDR
 
IP_ORIGDSTADDR


	)

87 
	#IP_MINTTL
 21

	)

88 
	#IP_NODEFRAG
 22

	)

91 
	#IP_PMTUDISC_DONT
 0

	)

92 
	#IP_PMTUDISC_WANT
 1

	)

93 
	#IP_PMTUDISC_DO
 2

	)

94 
	#IP_PMTUDISC_PROBE
 3

	)

96 
	#IP_MULTICAST_IF
 32

	)

97 
	#IP_MULTICAST_TTL
 33

	)

98 
	#IP_MULTICAST_LOOP
 34

	)

99 
	#IP_ADD_MEMBERSHIP
 35

	)

100 
	#IP_DROP_MEMBERSHIP
 36

	)

101 
	#IP_UNBLOCK_SOURCE
 37

	)

102 
	#IP_BLOCK_SOURCE
 38

	)

103 
	#IP_ADD_SOURCE_MEMBERSHIP
 39

	)

104 
	#IP_DROP_SOURCE_MEMBERSHIP
 40

	)

105 
	#IP_MSFILTER
 41

	)

106 
	#MCAST_JOIN_GROUP
 42

	)

107 
	#MCAST_BLOCK_SOURCE
 43

	)

108 
	#MCAST_UNBLOCK_SOURCE
 44

	)

109 
	#MCAST_LEAVE_GROUP
 45

	)

110 
	#MCAST_JOIN_SOURCE_GROUP
 46

	)

111 
	#MCAST_LEAVE_SOURCE_GROUP
 47

	)

112 
	#MCAST_MSFILTER
 48

	)

113 
	#IP_MULTICAST_ALL
 49

	)

115 
	#MCAST_EXCLUDE
 0

	)

116 
	#MCAST_INCLUDE
 1

	)

119 
	#IP_DEFAULT_MULTICAST_TTL
 1

	)

120 
	#IP_DEFAULT_MULTICAST_LOOP
 1

	)

124 
	s_m»q
 {

125 
š_addr
 
	mimr_muÉŸddr
;

126 
š_addr
 
	mimr_š‹rçû
;

129 
	s_m»qn
 {

130 
š_addr
 
	mimr_muÉŸddr
;

131 
š_addr
 
	mimr_add»ss
;

132 
	mimr_ifšdex
;

135 
	s_m»q_sourû
 {

136 
__be32
 
	mimr_muÉŸddr
;

137 
__be32
 
	mimr_š‹rçû
;

138 
__be32
 
	mimr_sourûaddr
;

141 
	s_msf‹r
 {

142 
__be32
 
	mimsf_muÉŸddr
;

143 
__be32
 
	mimsf_š‹rçû
;

144 
__u32
 
	mimsf_fmode
;

145 
__u32
 
	mimsf_num¤c
;

146 
__be32
 
	mimsf_¦i¡
[1];

149 
	#IP_MSFILTER_SIZE
(
num¤c
) \

150 ((
_msf‹r
è- (
__u32
) \

151 + (
num¤c
è* (
__u32
))

	)

153 
	sgroup_»q
 {

154 
__u32
 
	mgr_š‹rçû
;

155 
__k”Ãl_sockaddr_¡Üage
 
	mgr_group
;

158 
	sgroup_sourû_»q
 {

159 
__u32
 
	mg¤_š‹rçû
;

160 
__k”Ãl_sockaddr_¡Üage
 
	mg¤_group
;

161 
__k”Ãl_sockaddr_¡Üage
 
	mg¤_sourû
;

164 
	sgroup_f‹r
 {

165 
__u32
 
	mgf_š‹rçû
;

166 
__k”Ãl_sockaddr_¡Üage
 
	mgf_group
;

167 
__u32
 
	mgf_fmode
;

168 
__u32
 
	mgf_num¤c
;

169 
__k”Ãl_sockaddr_¡Üage
 
	mgf_¦i¡
[1];

172 
	#GROUP_FILTER_SIZE
(
num¤c
) \

173 ((
group_f‹r
è- (
__k”Ãl_sockaddr_¡Üage
) \

174 + (
num¤c
è* (
__k”Ãl_sockaddr_¡Üage
))

	)

176 
	sš_pktšfo
 {

177 
	mi_ifšdex
;

178 
š_addr
 
	mi_¥ec_d¡
;

179 
š_addr
 
	mi_addr
;

183 
	#__SOCK_SIZE__
 16

	)

184 
	ssockaddr_š
 {

185 
__k”Ãl_§_çmy_t
 
	msš_çmy
;

186 
__be16
 
	msš_pÜt
;

187 
š_addr
 
	msš_addr
;

190 
	m__·d
[
__SOCK_SIZE__
 - () -

191 (è- (
š_addr
)];

193 
	#sš_z”o
 
__·d


	)

201 
	#IN_CLASSA
(
a
è((((è×)è& 0x80000000è=ğ0)

	)

202 
	#IN_CLASSA_NET
 0xff000000

	)

203 
	#IN_CLASSA_NSHIFT
 24

	)

204 
	#IN_CLASSA_HOST
 (0xfffffffà& ~
IN_CLASSA_NET
)

	)

205 
	#IN_CLASSA_MAX
 128

	)

207 
	#IN_CLASSB
(
a
è((((è×)è& 0xc0000000è=ğ0x80000000)

	)

208 
	#IN_CLASSB_NET
 0xffff0000

	)

209 
	#IN_CLASSB_NSHIFT
 16

	)

210 
	#IN_CLASSB_HOST
 (0xfffffffà& ~
IN_CLASSB_NET
)

	)

211 
	#IN_CLASSB_MAX
 65536

	)

213 
	#IN_CLASSC
(
a
è((((è×)è& 0xe0000000è=ğ0xc0000000)

	)

214 
	#IN_CLASSC_NET
 0xffffff00

	)

215 
	#IN_CLASSC_NSHIFT
 8

	)

216 
	#IN_CLASSC_HOST
 (0xfffffffà& ~
IN_CLASSC_NET
)

	)

218 
	#IN_CLASSD
(
a
è((((è×)è& 0xf0000000è=ğ0xe0000000)

	)

219 
	#IN_MULTICAST
(
a
è
	`IN_CLASSD
×)

	)

220 
	#IN_MULTICAST_NET
 0xF0000000

	)

222 
	#IN_EXPERIMENTAL
(
a
è((((è×)è& 0xf0000000è=ğ0xf0000000)

	)

223 
	#IN_BADCLASS
(
a
è
	`IN_EXPERIMENTAL
(×))

	)

226 
	#INADDR_ANY
 ((è0x00000000)

	)

229 
	#INADDR_BROADCAST
 ((è0xffffffff)

	)

232 
	#INADDR_NONE
 ((è0xffffffff)

	)

235 
	#IN_LOOPBACKNET
 127

	)

238 
	#INADDR_LOOPBACK
 0x7f000001

	)

239 
	#IN_LOOPBACK
(
a
è((((è×)è& 0xff000000è=ğ0x7f000000)

	)

242 
	#INADDR_UNSPEC_GROUP
 0xe0000000U

	)

243 
	#INADDR_ALLHOSTS_GROUP
 0xe0000001U

	)

244 
	#INADDR_ALLRTRS_GROUP
 0xe0000002U

	)

245 
	#INADDR_MAX_LOCAL_GROUP
 0xe00000ffU

	)

249 
	~<asm/by‹Üd”.h
>

	@/usr/include/linux/ip.h

17 #iâdeà
_LINUX_IP_H


18 
	#_LINUX_IP_H


	)

19 
	~<lšux/ty³s.h
>

20 
	~<asm/by‹Üd”.h
>

22 
	#IPTOS_TOS_MASK
 0x1E

	)

23 
	#IPTOS_TOS
(
tos
è(Ños)&
IPTOS_TOS_MASK
)

	)

24 
	#IPTOS_LOWDELAY
 0x10

	)

25 
	#IPTOS_THROUGHPUT
 0x08

	)

26 
	#IPTOS_RELIABILITY
 0x04

	)

27 
	#IPTOS_MINCOST
 0x02

	)

29 
	#IPTOS_PREC_MASK
 0xE0

	)

30 
	#IPTOS_PREC
(
tos
è(Ños)&
IPTOS_PREC_MASK
)

	)

31 
	#IPTOS_PREC_NETCONTROL
 0xe0

	)

32 
	#IPTOS_PREC_INTERNETCONTROL
 0xc0

	)

33 
	#IPTOS_PREC_CRITIC_ECP
 0xa0

	)

34 
	#IPTOS_PREC_FLASHOVERRIDE
 0x80

	)

35 
	#IPTOS_PREC_FLASH
 0x60

	)

36 
	#IPTOS_PREC_IMMEDIATE
 0x40

	)

37 
	#IPTOS_PREC_PRIORITY
 0x20

	)

38 
	#IPTOS_PREC_ROUTINE
 0x00

	)

42 
	#IPOPT_COPY
 0x80

	)

43 
	#IPOPT_CLASS_MASK
 0x60

	)

44 
	#IPOPT_NUMBER_MASK
 0x1f

	)

46 
	#IPOPT_COPIED
(
o
è((o)&
IPOPT_COPY
)

	)

47 
	#IPOPT_CLASS
(
o
è((o)&
IPOPT_CLASS_MASK
)

	)

48 
	#IPOPT_NUMBER
(
o
è((o)&
IPOPT_NUMBER_MASK
)

	)

50 
	#IPOPT_CONTROL
 0x00

	)

51 
	#IPOPT_RESERVED1
 0x20

	)

52 
	#IPOPT_MEASUREMENT
 0x40

	)

53 
	#IPOPT_RESERVED2
 0x60

	)

55 
	#IPOPT_END
 (0 |
IPOPT_CONTROL
)

	)

56 
	#IPOPT_NOOP
 (1 |
IPOPT_CONTROL
)

	)

57 
	#IPOPT_SEC
 (2 |
IPOPT_CONTROL
|
IPOPT_COPY
)

	)

58 
	#IPOPT_LSRR
 (3 |
IPOPT_CONTROL
|
IPOPT_COPY
)

	)

59 
	#IPOPT_TIMESTAMP
 (4 |
IPOPT_MEASUREMENT
)

	)

60 
	#IPOPT_CIPSO
 (6 |
IPOPT_CONTROL
|
IPOPT_COPY
)

	)

61 
	#IPOPT_RR
 (7 |
IPOPT_CONTROL
)

	)

62 
	#IPOPT_SID
 (8 |
IPOPT_CONTROL
|
IPOPT_COPY
)

	)

63 
	#IPOPT_SSRR
 (9 |
IPOPT_CONTROL
|
IPOPT_COPY
)

	)

64 
	#IPOPT_RA
 (20|
IPOPT_CONTROL
|
IPOPT_COPY
)

	)

66 
	#IPVERSION
 4

	)

67 
	#MAXTTL
 255

	)

68 
	#IPDEFTTL
 64

	)

70 
	#IPOPT_OPTVAL
 0

	)

71 
	#IPOPT_OLEN
 1

	)

72 
	#IPOPT_OFFSET
 2

	)

73 
	#IPOPT_MINOFF
 4

	)

74 
	#MAX_IPOPTLEN
 40

	)

75 
	#IPOPT_NOP
 
IPOPT_NOOP


	)

76 
	#IPOPT_EOL
 
IPOPT_END


	)

77 
	#IPOPT_TS
 
IPOPT_TIMESTAMP


	)

79 
	#IPOPT_TS_TSONLY
 0

	)

80 
	#IPOPT_TS_TSANDADDR
 1

	)

81 
	#IPOPT_TS_PRESPEC
 3

	)

83 
	#IPV4_BEET_PHMAXLEN
 8

	)

85 
	shdr
 {

86 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

87 
__u8
 
	mihl
:4,

88 
	mv”siÚ
:4;

89 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

90 
__u8
 
	mv”siÚ
:4,

91 
	mihl
:4;

95 
__u8
 
	mtos
;

96 
__be16
 
	mtÙ_Ën
;

97 
__be16
 
	mid
;

98 
__be16
 
	mäag_off
;

99 
__u8
 
	m‰l
;

100 
__u8
 
	m´ÙocŞ
;

101 
__sum16
 
	mcheck
;

102 
__be32
 
	m§ddr
;

103 
__be32
 
	mdaddr
;

108 
	s_auth_hdr
 {

109 
__u8
 
	mÃxthdr
;

110 
__u8
 
	mhd¾’
;

111 
__be16
 
	m»£rved
;

112 
__be32
 
	m¥i
;

113 
__be32
 
	m£q_no
;

114 
__u8
 
	mauth_d©a
[0];

117 
	s_e¥_hdr
 {

118 
__be32
 
	m¥i
;

119 
__be32
 
	m£q_no
;

120 
__u8
 
	m’c_d©a
[0];

123 
	s_comp_hdr
 {

124 
__u8
 
	mÃxthdr
;

125 
__u8
 
	mæags
;

126 
__be16
 
	mıi
;

129 
	s_b“t_phdr
 {

130 
__u8
 
	mÃxthdr
;

131 
__u8
 
	mhd¾’
;

132 
__u8
 
	m·dËn
;

133 
__u8
 
	m»£rved
;

	@/usr/include/linux/ipv6.h

1 #iâdeà
_IPV6_H


2 
	#_IPV6_H


	)

4 
	~<lšux/ty³s.h
>

5 
	~<lšux/š6.h
>

6 
	~<asm/by‹Üd”.h
>

10 
	#IPV6_MIN_MTU
 1280

	)

19 
	sš6_pktšfo
 {

20 
š6_addr
 
	mi6_addr
;

21 
	mi6_ifšdex
;

24 
	s6_mtušfo
 {

25 
sockaddr_š6
 
	m6m_addr
;

26 
__u32
 
	m6m_mtu
;

29 
	sš6_iäeq
 {

30 
š6_addr
 
	miä6_addr
;

31 
__u32
 
	miä6_´efixËn
;

32 
	miä6_ifšdex
;

35 
	#IPV6_SRCRT_STRICT
 0x01

	)

36 
	#IPV6_SRCRT_TYPE_0
 0

	)

37 
	#IPV6_SRCRT_TYPE_2
 2

	)

42 
	sv6_¹_hdr
 {

43 
__u8
 
	mÃxthdr
;

44 
__u8
 
	mhd¾’
;

45 
__u8
 
	mty³
;

46 
__u8
 
	m£gm’ts_Ëá
;

55 
	sv6_İt_hdr
 {

56 
__u8
 
	mÃxthdr
;

57 
__u8
 
	mhd¾’
;

61 } 
__©Œibu‹__
((
·cked
));

63 
	#v6_de¡İt_hdr
 
v6_İt_hdr


	)

64 
	#v6_hİİt_hdr
 
v6_İt_hdr


	)

71 
	s¹0_hdr
 {

72 
v6_¹_hdr
 
	m¹_hdr
;

73 
__u32
 
	m»£rved
;

74 
š6_addr
 
	maddr
[0];

76 
	#¹0_ty³
 
¹_hdr
.
ty³


	)

83 
	s¹2_hdr
 {

84 
v6_¹_hdr
 
	m¹_hdr
;

85 
__u32
 
	m»£rved
;

86 
š6_addr
 
	maddr
;

88 
	#¹2_ty³
 
¹_hdr
.
ty³


	)

95 
	sv6_de¡İt_hao
 {

96 
__u8
 
	mty³
;

97 
__u8
 
	mËngth
;

98 
š6_addr
 
	maddr
;

99 } 
__©Œibu‹__
((
·cked
));

108 
	sv6hdr
 {

109 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

110 
__u8
 
	m´iÜ™y
:4,

111 
	mv”siÚ
:4;

112 #–ià
defšed
(
__BIG_ENDIAN_BITFIELD
)

113 
__u8
 
	mv”siÚ
:4,

114 
	m´iÜ™y
:4;

118 
__u8
 
	mæow_lbl
[3];

120 
__be16
 
	m·ylßd_Ën
;

121 
__u8
 
	mÃxthdr
;

122 
__u8
 
	mhİ_lim™
;

124 
š6_addr
 
	m§ddr
;

125 
š6_addr
 
	mdaddr
;

131 
	mDEVCONF_FORWARDING
 = 0,

132 
	mDEVCONF_HOPLIMIT
,

133 
	mDEVCONF_MTU6
,

134 
	mDEVCONF_ACCEPT_RA
,

135 
	mDEVCONF_ACCEPT_REDIRECTS
,

136 
	mDEVCONF_AUTOCONF
,

137 
	mDEVCONF_DAD_TRANSMITS
,

138 
	mDEVCONF_RTR_SOLICITS
,

139 
	mDEVCONF_RTR_SOLICIT_INTERVAL
,

140 
	mDEVCONF_RTR_SOLICIT_DELAY
,

141 
	mDEVCONF_USE_TEMPADDR
,

142 
	mDEVCONF_TEMP_VALID_LFT
,

143 
	mDEVCONF_TEMP_PREFERED_LFT
,

144 
	mDEVCONF_REGEN_MAX_RETRY
,

145 
	mDEVCONF_MAX_DESYNC_FACTOR
,

146 
	mDEVCONF_MAX_ADDRESSES
,

147 
	mDEVCONF_FORCE_MLD_VERSION
,

148 
	mDEVCONF_ACCEPT_RA_DEFRTR
,

149 
	mDEVCONF_ACCEPT_RA_PINFO
,

150 
	mDEVCONF_ACCEPT_RA_RTR_PREF
,

151 
	mDEVCONF_RTR_PROBE_INTERVAL
,

152 
	mDEVCONF_ACCEPT_RA_RT_INFO_MAX_PLEN
,

153 
	mDEVCONF_PROXY_NDP
,

154 
	mDEVCONF_OPTIMISTIC_DAD
,

155 
	mDEVCONF_ACCEPT_SOURCE_ROUTE
,

156 
	mDEVCONF_MC_FORWARDING
,

157 
	mDEVCONF_DISABLE_IPV6
,

158 
	mDEVCONF_ACCEPT_DAD
,

159 
	mDEVCONF_FORCE_TLLAO
,

160 
	mDEVCONF_MAX


	@/usr/include/linux/kernel.h

1 #iâdeà
_LINUX_KERNEL_H


2 
	#_LINUX_KERNEL_H


	)

7 
	#__ALIGN_KERNEL
(
x
, 
a
è
	`__ALIGN_KERNEL_MASK
(x, (
	`ty³of
(x))×è- 1)

	)

8 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
è(((xè+ (mask)è& ~(mask))

	)

11 
	#SI_LOAD_SHIFT
 16

	)

12 
	ssysšfo
 {

13 
	mu±ime
;

14 
	mlßds
[3];

15 
	mtÙ®¿m
;

16 
	mä“¿m
;

17 
	msh¬ed¿m
;

18 
	mbufã¼am
;

19 
	mtÙ®sw­
;

20 
	mä“sw­
;

21 
	m´ocs
;

22 
	m·d
;

23 
	mtÙ®high
;

24 
	mä“high
;

25 
	mmem_un™
;

26 
	m_f
[20-2*()-()];

	@/usr/include/linux/netdevice.h

25 #iâdeà
_LINUX_NETDEVICE_H


26 
	#_LINUX_NETDEVICE_H


	)

28 
	~<lšux/if.h
>

29 
	~<lšux/if_‘h”.h
>

30 
	~<lšux/if_·ck‘.h
>

31 
	~<lšux/if_lšk.h
>

34 
	#MAX_ADDR_LEN
 32

	)

37 
	#INIT_NETDEV_GROUP
 0

	)

43 
	mIF_PORT_UNKNOWN
 = 0,

44 
	mIF_PORT_10BASE2
,

45 
	mIF_PORT_10BASET
,

46 
	mIF_PORT_AUI
,

47 
	mIF_PORT_100BASET
,

48 
	mIF_PORT_100BASETX
,

49 
	mIF_PORT_100BASEFX


	@/usr/include/linux/pkt_sched.h

1 #iâdeà
__LINUX_PKT_SCHED_H


2 
	#__LINUX_PKT_SCHED_H


	)

4 
	~<lšux/ty³s.h
>

19 
	#TC_PRIO_BESTEFFORT
 0

	)

20 
	#TC_PRIO_FILLER
 1

	)

21 
	#TC_PRIO_BULK
 2

	)

22 
	#TC_PRIO_INTERACTIVE_BULK
 4

	)

23 
	#TC_PRIO_INTERACTIVE
 6

	)

24 
	#TC_PRIO_CONTROL
 7

	)

26 
	#TC_PRIO_MAX
 15

	)

32 
	stc_¡©s
 {

33 
__u64
 
	mby‹s
;

34 
__u32
 
	m·ck‘s
;

35 
__u32
 
	mdrİs
;

36 
__u32
 
	mov”lim™s
;

38 
__u32
 
	mbps
;

39 
__u32
 
	mµs
;

40 
__u32
 
	mqËn
;

41 
__u32
 
	mbacklog
;

44 
	stc_e¡im©Ü
 {

45 sigÃd 
	mš‹rv®
;

46 
	mewma_log
;

66 
	#TC_H_MAJ_MASK
 (0xFFFF0000U)

	)

67 
	#TC_H_MIN_MASK
 (0x0000FFFFU)

	)

68 
	#TC_H_MAJ
(
h
è((h)&
TC_H_MAJ_MASK
)

	)

69 
	#TC_H_MIN
(
h
è((h)&
TC_H_MIN_MASK
)

	)

70 
	#TC_H_MAKE
(
maj
,
mš
è(((maj)&
TC_H_MAJ_MASK
)|((mš)&
TC_H_MIN_MASK
))

	)

72 
	#TC_H_UNSPEC
 (0U)

	)

73 
	#TC_H_ROOT
 (0xFFFFFFFFU)

	)

74 
	#TC_H_INGRESS
 (0xFFFFFFF1U)

	)

76 
	stc_¿‹¥ec
 {

77 
	mûÎ_log
;

78 
	m__»£rved
;

79 
	mov”h—d
;

80 
	mûÎ_®ign
;

81 
	mmpu
;

82 
__u32
 
	m¿‹
;

85 
	#TC_RTAB_SIZE
 1024

	)

87 
	stc_size¥ec
 {

88 
	mûÎ_log
;

89 
	msize_log
;

90 
	mûÎ_®ign
;

91 
	mov”h—d
;

92 
	mlškÏy”
;

93 
	mmpu
;

94 
	mmtu
;

95 
	mtsize
;

99 
	mTCA_STAB_UNSPEC
,

100 
	mTCA_STAB_BASE
,

101 
	mTCA_STAB_DATA
,

102 
	m__TCA_STAB_MAX


105 
	#TCA_STAB_MAX
 (
__TCA_STAB_MAX
 - 1)

	)

109 
	stc_fifo_qİt
 {

110 
__u32
 
	mlim™
;

115 
	#TCQ_PRIO_BANDS
 16

	)

116 
	#TCQ_MIN_PRIO_BANDS
 2

	)

118 
	stc_´io_qİt
 {

119 
	mbªds
;

120 
__u8
 
	m´iom­
[
TC_PRIO_MAX
+1];

125 
	stc_muÉiq_qİt
 {

126 
__u16
 
	mbªds
;

127 
__u16
 
	mmax_bªds
;

132 
	stc_tbf_qİt
 {

133 
tc_¿‹¥ec
 
	m¿‹
;

134 
tc_¿‹¥ec
 
	m³ak¿‹
;

135 
__u32
 
	mlim™
;

136 
__u32
 
	mbufãr
;

137 
__u32
 
	mmtu
;

141 
	mTCA_TBF_UNSPEC
,

142 
	mTCA_TBF_PARMS
,

143 
	mTCA_TBF_RTAB
,

144 
	mTCA_TBF_PTAB
,

145 
	m__TCA_TBF_MAX
,

148 
	#TCA_TBF_MAX
 (
__TCA_TBF_MAX
 - 1)

	)

157 
	stc_sfq_qİt
 {

158 
	mquªtum
;

159 
	m³¹urb_³riod
;

160 
__u32
 
	mlim™
;

161 
	mdivisÜ
;

162 
	mæows
;

165 
	stc_sfq_x¡©s
 {

166 
__s32
 
	m®lÙ
;

181 
	mTCA_RED_UNSPEC
,

182 
	mTCA_RED_PARMS
,

183 
	mTCA_RED_STAB
,

184 
	m__TCA_RED_MAX
,

187 
	#TCA_RED_MAX
 (
__TCA_RED_MAX
 - 1)

	)

189 
	stc_»d_qİt
 {

190 
__u32
 
	mlim™
;

191 
__u32
 
	mqth_mš
;

192 
__u32
 
	mqth_max
;

193 
	mWlog
;

194 
	mPlog
;

195 
	mSûÎ_log
;

196 
	mæags
;

197 
	#TC_RED_ECN
 1

	)

198 
	#TC_RED_HARDDROP
 2

	)

201 
	stc_»d_x¡©s
 {

202 
__u32
 
	m—¾y
;

203 
__u32
 
	mpdrİ
;

204 
__u32
 
	mÙh”
;

205 
__u32
 
	mm¬ked
;

210 
	#MAX_DPs
 16

	)

213 
	mTCA_GRED_UNSPEC
,

214 
	mTCA_GRED_PARMS
,

215 
	mTCA_GRED_STAB
,

216 
	mTCA_GRED_DPS
,

217 
	m__TCA_GRED_MAX
,

220 
	#TCA_GRED_MAX
 (
__TCA_GRED_MAX
 - 1)

	)

222 
	stc_g»d_qİt
 {

223 
__u32
 
	mlim™
;

224 
__u32
 
	mqth_mš
;

225 
__u32
 
	mqth_max
;

226 
__u32
 
	mDP
;

227 
__u32
 
	mbacklog
;

228 
__u32
 
	mqave
;

229 
__u32
 
	mfÜûd
;

230 
__u32
 
	m—¾y
;

231 
__u32
 
	mÙh”
;

232 
__u32
 
	mpdrİ
;

233 
__u8
 
	mWlog
;

234 
__u8
 
	mPlog
;

235 
__u8
 
	mSûÎ_log
;

236 
__u8
 
	m´io
;

237 
__u32
 
	m·ck‘s
;

238 
__u32
 
	mby‹sš
;

242 
	stc_g»d_sİt
 {

243 
__u32
 
	mDPs
;

244 
__u32
 
	mdef_DP
;

245 
__u8
 
	mgrio
;

246 
__u8
 
	mæags
;

247 
__u16
 
	m·d1
;

253 
	mTCA_CHOKE_UNSPEC
,

254 
	mTCA_CHOKE_PARMS
,

255 
	mTCA_CHOKE_STAB
,

256 
	m__TCA_CHOKE_MAX
,

259 
	#TCA_CHOKE_MAX
 (
__TCA_CHOKE_MAX
 - 1)

	)

261 
	stc_choke_qİt
 {

262 
__u32
 
	mlim™
;

263 
__u32
 
	mqth_mš
;

264 
__u32
 
	mqth_max
;

265 
	mWlog
;

266 
	mPlog
;

267 
	mSûÎ_log
;

268 
	mæags
;

271 
	stc_choke_x¡©s
 {

272 
__u32
 
	m—¾y
;

273 
__u32
 
	mpdrİ
;

274 
__u32
 
	mÙh”
;

275 
__u32
 
	mm¬ked
;

276 
__u32
 
	mm©ched
;

280 
	#TC_HTB_NUMPRIO
 8

	)

281 
	#TC_HTB_MAXDEPTH
 8

	)

282 
	#TC_HTB_PROTOVER
 3

	)

284 
	stc_htb_İt
 {

285 
tc_¿‹¥ec
 
	m¿‹
;

286 
tc_¿‹¥ec
 
	mû
;

287 
__u32
 
	mbufãr
;

288 
__u32
 
	mcbufãr
;

289 
__u32
 
	mquªtum
;

290 
__u32
 
	mËv–
;

291 
__u32
 
	m´io
;

293 
	stc_htb_glob
 {

294 
__u32
 
	mv”siÚ
;

295 
__u32
 
	m¿‹2quªtum
;

296 
__u32
 
	mdefşs
;

297 
__u32
 
	mdebug
;

300 
__u32
 
	mdœeù_pkts
;

303 
	mTCA_HTB_UNSPEC
,

304 
	mTCA_HTB_PARMS
,

305 
	mTCA_HTB_INIT
,

306 
	mTCA_HTB_CTAB
,

307 
	mTCA_HTB_RTAB
,

308 
	m__TCA_HTB_MAX
,

311 
	#TCA_HTB_MAX
 (
__TCA_HTB_MAX
 - 1)

	)

313 
	stc_htb_x¡©s
 {

314 
__u32
 
	mËnds
;

315 
__u32
 
	mbÜrows
;

316 
__u32
 
	mgŸÁs
;

317 
__u32
 
	mtok’s
;

318 
__u32
 
	mùok’s
;

323 
	stc_hfsc_qİt
 {

324 
__u16
 
	mdefşs
;

327 
	stc_£rviû_curve
 {

328 
__u32
 
	mm1
;

329 
__u32
 
	md
;

330 
__u32
 
	mm2
;

333 
	stc_hfsc_¡©s
 {

334 
__u64
 
	mwÜk
;

335 
__u64
 
	m¹wÜk
;

336 
__u32
 
	m³riod
;

337 
__u32
 
	mËv–
;

341 
	mTCA_HFSC_UNSPEC
,

342 
	mTCA_HFSC_RSC
,

343 
	mTCA_HFSC_FSC
,

344 
	mTCA_HFSC_USC
,

345 
	m__TCA_HFSC_MAX
,

348 
	#TCA_HFSC_MAX
 (
__TCA_HFSC_MAX
 - 1)

	)

353 
	#TC_CBQ_MAXPRIO
 8

	)

354 
	#TC_CBQ_MAXLEVEL
 8

	)

355 
	#TC_CBQ_DEF_EWMA
 5

	)

357 
	stc_cbq_lssİt
 {

358 
	mchªge
;

359 
	mæags
;

360 
	#TCF_CBQ_LSS_BOUNDED
 1

	)

361 
	#TCF_CBQ_LSS_ISOLATED
 2

	)

362 
	mewma_log
;

363 
	mËv–
;

364 
	#TCF_CBQ_LSS_FLAGS
 1

	)

365 
	#TCF_CBQ_LSS_EWMA
 2

	)

366 
	#TCF_CBQ_LSS_MAXIDLE
 4

	)

367 
	#TCF_CBQ_LSS_MINIDLE
 8

	)

368 
	#TCF_CBQ_LSS_OFFTIME
 0x10

	)

369 
	#TCF_CBQ_LSS_AVPKT
 0x20

	)

370 
__u32
 
	mmaxidË
;

371 
__u32
 
	mmšidË
;

372 
__u32
 
	mofáime
;

373 
__u32
 
	mavpkt
;

376 
	stc_cbq_w¼İt
 {

377 
	mæags
;

378 
	m´iÜ™y
;

379 
	mıriÜ™y
;

380 
	m__»£rved
;

381 
__u32
 
	m®lÙ
;

382 
__u32
 
	mweight
;

385 
	stc_cbq_ovl
 {

386 
	m¡¿‹gy
;

387 
	#TC_CBQ_OVL_CLASSIC
 0

	)

388 
	#TC_CBQ_OVL_DELAY
 1

	)

389 
	#TC_CBQ_OVL_LOWPRIO
 2

	)

390 
	#TC_CBQ_OVL_DROP
 3

	)

391 
	#TC_CBQ_OVL_RCLASSIC
 4

	)

392 
	m´iÜ™y2
;

393 
__u16
 
	m·d
;

394 
__u32
 
	m³ÇÉy
;

397 
	stc_cbq_pŞiû
 {

398 
	mpŞiû
;

399 
	m__»s1
;

400 
	m__»s2
;

403 
	stc_cbq_fİt
 {

404 
__u32
 
	m¥l™
;

405 
__u32
 
	mdefm­
;

406 
__u32
 
	mdefchªge
;

409 
	stc_cbq_x¡©s
 {

410 
__u32
 
	mbÜrows
;

411 
__u32
 
	mov”aùiÚs
;

412 
__s32
 
	mavgidË
;

413 
__s32
 
	mund”time
;

417 
	mTCA_CBQ_UNSPEC
,

418 
	mTCA_CBQ_LSSOPT
,

419 
	mTCA_CBQ_WRROPT
,

420 
	mTCA_CBQ_FOPT
,

421 
	mTCA_CBQ_OVL_STRATEGY
,

422 
	mTCA_CBQ_RATE
,

423 
	mTCA_CBQ_RTAB
,

424 
	mTCA_CBQ_POLICE
,

425 
	m__TCA_CBQ_MAX
,

428 
	#TCA_CBQ_MAX
 (
__TCA_CBQ_MAX
 - 1)

	)

433 
	mTCA_DSMARK_UNSPEC
,

434 
	mTCA_DSMARK_INDICES
,

435 
	mTCA_DSMARK_DEFAULT_INDEX
,

436 
	mTCA_DSMARK_SET_TC_INDEX
,

437 
	mTCA_DSMARK_MASK
,

438 
	mTCA_DSMARK_VALUE
,

439 
	m__TCA_DSMARK_MAX
,

442 
	#TCA_DSMARK_MAX
 (
__TCA_DSMARK_MAX
 - 1)

	)

447 
	mTCA_ATM_UNSPEC
,

448 
	mTCA_ATM_FD
,

449 
	mTCA_ATM_PTR
,

450 
	mTCA_ATM_HDR
,

451 
	mTCA_ATM_EXCESS
,

452 
	mTCA_ATM_ADDR
,

453 
	mTCA_ATM_STATE
,

454 
	m__TCA_ATM_MAX
,

457 
	#TCA_ATM_MAX
 (
__TCA_ATM_MAX
 - 1)

	)

462 
	mTCA_NETEM_UNSPEC
,

463 
	mTCA_NETEM_CORR
,

464 
	mTCA_NETEM_DELAY_DIST
,

465 
	mTCA_NETEM_REORDER
,

466 
	mTCA_NETEM_CORRUPT
,

467 
	mTCA_NETEM_LOSS
,

468 
	m__TCA_NETEM_MAX
,

471 
	#TCA_NETEM_MAX
 (
__TCA_NETEM_MAX
 - 1)

	)

473 
	stc_Ã‹m_qİt
 {

474 
__u32
 
	mÏ‹ncy
;

475 
__u32
 
	mlim™
;

476 
__u32
 
	mloss
;

477 
__u32
 
	mg­
;

478 
__u32
 
	mdu¶iÿ‹
;

479 
__u32
 
	mj™‹r
;

482 
	stc_Ã‹m_cÜr
 {

483 
__u32
 
	md–ay_cÜr
;

484 
__u32
 
	mloss_cÜr
;

485 
__u32
 
	mdup_cÜr
;

488 
	stc_Ã‹m_»Üd”
 {

489 
__u32
 
	m´obab™y
;

490 
__u32
 
	mcÜ»ÏtiÚ
;

493 
	stc_Ã‹m_cÜru±
 {

494 
__u32
 
	m´obab™y
;

495 
__u32
 
	mcÜ»ÏtiÚ
;

499 
	mNETEM_LOSS_UNSPEC
,

500 
	mNETEM_LOSS_GI
,

501 
	mNETEM_LOSS_GE
,

502 
	m__NETEM_LOSS_MAX


504 
	#NETEM_LOSS_MAX
 (
__NETEM_LOSS_MAX
 - 1)

	)

507 
	stc_Ã‹m_gimod–
 {

508 
__u32
 
	mp13
;

509 
__u32
 
	mp31
;

510 
__u32
 
	mp32
;

511 
__u32
 
	mp14
;

512 
__u32
 
	mp23
;

516 
	stc_Ã‹m_gemod–
 {

517 
__u32
 
	mp
;

518 
__u32
 
	mr
;

519 
__u32
 
	mh
;

520 
__u32
 
	mk1
;

523 
	#NETEM_DIST_SCALE
 8192

	)

524 
	#NETEM_DIST_MAX
 16384

	)

529 
	mTCA_DRR_UNSPEC
,

530 
	mTCA_DRR_QUANTUM
,

531 
	m__TCA_DRR_MAX


534 
	#TCA_DRR_MAX
 (
__TCA_DRR_MAX
 - 1)

	)

536 
	stc_d¼_¡©s
 {

537 
__u32
 
	mdefic™
;

541 
	#TC_QOPT_BITMASK
 15

	)

542 
	#TC_QOPT_MAX_QUEUE
 16

	)

544 
	stc_mq´io_qİt
 {

545 
__u8
 
	mnum_tc
;

546 
__u8
 
	m´io_tc_m­
[
TC_QOPT_BITMASK
 + 1];

547 
__u8
 
	mhw
;

548 
__u16
 
	mcouÁ
[
TC_QOPT_MAX_QUEUE
];

549 
__u16
 
	moff£t
[
TC_QOPT_MAX_QUEUE
];

555 
	mTCA_SFB_UNSPEC
,

556 
	mTCA_SFB_PARMS
,

557 
	m__TCA_SFB_MAX
,

560 
	#TCA_SFB_MAX
 (
__TCA_SFB_MAX
 - 1)

	)

565 
	stc_sfb_qİt
 {

566 
__u32
 
	m»hash_š‹rv®
;

567 
__u32
 
	mw¬mup_time
;

568 
__u32
 
	mmax
;

569 
__u32
 
	mbš_size
;

570 
__u32
 
	mšüem’t
;

571 
__u32
 
	mdeüem’t
;

572 
__u32
 
	mlim™
;

573 
__u32
 
	m³ÇÉy_¿‹
;

574 
__u32
 
	m³ÇÉy_bur¡
;

577 
	stc_sfb_x¡©s
 {

578 
__u32
 
	m—¾ydrİ
;

579 
__u32
 
	m³ÇÉydrİ
;

580 
__u32
 
	mbuck‘drİ
;

581 
__u32
 
	mqueuedrİ
;

582 
__u32
 
	mchddrİ
;

583 
__u32
 
	mm¬ked
;

584 
__u32
 
	mmaxqËn
;

585 
__u32
 
	mmax´ob
;

586 
__u32
 
	mavg´ob
;

589 
	#SFB_MAX_PROB
 0xFFFF

	)

593 
	mTCA_QFQ_UNSPEC
,

594 
	mTCA_QFQ_WEIGHT
,

595 
	mTCA_QFQ_LMAX
,

596 
	m__TCA_QFQ_MAX


599 
	#TCA_QFQ_MAX
 (
__TCA_QFQ_MAX
 - 1)

	)

601 
	stc_qfq_¡©s
 {

602 
__u32
 
	mweight
;

603 
__u32
 
	mlmax
;

	@/usr/include/linux/poll.h

1 #iâdeà
_LINUX_POLL_H


2 
	#_LINUX_POLL_H


	)

4 
	~<asm/pŞl.h
>

	@/usr/include/linux/udp.h

17 #iâdeà
_LINUX_UDP_H


18 
	#_LINUX_UDP_H


	)

20 
	~<lšux/ty³s.h
>

22 
	sudphdr
 {

23 
__be16
 
	msourû
;

24 
__be16
 
	mde¡
;

25 
__be16
 
	mËn
;

26 
__sum16
 
	mcheck
;

30 
	#UDP_CORK
 1

	)

31 
	#UDP_ENCAP
 100

	)

34 
	#UDP_ENCAP_ESPINUDP_NON_IKE
 1

	)

35 
	#UDP_ENCAP_ESPINUDP
 2

	)

36 
	#UDP_ENCAP_L2TPINUDP
 3

	)

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 197154

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
è((×è<< 16è+ ((bè<< 8è+ (c))

	)

	@/usr/include/asm/byteorder.h

1 #iâdeà
_ASM_X86_BYTEORDER_H


2 
	#_ASM_X86_BYTEORDER_H


	)

4 
	~<lšux/by‹Üd”/l™e_’dŸn.h
>

	@/usr/include/asm/poll.h

1 
	~<asm-g’”ic/pŞl.h
>

	@/usr/include/linux/if.h

19 #iâdeà
_LINUX_IF_H


20 
	#_LINUX_IF_H


	)

22 
	~<lšux/ty³s.h
>

23 
	~<lšux/sock‘.h
>

26 
	#IFNAMSIZ
 16

	)

27 
	#IFALIASZ
 256

	)

28 
	~<lšux/hdlc/ioùl.h
>

31 
	#IFF_UP
 0x1

	)

32 
	#IFF_BROADCAST
 0x2

	)

33 
	#IFF_DEBUG
 0x4

	)

34 
	#IFF_LOOPBACK
 0x8

	)

35 
	#IFF_POINTOPOINT
 0x10

	)

36 
	#IFF_NOTRAILERS
 0x20

	)

37 
	#IFF_RUNNING
 0x40

	)

38 
	#IFF_NOARP
 0x80

	)

39 
	#IFF_PROMISC
 0x100

	)

40 
	#IFF_ALLMULTI
 0x200

	)

42 
	#IFF_MASTER
 0x400

	)

43 
	#IFF_SLAVE
 0x800

	)

45 
	#IFF_MULTICAST
 0x1000

	)

47 
	#IFF_PORTSEL
 0x2000

	)

48 
	#IFF_AUTOMEDIA
 0x4000

	)

49 
	#IFF_DYNAMIC
 0x8000

	)

51 
	#IFF_LOWER_UP
 0x10000

	)

52 
	#IFF_DORMANT
 0x20000

	)

54 
	#IFF_ECHO
 0x40000

	)

56 
	#IFF_VOLATILE
 (
IFF_LOOPBACK
|
IFF_POINTOPOINT
|
IFF_BROADCAST
|
IFF_ECHO
|\

57 
IFF_MASTER
|
IFF_SLAVE
|
IFF_RUNNING
|
IFF_LOWER_UP
|
IFF_DORMANT
)

	)

60 
	#IFF_802_1Q_VLAN
 0x1

	)

61 
	#IFF_EBRIDGE
 0x2

	)

62 
	#IFF_SLAVE_INACTIVE
 0x4

	)

63 
	#IFF_MASTER_8023AD
 0x8

	)

64 
	#IFF_MASTER_ALB
 0x10

	)

65 
	#IFF_BONDING
 0x20

	)

66 
	#IFF_SLAVE_NEEDARP
 0x40

	)

67 
	#IFF_ISATAP
 0x80

	)

68 
	#IFF_MASTER_ARPMON
 0x100

	)

69 
	#IFF_WAN_HDLC
 0x200

	)

70 
	#IFF_XMIT_DST_RELEASE
 0x400

	)

73 
	#IFF_DONT_BRIDGE
 0x800

	)

74 
	#IFF_DISABLE_NETPOLL
 0x1000

	)

75 
	#IFF_MACVLAN_PORT
 0x2000

	)

76 
	#IFF_BRIDGE_PORT
 0x4000

	)

77 
	#IFF_OVS_DATAPATH
 0x8000

	)

79 
	#IFF_TX_SKB_SHARING
 0x10000

	)

81 
	#IFF_UNICAST_FLT
 0x20000

	)

83 
	#IF_GET_IFACE
 0x0001

	)

84 
	#IF_GET_PROTO
 0x0002

	)

87 
	#IF_IFACE_V35
 0x1000

	)

88 
	#IF_IFACE_V24
 0x1001

	)

89 
	#IF_IFACE_X21
 0x1002

	)

90 
	#IF_IFACE_T1
 0x1003

	)

91 
	#IF_IFACE_E1
 0x1004

	)

92 
	#IF_IFACE_SYNC_SERIAL
 0x1005

	)

93 
	#IF_IFACE_X21D
 0x1006

	)

96 
	#IF_PROTO_HDLC
 0x2000

	)

97 
	#IF_PROTO_PPP
 0x2001

	)

98 
	#IF_PROTO_CISCO
 0x2002

	)

99 
	#IF_PROTO_FR
 0x2003

	)

100 
	#IF_PROTO_FR_ADD_PVC
 0x2004

	)

101 
	#IF_PROTO_FR_DEL_PVC
 0x2005

	)

102 
	#IF_PROTO_X25
 0x2006

	)

103 
	#IF_PROTO_HDLC_ETH
 0x2007

	)

104 
	#IF_PROTO_FR_ADD_ETH_PVC
 0x2008

	)

105 
	#IF_PROTO_FR_DEL_ETH_PVC
 0x2009

	)

106 
	#IF_PROTO_FR_PVC
 0x200A

	)

107 
	#IF_PROTO_FR_ETH_PVC
 0x200B

	)

108 
	#IF_PROTO_RAW
 0x200C

	)

112 
	mIF_OPER_UNKNOWN
,

113 
	mIF_OPER_NOTPRESENT
,

114 
	mIF_OPER_DOWN
,

115 
	mIF_OPER_LOWERLAYERDOWN
,

116 
	mIF_OPER_TESTING
,

117 
	mIF_OPER_DORMANT
,

118 
	mIF_OPER_UP
,

123 
	mIF_LINK_MODE_DEFAULT
,

124 
	mIF_LINK_MODE_DORMANT
,

137 
	sifm­
 {

138 
	mmem_¡¬t
;

139 
	mmem_’d
;

140 
	mba£_addr
;

141 
	mœq
;

142 
	mdma
;

143 
	mpÜt
;

147 
	sif_£‰šgs
 {

148 
	mty³
;

149 
	msize
;

152 
¿w_hdlc_´Ùo
 *
	m¿w_hdlc
;

153 
cisco_´Ùo
 *
	mcisco
;

154 
ä_´Ùo
 *
	mä
;

155 
ä_´Ùo_pvc
 *
	mä_pvc
;

156 
ä_´Ùo_pvc_šfo
 *
	mä_pvc_šfo
;

159 
sync_£rŸl_£‰šgs
 *
	msync
;

160 
‹1_£‰šgs
 *
	m‹1
;

161 } 
	mifs_ifsu
;

171 
	siäeq
 {

172 
	#IFHWADDRLEN
 6

	)

175 
	miän_Çme
[
IFNAMSIZ
];

176 } 
	miä_iän
;

179 
sockaddr
 
	miäu_addr
;

180 
sockaddr
 
	miäu_d¡addr
;

181 
sockaddr
 
	miäu_brßdaddr
;

182 
sockaddr
 
	miäu_Ãtmask
;

183 
sockaddr
 
	miäu_hwaddr
;

184 
	miäu_æags
;

185 
	miäu_iv®ue
;

186 
	miäu_mtu
;

187 
ifm­
 
	miäu_m­
;

188 
	miäu_¦ave
[
IFNAMSIZ
];

189 
	miäu_ÃwÇme
[
IFNAMSIZ
];

190 * 
	miäu_d©a
;

191 
if_£‰šgs
 
	miäu_£‰šgs
;

192 } 
	miä_iäu
;

195 
	#iä_Çme
 
iä_iän
.
iän_Çme


	)

196 
	#iä_hwaddr
 
iä_iäu
.
iäu_hwaddr


	)

197 
	#iä_addr
 
iä_iäu
.
iäu_addr


	)

198 
	#iä_d¡addr
 
iä_iäu
.
iäu_d¡addr


	)

199 
	#iä_brßdaddr
 
iä_iäu
.
iäu_brßdaddr


	)

200 
	#iä_Ãtmask
 
iä_iäu
.
iäu_Ãtmask


	)

201 
	#iä_æags
 
iä_iäu
.
iäu_æags


	)

202 
	#iä_m‘ric
 
iä_iäu
.
iäu_iv®ue


	)

203 
	#iä_mtu
 
iä_iäu
.
iäu_mtu


	)

204 
	#iä_m­
 
iä_iäu
.
iäu_m­


	)

205 
	#iä_¦ave
 
iä_iäu
.
iäu_¦ave


	)

206 
	#iä_d©a
 
iä_iäu
.
iäu_d©a


	)

207 
	#iä_ifšdex
 
iä_iäu
.
iäu_iv®ue


	)

208 
	#iä_bªdwidth
 
iä_iäu
.
iäu_iv®ue


	)

209 
	#iä_qËn
 
iä_iäu
.
iäu_iv®ue


	)

210 
	#iä_ÃwÇme
 
iä_iäu
.
iäu_ÃwÇme


	)

211 
	#iä_£‰šgs
 
iä_iäu
.
iäu_£‰šgs


	)

220 
	sifcÚf
 {

221 
	mifc_Ën
;

223 *
	mifcu_buf
;

224 
iäeq
 *
	mifcu_»q
;

225 } 
	mifc_ifcu
;

227 
	#ifc_buf
 
ifc_ifcu
.
ifcu_buf


	)

228 
	#ifc_»q
 
ifc_ifcu
.
ifcu_»q


	)

	@/usr/include/linux/if_link.h

1 #iâdeà
_LINUX_IF_LINK_H


2 
	#_LINUX_IF_LINK_H


	)

4 
	~<lšux/ty³s.h
>

5 
	~<lšux/Ãšk.h
>

8 
	s¹Æ_lšk_¡©s
 {

9 
__u32
 
	mrx_·ck‘s
;

10 
__u32
 
	mtx_·ck‘s
;

11 
__u32
 
	mrx_by‹s
;

12 
__u32
 
	mtx_by‹s
;

13 
__u32
 
	mrx_”rÜs
;

14 
__u32
 
	mtx_”rÜs
;

15 
__u32
 
	mrx_drİ³d
;

16 
__u32
 
	mtx_drİ³d
;

17 
__u32
 
	mmuÉiÿ¡
;

18 
__u32
 
	mcŞlisiÚs
;

21 
__u32
 
	mrx_Ëngth_”rÜs
;

22 
__u32
 
	mrx_ov”_”rÜs
;

23 
__u32
 
	mrx_üc_”rÜs
;

24 
__u32
 
	mrx_äame_”rÜs
;

25 
__u32
 
	mrx_fifo_”rÜs
;

26 
__u32
 
	mrx_mis£d_”rÜs
;

29 
__u32
 
	mtx_abÜ‹d_”rÜs
;

30 
__u32
 
	mtx_ÿ¼›r_”rÜs
;

31 
__u32
 
	mtx_fifo_”rÜs
;

32 
__u32
 
	mtx_h—¹b—t_”rÜs
;

33 
__u32
 
	mtx_wšdow_”rÜs
;

36 
__u32
 
	mrx_com´es£d
;

37 
__u32
 
	mtx_com´es£d
;

41 
	s¹Æ_lšk_¡©s64
 {

42 
__u64
 
	mrx_·ck‘s
;

43 
__u64
 
	mtx_·ck‘s
;

44 
__u64
 
	mrx_by‹s
;

45 
__u64
 
	mtx_by‹s
;

46 
__u64
 
	mrx_”rÜs
;

47 
__u64
 
	mtx_”rÜs
;

48 
__u64
 
	mrx_drİ³d
;

49 
__u64
 
	mtx_drİ³d
;

50 
__u64
 
	mmuÉiÿ¡
;

51 
__u64
 
	mcŞlisiÚs
;

54 
__u64
 
	mrx_Ëngth_”rÜs
;

55 
__u64
 
	mrx_ov”_”rÜs
;

56 
__u64
 
	mrx_üc_”rÜs
;

57 
__u64
 
	mrx_äame_”rÜs
;

58 
__u64
 
	mrx_fifo_”rÜs
;

59 
__u64
 
	mrx_mis£d_”rÜs
;

62 
__u64
 
	mtx_abÜ‹d_”rÜs
;

63 
__u64
 
	mtx_ÿ¼›r_”rÜs
;

64 
__u64
 
	mtx_fifo_”rÜs
;

65 
__u64
 
	mtx_h—¹b—t_”rÜs
;

66 
__u64
 
	mtx_wšdow_”rÜs
;

69 
__u64
 
	mrx_com´es£d
;

70 
__u64
 
	mtx_com´es£d
;

74 
	s¹Æ_lšk_ifm­
 {

75 
__u64
 
	mmem_¡¬t
;

76 
__u64
 
	mmem_’d
;

77 
__u64
 
	mba£_addr
;

78 
__u16
 
	mœq
;

79 
__u8
 
	mdma
;

80 
__u8
 
	mpÜt
;

102 
	mIFLA_UNSPEC
,

103 
	mIFLA_ADDRESS
,

104 
	mIFLA_BROADCAST
,

105 
	mIFLA_IFNAME
,

106 
	mIFLA_MTU
,

107 
	mIFLA_LINK
,

108 
	mIFLA_QDISC
,

109 
	mIFLA_STATS
,

110 
	mIFLA_COST
,

111 
	#IFLA_COST
 
IFLA_COST


	)

112 
	mIFLA_PRIORITY
,

113 
	#IFLA_PRIORITY
 
IFLA_PRIORITY


	)

114 
	mIFLA_MASTER
,

115 
	#IFLA_MASTER
 
IFLA_MASTER


	)

116 
	mIFLA_WIRELESS
,

117 
	#IFLA_WIRELESS
 
IFLA_WIRELESS


	)

118 
	mIFLA_PROTINFO
,

119 
	#IFLA_PROTINFO
 
IFLA_PROTINFO


	)

120 
	mIFLA_TXQLEN
,

121 
	#IFLA_TXQLEN
 
IFLA_TXQLEN


	)

122 
	mIFLA_MAP
,

123 
	#IFLA_MAP
 
IFLA_MAP


	)

124 
	mIFLA_WEIGHT
,

125 
	#IFLA_WEIGHT
 
IFLA_WEIGHT


	)

126 
	mIFLA_OPERSTATE
,

127 
	mIFLA_LINKMODE
,

128 
	mIFLA_LINKINFO
,

129 
	#IFLA_LINKINFO
 
IFLA_LINKINFO


	)

130 
	mIFLA_NET_NS_PID
,

131 
	mIFLA_IFALIAS
,

132 
	mIFLA_NUM_VF
,

133 
	mIFLA_VFINFO_LIST
,

134 
	mIFLA_STATS64
,

135 
	mIFLA_VF_PORTS
,

136 
	mIFLA_PORT_SELF
,

137 
	mIFLA_AF_SPEC
,

138 
	mIFLA_GROUP
,

139 
	mIFLA_NET_NS_FD
,

140 
	mIFLA_EXT_MASK
,

141 
	m__IFLA_MAX


145 
	#IFLA_MAX
 (
__IFLA_MAX
 - 1)

	)

148 
	#IFLA_RTA
(
r
è((
¹©Œ
*)(((*)Ô)è+ 
	`NLMSG_ALIGN
((
ifšfomsg
))))

	)

149 
	#IFLA_PAYLOAD
(
n
è
	`NLMSG_PAYLOAD
Ò,(
ifšfomsg
))

	)

152 
	mIFLA_INET_UNSPEC
,

153 
	mIFLA_INET_CONF
,

154 
	m__IFLA_INET_MAX
,

157 
	#IFLA_INET_MAX
 (
__IFLA_INET_MAX
 - 1)

	)

190 
	mIFLA_INET6_UNSPEC
,

191 
	mIFLA_INET6_FLAGS
,

192 
	mIFLA_INET6_CONF
,

193 
	mIFLA_INET6_STATS
,

194 
	mIFLA_INET6_MCAST
,

195 
	mIFLA_INET6_CACHEINFO
,

196 
	mIFLA_INET6_ICMP6STATS
,

197 
	m__IFLA_INET6_MAX


200 
	#IFLA_INET6_MAX
 (
__IFLA_INET6_MAX
 - 1)

	)

202 
	siæa_ÿchešfo
 {

203 
__u32
 
	mmax_»asm_Ën
;

204 
__u32
 
	mt¡amp
;

205 
__u32
 
	m»achabË_time
;

206 
__u32
 
	m»Œªs_time
;

210 
	mIFLA_INFO_UNSPEC
,

211 
	mIFLA_INFO_KIND
,

212 
	mIFLA_INFO_DATA
,

213 
	mIFLA_INFO_XSTATS
,

214 
	m__IFLA_INFO_MAX
,

217 
	#IFLA_INFO_MAX
 (
__IFLA_INFO_MAX
 - 1)

	)

222 
	mIFLA_VLAN_UNSPEC
,

223 
	mIFLA_VLAN_ID
,

224 
	mIFLA_VLAN_FLAGS
,

225 
	mIFLA_VLAN_EGRESS_QOS
,

226 
	mIFLA_VLAN_INGRESS_QOS
,

227 
	m__IFLA_VLAN_MAX
,

230 
	#IFLA_VLAN_MAX
 (
__IFLA_VLAN_MAX
 - 1)

	)

232 
	siæa_vÏn_æags
 {

233 
__u32
 
	mæags
;

234 
__u32
 
	mmask
;

238 
	mIFLA_VLAN_QOS_UNSPEC
,

239 
	mIFLA_VLAN_QOS_MAPPING
,

240 
	m__IFLA_VLAN_QOS_MAX


243 
	#IFLA_VLAN_QOS_MAX
 (
__IFLA_VLAN_QOS_MAX
 - 1)

	)

245 
	siæa_vÏn_qos_m­pšg
 {

246 
__u32
 
	mäom
;

247 
__u32
 
	mto
;

252 
	mIFLA_MACVLAN_UNSPEC
,

253 
	mIFLA_MACVLAN_MODE
,

254 
	m__IFLA_MACVLAN_MAX
,

257 
	#IFLA_MACVLAN_MAX
 (
__IFLA_MACVLAN_MAX
 - 1)

	)

259 
	emacvÏn_mode
 {

260 
	mMACVLAN_MODE_PRIVATE
 = 1,

261 
	mMACVLAN_MODE_VEPA
 = 2,

262 
	mMACVLAN_MODE_BRIDGE
 = 4,

263 
	mMACVLAN_MODE_PASSTHRU
 = 8,

269 
	mIFLA_VF_INFO_UNSPEC
,

270 
	mIFLA_VF_INFO
,

271 
	m__IFLA_VF_INFO_MAX
,

274 
	#IFLA_VF_INFO_MAX
 (
__IFLA_VF_INFO_MAX
 - 1)

	)

277 
	mIFLA_VF_UNSPEC
,

278 
	mIFLA_VF_MAC
,

279 
	mIFLA_VF_VLAN
,

280 
	mIFLA_VF_TX_RATE
,

281 
	mIFLA_VF_SPOOFCHK
,

282 
	m__IFLA_VF_MAX
,

285 
	#IFLA_VF_MAX
 (
__IFLA_VF_MAX
 - 1)

	)

287 
	siæa_vf_mac
 {

288 
__u32
 
	mvf
;

289 
__u8
 
	mmac
[32];

292 
	siæa_vf_vÏn
 {

293 
__u32
 
	mvf
;

294 
__u32
 
	mvÏn
;

295 
__u32
 
	mqos
;

298 
	siæa_vf_tx_¿‹
 {

299 
__u32
 
	mvf
;

300 
__u32
 
	m¿‹
;

303 
	siæa_vf_¥oofchk
 {

304 
__u32
 
	mvf
;

305 
__u32
 
	m£‰šg
;

324 
	mIFLA_VF_PORT_UNSPEC
,

325 
	mIFLA_VF_PORT
,

326 
	m__IFLA_VF_PORT_MAX
,

329 
	#IFLA_VF_PORT_MAX
 (
__IFLA_VF_PORT_MAX
 - 1)

	)

332 
	mIFLA_PORT_UNSPEC
,

333 
	mIFLA_PORT_VF
,

334 
	mIFLA_PORT_PROFILE
,

335 
	mIFLA_PORT_VSI_TYPE
,

336 
	mIFLA_PORT_INSTANCE_UUID
,

337 
	mIFLA_PORT_HOST_UUID
,

338 
	mIFLA_PORT_REQUEST
,

339 
	mIFLA_PORT_RESPONSE
,

340 
	m__IFLA_PORT_MAX
,

343 
	#IFLA_PORT_MAX
 (
__IFLA_PORT_MAX
 - 1)

	)

345 
	#PORT_PROFILE_MAX
 40

	)

346 
	#PORT_UUID_MAX
 16

	)

347 
	#PORT_SELF_VF
 -1

	)

350 
	mPORT_REQUEST_PREASSOCIATE
 = 0,

351 
	mPORT_REQUEST_PREASSOCIATE_RR
,

352 
	mPORT_REQUEST_ASSOCIATE
,

353 
	mPORT_REQUEST_DISASSOCIATE
,

357 
	mPORT_VDP_RESPONSE_SUCCESS
 = 0,

358 
	mPORT_VDP_RESPONSE_INVALID_FORMAT
,

359 
	mPORT_VDP_RESPONSE_INSUFFICIENT_RESOURCES
,

360 
	mPORT_VDP_RESPONSE_UNUSED_VTID
,

361 
	mPORT_VDP_RESPONSE_VTID_VIOLATION
,

362 
	mPORT_VDP_RESPONSE_VTID_VERSION_VIOALTION
,

363 
	mPORT_VDP_RESPONSE_OUT_OF_SYNC
,

365 
	mPORT_PROFILE_RESPONSE_SUCCESS
 = 0x100,

366 
	mPORT_PROFILE_RESPONSE_INPROGRESS
,

367 
	mPORT_PROFILE_RESPONSE_INVALID
,

368 
	mPORT_PROFILE_RESPONSE_BADSTATE
,

369 
	mPORT_PROFILE_RESPONSE_INSUFFICIENT_RESOURCES
,

370 
	mPORT_PROFILE_RESPONSE_ERROR
,

373 
	siæa_pÜt_vsi
 {

374 
__u8
 
	mvsi_mgr_id
;

375 
__u8
 
	mvsi_ty³_id
[3];

376 
__u8
 
	mvsi_ty³_v”siÚ
;

377 
__u8
 
	m·d
[3];

	@/usr/include/linux/if_packet.h

1 #iâdeà
__LINUX_IF_PACKET_H


2 
	#__LINUX_IF_PACKET_H


	)

4 
	~<lšux/ty³s.h
>

6 
	ssockaddr_pkt
 {

7 
	m¥kt_çmy
;

8 
	m¥kt_deviû
[14];

9 
__be16
 
	m¥kt_´ÙocŞ
;

12 
	ssockaddr_Î
 {

13 
	m¦l_çmy
;

14 
__be16
 
	m¦l_´ÙocŞ
;

15 
	m¦l_ifšdex
;

16 
	m¦l_h©y³
;

17 
	m¦l_pk‰y³
;

18 
	m¦l_h®’
;

19 
	m¦l_addr
[8];

24 
	#PACKET_HOST
 0

	)

25 
	#PACKET_BROADCAST
 1

	)

26 
	#PACKET_MULTICAST
 2

	)

27 
	#PACKET_OTHERHOST
 3

	)

28 
	#PACKET_OUTGOING
 4

	)

30 
	#PACKET_LOOPBACK
 5

	)

31 
	#PACKET_FASTROUTE
 6

	)

35 
	#PACKET_ADD_MEMBERSHIP
 1

	)

36 
	#PACKET_DROP_MEMBERSHIP
 2

	)

37 
	#PACKET_RECV_OUTPUT
 3

	)

39 
	#PACKET_RX_RING
 5

	)

40 
	#PACKET_STATISTICS
 6

	)

41 
	#PACKET_COPY_THRESH
 7

	)

42 
	#PACKET_AUXDATA
 8

	)

43 
	#PACKET_ORIGDEV
 9

	)

44 
	#PACKET_VERSION
 10

	)

45 
	#PACKET_HDRLEN
 11

	)

46 
	#PACKET_RESERVE
 12

	)

47 
	#PACKET_TX_RING
 13

	)

48 
	#PACKET_LOSS
 14

	)

49 
	#PACKET_VNET_HDR
 15

	)

50 
	#PACKET_TX_TIMESTAMP
 16

	)

51 
	#PACKET_TIMESTAMP
 17

	)

52 
	#PACKET_FANOUT
 18

	)

54 
	#PACKET_FANOUT_HASH
 0

	)

55 
	#PACKET_FANOUT_LB
 1

	)

56 
	#PACKET_FANOUT_CPU
 2

	)

57 
	#PACKET_FANOUT_FLAG_DEFRAG
 0x8000

	)

59 
	sack‘_¡©s
 {

60 
	m_·ck‘s
;

61 
	m_drİs
;

64 
	sack‘_¡©s_v3
 {

65 
	m_·ck‘s
;

66 
	m_drİs
;

67 
	m_ä“ze_q_út
;

70 
	uack‘_¡©s_u
 {

71 
ack‘_¡©s
 
	m¡©s1
;

72 
ack‘_¡©s_v3
 
	m¡©s3
;

75 
	sack‘_auxd©a
 {

76 
__u32
 
	m_¡©us
;

77 
__u32
 
	m_Ën
;

78 
__u32
 
	m_¢­Ën
;

79 
__u16
 
	m_mac
;

80 
__u16
 
	m_Ãt
;

81 
__u16
 
	m_vÏn_tci
;

82 
__u16
 
	m_·ddšg
;

86 
	#TP_STATUS_KERNEL
 0x0

	)

87 
	#TP_STATUS_USER
 0x1

	)

88 
	#TP_STATUS_COPY
 0x2

	)

89 
	#TP_STATUS_LOSING
 0x4

	)

90 
	#TP_STATUS_CSUMNOTREADY
 0x8

	)

91 
	#TP_STATUS_VLAN_VALID
 0x10

	)

92 
	#TP_STATUS_BLK_TMO
 0x20

	)

95 
	#TP_STATUS_AVAILABLE
 0x0

	)

96 
	#TP_STATUS_SEND_REQUEST
 0x1

	)

97 
	#TP_STATUS_SENDING
 0x2

	)

98 
	#TP_STATUS_WRONG_FORMAT
 0x4

	)

101 
	#TP_FT_REQ_FILL_RXHASH
 0x1

	)

103 
	sack‘_hdr
 {

104 
	m_¡©us
;

105 
	m_Ën
;

106 
	m_¢­Ën
;

107 
	m_mac
;

108 
	m_Ãt
;

109 
	m_£c
;

110 
	m_u£c
;

113 
	#TPACKET_ALIGNMENT
 16

	)

114 
	#TPACKET_ALIGN
(
x
è(((x)+
TPACKET_ALIGNMENT
-1)&~(TPACKET_ALIGNMENT-1))

	)

115 
	#TPACKET_HDRLEN
 (
	`TPACKET_ALIGN
((
ack‘_hdr
)è+ (
sockaddr_Î
))

	)

117 
	sack‘2_hdr
 {

118 
__u32
 
	m_¡©us
;

119 
__u32
 
	m_Ën
;

120 
__u32
 
	m_¢­Ën
;

121 
__u16
 
	m_mac
;

122 
__u16
 
	m_Ãt
;

123 
__u32
 
	m_£c
;

124 
__u32
 
	m_n£c
;

125 
__u16
 
	m_vÏn_tci
;

126 
__u16
 
	m_·ddšg
;

129 
	sack‘_hdr_v¬ŸÁ1
 {

130 
__u32
 
	m_rxhash
;

131 
__u32
 
	m_vÏn_tci
;

134 
	sack‘3_hdr
 {

135 
__u32
 
	m_Ãxt_off£t
;

136 
__u32
 
	m_£c
;

137 
__u32
 
	m_n£c
;

138 
__u32
 
	m_¢­Ën
;

139 
__u32
 
	m_Ën
;

140 
__u32
 
	m_¡©us
;

141 
__u16
 
	m_mac
;

142 
__u16
 
	m_Ãt
;

145 
ack‘_hdr_v¬ŸÁ1
 
	mhv1
;

149 
	sack‘_bd_ts
 {

150 
	mts_£c
;

152 
	mts_u£c
;

153 
	mts_n£c
;

157 
	sack‘_hdr_v1
 {

158 
__u32
 
	mblock_¡©us
;

159 
__u32
 
	mnum_pkts
;

160 
__u32
 
	moff£t_to_fœ¡_pkt
;

165 
__u32
 
	mblk_Ën
;

176 
__®igÃd_u64
 
	m£q_num
;

203 
ack‘_bd_ts
 
	mts_fœ¡_pkt
, 
	mts_Ï¡_pkt
;

206 
	uack‘_bd_h—d”_u
 {

207 
ack‘_hdr_v1
 
	mbh1
;

210 
	sack‘_block_desc
 {

211 
__u32
 
	mv”siÚ
;

212 
__u32
 
	moff£t_to_´iv
;

213 
ack‘_bd_h—d”_u
 
	mhdr
;

216 
	#TPACKET2_HDRLEN
 (
	`TPACKET_ALIGN
((
ack‘2_hdr
)è+ (
sockaddr_Î
))

	)

217 
	#TPACKET3_HDRLEN
 (
	`TPACKET_ALIGN
((
ack‘3_hdr
)è+ (
sockaddr_Î
))

	)

219 
	eack‘_v”siÚs
 {

220 
	mTPACKET_V1
,

221 
	mTPACKET_V2
,

222 
	mTPACKET_V3


238 
	sack‘_»q
 {

239 
	m_block_size
;

240 
	m_block_Ä
;

241 
	m_äame_size
;

242 
	m_äame_Ä
;

245 
	sack‘_»q3
 {

246 
	m_block_size
;

247 
	m_block_Ä
;

248 
	m_äame_size
;

249 
	m_äame_Ä
;

250 
	m_»tœe_blk_tov
;

251 
	m_sizeof_´iv
;

252 
	m_ã©u»_»q_wÜd
;

255 
	uack‘_»q_u
 {

256 
ack‘_»q
 
	m»q
;

257 
ack‘_»q3
 
	m»q3
;

260 
	s·ck‘_m»q
 {

261 
	mmr_ifšdex
;

262 
	mmr_ty³
;

263 
	mmr_®’
;

264 
	mmr_add»ss
[8];

267 
	#PACKET_MR_MULTICAST
 0

	)

268 
	#PACKET_MR_PROMISC
 1

	)

269 
	#PACKET_MR_ALLMULTI
 2

	)

270 
	#PACKET_MR_UNICAST
 3

	)

	@/usr/include/linux/in6.h

21 #iâdeà
_LINUX_IN6_H


22 
	#_LINUX_IN6_H


	)

24 
	~<lšux/ty³s.h
>

30 
	sš6_addr
 {

32 
__u8
 
	mu6_addr8
[16];

33 
__be16
 
	mu6_addr16
[8];

34 
__be32
 
	mu6_addr32
[4];

35 } 
	mš6_u
;

36 
	#s6_addr
 
š6_u
.
u6_addr8


	)

37 
	#s6_addr16
 
š6_u
.
u6_addr16


	)

38 
	#s6_addr32
 
š6_u
.
u6_addr32


	)

46 
	ssockaddr_š6
 {

47 
	msš6_çmy
;

48 
__be16
 
	msš6_pÜt
;

49 
__be32
 
	msš6_æowšfo
;

50 
š6_addr
 
	msš6_addr
;

51 
__u32
 
	msš6_scİe_id
;

54 
	sv6_m»q
 {

56 
š6_addr
 
	mv6mr_muÉŸddr
;

59 
	mv6mr_ifšdex
;

62 
	#v6mr_aÿddr
 
v6mr_muÉŸddr


	)

64 
	sš6_æowÏb–_»q
 {

65 
š6_addr
 
	mær_d¡
;

66 
__be32
 
	mær_Ïb–
;

67 
__u8
 
	mær_aùiÚ
;

68 
__u8
 
	mær_sh¬e
;

69 
__u16
 
	mær_æags
;

70 
__u16
 
	mær_expœes
;

71 
__u16
 
	mær_lšg”
;

72 
__u32
 
	m__ær_·d
;

76 
	#IPV6_FL_A_GET
 0

	)

77 
	#IPV6_FL_A_PUT
 1

	)

78 
	#IPV6_FL_A_RENEW
 2

	)

80 
	#IPV6_FL_F_CREATE
 1

	)

81 
	#IPV6_FL_F_EXCL
 2

	)

83 
	#IPV6_FL_S_NONE
 0

	)

84 
	#IPV6_FL_S_EXCL
 1

	)

85 
	#IPV6_FL_S_PROCESS
 2

	)

86 
	#IPV6_FL_S_USER
 3

	)

87 
	#IPV6_FL_S_ANY
 255

	)

98 
	#IPV6_FLOWINFO_FLOWLABEL
 0x000fffff

	)

99 
	#IPV6_FLOWINFO_PRIORITY
 0x0ff00000

	)

102 
	#IPV6_PRIORITY_UNCHARACTERIZED
 0x0000

	)

103 
	#IPV6_PRIORITY_FILLER
 0x0100

	)

104 
	#IPV6_PRIORITY_UNATTENDED
 0x0200

	)

105 
	#IPV6_PRIORITY_RESERVED1
 0x0300

	)

106 
	#IPV6_PRIORITY_BULK
 0x0400

	)

107 
	#IPV6_PRIORITY_RESERVED2
 0x0500

	)

108 
	#IPV6_PRIORITY_INTERACTIVE
 0x0600

	)

109 
	#IPV6_PRIORITY_CONTROL
 0x0700

	)

110 
	#IPV6_PRIORITY_8
 0x0800

	)

111 
	#IPV6_PRIORITY_9
 0x0900

	)

112 
	#IPV6_PRIORITY_10
 0x0a00

	)

113 
	#IPV6_PRIORITY_11
 0x0b00

	)

114 
	#IPV6_PRIORITY_12
 0x0c00

	)

115 
	#IPV6_PRIORITY_13
 0x0d00

	)

116 
	#IPV6_PRIORITY_14
 0x0e00

	)

117 
	#IPV6_PRIORITY_15
 0x0f00

	)

122 
	#IPPROTO_HOPOPTS
 0

	)

123 
	#IPPROTO_ROUTING
 43

	)

124 
	#IPPROTO_FRAGMENT
 44

	)

125 
	#IPPROTO_ICMPV6
 58

	)

126 
	#IPPROTO_NONE
 59

	)

127 
	#IPPROTO_DSTOPTS
 60

	)

128 
	#IPPROTO_MH
 135

	)

133 
	#IPV6_TLV_PAD0
 0

	)

134 
	#IPV6_TLV_PADN
 1

	)

135 
	#IPV6_TLV_ROUTERALERT
 5

	)

136 
	#IPV6_TLV_JUMBO
 194

	)

137 
	#IPV6_TLV_HAO
 201

	)

143 
	#IPV6_ADDRFORM
 1

	)

144 
	#IPV6_2292PKTINFO
 2

	)

145 
	#IPV6_2292HOPOPTS
 3

	)

146 
	#IPV6_2292DSTOPTS
 4

	)

147 
	#IPV6_2292RTHDR
 5

	)

148 
	#IPV6_2292PKTOPTIONS
 6

	)

149 
	#IPV6_CHECKSUM
 7

	)

150 
	#IPV6_2292HOPLIMIT
 8

	)

151 
	#IPV6_NEXTHOP
 9

	)

152 
	#IPV6_AUTHHDR
 10

	)

153 
	#IPV6_FLOWINFO
 11

	)

155 
	#IPV6_UNICAST_HOPS
 16

	)

156 
	#IPV6_MULTICAST_IF
 17

	)

157 
	#IPV6_MULTICAST_HOPS
 18

	)

158 
	#IPV6_MULTICAST_LOOP
 19

	)

159 
	#IPV6_ADD_MEMBERSHIP
 20

	)

160 
	#IPV6_DROP_MEMBERSHIP
 21

	)

161 
	#IPV6_ROUTER_ALERT
 22

	)

162 
	#IPV6_MTU_DISCOVER
 23

	)

163 
	#IPV6_MTU
 24

	)

164 
	#IPV6_RECVERR
 25

	)

165 
	#IPV6_V6ONLY
 26

	)

166 
	#IPV6_JOIN_ANYCAST
 27

	)

167 
	#IPV6_LEAVE_ANYCAST
 28

	)

170 
	#IPV6_PMTUDISC_DONT
 0

	)

171 
	#IPV6_PMTUDISC_WANT
 1

	)

172 
	#IPV6_PMTUDISC_DO
 2

	)

173 
	#IPV6_PMTUDISC_PROBE
 3

	)

176 
	#IPV6_FLOWLABEL_MGR
 32

	)

177 
	#IPV6_FLOWINFO_SEND
 33

	)

179 
	#IPV6_IPSEC_POLICY
 34

	)

180 
	#IPV6_XFRM_POLICY
 35

	)

201 
	#IPV6_RECVPKTINFO
 49

	)

202 
	#IPV6_PKTINFO
 50

	)

203 
	#IPV6_RECVHOPLIMIT
 51

	)

204 
	#IPV6_HOPLIMIT
 52

	)

205 
	#IPV6_RECVHOPOPTS
 53

	)

206 
	#IPV6_HOPOPTS
 54

	)

207 
	#IPV6_RTHDRDSTOPTS
 55

	)

208 
	#IPV6_RECVRTHDR
 56

	)

209 
	#IPV6_RTHDR
 57

	)

210 
	#IPV6_RECVDSTOPTS
 58

	)

211 
	#IPV6_DSTOPTS
 59

	)

212 
	#IPV6_RECVPATHMTU
 60

	)

213 
	#IPV6_PATHMTU
 61

	)

214 
	#IPV6_DONTFRAG
 62

	)

216 
	#IPV6_USE_MIN_MTU
 63

	)

232 
	#IPV6_RECVTCLASS
 66

	)

233 
	#IPV6_TCLASS
 67

	)

246 
	#IPV6_ADDR_PREFERENCES
 72

	)

248 
	#IPV6_PREFER_SRC_TMP
 0x0001

	)

249 
	#IPV6_PREFER_SRC_PUBLIC
 0x0002

	)

250 
	#IPV6_PREFER_SRC_PUBTMP_DEFAULT
 0x0100

	)

251 
	#IPV6_PREFER_SRC_COA
 0x0004

	)

252 
	#IPV6_PREFER_SRC_HOME
 0x0400

	)

253 
	#IPV6_PREFER_SRC_CGA
 0x0008

	)

254 
	#IPV6_PREFER_SRC_NONCGA
 0x0800

	)

257 
	#IPV6_MINHOPCOUNT
 73

	)

259 
	#IPV6_ORIGDSTADDR
 74

	)

260 
	#IPV6_RECVORIGDSTADDR
 
IPV6_ORIGDSTADDR


	)

261 
	#IPV6_TRANSPARENT
 75

	)

	@/usr/include/linux/socket.h

1 #iâdeà
_LINUX_SOCKET_H


2 
	#_LINUX_SOCKET_H


	)

7 
	#_K_SS_MAXSIZE
 128

	)

8 
	#_K_SS_ALIGNSIZE
 (
	`__®ignof__
 (
sockaddr
 *))

	)

11 
	t__k”Ãl_§_çmy_t
;

13 
	s__k”Ãl_sockaddr_¡Üage
 {

14 
__k”Ãl_§_çmy_t
 
	mss_çmy
;

16 
	m__d©a
[
_K_SS_MAXSIZE
 - ()];

19 } 
__©Œibu‹__
 ((
®igÃd
(
_K_SS_ALIGNSIZE
)));

	@/usr/include/linux/types.h

1 #iâdeà
_LINUX_TYPES_H


2 
	#_LINUX_TYPES_H


	)

4 
	~<asm/ty³s.h
>

6 #iâdeà
__ASSEMBLY__


8 
	~<lšux/posix_ty³s.h
>

16 #ifdeà
__CHECKER__


17 
	#__b™wi£__
 
	`__©Œibu‹__
((
b™wi£
))

	)

19 
	#__b™wi£__


	)

21 #ifdeà
__CHECK_ENDIAN__


22 
	#__b™wi£
 
__b™wi£__


	)

24 
	#__b™wi£


	)

27 
__u16
 
	t__b™wi£
 
	t__Ë16
;

28 
__u16
 
	t__b™wi£
 
	t__be16
;

29 
__u32
 
	t__b™wi£
 
	t__Ë32
;

30 
__u32
 
	t__b™wi£
 
	t__be32
;

31 
__u64
 
	t__b™wi£
 
	t__Ë64
;

32 
__u64
 
	t__b™wi£
 
	t__be64
;

34 
__u16
 
	t__b™wi£
 
	t__sum16
;

35 
__u32
 
	t__b™wi£
 
	t__wsum
;

46 
	#__®igÃd_u64
 
__u64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

47 
	#__®igÃd_be64
 
__be64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

48 
	#__®igÃd_Ë64
 
__Ë64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

	@/usr/include/asm-generic/poll.h

1 #iâdeà
__ASM_GENERIC_POLL_H


2 
	#__ASM_GENERIC_POLL_H


	)

5 
	#POLLIN
 0x0001

	)

6 
	#POLLPRI
 0x0002

	)

7 
	#POLLOUT
 0x0004

	)

8 
	#POLLERR
 0x0008

	)

9 
	#POLLHUP
 0x0010

	)

10 
	#POLLNVAL
 0x0020

	)

13 
	#POLLRDNORM
 0x0040

	)

14 
	#POLLRDBAND
 0x0080

	)

15 #iâdeà
POLLWRNORM


16 
	#POLLWRNORM
 0x0100

	)

18 #iâdeà
POLLWRBAND


19 
	#POLLWRBAND
 0x0200

	)

21 #iâdeà
POLLMSG


22 
	#POLLMSG
 0x0400

	)

24 #iâdeà
POLLREMOVE


25 
	#POLLREMOVE
 0x1000

	)

27 #iâdeà
POLLRDHUP


28 
	#POLLRDHUP
 0x2000

	)

31 
	#POLLFREE
 0x4000

	)

33 
	spŞlfd
 {

34 
	mfd
;

35 
	mev’ts
;

36 
	m»v’ts
;

	@/usr/include/asm/types.h

1 #iâdeà
_ASM_X86_TYPES_H


2 
	#_ASM_X86_TYPES_H


	)

4 
	~<asm-g’”ic/ty³s.h
>

	@/usr/include/linux/byteorder/little_endian.h

1 #iâdeà
_LINUX_BYTEORDER_LITTLE_ENDIAN_H


2 
	#_LINUX_BYTEORDER_LITTLE_ENDIAN_H


	)

4 #iâdeà
__LITTLE_ENDIAN


5 
	#__LITTLE_ENDIAN
 1234

	)

7 #iâdeà
__LITTLE_ENDIAN_BITFIELD


8 
	#__LITTLE_ENDIAN_BITFIELD


	)

11 
	~<lšux/ty³s.h
>

12 
	~<lšux/swab.h
>

14 
	#__cÚ¡ªt_htÚl
(
x
è((
__be32
)
	`___cÚ¡ªt_swab32
((x)))

	)

15 
	#__cÚ¡ªt_Áohl
(
x
è
	`___cÚ¡ªt_swab32
((
__be32
)(x))

	)

16 
	#__cÚ¡ªt_htÚs
(
x
è((
__be16
)
	`___cÚ¡ªt_swab16
((x)))

	)

17 
	#__cÚ¡ªt_Áohs
(
x
è
	`___cÚ¡ªt_swab16
((
__be16
)(x))

	)

18 
	#__cÚ¡ªt_ıu_to_Ë64
(
x
è((
__Ë64
)(
__u64
)(x))

	)

19 
	#__cÚ¡ªt_Ë64_to_ıu
(
x
è((
__u64
)(
__Ë64
)(x))

	)

20 
	#__cÚ¡ªt_ıu_to_Ë32
(
x
è((
__Ë32
)(
__u32
)(x))

	)

21 
	#__cÚ¡ªt_Ë32_to_ıu
(
x
è((
__u32
)(
__Ë32
)(x))

	)

22 
	#__cÚ¡ªt_ıu_to_Ë16
(
x
è((
__Ë16
)(
__u16
)(x))

	)

23 
	#__cÚ¡ªt_Ë16_to_ıu
(
x
è((
__u16
)(
__Ë16
)(x))

	)

24 
	#__cÚ¡ªt_ıu_to_be64
(
x
è((
__be64
)
	`___cÚ¡ªt_swab64
((x)))

	)

25 
	#__cÚ¡ªt_be64_to_ıu
(
x
è
	`___cÚ¡ªt_swab64
((
__u64
)(
__be64
)(x))

	)

26 
	#__cÚ¡ªt_ıu_to_be32
(
x
è((
__be32
)
	`___cÚ¡ªt_swab32
((x)))

	)

27 
	#__cÚ¡ªt_be32_to_ıu
(
x
è
	`___cÚ¡ªt_swab32
((
__u32
)(
__be32
)(x))

	)

28 
	#__cÚ¡ªt_ıu_to_be16
(
x
è((
__be16
)
	`___cÚ¡ªt_swab16
((x)))

	)

29 
	#__cÚ¡ªt_be16_to_ıu
(
x
è
	`___cÚ¡ªt_swab16
((
__u16
)(
__be16
)(x))

	)

30 
	#__ıu_to_Ë64
(
x
è((
__Ë64
)(
__u64
)(x))

	)

31 
	#__Ë64_to_ıu
(
x
è((
__u64
)(
__Ë64
)(x))

	)

32 
	#__ıu_to_Ë32
(
x
è((
__Ë32
)(
__u32
)(x))

	)

33 
	#__Ë32_to_ıu
(
x
è((
__u32
)(
__Ë32
)(x))

	)

34 
	#__ıu_to_Ë16
(
x
è((
__Ë16
)(
__u16
)(x))

	)

35 
	#__Ë16_to_ıu
(
x
è((
__u16
)(
__Ë16
)(x))

	)

36 
	#__ıu_to_be64
(
x
è((
__be64
)
	`__swab64
((x)))

	)

37 
	#__be64_to_ıu
(
x
è
	`__swab64
((
__u64
)(
__be64
)(x))

	)

38 
	#__ıu_to_be32
(
x
è((
__be32
)
	`__swab32
((x)))

	)

39 
	#__be32_to_ıu
(
x
è
	`__swab32
((
__u32
)(
__be32
)(x))

	)

40 
	#__ıu_to_be16
(
x
è((
__be16
)
	`__swab16
((x)))

	)

41 
	#__be16_to_ıu
(
x
è
	`__swab16
((
__u16
)(
__be16
)(x))

	)

43 
__šlše__
 
__Ë64
 
	$__ıu_to_Ë64p
(cÚ¡ 
__u64
 *
p
)

45  (
__Ë64
)*
p
;

46 
	}
}

47 
__šlše__
 
__u64
 
	$__Ë64_to_ıup
(cÚ¡ 
__Ë64
 *
p
)

49  (
__u64
)*
p
;

50 
	}
}

51 
__šlše__
 
__Ë32
 
	$__ıu_to_Ë32p
(cÚ¡ 
__u32
 *
p
)

53  (
__Ë32
)*
p
;

54 
	}
}

55 
__šlše__
 
__u32
 
	$__Ë32_to_ıup
(cÚ¡ 
__Ë32
 *
p
)

57  (
__u32
)*
p
;

58 
	}
}

59 
__šlše__
 
__Ë16
 
	$__ıu_to_Ë16p
(cÚ¡ 
__u16
 *
p
)

61  (
__Ë16
)*
p
;

62 
	}
}

63 
__šlše__
 
__u16
 
	$__Ë16_to_ıup
(cÚ¡ 
__Ë16
 *
p
)

65  (
__u16
)*
p
;

66 
	}
}

67 
__šlše__
 
__be64
 
	$__ıu_to_be64p
(cÚ¡ 
__u64
 *
p
)

69  (
__be64
)
	`__swab64p
(
p
);

70 
	}
}

71 
__šlše__
 
__u64
 
	$__be64_to_ıup
(cÚ¡ 
__be64
 *
p
)

73  
	`__swab64p
((
__u64
 *)
p
);

74 
	}
}

75 
__šlše__
 
__be32
 
	$__ıu_to_be32p
(cÚ¡ 
__u32
 *
p
)

77  (
__be32
)
	`__swab32p
(
p
);

78 
	}
}

79 
__šlše__
 
__u32
 
	$__be32_to_ıup
(cÚ¡ 
__be32
 *
p
)

81  
	`__swab32p
((
__u32
 *)
p
);

82 
	}
}

83 
__šlše__
 
__be16
 
	$__ıu_to_be16p
(cÚ¡ 
__u16
 *
p
)

85  (
__be16
)
	`__swab16p
(
p
);

86 
	}
}

87 
__šlše__
 
__u16
 
	$__be16_to_ıup
(cÚ¡ 
__be16
 *
p
)

89  
	`__swab16p
((
__u16
 *)
p
);

90 
	}
}

91 
	#__ıu_to_Ë64s
(
x
èdØ{ ()(x); } 0)

	)

92 
	#__Ë64_to_ıus
(
x
èdØ{ ()(x); } 0)

	)

93 
	#__ıu_to_Ë32s
(
x
èdØ{ ()(x); } 0)

	)

94 
	#__Ë32_to_ıus
(
x
èdØ{ ()(x); } 0)

	)

95 
	#__ıu_to_Ë16s
(
x
èdØ{ ()(x); } 0)

	)

96 
	#__Ë16_to_ıus
(
x
èdØ{ ()(x); } 0)

	)

97 
	#__ıu_to_be64s
(
x
è
	`__swab64s
((x))

	)

98 
	#__be64_to_ıus
(
x
è
	`__swab64s
((x))

	)

99 
	#__ıu_to_be32s
(
x
è
	`__swab32s
((x))

	)

100 
	#__be32_to_ıus
(
x
è
	`__swab32s
((x))

	)

101 
	#__ıu_to_be16s
(
x
è
	`__swab16s
((x))

	)

102 
	#__be16_to_ıus
(
x
è
	`__swab16s
((x))

	)

	@/usr/include/linux/hdlc/ioctl.h

1 #iâdeà
__HDLC_IOCTL_H__


2 
	#__HDLC_IOCTL_H__


	)

5 
	#GENERIC_HDLC_VERSION
 4

	)

7 
	#CLOCK_DEFAULT
 0

	)

8 
	#CLOCK_EXT
 1

	)

9 
	#CLOCK_INT
 2

	)

10 
	#CLOCK_TXINT
 3

	)

11 
	#CLOCK_TXFROMRX
 4

	)

14 
	#ENCODING_DEFAULT
 0

	)

15 
	#ENCODING_NRZ
 1

	)

16 
	#ENCODING_NRZI
 2

	)

17 
	#ENCODING_FM_MARK
 3

	)

18 
	#ENCODING_FM_SPACE
 4

	)

19 
	#ENCODING_MANCHESTER
 5

	)

22 
	#PARITY_DEFAULT
 0

	)

23 
	#PARITY_NONE
 1

	)

24 
	#PARITY_CRC16_PR0
 2

	)

25 
	#PARITY_CRC16_PR1
 3

	)

26 
	#PARITY_CRC16_PR0_CCITT
 4

	)

27 
	#PARITY_CRC16_PR1_CCITT
 5

	)

28 
	#PARITY_CRC32_PR0_CCITT
 6

	)

29 
	#PARITY_CRC32_PR1_CCITT
 7

	)

31 
	#LMI_DEFAULT
 0

	)

32 
	#LMI_NONE
 1

	)

33 
	#LMI_ANSI
 2

	)

34 
	#LMI_CCITT
 3

	)

35 
	#LMI_CISCO
 4

	)

38 
	mşock_¿‹
;

39 
	mşock_ty³
;

40 
	mloİback
;

41 } 
	tsync_£rŸl_£‰šgs
;

44 
	mşock_¿‹
;

45 
	mşock_ty³
;

46 
	mloİback
;

47 
	m¦Ù_m­
;

48 } 
	t‹1_£‰šgs
;

51 
	m’codšg
;

52 
	m·r™y
;

53 } 
	t¿w_hdlc_´Ùo
;

56 
	mt391
;

57 
	mt392
;

58 
	mn391
;

59 
	mn392
;

60 
	mn393
;

61 
	mlmi
;

62 
	mdû
;

63 } 
	tä_´Ùo
;

66 
	mdlci
;

67 } 
	tä_´Ùo_pvc
;

70 
	mdlci
;

71 
	mma¡”
[
IFNAMSIZ
];

72 }
	tä_´Ùo_pvc_šfo
;

75 
	mš‹rv®
;

76 
	mtimeout
;

77 } 
	tcisco_´Ùo
;

	@/usr/include/linux/netlink.h

1 #iâdeà
__LINUX_NETLINK_H


2 
	#__LINUX_NETLINK_H


	)

4 
	~<lšux/sock‘.h
>

5 
	~<lšux/ty³s.h
>

7 
	#NETLINK_ROUTE
 0

	)

8 
	#NETLINK_UNUSED
 1

	)

9 
	#NETLINK_USERSOCK
 2

	)

10 
	#NETLINK_FIREWALL
 3

	)

11 
	#NETLINK_INET_DIAG
 4

	)

12 
	#NETLINK_NFLOG
 5

	)

13 
	#NETLINK_XFRM
 6

	)

14 
	#NETLINK_SELINUX
 7

	)

15 
	#NETLINK_ISCSI
 8

	)

16 
	#NETLINK_AUDIT
 9

	)

17 
	#NETLINK_FIB_LOOKUP
 10

	)

18 
	#NETLINK_CONNECTOR
 11

	)

19 
	#NETLINK_NETFILTER
 12

	)

20 
	#NETLINK_IP6_FW
 13

	)

21 
	#NETLINK_DNRTMSG
 14

	)

22 
	#NETLINK_KOBJECT_UEVENT
 15

	)

23 
	#NETLINK_GENERIC
 16

	)

25 
	#NETLINK_SCSITRANSPORT
 18

	)

26 
	#NETLINK_ECRYPTFS
 19

	)

27 
	#NETLINK_RDMA
 20

	)

28 
	#NETLINK_CRYPTO
 21

	)

30 
	#MAX_LINKS
 32

	)

32 
	ssockaddr_Æ
 {

33 
__k”Ãl_§_çmy_t
 
	mÆ_çmy
;

34 
	mÆ_·d
;

35 
__u32
 
	mÆ_pid
;

36 
__u32
 
	mÆ_groups
;

39 
	sÆmsghdr
 {

40 
__u32
 
	mÆmsg_Ën
;

41 
__u16
 
	mÆmsg_ty³
;

42 
__u16
 
	mÆmsg_æags
;

43 
__u32
 
	mÆmsg_£q
;

44 
__u32
 
	mÆmsg_pid
;

49 
	#NLM_F_REQUEST
 1

	)

50 
	#NLM_F_MULTI
 2

	)

51 
	#NLM_F_ACK
 4

	)

52 
	#NLM_F_ECHO
 8

	)

53 
	#NLM_F_DUMP_INTR
 16

	)

56 
	#NLM_F_ROOT
 0x100

	)

57 
	#NLM_F_MATCH
 0x200

	)

58 
	#NLM_F_ATOMIC
 0x400

	)

59 
	#NLM_F_DUMP
 (
NLM_F_ROOT
|
NLM_F_MATCH
)

	)

62 
	#NLM_F_REPLACE
 0x100

	)

63 
	#NLM_F_EXCL
 0x200

	)

64 
	#NLM_F_CREATE
 0x400

	)

65 
	#NLM_F_APPEND
 0x800

	)

76 
	#NLMSG_ALIGNTO
 4U

	)

77 
	#NLMSG_ALIGN
(
Ën
èĞ(Ö’)+
NLMSG_ALIGNTO
-1è& ~(NLMSG_ALIGNTO-1è)

	)

78 
	#NLMSG_HDRLEN
 ((è
	`NLMSG_ALIGN
((
Æmsghdr
)))

	)

79 
	#NLMSG_LENGTH
(
Ën
è(Ö’)+
	`NLMSG_ALIGN
(
NLMSG_HDRLEN
))

	)

80 
	#NLMSG_SPACE
(
Ën
è
	`NLMSG_ALIGN
(
	`NLMSG_LENGTH
Ö’))

	)

81 
	#NLMSG_DATA
(
Æh
è((*)(((*êlhè+ 
	`NLMSG_LENGTH
(0)))

	)

82 
	#NLMSG_NEXT
(
Æh
,
Ën
è(Ö’è-ğ
	`NLMSG_ALIGN
(Òlh)->
Æmsg_Ën
), \

83 (
Æmsghdr
*)(((*)(
Æh
)è+ 
	`NLMSG_ALIGN
(Òlh)->
Æmsg_Ën
)))

	)

84 
	#NLMSG_OK
(
Æh
,
Ën
è(Ö’è>ğ()(
Æmsghdr
) && \

85 (
Æh
)->
Æmsg_Ën
 >ğ(
Æmsghdr
) && \

86 (
Æh
)->
Æmsg_Ën
 <ğ(
Ën
))

	)

87 
	#NLMSG_PAYLOAD
(
Æh
,
Ën
è(Òlh)->
Æmsg_Ën
 - 
	`NLMSG_SPACE
(Ö’)))

	)

89 
	#NLMSG_NOOP
 0x1

	)

90 
	#NLMSG_ERROR
 0x2

	)

91 
	#NLMSG_DONE
 0x3

	)

92 
	#NLMSG_OVERRUN
 0x4

	)

94 
	#NLMSG_MIN_TYPE
 0x10

	)

96 
	sÆmsg”r
 {

97 
	m”rÜ
;

98 
Æmsghdr
 
	mmsg
;

101 
	#NETLINK_ADD_MEMBERSHIP
 1

	)

102 
	#NETLINK_DROP_MEMBERSHIP
 2

	)

103 
	#NETLINK_PKTINFO
 3

	)

104 
	#NETLINK_BROADCAST_ERROR
 4

	)

105 
	#NETLINK_NO_ENOBUFS
 5

	)

107 
	sÆ_pktšfo
 {

108 
__u32
 
	mgroup
;

111 
	#NET_MAJOR
 36

	)

114 
	mNETLINK_UNCONNECTED
 = 0,

115 
	mNETLINK_CONNECTED
,

127 
	sÆ©Œ
 {

128 
__u16
 
	mÆa_Ën
;

129 
__u16
 
	mÆa_ty³
;

142 
	#NLA_F_NESTED
 (1 << 15)

	)

143 
	#NLA_F_NET_BYTEORDER
 (1 << 14)

	)

144 
	#NLA_TYPE_MASK
 ~(
NLA_F_NESTED
 | 
NLA_F_NET_BYTEORDER
)

	)

146 
	#NLA_ALIGNTO
 4

	)

147 
	#NLA_ALIGN
(
Ën
è((Ö’è+ 
NLA_ALIGNTO
 - 1è& ~(NLA_ALIGNTO - 1))

	)

148 
	#NLA_HDRLEN
 ((è
	`NLA_ALIGN
((
Æ©Œ
)))

	)

	@/usr/include/linux/posix_types.h

1 #iâdeà
_LINUX_POSIX_TYPES_H


2 
	#_LINUX_POSIX_TYPES_H


	)

4 
	~<lšux/¡ddef.h
>

21 #undeà
__NFDBITS


22 
	#__NFDBITS
 (8 * ())

	)

24 #undeà
__FD_SETSIZE


25 
	#__FD_SETSIZE
 1024

	)

27 #undeà
__FDSET_LONGS


28 
	#__FDSET_LONGS
 (
__FD_SETSIZE
/
__NFDBITS
)

	)

30 #undeà
__FDELT


31 
	#__FDELT
(
d
è((dè/ 
__NFDBITS
)

	)

33 #undeà
__FDMASK


34 
	#__FDMASK
(
d
è(1UL << ((dè% 
__NFDBITS
))

	)

37 
	mfds_b™s
 [
__FDSET_LONGS
];

38 } 
	t__k”Ãl_fd_£t
;

41 (*
	t__k”Ãl_sighªdËr_t
)();

44 
	t__k”Ãl_key_t
;

45 
	t__k”Ãl_mqd_t
;

47 
	~<asm/posix_ty³s.h
>

	@/usr/include/asm-generic/types.h

1 #iâdeà
_ASM_GENERIC_TYPES_H


2 
	#_ASM_GENERIC_TYPES_H


	)

7 
	~<asm-g’”ic/št-Î64.h
>

9 #iâdeà
__ASSEMBLY__


11 
	tumode_t
;

	@/usr/include/asm/posix_types.h

1 #ifdeà
__i386__


2 
	~<asm/posix_ty³s_32.h
>

4 
	~<asm/posix_ty³s_64.h
>

	@/usr/include/linux/stddef.h

1 #iâdeà
_LINUX_STDDEF_H


2 
	#_LINUX_STDDEF_H


	)

6 #undeà
NULL


7 #ià
defšed
(
__ılu¥lus
)

8 
	#NULL
 0

	)

10 
	#NULL
 ((*)0)

	)

	@/usr/include/linux/swab.h

1 #iâdeà
_LINUX_SWAB_H


2 
	#_LINUX_SWAB_H


	)

4 
	~<lšux/ty³s.h
>

6 
	~<asm/swab.h
>

12 
	#___cÚ¡ªt_swab16
(
x
è((
__u16
)( \

13 (((
__u16
)(
x
) & (__u16)0x00ffU) << 8) | \

14 (((
__u16
)(
x
è& (__u16)0xff00Uè>> 8)))

	)

16 
	#___cÚ¡ªt_swab32
(
x
è((
__u32
)( \

17 (((
__u32
)(
x
) & (__u32)0x000000ffUL) << 24) | \

18 (((
__u32
)(
x
) & (__u32)0x0000ff00UL) << 8) | \

19 (((
__u32
)(
x
) & (__u32)0x00ff0000UL) >> 8) | \

20 (((
__u32
)(
x
è& (__u32)0xff000000ULè>> 24)))

	)

22 
	#___cÚ¡ªt_swab64
(
x
è((
__u64
)( \

23 (((
__u64
)(
x
) & (__u64)0x00000000000000ffULL) << 56) | \

24 (((
__u64
)(
x
) & (__u64)0x000000000000ff00ULL) << 40) | \

25 (((
__u64
)(
x
) & (__u64)0x0000000000ff0000ULL) << 24) | \

26 (((
__u64
)(
x
) & (__u64)0x00000000ff000000ULL) << 8) | \

27 (((
__u64
)(
x
) & (__u64)0x000000ff00000000ULL) >> 8) | \

28 (((
__u64
)(
x
) & (__u64)0x0000ff0000000000ULL) >> 24) | \

29 (((
__u64
)(
x
) & (__u64)0x00ff000000000000ULL) >> 40) | \

30 (((
__u64
)(
x
è& (__u64)0xff00000000000000ULLè>> 56)))

	)

32 
	#___cÚ¡ªt_swahw32
(
x
è((
__u32
)( \

33 (((
__u32
)(
x
) & (__u32)0x0000ffffUL) << 16) | \

34 (((
__u32
)(
x
è& (__u32)0xffff0000ULè>> 16)))

	)

36 
	#___cÚ¡ªt_swahb32
(
x
è((
__u32
)( \

37 (((
__u32
)(
x
) & (__u32)0x00ff00ffUL) << 8) | \

38 (((
__u32
)(
x
è& (__u32)0xff00ff00ULè>> 8)))

	)

46 
__šlše__
 
__u16
 
	$__fswab16
(
__u16
 
v®
)

48 #ifdeà
__¬ch_swab16


49  
	`__¬ch_swab16
(
v®
);

51  
	`___cÚ¡ªt_swab16
(
v®
);

53 
	}
}

55 
__šlše__
 
__u32
 
	$__fswab32
(
__u32
 
v®
)

57 #ifdeà
__¬ch_swab32


58  
	`__¬ch_swab32
(
v®
);

60  
	`___cÚ¡ªt_swab32
(
v®
);

62 
	}
}

64 
__šlše__
 
__u64
 
	$__fswab64
(
__u64
 
v®
)

66 #ifdeà
__¬ch_swab64


67  
	`__¬ch_swab64
(
v®
);

68 #–ià
	`defšed
(
__SWAB_64_THRU_32__
)

69 
__u32
 
h
 = 
v®
 >> 32;

70 
__u32
 
l
 = 
v®
 & ((1ULL << 32) - 1);

71  (((
__u64
)
	`__fswab32
(
l
)è<< 32è| ((__u64)(__fswab32(
h
)));

73  
	`___cÚ¡ªt_swab64
(
v®
);

75 
	}
}

77 
__šlše__
 
__u32
 
	$__fswahw32
(
__u32
 
v®
)

79 #ifdeà
__¬ch_swahw32


80  
	`__¬ch_swahw32
(
v®
);

82  
	`___cÚ¡ªt_swahw32
(
v®
);

84 
	}
}

86 
__šlše__
 
__u32
 
	$__fswahb32
(
__u32
 
v®
)

88 #ifdeà
__¬ch_swahb32


89  
	`__¬ch_swahb32
(
v®
);

91  
	`___cÚ¡ªt_swahb32
(
v®
);

93 
	}
}

99 
	#__swab16
(
x
) \

100 (
	`__butš_cÚ¡ªt_p
((
__u16
)(
x
)) ? \

101 
	`___cÚ¡ªt_swab16
(
x
) : \

102 
	`__fswab16
(
x
))

	)

108 
	#__swab32
(
x
) \

109 (
	`__butš_cÚ¡ªt_p
((
__u32
)(
x
)) ? \

110 
	`___cÚ¡ªt_swab32
(
x
) : \

111 
	`__fswab32
(
x
))

	)

117 
	#__swab64
(
x
) \

118 (
	`__butš_cÚ¡ªt_p
((
__u64
)(
x
)) ? \

119 
	`___cÚ¡ªt_swab64
(
x
) : \

120 
	`__fswab64
(
x
))

	)

128 
	#__swahw32
(
x
) \

129 (
	`__butš_cÚ¡ªt_p
((
__u32
)(
x
)) ? \

130 
	`___cÚ¡ªt_swahw32
(
x
) : \

131 
	`__fswahw32
(
x
))

	)

139 
	#__swahb32
(
x
) \

140 (
	`__butš_cÚ¡ªt_p
((
__u32
)(
x
)) ? \

141 
	`___cÚ¡ªt_swahb32
(
x
) : \

142 
	`__fswahb32
(
x
))

	)

148 
__šlše__
 
__u16
 
	$__swab16p
(cÚ¡ 
__u16
 *
p
)

150 #ifdeà
__¬ch_swab16p


151  
	`__¬ch_swab16p
(
p
);

153  
	`__swab16
(*
p
);

155 
	}
}

161 
__šlše__
 
__u32
 
	$__swab32p
(cÚ¡ 
__u32
 *
p
)

163 #ifdeà
__¬ch_swab32p


164  
	`__¬ch_swab32p
(
p
);

166  
	`__swab32
(*
p
);

168 
	}
}

174 
__šlše__
 
__u64
 
	$__swab64p
(cÚ¡ 
__u64
 *
p
)

176 #ifdeà
__¬ch_swab64p


177  
	`__¬ch_swab64p
(
p
);

179  
	`__swab64
(*
p
);

181 
	}
}

189 
__šlše__
 
__u32
 
	$__swahw32p
(cÚ¡ 
__u32
 *
p
)

191 #ifdeà
__¬ch_swahw32p


192  
	`__¬ch_swahw32p
(
p
);

194  
	`__swahw32
(*
p
);

196 
	}
}

204 
__šlše__
 
__u32
 
	$__swahb32p
(cÚ¡ 
__u32
 *
p
)

206 #ifdeà
__¬ch_swahb32p


207  
	`__¬ch_swahb32p
(
p
);

209  
	`__swahb32
(*
p
);

211 
	}
}

217 
__šlše__
 
	$__swab16s
(
__u16
 *
p
)

219 #ifdeà
__¬ch_swab16s


220 
	`__¬ch_swab16s
(
p
);

222 *
p
 = 
	`__swab16p
(p);

224 
	}
}

229 
__šlše__
 
	$__swab32s
(
__u32
 *
p
)

231 #ifdeà
__¬ch_swab32s


232 
	`__¬ch_swab32s
(
p
);

234 *
p
 = 
	`__swab32p
(p);

236 
	}
}

242 
__šlše__
 
	$__swab64s
(
__u64
 *
p
)

244 #ifdeà
__¬ch_swab64s


245 
	`__¬ch_swab64s
(
p
);

247 *
p
 = 
	`__swab64p
(p);

249 
	}
}

257 
__šlše__
 
	$__swahw32s
(
__u32
 *
p
)

259 #ifdeà
__¬ch_swahw32s


260 
	`__¬ch_swahw32s
(
p
);

262 *
p
 = 
	`__swahw32p
(p);

264 
	}
}

272 
__šlše__
 
	$__swahb32s
(
__u32
 *
p
)

274 #ifdeà
__¬ch_swahb32s


275 
	`__¬ch_swahb32s
(
p
);

277 *
p
 = 
	`__swahb32p
(p);

279 
	}
}

	@/usr/include/asm-generic/int-ll64.h

8 #iâdeà
_ASM_GENERIC_INT_LL64_H


9 
	#_ASM_GENERIC_INT_LL64_H


	)

11 
	~<asm/b™¥”lÚg.h
>

13 #iâdeà
__ASSEMBLY__


19 
__sigÃd__
 
	t__s8
;

20 
	t__u8
;

22 
__sigÃd__
 
	t__s16
;

23 
	t__u16
;

25 
__sigÃd__
 
	t__s32
;

26 
	t__u32
;

28 #ifdeà
__GNUC__


29 
__ex‹nsiÚ__
 
__sigÃd__
 
	t__s64
;

30 
__ex‹nsiÚ__
 
	t__u64
;

32 
__sigÃd__
 
	t__s64
;

33 
	t__u64
;

	@/usr/include/asm/posix_types_32.h

1 #iâdeà
_ASM_X86_POSIX_TYPES_32_H


2 
	#_ASM_X86_POSIX_TYPES_32_H


	)

10 
	t__k”Ãl_šo_t
;

11 
	t__k”Ãl_mode_t
;

12 
	t__k”Ãl_Æšk_t
;

13 
	t__k”Ãl_off_t
;

14 
	t__k”Ãl_pid_t
;

15 
	t__k”Ãl_c_pid_t
;

16 
	t__k”Ãl_uid_t
;

17 
	t__k”Ãl_gid_t
;

18 
	t__k”Ãl_size_t
;

19 
	t__k”Ãl_ssize_t
;

20 
	t__k”Ãl_±rdiff_t
;

21 
	t__k”Ãl_time_t
;

22 
	t__k”Ãl_su£cÚds_t
;

23 
	t__k”Ãl_şock_t
;

24 
	t__k”Ãl_tim”_t
;

25 
	t__k”Ãl_şockid_t
;

26 
	t__k”Ãl_daddr_t
;

27 * 
	t__k”Ãl_ÿddr_t
;

28 
	t__k”Ãl_uid16_t
;

29 
	t__k”Ãl_gid16_t
;

30 
	t__k”Ãl_uid32_t
;

31 
	t__k”Ãl_gid32_t
;

33 
	t__k”Ãl_Şd_uid_t
;

34 
	t__k”Ãl_Şd_gid_t
;

35 
	t__k”Ãl_Şd_dev_t
;

37 #ifdeà
__GNUC__


38 
	t__k”Ãl_loff_t
;

42 
	mv®
[2];

43 } 
	t__k”Ãl_fsid_t
;

	@/usr/include/asm/posix_types_64.h

1 #iâdeà
_ASM_X86_POSIX_TYPES_64_H


2 
	#_ASM_X86_POSIX_TYPES_64_H


	)

10 
	t__k”Ãl_šo_t
;

11 
	t__k”Ãl_mode_t
;

12 
	t__k”Ãl_Æšk_t
;

13 
	t__k”Ãl_off_t
;

14 
	t__k”Ãl_pid_t
;

15 
	t__k”Ãl_c_pid_t
;

16 
	t__k”Ãl_uid_t
;

17 
	t__k”Ãl_gid_t
;

18 
	t__k”Ãl_size_t
;

19 
	t__k”Ãl_ssize_t
;

20 
	t__k”Ãl_±rdiff_t
;

21 
	t__k”Ãl_time_t
;

22 
	t__k”Ãl_su£cÚds_t
;

23 
	t__k”Ãl_şock_t
;

24 
	t__k”Ãl_tim”_t
;

25 
	t__k”Ãl_şockid_t
;

26 
	t__k”Ãl_daddr_t
;

27 * 
	t__k”Ãl_ÿddr_t
;

28 
	t__k”Ãl_uid16_t
;

29 
	t__k”Ãl_gid16_t
;

31 #ifdeà
__GNUC__


32 
	t__k”Ãl_loff_t
;

36 
	mv®
[2];

37 } 
	t__k”Ãl_fsid_t
;

39 
	t__k”Ãl_Şd_uid_t
;

40 
	t__k”Ãl_Şd_gid_t
;

41 
__k”Ãl_uid_t
 
	t__k”Ãl_uid32_t
;

42 
__k”Ãl_gid_t
 
	t__k”Ãl_gid32_t
;

44 
	t__k”Ãl_Şd_dev_t
;

	@/usr/include/asm/swab.h

1 #iâdeà
_ASM_X86_SWAB_H


2 
	#_ASM_X86_SWAB_H


	)

4 
	~<lšux/ty³s.h
>

7 
__šlše__
 
__u32
 
	$__¬ch_swab32
(
__u32
 
v®
)

9 #ifdeà
__i386__


10 #ifdeà
CONFIG_X86_BSWAP


11 
	`__asm__
("bsw­ %0" : "ô" (
v®
) : "0" (val));

13 
	`__asm__
("xchgb %b0,%h0\n\t"

16 : "=q" (
v®
)

17 : "0" (
v®
));

21 
	`__asm__
("bswapl %0"

22 : "ô" (
v®
)

23 : "0" (
v®
));

25  
v®
;

26 
	}
}

27 
	#__¬ch_swab32
 
__¬ch_swab32


	)

29 
__šlše__
 
__u64
 
	$__¬ch_swab64
(
__u64
 
v®
)

31 #ifdeà
__i386__


34 
__u32
 
a
;

35 
__u32
 
b
;

36 } 
s
;

37 
__u64
 
u
;

38 } 
v
;

39 
v
.
u
 = 
v®
;

40 #ifdeà
CONFIG_X86_BSWAP


41 
	`__asm__
("bswapl %0 ; bswapl %1 ; xchgl %0,%1"

42 : "ô" (
v
.
s
.
a
), "ô" (v.s.
b
)

43 : "0" (
v
.
s
.
a
), "1" (v.s.
b
));

45 
v
.
s
.
a
 = 
	`__¬ch_swab32
(v.s.a);

46 
v
.
s
.
b
 = 
	`__¬ch_swab32
(v.s.b);

47 
	`__asm__
("xchgl %0,%1"

48 : "ô" (
v
.
s
.
a
), "ô" (v.s.
b
)

49 : "0" (
v
.
s
.
a
), "1" (v.s.
b
));

51  
v
.
u
;

53 
	`__asm__
("bswapq %0"

54 : "ô" (
v®
)

55 : "0" (
v®
));

56  
v®
;

58 
	}
}

59 
	#__¬ch_swab64
 
__¬ch_swab64


	)

	@/usr/include/asm/bitsperlong.h

1 #iâdeà
__ASM_X86_BITSPERLONG_H


2 
	#__ASM_X86_BITSPERLONG_H


	)

4 #ifdeà
__x86_64__


5 
	#__BITS_PER_LONG
 64

	)

7 
	#__BITS_PER_LONG
 32

	)

10 
	~<asm-g’”ic/b™¥”lÚg.h
>

	@/usr/include/asm-generic/bitsperlong.h

1 #iâdeà
__ASM_GENERIC_BITS_PER_LONG


2 
	#__ASM_GENERIC_BITS_PER_LONG


	)

11 #iâdeà
__BITS_PER_LONG


12 
	#__BITS_PER_LONG
 32

	)

	@
1
.
1
/usr/include
81
1641
bat_algo.h
bat_iv_ogm.c
batman-adv.mod.c
bitarray.c
bitarray.h
bridge_loop_avoidance.c
bridge_loop_avoidance.h
compat-autoconf.h
compat.c
compat.h
debugfs.c
debugfs.h
gateway_client.c
gateway_client.h
gateway_common.c
gateway_common.h
hard-interface.c
hard-interface.h
hash.c
hash.h
icmp_socket.c
icmp_socket.h
main.c
main.h
originator.c
originator.h
packet.h
ring_buffer.c
ring_buffer.h
routing.c
routing.h
send.c
send.h
soft-interface.c
soft-interface.h
sysfs.c
sysfs.h
translation-table.c
translation-table.h
types.h
unicast.c
unicast.h
vis.c
vis.h
/usr/include/linux/ethtool.h
/usr/include/linux/if_arp.h
/usr/include/linux/if_ether.h
/usr/include/linux/if_vlan.h
/usr/include/linux/in.h
/usr/include/linux/ip.h
/usr/include/linux/ipv6.h
/usr/include/linux/kernel.h
/usr/include/linux/netdevice.h
/usr/include/linux/pkt_sched.h
/usr/include/linux/poll.h
/usr/include/linux/udp.h
/usr/include/linux/version.h
/usr/include/asm/byteorder.h
/usr/include/asm/poll.h
/usr/include/linux/if.h
/usr/include/linux/if_link.h
/usr/include/linux/if_packet.h
/usr/include/linux/in6.h
/usr/include/linux/socket.h
/usr/include/linux/types.h
/usr/include/asm-generic/poll.h
/usr/include/asm/types.h
/usr/include/linux/byteorder/little_endian.h
/usr/include/linux/hdlc/ioctl.h
/usr/include/linux/netlink.h
/usr/include/linux/posix_types.h
/usr/include/asm-generic/types.h
/usr/include/asm/posix_types.h
/usr/include/linux/stddef.h
/usr/include/linux/swab.h
/usr/include/asm-generic/int-ll64.h
/usr/include/asm/posix_types_32.h
/usr/include/asm/posix_types_64.h
/usr/include/asm/swab.h
/usr/include/asm/bitsperlong.h
/usr/include/asm-generic/bitsperlong.h
